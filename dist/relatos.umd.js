(function(_,R){typeof exports=="object"&&typeof module<"u"?R(exports):typeof define=="function"&&define.amd?define(["exports"],R):(_=typeof globalThis<"u"?globalThis:_||self,R(_.Relatos={}))})(this,(function(_){"use strict";const R=`<!-- relatos/src/assets/icons/icons.svg -->
<svg xmlns="http://www.w3.org/2000/svg" style="display:none">
  <!-- =========================================
       Edit (pencil) : toggle "edit relations"
       ========================================= -->
  <symbol id="icon-edit" viewBox="0 0 24 24">
    <path
      d="M12 20h9"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
    <path
      d="M16.5 3.5a2.12 2.12 0 0 1 3 3L8 18l-4 1 1-4 11.5-11.5z"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
  </symbol>

  <!-- =========================================
       Sun (day/night shading toggle)
       ========================================= -->
  <symbol id="icon-sun" viewBox="0 0 24 24">
    <circle
      cx="12"
      cy="12"
      r="4"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
    <path
      d="M12 2v2"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
    <path
      d="M12 20v2"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
    <path
      d="M2 12h2"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
    <path
      d="M20 12h2"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
    <path
      d="M4.93 4.93l1.41 1.41"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
    <path
      d="M17.66 17.66l1.41 1.41"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
    <path
      d="M19.07 4.93l-1.41 1.41"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
    <path
      d="M6.34 17.66l-1.41 1.41"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
  </symbol>

  <!-- =========================================
       Home (fit to graph / reset view)
       ========================================= -->
  <symbol id="icon-home" viewBox="0 0 24 24">
    <path
      d="M3 10.5l9-7 9 7"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
    <path
      d="M5 9.8V20a1 1 0 0 0 1 1h4v-6h4v6h4a1 1 0 0 0 1-1V9.8"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
  </symbol>

  <!-- =========================================
       Relations (edges show/hide toggle)
       - Universal: 3 nodes + connections
       ========================================= -->
  <symbol id="icon-relations" viewBox="0 0 24 24">
    <circle
      cx="6.5"
      cy="7"
      r="2.5"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
    <circle
      cx="17.5"
      cy="6.5"
      r="2.5"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
    <circle
      cx="12"
      cy="17.5"
      r="2.5"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
    <path
      d="M8.8 7.7l6.4-0.6"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
    <path
      d="M8.2 9.1l2.7 6"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
    <path
      d="M16.2 8.6l-2.6 6.1"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
  </symbol>

  <!-- =========================================
       Undo / Cancel edit / Restore previous state
       - Universal: curved left arrow (undo)
       ========================================= -->
  <symbol id="icon-undo" viewBox="0 0 24 24">
    <path
      d="M7 7L10.5 3.5"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
    <path
      d="M7 7L10.5 10.5"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />

    <path
      d="M7 7h6.5a7.5 7.5 0 0 1 0 15H6"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
  </symbol>

  <symbol id="icon-view-graph" viewBox="0 0 24 24">
    <!-- Left node (pushed to the left) -->
    <rect
      x="2.5"
      y="8.5"
      width="5"
      height="7"
      rx="1.5"
      ry="1.5"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
    />

    <!-- Right node (pushed to the right) -->
    <rect
      x="16.5"
      y="8.5"
      width="5"
      height="7"
      rx="1.5"
      ry="1.5"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
    />

    <!-- Bidirectional arrow (long and clear) -->
    <path
      d="M8.8 12h6.4"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
    />

    <!-- Left arrow head (points left) -->
    <path
      d="M8.8 12l1.8-1.8"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
    <path
      d="M8.8 12l1.8 1.8"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />

    <!-- Right arrow head (points right) -->
    <path
      d="M15.2 12l-1.8-1.8"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
    <path
      d="M15.2 12l-1.8 1.8"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
  </symbol>

  <symbol id="icon-view-globe3d" viewBox="0 0 24 24">
    <!-- Globe outline: as large as possible inside viewBox -->
    <circle
      cx="12"
      cy="12"
      r="11"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
    />

    <!-- Left node (pushed left) -->
    <rect
      x="4.2"
      y="8.5"
      width="4.6"
      height="7"
      rx="1.3"
      ry="1.3"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
    />
    <!-- Right node (pushed right) -->
    <rect
      x="15.2"
      y="8.5"
      width="4.6"
      height="7"
      rx="1.3"
      ry="1.3"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
    />

    <!-- Bidirectional arrow (longer, not crushed) -->
    <path
      d="M9.6 12h4.8"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
    />
    <!-- Left arrow head (points left) -->
    <path
      d="M9.6 12l1.6-1.6"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
    <path
      d="M9.6 12l1.6 1.6"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
    <!-- Right arrow head (points right) -->
    <path
      d="M14.4 12l-1.6-1.6"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
    <path
      d="M14.4 12l-1.6 1.6"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
  </symbol>

  <symbol id="icon-view-map" viewBox="0 0 24 24">
    <!-- Map frame: as large as possible inside viewBox -->
    <rect
      x="1"
      y="3"
      width="22"
      height="18"
      rx="3"
      ry="3"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
    />

    <!-- Left node (pushed left) -->
    <rect
      x="4.2"
      y="8.5"
      width="4.6"
      height="7"
      rx="1.3"
      ry="1.3"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
    />
    <!-- Right node (pushed right) -->
    <rect
      x="15.2"
      y="8.5"
      width="4.6"
      height="7"
      rx="1.3"
      ry="1.3"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
    />

    <!-- Bidirectional arrow (longer, not crushed) -->
    <path
      d="M9.6 12h4.8"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
    />
    <!-- Left arrow head (points left) -->
    <path
      d="M9.6 12l1.6-1.6"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
    <path
      d="M9.6 12l1.6 1.6"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
    <!-- Right arrow head (points right) -->
    <path
      d="M14.4 12l-1.6-1.6"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
    <path
      d="M14.4 12l-1.6 1.6"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
  </symbol>

  <symbol id="icon-map-tiles" viewBox="0 0 24 24">
    <!-- Top-left (filled) -->
    <rect
      x="4"
      y="4"
      width="7"
      height="7"
      rx="1.2"
      ry="1.2"
      fill="currentColor"
      stroke="currentColor"
      stroke-width="2"
    />
    <!-- Top-right (outline) -->
    <rect
      x="14"
      y="4"
      width="7"
      height="7"
      rx="1.2"
      ry="1.2"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
    />
    <!-- Bottom-left (outline) -->
    <rect
      x="4"
      y="14"
      width="7"
      height="7"
      rx="1.2"
      ry="1.2"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
    />
    <!-- Bottom-right (filled) -->
    <rect
      x="14"
      y="14"
      width="7"
      height="7"
      rx="1.2"
      ry="1.2"
      fill="currentColor"
      stroke="currentColor"
      stroke-width="2"
    />
  </symbol>

</svg>`;let V=!1;const U="relatos-icons-sprite";function D(){if(V)return;if(document.getElementById(U)){V=!0;return}const k=document.createElement("div");k.id=U,k.style.display="none",k.innerHTML=R,document.body.appendChild(k),V=!0}function H(k,t=16){return D(),`<svg width="${t}" height="${t}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <use href="#${k}"></use>
  </svg>`}class j{constructor(t,e){this.currentView=null,this.views=new Map,this.tabButtons=new Map,this.editToggleButton=null,this.alwaysShowEdgesButton=null,this.lightingToggleButton=null,this.tileTypeButton=null,this.fitCenterButton=null,this.clearSelectionButton=null,this.deleteBendButton=null,this.cancelEditButton=null,this.tableContainer=null,this.nodesTableContainer=null,this.edgesTableContainer=null,this.tableOptions=null,this.nodes=[],this.edges=[],this.isExternalTableContainer=!1,this.hasEdges=!1,this.sharedAlwaysShowEdges=!1,this.sharedLightingEnabled=!1,this.sharedTime=null,this.sharedTileServerIndex=0,this.container=t,this.enabledViews=e,D(),this.container.style.display="flex",this.container.style.flexDirection="column",this.container.style.width="100%",this.tabContainer=document.createElement("div"),this.tabContainer.style.display="flex",this.tabContainer.style.gap="4px",this.tabContainer.style.padding="8px",this.tabContainer.style.borderBottom="none",this.tabContainer.style.backgroundColor="transparent",this.tabContainer.style.position="absolute",this.tabContainer.style.top="0",this.tabContainer.style.left="0",this.tabContainer.style.right="0",this.tabContainer.style.zIndex="1000",this.tabContainer.style.pointerEvents="none",this.viewContainer=document.createElement("div"),this.viewContainer.style.flex="1 1 0%",this.viewContainer.style.position="relative",this.viewContainer.style.overflow="hidden",this.viewContainer.style.minHeight="0",this.createTabButtons(),this.createCommonControlsContainer(),this.container.appendChild(this.viewContainer),this.viewContainer.appendChild(this.tabContainer)}setTableOptions(t){this.tableOptions=t,t&&(t.nodes?.format||t.edges?.format)?this.createTableContainer():this.tableContainer&&(this.isExternalTableContainer?(this.tableContainer.innerHTML="",this.tableContainer=null,this.isExternalTableContainer=!1):this.container.contains(this.tableContainer)&&(this.container.removeChild(this.tableContainer),this.tableContainer=null),this.nodesTableContainer=null,this.edgesTableContainer=null)}setOnNodeClickCallback(t){this.onNodeClickCallback=t}createTableContainer(){if(!this.tableContainer){if(this.tableOptions&&"container"in this.tableOptions&&this.tableOptions.container){const t=this.tableOptions.container;let e=null;if(typeof t=="string"?e=document.querySelector(t):t instanceof HTMLElement&&(e=t),e){this.tableContainer=e,this.isExternalTableContainer=!0;return}}this.tableContainer=document.createElement("div"),this.tableContainer.style.height="300px",this.tableContainer.style.overflowY="auto",this.tableContainer.style.backgroundColor="#fff",this.tableContainer.style.borderTop="1px solid #ddd",this.isExternalTableContainer=!1,this.container.appendChild(this.tableContainer)}}setData(t,e){this.nodes=t,this.edges=e,this.hasEdges=Array.isArray(e)&&e.length>0,this.updateTables(),this.updateAlwaysShowEdgesButtonVisibility()}updateTables(){!this.tableOptions||!this.tableContainer||(this.tableContainer.innerHTML="",this.tableOptions.nodes?.format&&(this.nodesTableContainer=this.createTable("nodes",this.tableOptions.nodes.header||"",this.tableOptions.nodes.format,this.nodes,"node"),this.tableContainer.appendChild(this.nodesTableContainer)),this.tableOptions.edges?.format&&(this.edgesTableContainer=this.createTable("edges",this.tableOptions.edges.header||"",this.tableOptions.edges.format,this.edges,"edge"),this.tableContainer.appendChild(this.edgesTableContainer)))}createTable(t,e,i,s,n){const o=document.createElement("div"),l=document.createElement("table");if(l.style.width="100%",l.style.borderCollapse="collapse",!document.getElementById("relatos-table-styles")){const d=document.createElement("style");d.id="relatos-table-styles",d.textContent=`
        .relatos-table tr {
          border-bottom: 1px solid #ddd;
        }
        .relatos-table tr:hover {
          background-color: #f9f9f9;
        }
        .relatos-table tr.highlight {
          background-color: #fff9c4;
          animation: relatos-highlight-fade 2s ease-out;
        }
        @keyframes relatos-highlight-fade {
          from {
            background-color: #fff9c4;
          }
          to {
            background-color: transparent;
          }
        }
        .relatos-table th,
        .relatos-table td {
          padding: 12px;
          text-align: left;
        }
        .relatos-table th {
          background-color: #f5f5f5;
          font-weight: 600;
          color: #333;
          position: sticky;
          top: 0;
          z-index: 1;
        }
      `,document.head.appendChild(d)}l.className="relatos-table";const a=document.createElement("thead");if(e)a.innerHTML=e;else{const d=document.createElement("tr");a.appendChild(d)}l.appendChild(a);const c=document.createElement("tbody");for(const d of s){const r=document.createElement("tr");r.id=`${n}-${d.id}`,r.style.cursor="pointer";let h=i;if("info"in d&&d.info)for(const[g,u]of Object.entries(d.info)){const w=new RegExp(`\\{\\{info\\.${g}\\}\\}`,"g");h=h.replace(w,String(u||""))}if(h=h.replace(/\{\{id\}\}/g,String(d.id||"")),h=h.replace(/\{\{label\}\}/g,String("label"in d&&d.label||"")),h=h.replace(/\{\{type\}\}/g,String("type"in d&&d.type||"")),"coordinates"in d&&d.coordinates&&(h=h.replace(/\{\{coordinates\.0\}\}/g,String(d.coordinates[0]||"")),h=h.replace(/\{\{coordinates\.1\}\}/g,String(d.coordinates[1]||"")),h=h.replace(/\{\{latitude\}\}/g,String(d.coordinates[0]||"")),h=h.replace(/\{\{longitude\}\}/g,String(d.coordinates[1]||""))),d.style&&typeof d.style=="object"){const g=d.style;h=h.replace(/\{\{style\.color\}\}/g,String(g.color??"")),h=h.replace(/\{\{style\.borderColor\}\}/g,String(g.borderColor??"")),h=h.replace(/\{\{style\.width\}\}/g,String(g.width??"")),h=h.replace(/\{\{style\.height\}\}/g,String(g.height??"")),h=h.replace(/\{\{style\.weight\}\}/g,String(g.weight??"")),h=h.replace(/\{\{style\.label\}\}/g,String(g.label??"")),h=h.replace(/\{\{style\.srcLabel\}\}/g,String(g.srcLabel??"")),h=h.replace(/\{\{style\.dstLabel\}\}/g,String(g.dstLabel??""))}"src"in d&&(h=h.replace(/\{\{src\}\}/g,String(d.src||"")),h=h.replace(/\{\{dst\}\}/g,String(d.dst||"")),h=h.replace(/\{\{relType\}\}/g,String(d.relType||""))),r.innerHTML=h,r.addEventListener("click",()=>{if(n==="node"){if(this.highlightAndScrollToRow(r),!this.currentView)return;const g=this.views.get(this.currentView);g?.selectNode&&g.selectNode(d.id)}}),c.appendChild(r)}return l.appendChild(c),o.appendChild(l),o}highlightAndScrollToRow(t){const e=this.tableContainer?.querySelector(".highlight");e&&e.classList.remove("highlight"),t.classList.add("highlight"),setTimeout(()=>{t.classList.remove("highlight")},2e3),t.scrollIntoView({behavior:"smooth",block:"center"})}highlightNodeRow(t){if(!t||!this.tableContainer)return;const e=this.tableContainer.querySelector(`#node-${t}`);e&&this.highlightAndScrollToRow(e)}highlightNodeRows(t){if(!t||t.length===0||!this.tableContainer)return;this.tableContainer.querySelectorAll(".highlight").forEach(s=>s.classList.remove("highlight"));let i=null;for(const s of t){const n=this.tableContainer?.querySelector(`#node-${s}`);n&&(n.classList.add("highlight"),i||(i=n),setTimeout(()=>{n.classList.remove("highlight")},2e3))}i&&i.scrollIntoView({behavior:"smooth",block:"center"})}highlightEdgeRow(t){if(!t||!this.tableContainer)return;const e=this.tableContainer.querySelector(`#edge-${t}`);e&&this.highlightAndScrollToRow(e)}createCommonControlsContainer(){this.commonControlsContainer=document.createElement("div"),this.commonControlsContainer.style.display="flex",this.commonControlsContainer.style.gap="4px",this.commonControlsContainer.style.marginLeft="auto",this.commonControlsContainer.style.pointerEvents="none",this.createCancelEditButton(),this.createEditToggleButton(),this.createAlwaysShowEdgesButton(),this.createClearSelectionButton(),this.createDeleteBendButton(),this.createLightingToggleButton(),this.createTileTypeButton(),this.createFitCenterButton(),this.tabContainer.appendChild(this.commonControlsContainer)}createEditToggleButton(){this.editToggleButton=document.createElement("button"),this.editToggleButton.className="relatos-edit-toggle",this.editToggleButton.style.padding="6px",this.editToggleButton.style.border="1px solid #ccc",this.editToggleButton.style.borderRadius="4px",this.editToggleButton.style.backgroundColor="#fff",this.editToggleButton.style.cursor="pointer",this.editToggleButton.style.fontSize="16px",this.editToggleButton.style.width="32px",this.editToggleButton.style.height="32px",this.editToggleButton.style.display="none",this.editToggleButton.style.alignItems="center",this.editToggleButton.style.justifyContent="center",this.editToggleButton.style.pointerEvents="auto",this.editToggleButton.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)",this.editToggleButton.style.transition="0.2s",this.editToggleButton.style.color="#333",this.commonControlsContainer.insertBefore(this.editToggleButton,this.commonControlsContainer.firstChild)}createAlwaysShowEdgesButton(){this.alwaysShowEdgesButton=document.createElement("button"),this.alwaysShowEdgesButton.className="relatos-always-show-edges-toggle",this.alwaysShowEdgesButton.innerHTML=H("icon-relations",16),this.alwaysShowEdgesButton.setAttribute("aria-label","Toggle edges"),this.alwaysShowEdgesButton.setAttribute("title","Toggle edges"),this.alwaysShowEdgesButton.style.padding="6px",this.alwaysShowEdgesButton.style.border="1px solid #ccc",this.alwaysShowEdgesButton.style.borderRadius="4px",this.alwaysShowEdgesButton.style.backgroundColor="#fff",this.alwaysShowEdgesButton.style.cursor="pointer",this.alwaysShowEdgesButton.style.fontSize="16px",this.alwaysShowEdgesButton.style.width="32px",this.alwaysShowEdgesButton.style.height="32px",this.alwaysShowEdgesButton.style.display="flex",this.alwaysShowEdgesButton.style.alignItems="center",this.alwaysShowEdgesButton.style.justifyContent="center",this.alwaysShowEdgesButton.style.pointerEvents="auto",this.alwaysShowEdgesButton.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)",this.alwaysShowEdgesButton.style.transition="0.2s",this.alwaysShowEdgesButton.style.color="#000000",this.alwaysShowEdgesButton.addEventListener("click",()=>{if(!this.currentView)return;const t=this.views.get(this.currentView);if(t?.getAlwaysShowEdges){const e=t.getAlwaysShowEdges();this.setAlwaysShowEdges(!e)}}),this.commonControlsContainer.appendChild(this.alwaysShowEdgesButton)}createLightingToggleButton(){this.lightingToggleButton=document.createElement("button"),this.lightingToggleButton.innerHTML=H("icon-sun",16),this.lightingToggleButton.setAttribute("aria-label","Toggle lighting"),this.lightingToggleButton.setAttribute("title","Toggle lighting"),this.lightingToggleButton.style.padding="6px",this.lightingToggleButton.style.border="1px solid #ccc",this.lightingToggleButton.style.borderRadius="4px",this.lightingToggleButton.style.backgroundColor="#fff",this.lightingToggleButton.style.cursor="pointer",this.lightingToggleButton.style.fontSize="16px",this.lightingToggleButton.style.width="32px",this.lightingToggleButton.style.height="32px",this.lightingToggleButton.style.display="none",this.lightingToggleButton.style.alignItems="center",this.lightingToggleButton.style.justifyContent="center",this.lightingToggleButton.style.pointerEvents="auto",this.lightingToggleButton.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)",this.lightingToggleButton.style.transition="0.2s",this.lightingToggleButton.addEventListener("click",()=>{if(!this.currentView)return;const t=this.views.get(this.currentView);if(t?.getLightingEnabled){const e=t.getLightingEnabled();this.setLightingEnabled(!e)}}),this.commonControlsContainer.appendChild(this.lightingToggleButton)}createTileTypeButton(){this.tileTypeButton=document.createElement("button"),this.tileTypeButton.innerHTML=H("icon-map-tiles",16),this.tileTypeButton.setAttribute("aria-label","Switch tile type"),this.tileTypeButton.setAttribute("title","Switch tile type"),this.tileTypeButton.style.padding="6px",this.tileTypeButton.style.border="1px solid #ccc",this.tileTypeButton.style.borderRadius="4px",this.tileTypeButton.style.backgroundColor="#fff",this.tileTypeButton.style.cursor="pointer",this.tileTypeButton.style.fontSize="16px",this.tileTypeButton.style.width="32px",this.tileTypeButton.style.height="32px",this.tileTypeButton.style.display="none",this.tileTypeButton.style.alignItems="center",this.tileTypeButton.style.justifyContent="center",this.tileTypeButton.style.pointerEvents="auto",this.tileTypeButton.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)",this.tileTypeButton.style.transition="0.2s",this.tileTypeButton.addEventListener("click",()=>{if(!this.currentView)return;let t=0;for(const e of this.views.values())if(e.getTileServerCount){const i=e.getTileServerCount();i>t&&(t=i)}if(!(t<2)){this.sharedTileServerIndex=(this.sharedTileServerIndex+1)%t;for(const e of this.views.values())if(e.getTileServerCount&&e.setTileServerIndex){const i=e.getTileServerCount();if(i>0){const s=this.sharedTileServerIndex%i;e.setTileServerIndex(s)}}this.updateTileTypeButton()}}),this.commonControlsContainer.appendChild(this.tileTypeButton)}createFitCenterButton(){this.fitCenterButton=document.createElement("button"),this.fitCenterButton.innerHTML=H("icon-home",16),this.fitCenterButton.setAttribute("aria-label","Fit and center"),this.fitCenterButton.setAttribute("title","Fit and center"),this.fitCenterButton.style.padding="6px",this.fitCenterButton.style.border="1px solid #ccc",this.fitCenterButton.style.borderRadius="4px",this.fitCenterButton.style.backgroundColor="#fff",this.fitCenterButton.style.cursor="pointer",this.fitCenterButton.style.fontSize="16px",this.fitCenterButton.style.width="32px",this.fitCenterButton.style.height="32px",this.fitCenterButton.style.display="flex",this.fitCenterButton.style.alignItems="center",this.fitCenterButton.style.justifyContent="center",this.fitCenterButton.style.pointerEvents="auto",this.fitCenterButton.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)",this.fitCenterButton.style.transition="0.2s",this.fitCenterButton.addEventListener("click",()=>{if(!this.currentView)return;const t=this.views.get(this.currentView);t?.fitAndCenter&&t.fitAndCenter()}),this.commonControlsContainer.appendChild(this.fitCenterButton)}createClearSelectionButton(){this.clearSelectionButton=document.createElement("button"),this.clearSelectionButton.innerHTML="âœ•",this.clearSelectionButton.setAttribute("aria-label","Clear selection"),this.clearSelectionButton.setAttribute("title","Clear selection"),this.clearSelectionButton.style.padding="6px",this.clearSelectionButton.style.border="1px solid #ccc",this.clearSelectionButton.style.borderRadius="4px",this.clearSelectionButton.style.backgroundColor="#fff",this.clearSelectionButton.style.cursor="pointer",this.clearSelectionButton.style.fontSize="16px",this.clearSelectionButton.style.width="32px",this.clearSelectionButton.style.height="32px",this.clearSelectionButton.style.display="none",this.clearSelectionButton.style.alignItems="center",this.clearSelectionButton.style.justifyContent="center",this.clearSelectionButton.style.pointerEvents="auto",this.clearSelectionButton.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)",this.clearSelectionButton.style.transition="0.2s",this.clearSelectionButton.addEventListener("click",()=>{if(!this.currentView)return;const t=this.views.get(this.currentView);t?.clearSelection&&t.clearSelection()}),this.commonControlsContainer.appendChild(this.clearSelectionButton)}createDeleteBendButton(){this.deleteBendButton=document.createElement("button"),this.deleteBendButton.innerHTML="ðŸ—‘",this.deleteBendButton.setAttribute("aria-label","Delete bend point"),this.deleteBendButton.setAttribute("title","Delete bend point"),this.deleteBendButton.style.padding="6px",this.deleteBendButton.style.border="1px solid #ccc",this.deleteBendButton.style.borderRadius="4px",this.deleteBendButton.style.backgroundColor="#fff",this.deleteBendButton.style.cursor="pointer",this.deleteBendButton.style.fontSize="16px",this.deleteBendButton.style.width="32px",this.deleteBendButton.style.height="32px",this.deleteBendButton.style.display="none",this.deleteBendButton.style.alignItems="center",this.deleteBendButton.style.justifyContent="center",this.deleteBendButton.style.pointerEvents="auto",this.deleteBendButton.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)",this.deleteBendButton.style.transition="0.2s",this.deleteBendButton.addEventListener("click",()=>{if(!this.currentView)return;const t=this.views.get(this.currentView);t?.deleteNearestBendPoint&&t.deleteNearestBendPoint()}),this.commonControlsContainer.appendChild(this.deleteBendButton)}createCancelEditButton(){this.cancelEditButton=document.createElement("button"),this.cancelEditButton.innerHTML=H("icon-undo",16),this.cancelEditButton.setAttribute("aria-label","Cancel edit"),this.cancelEditButton.setAttribute("title","Cancel edit and restore previous state"),this.cancelEditButton.style.padding="6px",this.cancelEditButton.style.border="1px solid #ccc",this.cancelEditButton.style.borderRadius="4px",this.cancelEditButton.style.backgroundColor="#fff",this.cancelEditButton.style.cursor="pointer",this.cancelEditButton.style.fontSize="16px",this.cancelEditButton.style.width="32px",this.cancelEditButton.style.height="32px",this.cancelEditButton.style.display="none",this.cancelEditButton.style.alignItems="center",this.cancelEditButton.style.justifyContent="center",this.cancelEditButton.style.pointerEvents="auto",this.cancelEditButton.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)",this.cancelEditButton.style.transition="0.2s",this.cancelEditButton.addEventListener("click",()=>{if(!this.currentView)return;const t=this.views.get(this.currentView);t?.cancelEdit&&t.cancelEdit()}),this.commonControlsContainer.appendChild(this.cancelEditButton)}updateEditToggleButton(){if(!this.editToggleButton||!this.currentView)return;const t=this.views.get(this.currentView);if(!t)return;if((t.isEditable?.()||!1)&&this.currentView==="graph"){this.editToggleButton.style.display="flex";const i=t.getEditToggleButton?.();i&&(this.editToggleButton.innerHTML=i.innerHTML,this.editToggleButton.setAttribute("aria-label",i.getAttribute("aria-label")||"Toggle edit mode"),this.editToggleButton.setAttribute("title",i.getAttribute("title")||"Toggle edit mode"),this.editToggleButton.className=i.className,this.editToggleButton.style.padding="6px",this.editToggleButton.style.border=i.style.border||"1px solid #ccc",this.editToggleButton.style.borderRadius=i.style.borderRadius||"4px",this.editToggleButton.style.backgroundColor=i.style.backgroundColor||"#fff",this.editToggleButton.style.color=i.style.color||"#333",this.editToggleButton.style.borderColor=i.style.borderColor||"#ccc",this.editToggleButton.style.cursor=i.style.cursor||"pointer",this.editToggleButton.style.fontSize="16px",this.editToggleButton.style.width="32px",this.editToggleButton.style.height="32px",this.editToggleButton.style.alignItems="center",this.editToggleButton.style.justifyContent="center",this.editToggleButton.style.transition=i.style.transition||"0.2s",this.editToggleButton.style.boxShadow=i.style.boxShadow||"0 2px 4px rgba(0, 0, 0, 0.1)",this.editToggleButton.style.transform=i.style.transform||"translateY(0)",this.editToggleButton.onclick=()=>{i.click()})}else this.editToggleButton.style.display="none"}createTabButtons(){const t={graph:"icon-view-graph",map2d:"icon-view-map",globe3d:"icon-view-globe3d"},e={graph:"Graph",map2d:"Map 2D",globe3d:"Globe 3D"};for(const i of this.enabledViews){const s=document.createElement("button");s.innerHTML=H(t[i],16),s.setAttribute("aria-label",e[i]),s.setAttribute("title",e[i]),s.style.padding="8px 16px",s.style.border="1px solid #ccc",s.style.borderRadius="4px 4px 0 0",s.style.backgroundColor="#fff",s.style.cursor="pointer",s.style.fontSize="14px",s.style.display="flex",s.style.alignItems="center",s.style.justifyContent="center",s.style.color="#000000",s.style.pointerEvents="auto",s.style.visibility="visible",s.style.opacity="1",s.addEventListener("click",()=>{this.switchView(i)}),this.tabButtons.set(i,s),this.tabContainer.appendChild(s),console.log(`Created tab button for view: ${i}`)}console.log(`Created ${this.tabButtons.size} tab buttons for enabled views: ${this.enabledViews.join(", ")}`)}registerView(t,e){this.views.set(t,e),e.hide(),this.applySharedToggleStates(e),this.updateEditToggleButton()}switchView(t){if(!this.enabledViews.includes(t)){console.warn(`View "${t}" is not enabled`);return}if(this.currentView===t)return;if(this.currentView){const s=this.views.get(this.currentView);s&&s.hide();const n=this.tabButtons.get(this.currentView);n&&(n.style.backgroundColor="#fff",n.style.fontWeight="normal",n.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)",n.style.transform="translateY(0)")}const e=this.views.get(t);e?(this.applySharedToggleStates(e),e.show(),setTimeout(()=>{this.currentView===t&&(this.applySharedToggleStates(e),this.updateLightingButton(),this.updateTileTypeButton())},100),e.resize()):console.warn(`View "${t}" is enabled but not registered. Make sure the view is created and registered.`);const i=this.tabButtons.get(t);i&&(i.style.backgroundColor="#fff9c4",i.style.fontWeight="bold",i.style.boxShadow="inset 0 2px 4px rgba(0, 0, 0, 0.2)",i.style.transform="translateY(1px)"),this.currentView=t,this.updateEditToggleButton(),this.updateCommonControlsVisibility(),this.updateAlwaysShowEdgesButton(),this.updateLightingButton(),this.updateTileTypeButton(),this.updateCancelEditButton(),this.updateClearSelectionButton(),this.updateDeleteBendButton()}setInitialView(t){if(!this.enabledViews.includes(t)){console.warn(`View "${t}" is not enabled, using first enabled view`),this.switchView(this.enabledViews[0]);return}this.switchView(t)}getCurrentView(){return this.currentView}getViewContainer(){return this.viewContainer}getView(t){return this.views.get(t)}resize(){if(this.currentView){const t=this.views.get(this.currentView);t&&t.resize()}}applySharedToggleStates(t){if(t.setAlwaysShowEdges&&t.setAlwaysShowEdges(this.sharedAlwaysShowEdges),t.setLightingEnabled&&t.setLightingEnabled(this.sharedLightingEnabled),t.setTime&&this.sharedTime!==null&&t.setTime(this.sharedTime),t.getTileServerCount&&t.setTileServerIndex){const e=t.getTileServerCount();if(e>0){const i=this.sharedTileServerIndex%e;t.setTileServerIndex(i)}}}setAlwaysShowEdges(t){this.sharedAlwaysShowEdges=t;for(const e of this.views.values())e.setAlwaysShowEdges&&e.setAlwaysShowEdges(t);this.updateAlwaysShowEdgesButton()}getAlwaysShowEdges(){return this.sharedAlwaysShowEdges}setLightingEnabled(t){this.sharedLightingEnabled=t;for(const e of this.views.values())e.setLightingEnabled&&e.setLightingEnabled(t);this.updateLightingButton()}getLightingEnabled(){return this.sharedLightingEnabled}setTime(t){this.sharedTime=t;for(const e of this.views.values())e.setTime&&e.setTime(t)}getTime(){return this.sharedTime}updateCommonControlsVisibility(){const t=this.currentView==="graph",e=this.currentView==="map2d"||this.currentView==="globe3d";this.cancelEditButton&&e&&(this.cancelEditButton.style.display="none"),this.editToggleButton&&e&&(this.editToggleButton.style.display="none"),this.clearSelectionButton&&(this.clearSelectionButton.style.display=t?"flex":"none"),this.deleteBendButton&&(this.deleteBendButton.style.display=t?"flex":"none"),this.lightingToggleButton&&(this.lightingToggleButton.style.display=e?"flex":"none"),this.tileTypeButton&&(this.tileTypeButton.style.display=e?"flex":"none"),this.alwaysShowEdgesButton&&(this.alwaysShowEdgesButton.style.display=this.hasEdges?"flex":"none"),this.fitCenterButton&&(this.fitCenterButton.style.display="flex"),this.reorderButtons()}reorderButtons(){const t=this.currentView==="graph",e=this.currentView==="map2d"||this.currentView==="globe3d";if(!this.commonControlsContainer)return;const i=[];for(this.cancelEditButton&&i.push(this.cancelEditButton),this.editToggleButton&&i.push(this.editToggleButton),this.clearSelectionButton&&i.push(this.clearSelectionButton),this.deleteBendButton&&i.push(this.deleteBendButton),this.lightingToggleButton&&i.push(this.lightingToggleButton),this.tileTypeButton&&i.push(this.tileTypeButton),this.alwaysShowEdgesButton&&this.hasEdges&&i.push(this.alwaysShowEdgesButton),this.fitCenterButton&&i.push(this.fitCenterButton);this.commonControlsContainer.firstChild;)this.commonControlsContainer.removeChild(this.commonControlsContainer.firstChild);t?(this.cancelEditButton&&this.commonControlsContainer.appendChild(this.cancelEditButton),this.editToggleButton&&this.commonControlsContainer.appendChild(this.editToggleButton),this.alwaysShowEdgesButton&&this.hasEdges&&this.commonControlsContainer.appendChild(this.alwaysShowEdgesButton),this.fitCenterButton&&this.commonControlsContainer.appendChild(this.fitCenterButton)):e&&(this.lightingToggleButton&&this.commonControlsContainer.appendChild(this.lightingToggleButton),this.tileTypeButton&&this.commonControlsContainer.appendChild(this.tileTypeButton),this.alwaysShowEdgesButton&&this.hasEdges&&this.commonControlsContainer.appendChild(this.alwaysShowEdgesButton),this.fitCenterButton&&this.commonControlsContainer.appendChild(this.fitCenterButton))}updateAlwaysShowEdgesButtonVisibility(){this.alwaysShowEdgesButton&&(this.alwaysShowEdgesButton.style.display=this.hasEdges?"flex":"none",this.reorderButtons())}updateAlwaysShowEdgesButton(){if(!this.alwaysShowEdgesButton)return;if(!this.hasEdges){this.alwaysShowEdgesButton.style.display="none";return}if(!this.currentView)return;const t=this.views.get(this.currentView);if(!t)return;t.getAlwaysShowEdges?.()??this.sharedAlwaysShowEdges?(this.alwaysShowEdgesButton.setAttribute("aria-label","Hide edges"),this.alwaysShowEdgesButton.setAttribute("title","Hide edges"),this.alwaysShowEdgesButton.classList.add("relatos-always-show-edges-active"),this.alwaysShowEdgesButton.style.backgroundColor="#fff9c4",this.alwaysShowEdgesButton.style.color="#000000",this.alwaysShowEdgesButton.style.borderColor="#999",this.alwaysShowEdgesButton.style.boxShadow="inset 0 2px 4px rgba(0, 0, 0, 0.2)",this.alwaysShowEdgesButton.style.transform="translateY(1px)"):(this.alwaysShowEdgesButton.setAttribute("aria-label","Show edges"),this.alwaysShowEdgesButton.setAttribute("title","Show edges"),this.alwaysShowEdgesButton.classList.remove("relatos-always-show-edges-active"),this.alwaysShowEdgesButton.style.backgroundColor="#fff",this.alwaysShowEdgesButton.style.color="#333",this.alwaysShowEdgesButton.style.borderColor="#ccc",this.alwaysShowEdgesButton.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)",this.alwaysShowEdgesButton.style.transform="translateY(0)")}updateLightingButton(){if(!this.lightingToggleButton)return;this.sharedLightingEnabled?(this.lightingToggleButton.style.backgroundColor="#fff9c4",this.lightingToggleButton.style.boxShadow="inset 0 2px 4px rgba(0, 0, 0, 0.2)",this.lightingToggleButton.style.transform="translateY(1px)"):(this.lightingToggleButton.style.backgroundColor="#fff",this.lightingToggleButton.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)",this.lightingToggleButton.style.transform="translateY(0)")}updateTileTypeButton(){if(!this.tileTypeButton)return;let t=0;for(const e of this.views.values())if(e.getTileServerCount){const i=e.getTileServerCount();i>t&&(t=i)}if(t>=2){this.tileTypeButton.style.display="flex";const e=this.sharedTileServerIndex%t;this.tileTypeButton.setAttribute("title",`Tile server ${e+1}/${t} (click to switch)`);return}this.tileTypeButton.style.display="none",this.tileTypeButton.removeAttribute("title")}updateCancelEditButton(){if(!this.cancelEditButton)return;if(!this.currentView||this.currentView!=="graph"){this.cancelEditButton.style.display="none";return}const t=this.views.get(this.currentView);if(!t){this.cancelEditButton.style.display="none";return}const i=t.getMode?.()==="edit";this.cancelEditButton.style.display=i?"flex":"none"}updateClearSelectionButton(){if(!this.clearSelectionButton)return;if(!this.currentView||this.currentView!=="graph"){this.clearSelectionButton.style.display="none";return}const t=this.views.get(this.currentView);if(!t){this.clearSelectionButton.style.display="none";return}const i=t.getSelectedEdgeId?.();this.clearSelectionButton.style.display=i?"flex":"none"}updateDeleteBendButton(){if(!this.deleteBendButton)return;if(!this.currentView||this.currentView!=="graph"){this.deleteBendButton.style.display="none";return}const t=this.views.get(this.currentView);if(!t){this.deleteBendButton.style.display="none";return}const e=t,i=e.getSelectedEdgeId?.();if(i){const n=(e.getEdges?.()||[]).find(l=>l.id===i),o=n?.bends&&n.bends.length>0;this.deleteBendButton.style.display=o?"flex":"none"}else this.deleteBendButton.style.display="none"}updateGraphButtons(){this.updateCancelEditButton(),this.updateClearSelectionButton(),this.updateDeleteBendButton()}destroy(){for(const t of this.views.values())t.destroy();this.views.clear(),this.tabButtons.clear(),this.container.contains(this.tabContainer)&&this.container.removeChild(this.tabContainer),this.container.contains(this.viewContainer)&&this.container.removeChild(this.viewContainer)}}function F(k,t=16){return D(),`<svg width="${t}" height="${t}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <use href="#${k}"></use>
  </svg>`}class q{constructor(t,e,i,s=!1,n){this.nodes=[],this.edges=[],this.mode="view",this.editable=!1,this.nodeElements=new Map,this.edgeElements=new Map,this.selectedEdgeId=null,this.selectedNodeId=null,this.zoomedNodeId=null,this.anchorHandles=new Map,this.draggingAnchor=null,this.bendHandles=new Map,this.draggingBend=null,this.draggingNode=null,this.panning=null,this.lastPanEndTime=0,this.resizingNode=null,this.saveDebounceTimer=null,this.SAVE_DEBOUNCE_MS=500,this.resizeRenderTimer=null,this.editToggleButton=null,this.alwaysShowEdgesButton=null,this.alwaysShowEdges=!1,this.hoveredEdgePairKey=null,this.tappedEdgePairKey=null,this.snapshotBeforeEdit=null,this.edgeClickTimers=new WeakMap,this.offsetX=0,this.offsetY=0,this.zoom=1,this.pinchDistance=null,this.pinchCenter=null,this.initialZoom=1,this.popupElement=null,this.popupNodeId=null,this.DEFAULT_NODE_WIDTH=120,this.DEFAULT_NODE_HEIGHT=60,this.EDGE_DEFAULT_COLOR="#999",this.EDGE_HOVER_COLOR="#333",this.EDGE_DEFAULT_WIDTH=1.5,this.EDGE_HOVER_WIDTH=3,this.EDGE_MIN_WEIGHT=1,this.EDGE_MAX_WEIGHT=10,this.NODE_PADDING=10,this.HANDLE_RADIUS=8,this.BEND_HANDLE_RADIUS=7,this.HIT_PATH_WIDTH=32,this.controlButtonsContainer=null,this.clearSelectionButton=null,this.deleteBendButton=null,this.fitCenterButton=null,this.cancelEditButton=null,this.container=t,this.onNodeClick=e?o=>{this.popupNodeId===o.node.id&&this.popupElement&&this.popupElement.style.opacity==="1"?this.hidePopup():this.showPopup(o.node),e(o)}:void 0,this.onSave=i,this.editable=s,this.onEdgeClick=n,this.container.style.position="relative",this.container.style.width="100%",this.container.style.height="100%",this.container.style.overflow="visible",this.createAlwaysShowEdgesButton(),this.alwaysShowEdgesButton&&(this.alwaysShowEdgesButton.style.display="none",this.alwaysShowEdgesButton.parentNode&&this.alwaysShowEdgesButton.parentNode.removeChild(this.alwaysShowEdgesButton)),this.createEditToggleButton(),this.editToggleButton&&(this.editToggleButton.style.display="none",this.editToggleButton.parentNode&&this.editToggleButton.parentNode.removeChild(this.editToggleButton)),this.createControlButtons(),this.controlButtonsContainer&&(this.controlButtonsContainer.style.display="none",this.controlButtonsContainer.parentNode&&this.controlButtonsContainer.parentNode.removeChild(this.controlButtonsContainer)),this.createAttributionLabel(),this.svgWrapper=document.createElement("div"),this.svgWrapper.style.position="absolute",this.svgWrapper.style.top="0",this.svgWrapper.style.left="0",this.svgWrapper.style.width="100%",this.svgWrapper.style.height="100%",this.svgWrapper.style.transformOrigin="0 0",this.svgWrapper.style.pointerEvents="none",this.container.appendChild(this.svgWrapper),this.svg=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.svg.style.width="100%",this.svg.style.height="100%",this.svg.style.display="block",this.svg.style.pointerEvents="auto",this.svgWrapper.appendChild(this.svg),this.svgDefs=document.createElementNS("http://www.w3.org/2000/svg","defs"),this.createArrowMarkers(),this.svg.appendChild(this.svgDefs),this.edgesGroup=document.createElementNS("http://www.w3.org/2000/svg","g"),this.edgesGroup.setAttribute("class","edges"),this.svg.appendChild(this.edgesGroup),this.nodesGroup=document.createElementNS("http://www.w3.org/2000/svg","g"),this.nodesGroup.setAttribute("class","nodes"),this.svg.appendChild(this.nodesGroup),this.anchorHandlesGroup=document.createElementNS("http://www.w3.org/2000/svg","g"),this.anchorHandlesGroup.setAttribute("class","anchor-handles"),this.anchorHandlesGroup.style.display="none",this.svg.appendChild(this.anchorHandlesGroup),this.bendHandlesGroup=document.createElementNS("http://www.w3.org/2000/svg","g"),this.bendHandlesGroup.setAttribute("class","bend-handles"),this.bendHandlesGroup.style.display="none",this.svg.appendChild(this.bendHandlesGroup),this.edgeLabelsGroup=document.createElementNS("http://www.w3.org/2000/svg","g"),this.edgeLabelsGroup.setAttribute("class","edge-labels"),this.svg.appendChild(this.edgeLabelsGroup),this.updateTransform(),this.setupEventListeners()}createAlwaysShowEdgesButton(){this.alwaysShowEdgesButton=document.createElement("button"),this.alwaysShowEdgesButton.className="relatos-always-show-edges-toggle",this.alwaysShowEdgesButton.setAttribute("aria-label","Always show all edges"),this.alwaysShowEdgesButton.setAttribute("title","Always show all edges"),this.alwaysShowEdgesButton.style.padding="6px",this.alwaysShowEdgesButton.style.border="1px solid #ccc",this.alwaysShowEdgesButton.style.borderRadius="4px",this.alwaysShowEdgesButton.style.backgroundColor="#fff",this.alwaysShowEdgesButton.style.cursor="pointer",this.alwaysShowEdgesButton.style.fontSize="16px",this.alwaysShowEdgesButton.style.lineHeight="1",this.alwaysShowEdgesButton.style.width="32px",this.alwaysShowEdgesButton.style.height="32px",this.alwaysShowEdgesButton.style.display="flex",this.alwaysShowEdgesButton.style.alignItems="center",this.alwaysShowEdgesButton.style.justifyContent="center",this.alwaysShowEdgesButton.style.transition="all 0.2s",this.alwaysShowEdgesButton.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)",this.alwaysShowEdgesButton.style.pointerEvents="auto",this.alwaysShowEdgesButton.style.color="#000000",this.alwaysShowEdgesButton.innerHTML=F("icon-relations",16),this.alwaysShowEdgesButton.addEventListener("click",()=>{this.alwaysShowEdges=!this.alwaysShowEdges,this.updateAlwaysShowEdgesButton(),this.alwaysShowEdges||(this.hoveredEdgePairKey=null,this.tappedEdgePairKey=null),this.onAlwaysShowEdgesChange&&this.onAlwaysShowEdgesChange(this.alwaysShowEdges),this.render()}),this.updateAlwaysShowEdgesButton()}updateAlwaysShowEdgesButton(){this.alwaysShowEdgesButton&&(this.alwaysShowEdges?(this.alwaysShowEdgesButton.setAttribute("aria-label","Hide edge labels"),this.alwaysShowEdgesButton.setAttribute("title","Hide edge labels"),this.alwaysShowEdgesButton.classList.add("relatos-always-show-edges-active"),this.alwaysShowEdgesButton.style.backgroundColor="#fff9c4",this.alwaysShowEdgesButton.style.color="#000000",this.alwaysShowEdgesButton.style.borderColor="#999",this.alwaysShowEdgesButton.style.boxShadow="inset 0 2px 4px rgba(0, 0, 0, 0.2)",this.alwaysShowEdgesButton.style.transform="translateY(1px)"):(this.alwaysShowEdgesButton.setAttribute("aria-label","Always show all edges"),this.alwaysShowEdgesButton.setAttribute("title","Always show all edges"),this.alwaysShowEdgesButton.classList.remove("relatos-always-show-edges-active"),this.alwaysShowEdgesButton.style.backgroundColor="#fff",this.alwaysShowEdgesButton.style.color="#333",this.alwaysShowEdgesButton.style.borderColor="#ccc",this.alwaysShowEdgesButton.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)",this.alwaysShowEdgesButton.style.transform="translateY(0)"))}createEditToggleButton(){this.editToggleButton=document.createElement("button"),this.editToggleButton.className="relatos-edit-toggle",this.editToggleButton.setAttribute("aria-label","Toggle edit mode"),this.editToggleButton.setAttribute("title","Toggle edit mode"),this.editToggleButton.style.position="relative",this.editToggleButton.style.zIndex="1000",this.editToggleButton.style.padding="6px",this.editToggleButton.style.border="1px solid #ccc",this.editToggleButton.style.borderRadius="4px",this.editToggleButton.style.backgroundColor="#fff",this.editToggleButton.style.cursor="pointer",this.editToggleButton.style.fontSize="16px",this.editToggleButton.style.lineHeight="1",this.editToggleButton.style.width="28px",this.editToggleButton.style.height="28px",this.editToggleButton.style.display="flex",this.editToggleButton.style.alignItems="center",this.editToggleButton.style.justifyContent="center",this.editToggleButton.style.transition="all 0.2s",this.editToggleButton.style.boxShadow="0 1px 2px rgba(0, 0, 0, 0.1)",this.updateEditToggleButtonIcon(),this.editToggleButton.addEventListener("click",()=>{this.toggleEditMode()})}updateEditToggleButtonIcon(){this.editToggleButton&&(this.editToggleButton.innerHTML=F("icon-edit",16),this.mode==="edit"?(this.editToggleButton.setAttribute("aria-label","Exit edit mode"),this.editToggleButton.setAttribute("title","Exit edit mode"),this.editToggleButton.classList.add("relatos-edit-toggle-active"),this.editToggleButton.style.backgroundColor="#fff9c4",this.editToggleButton.style.color="red",this.editToggleButton.style.borderColor="#999",this.editToggleButton.style.boxShadow="inset 0 2px 4px rgba(0, 0, 0, 0.2)",this.editToggleButton.style.transform="translateY(1px)"):(this.editToggleButton.setAttribute("aria-label","Enter edit mode"),this.editToggleButton.setAttribute("title","Enter edit mode"),this.editToggleButton.classList.remove("relatos-edit-toggle-active"),this.editToggleButton.style.backgroundColor="#fff",this.editToggleButton.style.color="#333",this.editToggleButton.style.borderColor="#ccc",this.editToggleButton.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)",this.editToggleButton.style.transform="translateY(0)"))}toggleEditMode(){this.editable&&this.setMode(this.mode==="edit"?"view":"edit")}createControlButtons(){this.controlButtonsContainer=document.createElement("div"),this.controlButtonsContainer.style.position="absolute",this.controlButtonsContainer.style.top="8px",this.controlButtonsContainer.style.right="8px",this.controlButtonsContainer.style.display="flex",this.controlButtonsContainer.style.gap="4px",this.controlButtonsContainer.style.zIndex="1000",this.controlButtonsContainer.style.pointerEvents="none",this.clearSelectionButton=this.createIconButton("âœ•","Clear selection","Clear selection",()=>{this.deselectEdge()}),this.clearSelectionButton.style.display="none",this.deleteBendButton=this.createIconButton("ðŸ—‘","Delete bend point","Delete bend point",()=>{this.selectedEdgeId&&this.deleteNearestBendPoint()}),this.deleteBendButton.style.display="none",this.fitCenterButton=this.createIconButton(F("icon-home",16),"Fit and center","Fit and center",()=>{this.fitAndCenter()}),this.fitCenterButton.style.display="none",this.cancelEditButton=this.createIconButton(F("icon-undo",16),"Cancel edit","Cancel edit and restore previous state",()=>{this.restoreSnapshot(),this.setMode("view")}),this.cancelEditButton.style.display="none",this.controlButtonsContainer.appendChild(this.clearSelectionButton),this.controlButtonsContainer.appendChild(this.deleteBendButton),this.controlButtonsContainer.appendChild(this.fitCenterButton),this.controlButtonsContainer.appendChild(this.cancelEditButton)}createAttributionLabel(){const t=document.createElement("div");t.style.position="absolute",t.style.bottom="8px",t.style.left="8px",t.style.zIndex="1000",t.style.pointerEvents="auto",t.style.fontSize="12px",t.style.fontFamily="Arial, sans-serif",t.style.color="#333",t.style.backgroundColor="rgba(255, 255, 255, 0.8)",t.style.padding="4px 8px",t.style.borderRadius="4px",t.style.boxShadow="0 1px 3px rgba(0, 0, 0, 0.2)";const e=document.createElement("a");e.href="https://humanhistories.org/en/histoverse/",e.target="_blank",e.rel="noopener noreferrer",e.textContent="Relatos",e.style.color="#333",e.style.textDecoration="none",e.style.cursor="pointer",e.addEventListener("mouseenter",()=>{e.style.textDecoration="underline",e.style.color="#0066cc"}),e.addEventListener("mouseleave",()=>{e.style.textDecoration="none",e.style.color="#333"}),t.appendChild(e),this.container.appendChild(t)}createIconButton(t,e,i,s){const n=document.createElement("button");return n.innerHTML=t,n.setAttribute("aria-label",e),n.setAttribute("title",i),n.style.padding="6px",n.style.border="1px solid #ccc",n.style.borderRadius="4px",n.style.backgroundColor="#fff",n.style.cursor="pointer",n.style.fontSize="16px",n.style.width="32px",n.style.height="32px",n.style.display="flex",n.style.alignItems="center",n.style.justifyContent="center",n.style.pointerEvents="auto",n.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)",n.style.transition="all 0.2s",n.addEventListener("click",o=>{o.stopPropagation(),s()}),n.addEventListener("mouseenter",()=>{n.style.backgroundColor="#f5f5f5"}),n.addEventListener("mouseleave",()=>{n.style.backgroundColor="#fff"}),n}updateControlButtons(){this.onGraphButtonsUpdate&&this.onGraphButtonsUpdate()}zoomToPoint(t,e,i){const s=this.screenToSvg(e,i);this.zoom,this.zoom=t;const n=this.container.getBoundingClientRect(),o=e-n.left,l=i-n.top,a={x:o/this.zoom-this.offsetX,y:l/this.zoom-this.offsetY},c=s.x-a.x,d=s.y-a.y;this.offsetX+=c,this.offsetY+=d}screenToSvg(t,e){const i=this.container.getBoundingClientRect(),s=t-i.left,n=e-i.top,o=s/this.zoom,l=n/this.zoom;return{x:o-this.offsetX,y:l-this.offsetY}}updateTransform(){if(this.popupNodeId&&this.popupElement){const o=this.nodes.find(l=>l.id===this.popupNodeId);o&&this.updatePopupPosition(o)}const t=isFinite(this.zoom)&&this.zoom>0?this.zoom:1,e=isFinite(this.offsetX)?this.offsetX:0,i=isFinite(this.offsetY)?this.offsetY:0,s=1/t;this.svgWrapper.style.width=`${s*100}%`,this.svgWrapper.style.height=`${s*100}%`,this.svgWrapper.style.transform=`scale(${t})`;const n=`translate(${-e}, ${-i})`;this.nodesGroup.setAttribute("transform",n),this.edgesGroup.setAttribute("transform",n),this.anchorHandlesGroup.setAttribute("transform",n),this.bendHandlesGroup.setAttribute("transform",n),this.edgeLabelsGroup&&this.edgeLabelsGroup.setAttribute("transform",n)}fitAndCenter(){if(this.nodes.length===0)return;const t=this.container.getBoundingClientRect();if(t.width<=0||t.height<=0||!isFinite(t.width)||!isFinite(t.height))return;let e=1/0,i=1/0,s=-1/0,n=-1/0;for(const f of this.nodes)if(f.position){const p=f.style||{},m=p.width||this.DEFAULT_NODE_WIDTH,T=p.height||this.DEFAULT_NODE_HEIGHT;e=Math.min(e,f.position.x-m/2),i=Math.min(i,f.position.y-T/2),s=Math.max(s,f.position.x+m/2),n=Math.max(n,f.position.y+T/2)}if(e===1/0)return;const o=60;e-=o,i-=o,s+=o,n+=o;const l=(e+s)/2,a=(i+n)/2,c=s-e,d=n-i,r=this.container.getBoundingClientRect();if(r.width<=0||r.height<=0||!isFinite(c)||!isFinite(d)||c<=0||d<=0)return;const h=r.width/c,g=r.height/d;if(!isFinite(h)||!isFinite(g))return;const u=Math.min(h,g,1);this.zoom=u;const w=r.width/(2*this.zoom),y=r.height/(2*this.zoom);!isFinite(l)||!isFinite(a)||!isFinite(w)||!isFinite(y)||(this.offsetX=l-w,this.offsetY=a-y,this.svg.removeAttribute("viewBox"),this.updateTransform(),this.render())}animateFitAndCenter(){if(this.nodes.length===0)return;const t=this.container.getBoundingClientRect();if(t.width<=0||t.height<=0||!isFinite(t.width)||!isFinite(t.height))return;let e=1/0,i=1/0,s=-1/0,n=-1/0;for(const f of this.nodes)if(f.position){const p=f.style||{},m=p.width||this.DEFAULT_NODE_WIDTH,T=p.height||this.DEFAULT_NODE_HEIGHT;e=Math.min(e,f.position.x-m/2),i=Math.min(i,f.position.y-T/2),s=Math.max(s,f.position.x+m/2),n=Math.max(n,f.position.y+T/2)}if(e===1/0)return;const o=60;e-=o,i-=o,s+=o,n+=o;const l=(e+s)/2,a=(i+n)/2,c=s-e,d=n-i,r=this.container.getBoundingClientRect();if(r.width<=0||r.height<=0||!isFinite(c)||!isFinite(d)||c<=0||d<=0)return;const h=r.width/c,g=r.height/d;if(!isFinite(h)||!isFinite(g))return;const u=Math.min(h,g,1),w=r.width/2,y=r.height/2;this.animateZoomToPoint(u,w,y,l,a)}setupEventListeners(){this.svg.addEventListener("click",s=>{const n=s.target;n.closest("[data-node-id]")||n.getAttribute("data-edge-pair-key")||n.getAttribute("data-hit-edge-pair-key")||Date.now()-(this.lastPanEndTime||0)<100||this.mode==="view"&&this.hidePopup()}),this.svg.addEventListener("pointerdown",s=>{const n=s.target,o=n.closest("[data-node-id]")?.getAttribute("data-node-id"),l=n.getAttribute("data-edge-pair-key")||n.getAttribute("data-hit-edge-pair-key"),a=n.getAttribute("data-handle-type"),c=n.getAttribute("data-bend-index");if(this.mode==="edit"){const d=n.getAttribute("data-resize-side");if(d){const r=n.getAttribute("data-node-id");if(r){const h=this.nodes.find(g=>g.id===r);if(h?.position){const g=h.style||{},u=g.width||this.DEFAULT_NODE_WIDTH,w=g.height||this.DEFAULT_NODE_HEIGHT,y=this.screenToSvg(s.clientX,s.clientY);this.resizingNode={nodeId:r,side:d,startX:y.x,startY:y.y,startWidth:u,startHeight:w,startNodeX:h.position.x,startNodeY:h.position.y},s.target.setPointerCapture(s.pointerId),s.preventDefault(),s.stopPropagation();return}}}if(o){const r=this.nodes.find(h=>h.id===o);if(r?.position){const h=this.screenToSvg(s.clientX,s.clientY);this.draggingNode={nodeId:o,offsetX:h.x-r.position.x,offsetY:h.y-r.position.y},s.target.setPointerCapture(s.pointerId),s.preventDefault(),s.stopPropagation();return}}else if(c!==null){const r=n.getAttribute("data-edge-id");if(r){this.draggingBend={edgeId:r,bendIndex:parseInt(c,10)},s.preventDefault(),s.stopPropagation();return}}else if(a){const r=n.getAttribute("data-edge-id");if(r){this.draggingAnchor={edgeId:r,type:a},s.preventDefault(),s.stopPropagation();return}}else l||this.deselectEdge()}else if(o){const d=this.nodes.find(r=>r.id===o);if(d&&this.onNodeClick){const r=this.screenToSvg(s.clientX,s.clientY);this.onNodeClick({node:d,position:{x:r.x,y:r.y},originalEvent:s})}}else l||(this.deselectEdge(),this.tappedEdgePairKey&&(this.tappedEdgePairKey=null,this.render()))});let t=0,e=null;this.svg.addEventListener("pointerdown",s=>{const n=s.target,o=n.getAttribute("data-edge-pair-key")||n.getAttribute("data-hit-edge-pair-key");if(this.mode==="edit"&&o){const l=Date.now();if(l-t<300&&e===n){const c=this.groupEdgesByPair(this.edges).find(d=>d.key===o);if(c&&c.edges.length>0){this.insertBendPoint(c.edges[0].id,s),s.preventDefault(),s.stopPropagation(),t=0,e=null;return}}t=l,e=n}}),this.container.addEventListener("dblclick",s=>{if(this.mode!=="edit")return;const n=s.target;if(!n||!this.container.contains(n))return;const o=n.getAttribute("data-hit-edge-pair-key")||n.getAttribute("data-edge-pair-key");if(o){const a=this.groupEdgesByPair(this.edges).find(c=>c.key===o);if(a&&a.edges.length>0){this.insertBendPoint(a.edges[0].id,s),s.preventDefault(),s.stopPropagation();return}}let l=n;for(;l&&l!==this.svg;){const a=l.getAttribute("data-hit-edge-pair-key")||l.getAttribute("data-edge-pair-key");if(a){const c=this.groupEdgesByPair(this.edges).find(d=>d.key===a);if(c&&c.edges.length>0){this.insertBendPoint(c.edges[0].id,s),s.preventDefault(),s.stopPropagation();return}}l=l.parentElement}},!0);const i=new Map;this.svg.addEventListener("pointerdown",s=>{if(s.pointerType==="touch"&&(i.set(s.pointerId,s),i.size===2)){const n=Array.from(i.values()),[o,l]=n;this.pinchDistance=Math.hypot(l.clientX-o.clientX,l.clientY-o.clientY),this.pinchCenter={x:(o.clientX+l.clientX)/2,y:(o.clientY+l.clientY)/2},this.initialZoom=this.zoom,s.preventDefault()}}),this.svg.addEventListener("pointermove",s=>{if(s.pointerType==="touch"&&i.set(s.pointerId,s),this.pinchDistance!==null&&this.pinchCenter!==null&&i.size===2){const c=Array.from(i.values()),[d,r]=c,g=Math.hypot(r.clientX-d.clientX,r.clientY-d.clientY)/this.pinchDistance,u=Math.pow(g,1.5),w=Math.max(.1,Math.min(5,this.initialZoom*u));this.zoomToPoint(w,this.pinchCenter.x,this.pinchCenter.y),this.updateTransform(),this.render(),s.preventDefault();return}const n=s.target,o=n instanceof HTMLButtonElement||n.closest("button")!==null||n.closest(".relatos-always-show-edges-toggle")!==null||n.closest(".relatos-edit-toggle")!==null||n.closest(".relatos-control-buttons")!==null,l=s.pointerType==="touch"&&i.size===1,a=s.pointerType==="mouse"&&s.buttons===1;if(!o&&!this.resizingNode&&!this.draggingNode&&!this.draggingAnchor&&!this.draggingBend&&(l||a)){if(!this.panning)this.panning={startX:s.clientX,startY:s.clientY,startOffsetX:this.offsetX,startOffsetY:this.offsetY};else{const c=s.clientX-this.panning.startX,d=s.clientY-this.panning.startY,r=c/this.zoom,h=d/this.zoom;this.offsetX=this.panning.startOffsetX+r,this.offsetY=this.panning.startOffsetY+h,this.updateTransform(),this.render()}s.preventDefault();return}this.resizingNode?this.updateNodeSize(s):this.draggingNode?this.updateNodePosition(s):this.draggingAnchor?this.updateAnchorPosition(s):this.draggingBend&&this.updateBendPosition(s)}),document.addEventListener("pointermove",s=>{s.pointerType==="touch"&&i.set(s.pointerId,s);const n=s.target;if(!(n instanceof HTMLButtonElement||n.closest("button")!==null||n.closest(".relatos-always-show-edges-toggle")!==null||n.closest(".relatos-edit-toggle")!==null||n.closest(".relatos-control-buttons")!==null)&&this.panning&&!this.resizingNode&&!this.draggingNode&&!this.draggingAnchor&&!this.draggingBend){const l=s.pointerType==="touch"&&i.size===1,a=s.pointerType==="mouse"&&(s.buttons===1||s.button===0);if(l||a){const c=s.clientX-this.panning.startX,d=s.clientY-this.panning.startY,r=c/this.zoom,h=d/this.zoom;this.offsetX=this.panning.startOffsetX-r,this.offsetY=this.panning.startOffsetY-h,this.updateTransform(),this.render(),s.preventDefault();return}}this.resizingNode?this.updateNodeSize(s):this.draggingNode?this.updateNodePosition(s):this.draggingAnchor?this.updateAnchorPosition(s):this.draggingBend&&this.updateBendPosition(s)}),this.svg.addEventListener("pointerup",s=>{s.pointerType==="touch"&&(i.delete(s.pointerId),i.size<2&&(this.pinchDistance=null,this.pinchCenter=null)),s.target instanceof SVGElement&&s.target.releasePointerCapture(s.pointerId),this.resizingNode&&this.handleResizeEnd(),this.panning&&(this.lastPanEndTime=Date.now()),this.panning=null,this.resizingNode=null,this.draggingNode=null,this.draggingAnchor=null,this.draggingBend=null}),document.addEventListener("pointerup",s=>{s.pointerType==="touch"&&(i.delete(s.pointerId),i.size<2&&(this.pinchDistance=null,this.pinchCenter=null)),this.resizingNode&&this.handleResizeEnd(),this.panning&&(this.lastPanEndTime=Date.now()),this.panning=null,this.resizingNode=null,this.draggingNode=null,this.draggingAnchor=null,this.draggingBend=null}),this.svg.addEventListener("pointercancel",s=>{s.pointerType==="touch"&&(i.delete(s.pointerId),i.size<2&&(this.pinchDistance=null,this.pinchCenter=null)),s.target instanceof SVGElement&&s.target.releasePointerCapture(s.pointerId),this.resizingNode&&this.handleResizeEnd(),this.panning&&(this.lastPanEndTime=Date.now()),this.panning=null,this.resizingNode=null,this.draggingNode=null,this.draggingAnchor=null,this.draggingBend=null}),this.container.addEventListener("keydown",s=>{this.mode!=="edit"||!this.selectedEdgeId||(s.key==="Delete"||s.key==="Backspace")&&(this.deleteNearestBendPoint(),s.preventDefault())}),this.container.setAttribute("tabindex","0"),this.container.addEventListener("wheel",s=>{if(s.ctrlKey||s.metaKey){s.preventDefault();const n=Math.pow(1.5,-s.deltaY/60),o=Math.max(.1,Math.min(5,this.zoom*n));this.zoomToPoint(o,s.clientX,s.clientY),this.updateTransform(),this.render()}else{s.preventDefault();const n=Math.pow(1.5,s.deltaY/60),o=Math.max(.1,Math.min(5,this.zoom*n));this.zoomToPoint(o,s.clientX,s.clientY),this.updateTransform(),this.render()}},{passive:!1})}createArrowMarkers(){const t=document.createElementNS("http://www.w3.org/2000/svg","marker");t.setAttribute("id","arrow-end"),t.setAttribute("viewBox","0 0 10 10"),t.setAttribute("refX","9"),t.setAttribute("refY","5"),t.setAttribute("markerWidth","6"),t.setAttribute("markerHeight","6"),t.setAttribute("orient","auto");const e=document.createElementNS("http://www.w3.org/2000/svg","path");e.setAttribute("d","M 0 0 L 10 5 L 0 10 z"),e.setAttribute("fill","#333"),t.appendChild(e),this.svgDefs.appendChild(t);const i=document.createElementNS("http://www.w3.org/2000/svg","marker");i.setAttribute("id","arrow-start"),i.setAttribute("viewBox","0 0 10 10"),i.setAttribute("refX","1"),i.setAttribute("refY","5"),i.setAttribute("markerWidth","6"),i.setAttribute("markerHeight","6"),i.setAttribute("orient","auto");const s=document.createElementNS("http://www.w3.org/2000/svg","path");s.setAttribute("d","M 10 0 L 0 5 L 10 10 z"),s.setAttribute("fill","#333"),i.appendChild(s),this.svgDefs.appendChild(i)}setData(t,e){this.nodes=t,this.edges=e,this.ensureNodePositions(),this.render(),this.container.style.display!=="none"&&this.container.offsetParent!==null&&setTimeout(()=>{const i=this.container.getBoundingClientRect();i.width>0&&i.height>0&&this.fitAndCenter()},100)}selectNode(t,e=!0){if(t&&e&&this.zoomedNodeId===t){this.zoomedNodeId=null,this.selectedNodeId=t,this.render(),this.animateFitAndCenter();return}if(this.selectedNodeId=t,t?this.zoomedNodeId=t:this.zoomedNodeId=null,this.render(),t&&e){this.zoomToNode(t);const i=this.nodes.find(s=>s.id===t);i&&this.showPopup(i)}else t||(this.zoomedNodeId=null,this.hidePopup())}zoomToNode(t){const e=this.nodes.find(p=>p.id===t);if(!e||!e.position)return;const i=this.container.getBoundingClientRect();if(i.width<=0||i.height<=0)return;const s=e.style||{},n=s.width||this.DEFAULT_NODE_WIDTH,o=s.height||this.DEFAULT_NODE_HEIGHT,l=e.position.x+n/2,a=e.position.y+o/2;n*this.zoom,o*this.zoom;const c=Math.min(i.width*.3,i.height*.3),d=c/n,r=c/o,h=Math.min(d,r),w=Math.max(.5,Math.min(3,h)),y=i.width/2,f=i.height/2;console.log("[Graph Debug] Zoom to node:",{nodeId:t,nodePosition:{x:e.position.x,y:e.position.y,width:n,height:o},nodeCenter:{svgX:l,svgY:a},currentZoom:this.zoom,targetZoom:w,currentOffset:{x:this.offsetX,y:this.offsetY},containerSize:{width:i.width,height:i.height},containerCenter:{screenX:y,screenY:f}}),this.animateZoomToPoint(w,y,f,l,a)}animateZoomToPoint(t,e,i,s,n){const o=this.zoom,l=this.offsetX,a=this.offsetY,c=this.container.getBoundingClientRect(),d=c.width/(2*t),r=c.height/(2*t),h=s-d,g=n-r,u=500,w=performance.now(),y=f=>{const p=f-w,m=Math.min(p/u,1),T=1-Math.pow(1-m,3),b=o+(t-o)*T,B=l+(h-l)*T,C=a+(g-a)*T;if(this.zoom=b,this.offsetX=B,this.offsetY=C,this.updateTransform(),this.render(),m>=1){const E=this.container.getBoundingClientRect(),x=E.width/2,S=E.height/2,A=x/this.zoom-this.offsetX,v=S/this.zoom-this.offsetY;console.log("[Graph Debug] Zoom completed:",{finalZoom:this.zoom,finalOffset:{x:this.offsetX,y:this.offsetY},screenCenterToSvg:{svgX:A,svgY:v},targetNode:{svgX:s,svgY:n},nodePositionInSvg:{x:s,y:n}})}m<1&&requestAnimationFrame(y)};requestAnimationFrame(y)}ensureNodePositions(){const t=this.nodes.filter(y=>y.coordinates&&y.coordinates.length===2),e=this.nodes.filter(y=>!y.coordinates||y.coordinates.length!==2);if(this.nodes.filter(y=>!y.position).length===0&&t.length===0&&e.length===0)return;const s=this.container.getBoundingClientRect(),n=s.width||1e3,o=s.height||600,l=2,a=n*l*.25,c=n*l*.75,d=o*l,r=a,h=o*l,g=0,u=[];for(const y of this.nodes)if(y.position){const f=y.style||{},p=f.width||this.DEFAULT_NODE_WIDTH,m=f.height||this.DEFAULT_NODE_HEIGHT;if(u.push({x:y.position.x-p/2,y:y.position.y-m/2,width:p,height:m}),y.coordinates&&y.coordinates.length===2){const[T,b]=y.coordinates}}if(t.length>0){const y=t.map(v=>v.coordinates[0]),f=t.map(v=>v.coordinates[1]),p=Math.min(...y),m=Math.max(...y),T=Math.min(...f),b=Math.max(...f),B=m-p,C=b-T,E=Math.max(B,C)*.1||.01,x={minLat:p-E,maxLat:m+E,minLon:T-E,maxLon:b+E},S=new Map,A=new Map;for(const v of t){const[L,I]=v.coordinates,N=(I-x.minLon)/(x.maxLon-x.minLon),M=1-(L-x.minLat)/(x.maxLat-x.minLat),O={x:r+N*c,y:M*d},P=v.style||{},z=P.width||this.DEFAULT_NODE_WIDTH,G=P.height||this.DEFAULT_NODE_HEIGHT,X=O.x,$=O.y;S.set(v.id,{originalCenterX:X,originalCenterY:$}),A.set(v.id,{node:v,width:z,height:G,originalCenterX:X,originalCenterY:$})}this.resolveNodePositionsWithOrderConstraints(A,S)}const w=e.filter(y=>!y.position);if(w.length>0){const f=Math.ceil(Math.sqrt(w.length)),p=Math.ceil(w.length/f),m=a-40,T=h-40,b=m/f,B=T/p;w.forEach((C,E)=>{const x=C.style||{},S=x.width||this.DEFAULT_NODE_WIDTH,A=x.height||this.DEFAULT_NODE_HEIGHT,v=Math.floor(E/f),L=E%f,I=g+20+(L+.5)*b,N=20+(v+.5)*B;C.position={x:I,y:N},u.push({x:I-S/2,y:N-A/2,width:S,height:A})})}}resolveNodePositionsWithOrderConstraints(t,e){const n=new Map,o=new Map;for(const[c,d]of t){const r=d.node;if(r.position){const h=r.position.x,g=r.position.y;n.set(c,{centerX:h,centerY:g}),o.set(c,{x:r.position.x-d.width/2,y:r.position.y-d.height/2,width:d.width,height:d.height})}else{const h=e.get(c);n.set(c,{centerX:h.originalCenterX,centerY:h.originalCenterY}),o.set(c,{x:h.originalCenterX-d.width/2,y:h.originalCenterY-d.height/2,width:d.width,height:d.height})}}const l=Array.from(t.entries()).sort((c,d)=>{const r=e.get(c[0]),h=e.get(d[0]);return r.originalCenterX-h.originalCenterX}),a=Array.from(t.entries()).sort((c,d)=>{const r=e.get(c[0]),h=e.get(d[0]);return r.originalCenterY-h.originalCenterY});for(let c=0;c<50;c++){let d=!1;for(let r=0;r<l.length;r++){const[h]=l[r],g=o.get(h),u=n.get(h);for(let w=0;w<r;w++){const[y]=l[w],f=o.get(y);if(g.x<f.x+f.width+20&&g.x+g.width+20>f.x){d=!0;const p=f.width/2+g.width/2+20,T=n.get(y).centerX+p;u.centerX=T,g.x=T-g.width/2}}}for(let r=0;r<a.length;r++){const[h]=a[r],g=o.get(h),u=n.get(h);for(let w=0;w<r;w++){const[y]=a[w],f=o.get(y);if(g.y<f.y+f.height+20&&g.y+g.height+20>f.y){d=!0;const p=f.height/2+g.height/2+20,T=n.get(y).centerY+p;u.centerY=T,g.y=T-g.height/2}}}if(!d)break}for(const[c,d]of t)if(!d.node.position){const r=o.get(c);d.node.position={x:r.x+r.width/2,y:r.y+r.height/2}}}adjustNodePosition(t,e,i,s,n=20){let l=t.x,a=t.y;const c=t.width,d=t.height,r=i?.originalX??t.x,h=i?.originalY??t.y,g=e.map((u,w)=>{const y=u.width||this.DEFAULT_NODE_WIDTH,f=u.height||this.DEFAULT_NODE_HEIGHT,p=u.x+y/2,m=u.y+f/2,T=p-r,b=m-h;return{x:u.x,y:u.y,width:y,height:f,centerX:p,centerY:m,relativeDx:T,relativeDy:b,originalCenterX:p,originalCenterY:m}});for(let u=0;u<n;u++){let w=!1,y=l,f=a,p=1/0;for(const m of g)if(l<m.x+m.width+20&&l+c+20>m.x&&a<m.y+m.height+20&&a+d+20>m.y){w=!0;const T=l+c/2,b=a+d/2,B=m.centerX-T,C=m.centerY-b,E=Math.sqrt(B*B+C*C);if(E>0){const x=(c+m.width)/2+20;let S=B,A=C;if(Math.abs(m.relativeDx)>.1||Math.abs(m.relativeDy)>.1)if(Math.abs(m.relativeDx)>Math.abs(m.relativeDy))S=(m.relativeDx>0?-1:1)*Math.abs(B)/E*x,A=C/E*x*.5;else{const X=m.relativeDy>0?-1:1;S=B/E*x*.5,A=X*Math.abs(C)/E*x}else S=B/E*x,A=C/E*x;const v=l+S,L=a+A,I=Math.sqrt(Math.pow(v-r,2)+Math.pow(L-h,2)),N=v+c/2,M=L+d/2,O=N-r,P=M-h;let z=0;(m.relativeDx>0&&O<m.relativeDx||m.relativeDx<0&&O>m.relativeDx)&&(z+=1e3),(m.relativeDy>0&&P<m.relativeDy||m.relativeDy<0&&P>m.relativeDy)&&(z+=1e3);const G=I+z;G<p&&(p=G,y=v,f=L)}else{const x=(c+m.width)/2+20;let S=0,A=0;if(m.relativeDx!==0||m.relativeDy!==0){const N=m.relativeDx>0?-1:1,M=m.relativeDy>0?-1:1;S=N*x,A=M*x}else{const N=Math.random()*Math.PI*2;S=Math.cos(N)*x,A=Math.sin(N)*x}const v=l+S,L=a+A,I=Math.sqrt(Math.pow(v-r,2)+Math.pow(L-h,2));I<p&&(p=I,y=v,f=L)}}if(!w)break;l=y,a=f}return{x:l,y:a}}groupEdgesByPair(t){const e=new Map;for(const i of t){const[s,n]=i.src<i.dst?[i.src,i.dst]:[i.dst,i.src],o=`${s}||${n}`;let l=e.get(o);l||(l={key:o,a:s,b:n,edges:[]},e.set(o,l)),l.edges.push(i),i.src===s&&i.dst===n?(i.srcAnchor&&!l.srcAnchor&&(l.srcAnchor=i.srcAnchor),i.dstAnchor&&!l.dstAnchor&&(l.dstAnchor=i.dstAnchor),i.bends&&!l.bends&&(l.bends=i.bends)):(i.srcAnchor&&!l.dstAnchor&&(l.dstAnchor=i.srcAnchor),i.dstAnchor&&!l.srcAnchor&&(l.srcAnchor=i.dstAnchor),i.bends&&!l.bends&&(l.bends=i.bends))}return Array.from(e.values())}getEdgePairDirection(t){let e=!1,i=!1;for(const s of t.edges)s.src===t.a&&s.dst===t.b?e=!0:s.src===t.b&&s.dst===t.a&&(i=!0);return{hasAtoB:e,hasBtoA:i}}calculateEdgePairPath(t){const e=this.nodes.find(y=>y.id===t.a),i=this.nodes.find(y=>y.id===t.b);if(!e?.position||!i?.position)return"";const s=t.srcAnchor||this.estimateAnchor(e,i),n=t.dstAnchor||this.estimateAnchor(i,e),o=e.style||{},l=i.style||{},a=o.width||this.DEFAULT_NODE_WIDTH,c=o.height||this.DEFAULT_NODE_HEIGHT,d=l.width||this.DEFAULT_NODE_WIDTH,r=l.height||this.DEFAULT_NODE_HEIGHT,h=this.calculateAnchorPosition(e,s,a,c),g=this.calculateAnchorPosition(i,n,d,r),u=[h];t.bends&&u.push(...t.bends),u.push(g);const w=[`M ${u[0].x} ${u[0].y}`];for(let y=1;y<u.length;y++)w.push(`L ${u[y].x} ${u[y].y}`);return w.join(" ")}calculateAnchorPosition(t,e,i,s){if(!t.position)return{x:0,y:0};const n=t.position.x,o=t.position.y,l=i||t.style?.width||this.DEFAULT_NODE_WIDTH,a=s||t.style?.height||this.DEFAULT_NODE_HEIGHT;let c=0,d=0;switch(e.side){case"top":c=n-l/2+l*e.t,d=o-a/2;break;case"right":c=n+l/2,d=o-a/2+a*e.t;break;case"bottom":c=n-l/2+l*e.t,d=o+a/2;break;case"left":c=n-l/2,d=o-a/2+a*e.t;break}return{x:c,y:d}}estimateAnchor(t,e){if(!t.position||!e.position)return{side:"right",t:.5};const i=t.style||{},s=i.width||this.DEFAULT_NODE_WIDTH,n=i.height||this.DEFAULT_NODE_HEIGHT,o=e.position.x-t.position.x,l=e.position.y-t.position.y,a=Math.atan2(l,o),c=a<0?a+2*Math.PI:a;let d,r;return c>=7*Math.PI/4||c<Math.PI/4?(d="right",r=.5+l/n*.5):c>=Math.PI/4&&c<3*Math.PI/4?(d="bottom",r=.5+o/s*.5):c>=3*Math.PI/4&&c<5*Math.PI/4?(d="left",r=.5-l/n*.5):(d="top",r=.5-o/s*.5),r=Math.max(0,Math.min(1,r)),{side:d,t:r}}getEdgePoints(t){const e=this.nodes.find(w=>w.id===t.src),i=this.nodes.find(w=>w.id===t.dst);if(!e?.position||!i?.position)return[];const s=t.srcAnchor||this.estimateAnchor(e,i),n=t.dstAnchor||this.estimateAnchor(i,e),o=e.style||{},l=i.style||{},a=o.width||this.DEFAULT_NODE_WIDTH,c=o.height||this.DEFAULT_NODE_HEIGHT,d=l.width||this.DEFAULT_NODE_WIDTH,r=l.height||this.DEFAULT_NODE_HEIGHT,h=this.calculateAnchorPosition(e,s,a,c),g=this.calculateAnchorPosition(i,n,d,r),u=[h];return t.bends&&u.push(...t.bends),u.push(g),u}calculateEdgePath(t){const e=this.getEdgePoints(t);if(e.length<2)return"";const i=[`M ${e[0].x} ${e[0].y}`];for(let s=1;s<e.length;s++)i.push(`L ${e[s].x} ${e[s].y}`);return i.join(" ")}getEdgePairMarkerAttributes(t){const{hasAtoB:e,hasBtoA:i}=this.getEdgePairDirection(t),s={};return e&&(s.markerEnd="url(#arrow-end)"),i&&(s.markerStart="url(#arrow-start)"),s}deselectEdge(){this.selectedEdgeId=null,this.anchorHandlesGroup.style.display="none",this.bendHandlesGroup.style.display="none",this.anchorHandles.clear(),this.bendHandles.clear()}selectEdge(t,e){this.selectedEdgeId===t&&e?this.rotateAnchorSide(t):(this.selectedEdgeId=t,this.updateAnchorHandles(),this.updateBendHandles())}rotateAnchorSide(t){const e=this.edges.find(c=>c.id===t);if(!e)return;const[i,s]=e.src<e.dst?[e.src,e.dst]:[e.dst,e.src],n=`${i}||${s}`,o=this.groupEdgesByPair(this.edges).find(c=>c.key===n);if(!o)return;const l=["top","right","bottom","left"],a=c=>{const d=l.indexOf(c);return l[(d+1)%4]};o.srcAnchor&&(o.srcAnchor.side=a(o.srcAnchor.side)),o.dstAnchor&&(o.dstAnchor.side=a(o.dstAnchor.side));for(const c of o.edges)c.src===o.a&&c.dst===o.b?(c.srcAnchor=o.srcAnchor,c.dstAnchor=o.dstAnchor):(c.srcAnchor=o.dstAnchor,c.dstAnchor=o.srcAnchor);this.render(),this.updateAnchorHandles(),this.updateBendHandles()}updateAnchorHandles(){if(this.anchorHandles.clear(),this.anchorHandlesGroup.innerHTML="",!this.selectedEdgeId||this.mode!=="edit"){this.anchorHandlesGroup.style.display="none";return}const t=this.edges.find(p=>p.id===this.selectedEdgeId);if(!t)return;const[e,i]=t.src<t.dst?[t.src,t.dst]:[t.dst,t.src],s=`${e}||${i}`,n=this.groupEdgesByPair(this.edges).find(p=>p.key===s);if(!n)return;const o=this.nodes.find(p=>p.id===n.a),l=this.nodes.find(p=>p.id===n.b);if(!o||!l)return;const a=n.srcAnchor||this.estimateAnchor(o,l),c=n.dstAnchor||this.estimateAnchor(l,o),d=o.style||{},r=l.style||{},h=d.width||this.DEFAULT_NODE_WIDTH,g=d.height||this.DEFAULT_NODE_HEIGHT,u=r.width||this.DEFAULT_NODE_WIDTH,w=r.height||this.DEFAULT_NODE_HEIGHT,y=this.calculateAnchorPosition(o,a,h,g),f=this.calculateAnchorPosition(l,c,u,w);this.createAnchorHandle(t.id,"src",y.x,y.y),this.createAnchorHandle(t.id,"dst",f.x,f.y),this.anchorHandlesGroup.style.display="block",this.anchorHandlesGroup.style.pointerEvents="auto"}updateBendHandles(){if(this.bendHandles.clear(),this.bendHandlesGroup.innerHTML="",!this.selectedEdgeId||this.mode!=="edit"){this.bendHandlesGroup.style.display="none";return}const t=this.edges.find(o=>o.id===this.selectedEdgeId);if(!t)return;const[e,i]=t.src<t.dst?[t.src,t.dst]:[t.dst,t.src],s=`${e}||${i}`,n=this.groupEdgesByPair(this.edges).find(o=>o.key===s);if(!n||!n.bends||n.bends.length===0){this.bendHandlesGroup.style.display="none";return}n.bends.forEach((o,l)=>{this.createBendHandle(t.id,l,o.x,o.y)}),this.bendHandlesGroup.style.display="block",this.bendHandlesGroup.style.pointerEvents="auto"}createAnchorHandle(t,e,i,s){const n=document.createElementNS("http://www.w3.org/2000/svg","circle");n.setAttribute("cx",String(i)),n.setAttribute("cy",String(s)),n.setAttribute("r",String(this.HANDLE_RADIUS)),n.setAttribute("fill","#2196f3"),n.setAttribute("stroke","#fff"),n.setAttribute("stroke-width","2"),n.setAttribute("data-edge-id",t),n.setAttribute("data-handle-type",e),n.style.cursor="move",this.anchorHandles.set(e,n),this.anchorHandlesGroup.appendChild(n)}createBendHandle(t,e,i,s){const n=document.createElementNS("http://www.w3.org/2000/svg","circle");n.setAttribute("cx",String(i)),n.setAttribute("cy",String(s)),n.setAttribute("r",String(this.BEND_HANDLE_RADIUS)),n.setAttribute("fill","#ff9800"),n.setAttribute("stroke","#fff"),n.setAttribute("stroke-width","2"),n.setAttribute("data-edge-id",t),n.setAttribute("data-bend-index",String(e)),n.style.cursor="move",this.bendHandles.set(e,n),this.bendHandlesGroup.appendChild(n)}updateNodePosition(t){if(!this.draggingNode)return;const e=this.nodes.find(o=>o.id===this.draggingNode.nodeId);if(!e)return;const i=this.screenToSvg(t.clientX,t.clientY),s=i.x,n=i.y;e.position||(e.position={x:0,y:0}),e.position.x=s-this.draggingNode.offsetX,e.position.y=n-this.draggingNode.offsetY,this.render(),this.updateAnchorHandles(),this.updateBendHandles(),this.debouncedSave()}updateNodeSize(t){if(!this.resizingNode)return;const e=this.nodes.find(c=>c.id===this.resizingNode.nodeId);if(!e?.position)return;const i=this.screenToSvg(t.clientX,t.clientY),s=i.x,n=i.y;e.style||(e.style={});const o=s-this.resizingNode.startX,l=n-this.resizingNode.startY;switch(this.resizingNode.side){case"right":{const c=Math.max(60,this.resizingNode.startWidth+o);e.style.width=c,e.position.x=this.resizingNode.startNodeX+o/2;break}case"left":{const c=Math.max(60,this.resizingNode.startWidth-o);e.style.width=c,e.position.x=this.resizingNode.startNodeX+o/2;break}case"bottom":{const c=Math.max(40,this.resizingNode.startHeight+l);e.style.height=c,e.position.y=this.resizingNode.startNodeY+l/2;break}case"top":{const c=Math.max(40,this.resizingNode.startHeight-l);e.style.height=c,e.position.y=this.resizingNode.startNodeY+l/2;break}}const a=this.nodeElements.get(e.id);if(a){const c=e.style||{},d=c.width||this.DEFAULT_NODE_WIDTH,r=c.height||this.DEFAULT_NODE_HEIGHT,h=e.position.x-d/2,g=e.position.y-r/2;a.setAttribute("x",String(h)),a.setAttribute("y",String(g)),a.setAttribute("width",String(d)),a.setAttribute("height",String(r));const u=a.parentElement;if(u){const w=u.querySelector("foreignObject");if(w){const y=e.style||{},f=y.width||this.DEFAULT_NODE_WIDTH,p=y.height||this.DEFAULT_NODE_HEIGHT,m=e.position.x-f/2,T=e.position.y-p/2;w.setAttribute("x",String(m)),w.setAttribute("y",String(T))}e.position&&u.querySelectorAll("[data-resize-side]").forEach(f=>{const p=f.getAttribute("data-resize-side");p==="top"?(f.setAttribute("cx",String(e.position.x)),f.setAttribute("cy",String(e.position.y-r/2))):p==="right"?(f.setAttribute("cx",String(e.position.x+d/2)),f.setAttribute("cy",String(e.position.y))):p==="bottom"?(f.setAttribute("cx",String(e.position.x)),f.setAttribute("cy",String(e.position.y+r/2))):p==="left"&&(f.setAttribute("cx",String(e.position.x-d/2)),f.setAttribute("cy",String(e.position.y)))})}}}handleResizeEnd(){this.resizeRenderTimer&&(clearTimeout(this.resizeRenderTimer),this.resizeRenderTimer=null),this.render(),this.debouncedSave()}saveSnapshot(){this.snapshotBeforeEdit={nodes:this.nodes.map(t=>({...t,position:t.position?{...t.position}:void 0,style:t.style?{...t.style}:void 0,meta:t.meta?{...t.meta}:void 0})),edges:this.edges.map(t=>({...t,srcAnchor:t.srcAnchor?{...t.srcAnchor}:void 0,dstAnchor:t.dstAnchor?{...t.dstAnchor}:void 0,bends:t.bends?t.bends.map(e=>({...e})):void 0,style:t.style?{...t.style}:void 0,meta:t.meta?{...t.meta}:void 0}))}}restoreSnapshot(){this.snapshotBeforeEdit&&(this.nodes=this.snapshotBeforeEdit.nodes.map(t=>({...t,position:t.position?{...t.position}:void 0,style:t.style?{...t.style}:void 0,meta:t.meta?{...t.meta}:void 0})),this.edges=this.snapshotBeforeEdit.edges.map(t=>({...t,srcAnchor:t.srcAnchor?{...t.srcAnchor}:void 0,dstAnchor:t.dstAnchor?{...t.dstAnchor}:void 0,bends:t.bends?t.bends.map(e=>({...e})):void 0,style:t.style?{...t.style}:void 0,meta:t.meta?{...t.meta}:void 0})),this.render(),this.deselectEdge())}updateAnchorPosition(t){if(!this.draggingAnchor)return;const e=this.edges.find(b=>b.id===this.draggingAnchor.edgeId);if(!e)return;const[i,s]=e.src<e.dst?[e.src,e.dst]:[e.dst,e.src],n=`${i}||${s}`,o=this.groupEdgesByPair(this.edges).find(b=>b.key===n);if(!o)return;const l=this.draggingAnchor.type==="src"?o.a:o.b,a=this.nodes.find(b=>b.id===l);if(!a?.position)return;const c=this.screenToSvg(t.clientX,t.clientY),d=c.x,r=c.y,h=a.position.x,g=a.position.y,u=a.style||{},w=u.width||this.DEFAULT_NODE_WIDTH,y=u.height||this.DEFAULT_NODE_HEIGHT,f={top:Math.abs(r-(g-y/2)),right:Math.abs(d-(h+w/2)),bottom:Math.abs(r-(g+y/2)),left:Math.abs(d-(h-w/2))};let p="right",m=f.right;for(const[b,B]of Object.entries(f))B<m&&(m=B,p=b);let T=.5;switch(p){case"top":case"bottom":T=(d-(h-w/2))/w;break;case"left":case"right":T=(r-(g-y/2))/y;break}T=Math.max(0,Math.min(1,T)),this.draggingAnchor.type==="src"?o.srcAnchor={side:p,t:T}:o.dstAnchor={side:p,t:T};for(const b of o.edges)b.src===o.a&&b.dst===o.b?(b.srcAnchor=o.srcAnchor,b.dstAnchor=o.dstAnchor):(b.srcAnchor=o.dstAnchor,b.dstAnchor=o.srcAnchor);this.render(),this.updateAnchorHandles(),this.updateBendHandles(),this.debouncedSave()}updateBendPosition(t){if(!this.draggingBend)return;const e=this.edges.find(r=>r.id===this.draggingBend.edgeId);if(!e)return;const[i,s]=e.src<e.dst?[e.src,e.dst]:[e.dst,e.src],n=`${i}||${s}`,o=this.groupEdgesByPair(this.edges).find(r=>r.key===n);if(!o||!o.bends)return;const l=this.draggingBend.bendIndex;if(l<0||l>=o.bends.length)return;const a=this.screenToSvg(t.clientX,t.clientY),c=a.x,d=a.y;o.bends[l]={x:c,y:d};for(const r of o.edges)r.bends=[...o.bends];this.render(),this.updateBendHandles(),this.debouncedSave()}insertBendPoint(t,e){const i=this.edges.find(L=>L.id===t);if(!i)return;const[s,n]=i.src<i.dst?[i.src,i.dst]:[i.dst,i.src],o=`${s}||${n}`,l=this.groupEdgesByPair(this.edges).find(L=>L.key===o);if(!l)return;const a=this.svg.getBoundingClientRect(),c=e.clientX-a.left,d=e.clientY-a.top,r=[],h=this.nodes.find(L=>L.id===l.a),g=this.nodes.find(L=>L.id===l.b);if(!h?.position||!g?.position)return;const u=l.srcAnchor||this.estimateAnchor(h,g),w=l.dstAnchor||this.estimateAnchor(g,h),y=h.style||{},f=g.style||{},p=y.width||this.DEFAULT_NODE_WIDTH,m=y.height||this.DEFAULT_NODE_HEIGHT,T=f.width||this.DEFAULT_NODE_WIDTH,b=f.height||this.DEFAULT_NODE_HEIGHT,B=this.calculateAnchorPosition(h,u,p,m),C=this.calculateAnchorPosition(g,w,T,b);r.push(B),l.bends&&r.push(...l.bends),r.push(C);let E=0,x=1/0;for(let L=0;L<r.length-1;L++){const I=r[L],N=r[L+1],M=this.pointToLineSegmentDistance(c,d,I.x,I.y,N.x,N.y);M<x&&(x=M,E=L)}const S=r[E],A=r[E+1],v={x:(S.x+A.x)/2,y:(S.y+A.y)/2};l.bends||(l.bends=[]),l.bends.splice(E,0,v);for(const L of l.edges)L.bends=[...l.bends];this.render(),this.updateBendHandles(),this.debouncedSave()}pointToLineSegmentDistance(t,e,i,s,n,o){const l=n-i,a=o-s,c=l*l+a*a;if(c===0)return Math.sqrt((t-i)**2+(e-s)**2);const d=Math.max(0,Math.min(1,((t-i)*l+(e-s)*a)/c)),r=i+d*l,h=s+d*a;return Math.sqrt((t-r)**2+(e-h)**2)}deleteNearestBendPoint(){if(!this.selectedEdgeId)return;const t=this.edges.find(o=>o.id===this.selectedEdgeId);if(!t)return;const[e,i]=t.src<t.dst?[t.src,t.dst]:[t.dst,t.src],s=`${e}||${i}`,n=this.groupEdgesByPair(this.edges).find(o=>o.key===s);if(!(!n||!n.bends||n.bends.length===0)){n.bends.pop(),n.bends.length===0&&delete n.bends;for(const o of n.edges)n.bends?o.bends=[...n.bends]:delete o.bends;this.render(),this.updateBendHandles(),this.updateControlButtons(),this.debouncedSave()}}debouncedSave(){this.onSave&&(this.saveDebounceTimer!==null&&clearTimeout(this.saveDebounceTimer),this.saveDebounceTimer=window.setTimeout(()=>{this.onSave({nodes:this.nodes,edges:this.edges}),this.saveDebounceTimer=null},this.SAVE_DEBOUNCE_MS))}render(){this.updateTransform(),this.nodeElements.clear(),this.edgeElements.clear(),this.edgesGroup.innerHTML="",this.nodesGroup.innerHTML="",this.edgeLabelsGroup.innerHTML="";const t=this.groupEdgesByPair(this.edges);for(const e of t){const i=e.edges.some(b=>b.id===this.selectedEdgeId),s=this.mode==="view"&&e.key===this.hoveredEdgePairKey,n=this.mode==="view"&&e.key===this.tappedEdgePairKey,o=this.alwaysShowEdges||i||s||n,a=e.edges[0].style||{},c=a.color||this.EDGE_DEFAULT_COLOR,d=a.weight||1,r=Math.max(this.EDGE_MIN_WEIGHT,Math.min(this.EDGE_MAX_WEIGHT,d)),h=this.EDGE_DEFAULT_WIDTH+(r-1)*.5,g=o?Math.max(h,this.EDGE_HOVER_WIDTH):h,u=i?"#2196f3":c,w=o?1:.3,y=this.calculateEdgePairPath(e);if(!y)continue;const f=document.createElementNS("http://www.w3.org/2000/svg","path");f.setAttribute("d",y),f.setAttribute("stroke","transparent"),f.setAttribute("stroke-width",String(this.HIT_PATH_WIDTH)),f.setAttribute("fill","none"),f.setAttribute("data-hit-edge-pair-key",e.key),f.style.cursor="pointer",f.style.pointerEvents="stroke",this.edgesGroup.appendChild(f);const p=document.createElementNS("http://www.w3.org/2000/svg","path");p.setAttribute("d",y),p.setAttribute("stroke",u),p.setAttribute("stroke-width",String(g)),p.setAttribute("stroke-opacity",String(w)),p.setAttribute("fill","none"),p.setAttribute("data-edge-pair-key",e.key),p.style.pointerEvents="none",p.style.transition="stroke-opacity 0.2s, stroke-width 0.2s";const m=this.getEdgePairMarkerAttributes(e);if(m.markerStart&&p.setAttribute("marker-start",m.markerStart),m.markerEnd&&p.setAttribute("marker-end",m.markerEnd),this.edgeElements.set(e.key,p),this.edgesGroup.appendChild(p),this.mode==="view")this.setupEdgeInteraction(f,e,a);else if(this.mode==="edit"){this.setupEdgeInteractionForEdit(f,e);const b=e.key;f.addEventListener("click",B=>{const C=this.edgeClickTimers.get(f);if(C!=null){clearTimeout(C),this.edgeClickTimers.set(f,null);return}const E=window.setTimeout(()=>{if(this.edgeClickTimers.set(f,null),this.mode==="edit"){const x=this.groupEdgesByPair(this.edges).find(S=>S.key===b);x&&x.edges.length>0&&(this.selectEdge(x.edges[0].id,B.shiftKey),this.render())}},300);this.edgeClickTimers.set(f,E)})}const T=e.key;f.addEventListener("dblclick",b=>{if(this.mode!=="edit")return;const B=this.edgeClickTimers.get(f);B!=null&&(clearTimeout(B),this.edgeClickTimers.set(f,null));const C=this.groupEdgesByPair(this.edges).find(E=>E.key===T);C&&C.edges.length>0&&(this.insertBendPoint(C.edges[0].id,b),b.preventDefault(),b.stopPropagation())}),o&&this.renderEdgeLabels(e,a)}for(const e of this.nodes){if(!e.position)continue;const i=e.style||{},s=i.width||this.DEFAULT_NODE_WIDTH,n=i.height||this.DEFAULT_NODE_HEIGHT,o=i.color||"#fff",l=i.borderColor||"#333",a=document.createElementNS("http://www.w3.org/2000/svg","g");a.setAttribute("data-node-id",e.id);const c=document.createElementNS("http://www.w3.org/2000/svg","rect"),d=e.position.x-s/2,r=e.position.y-n/2;c.setAttribute("x",String(d)),c.setAttribute("y",String(r)),c.setAttribute("width",String(s)),c.setAttribute("height",String(n));const h=o.match(/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/i);if(h){const y=parseInt(h[1],16),f=parseInt(h[2],16),p=parseInt(h[3],16);c.setAttribute("fill",`rgba(${y}, ${f}, ${p}, 0.5)`)}else c.setAttribute("fill",o);const g=this.selectedNodeId===e.id;c.setAttribute("stroke",g?"#2196f3":l),c.setAttribute("stroke-width",g?"4":"2"),c.setAttribute("rx","4"),c.style.cursor=this.mode==="view"?"pointer":"move";const u=document.createElementNS("http://www.w3.org/2000/svg","foreignObject");u.setAttribute("x",String(d)),u.setAttribute("y",String(r)),u.setAttribute("width",String(s)),u.setAttribute("height",String(n));const w=document.createElement("div");w.style.width="100%",w.style.height="100%",w.style.display="flex",w.style.alignItems="flex-start",w.style.justifyContent="center",w.style.textAlign="center",w.style.fontSize="14px",w.style.color="#333",w.style.padding="4px",w.style.wordWrap="break-word",w.style.overflowWrap="break-word",w.style.whiteSpace="normal",w.style.overflow="hidden",w.style.textOverflow="ellipsis",w.textContent=e.label,u.appendChild(w),a.appendChild(c),a.appendChild(u),this.mode==="edit"&&this.addResizeHandles(a,e,s,n),this.nodesGroup.appendChild(a),this.nodeElements.set(e.id,c),this.mode==="view"&&this.onNodeClick&&a.addEventListener("click",y=>{y.stopPropagation(),y.preventDefault();const f=this.svg.getBoundingClientRect(),p=y.clientX-f.left,m=y.clientY-f.top;this.onNodeClick({node:e,position:{x:p,y:m},originalEvent:y})},!0)}this.mode==="edit"&&(this.updateAnchorHandles(),this.updateBendHandles(),this.updateControlButtons())}updateEdgeHighlight(t){const e=this.groupEdgesByPair(this.edges);for(const i of e){const s=this.edgeElements.get(i.key);if(!s)continue;const n=i.edges.some(p=>p.id===this.selectedEdgeId),o=this.mode==="view"&&i.key===this.hoveredEdgePairKey,l=this.mode==="view"&&i.key===this.tappedEdgePairKey,a=this.alwaysShowEdges||n||o||l,d=i.edges[0].style||{},r=d.color||this.EDGE_DEFAULT_COLOR,h=d.weight||1,g=Math.max(this.EDGE_MIN_WEIGHT,Math.min(this.EDGE_MAX_WEIGHT,h)),u=this.EDGE_DEFAULT_WIDTH+(g-1)*.5,w=a?Math.max(u,this.EDGE_HOVER_WIDTH):u,y=n?"#2196f3":r,f=a?1:.3;s.setAttribute("stroke",y),s.setAttribute("stroke-width",String(w)),s.setAttribute("stroke-opacity",String(f)),a?(this.edgeLabelsGroup.querySelectorAll(`[data-edge-pair-key="${i.key}"]`).forEach(m=>m.remove()),this.renderEdgeLabels(i,d)):this.edgeLabelsGroup.querySelectorAll(`[data-edge-pair-key="${i.key}"]`).forEach(m=>m.remove())}}setupEdgeInteraction(t,e,i){t.addEventListener("pointerenter",()=>{this.tappedEdgePairKey!==e.key&&(this.hoveredEdgePairKey=e.key,this.updateEdgeHighlight(e.key))}),t.addEventListener("pointerleave",()=>{this.tappedEdgePairKey!==e.key&&(this.hoveredEdgePairKey=null,this.updateEdgeHighlight(null))}),t.addEventListener("click",s=>{if(this.mode==="view"&&e.edges.length>0&&(this.tappedEdgePairKey=e.key,this.updateEdgeHighlight(e.key),this.onEdgeClick)){const n=this.screenToSvg(s.clientX,s.clientY),o=e.edges[0];this.onEdgeClick({edge:o,position:{x:n.x,y:n.y},originalEvent:s})}})}setupEdgeInteractionForEdit(t,e){t.addEventListener("pointerenter",()=>{e.edges.length>0&&(this.selectedEdgeId=e.edges[0].id,this.updateAnchorHandles(),this.updateBendHandles(),this.updateControlButtons())}),t.addEventListener("pointerleave",()=>{}),t.addEventListener("pointerdown",i=>{e.edges.length>0&&(this.selectedEdgeId=e.edges[0].id,this.updateAnchorHandles(),this.updateBendHandles(),this.updateControlButtons())})}addResizeHandles(t,e,i,s){const n=[{side:"top",x:e.position.x,y:e.position.y-s/2},{side:"right",x:e.position.x+i/2,y:e.position.y},{side:"bottom",x:e.position.x,y:e.position.y+s/2},{side:"left",x:e.position.x-i/2,y:e.position.y}];for(const o of n){const l=document.createElementNS("http://www.w3.org/2000/svg","circle");l.setAttribute("cx",String(o.x)),l.setAttribute("cy",String(o.y)),l.setAttribute("r","6"),l.setAttribute("fill","#4CAF50"),l.setAttribute("stroke","#fff"),l.setAttribute("stroke-width","2"),l.setAttribute("data-resize-side",o.side),l.setAttribute("data-node-id",e.id),l.style.cursor=this.getResizeCursor(o.side),l.style.pointerEvents="auto",t.appendChild(l)}}getResizeCursor(t){switch(t){case"top":case"bottom":return"ns-resize";case"left":case"right":return"ew-resize"}}renderEdgeLabels(t,e){const i=this.nodes.find(b=>b.id===t.a),s=this.nodes.find(b=>b.id===t.b);if(!i?.position||!s?.position)return;const n=i.style||{},o=s.style||{},l=n.width||this.DEFAULT_NODE_WIDTH,a=n.height||this.DEFAULT_NODE_HEIGHT,c=o.width||this.DEFAULT_NODE_WIDTH,d=o.height||this.DEFAULT_NODE_HEIGHT,r=t.srcAnchor||this.estimateAnchor(i,s),h=t.dstAnchor||this.estimateAnchor(s,i),g=this.calculateAnchorPosition(i,r,l,a),u=this.calculateAnchorPosition(s,h,c,d),w=t.edges.find(b=>b.src===t.a&&b.dst===t.b),y=t.edges.find(b=>b.src===t.b&&b.dst===t.a),f=w?.style?.label||w?.relType||"",p=y?.style?.label||y?.relType||"",m=f!==p&&f&&p,T=f===p&&f;if(m){const B=g.x+(u.x-g.x)*.75,C=g.y+(u.y-g.y)*(1-.25),E=g.x+(u.x-g.x)*.25,x=g.y+(u.y-g.y)*.25;if(f){const S=document.createElementNS("http://www.w3.org/2000/svg","text");S.setAttribute("x",String(B)),S.setAttribute("y",String(C-8)),S.setAttribute("text-anchor","middle"),S.setAttribute("dominant-baseline","middle"),S.setAttribute("font-size","12"),S.setAttribute("fill","#333"),S.setAttribute("font-weight","bold"),S.setAttribute("pointer-events","none"),S.setAttribute("data-edge-pair-key",t.key);const A=document.createElementNS("http://www.w3.org/2000/svg","rect"),v=f.length*7;A.setAttribute("x",String(B-v/2-4)),A.setAttribute("y",String(C-16)),A.setAttribute("width",String(v+8)),A.setAttribute("height","16"),A.setAttribute("fill","rgba(255, 255, 255, 0.9)"),A.setAttribute("rx","2"),A.setAttribute("pointer-events","none"),A.setAttribute("data-edge-pair-key",t.key),this.edgeLabelsGroup.appendChild(A),S.textContent=f,this.edgeLabelsGroup.appendChild(S)}if(p){const S=document.createElementNS("http://www.w3.org/2000/svg","text");S.setAttribute("x",String(E)),S.setAttribute("y",String(x-8)),S.setAttribute("text-anchor","middle"),S.setAttribute("dominant-baseline","middle"),S.setAttribute("font-size","12"),S.setAttribute("fill","#333"),S.setAttribute("font-weight","bold"),S.setAttribute("pointer-events","none"),S.setAttribute("data-edge-pair-key",t.key);const A=document.createElementNS("http://www.w3.org/2000/svg","rect"),v=p.length*7;A.setAttribute("x",String(E-v/2-4)),A.setAttribute("y",String(x-16)),A.setAttribute("width",String(v+8)),A.setAttribute("height","16"),A.setAttribute("fill","rgba(255, 255, 255, 0.9)"),A.setAttribute("rx","2"),A.setAttribute("pointer-events","none"),A.setAttribute("data-edge-pair-key",t.key),this.edgeLabelsGroup.appendChild(A),S.textContent=p,this.edgeLabelsGroup.appendChild(S)}}else if(T){const b=(g.x+u.x)/2,B=(g.y+u.y)/2,C=document.createElementNS("http://www.w3.org/2000/svg","text");C.setAttribute("x",String(b)),C.setAttribute("y",String(B)),C.setAttribute("text-anchor","middle"),C.setAttribute("dominant-baseline","middle"),C.setAttribute("data-edge-pair-key",t.key),C.setAttribute("font-size","12"),C.setAttribute("fill","#333"),C.setAttribute("font-weight","bold"),C.setAttribute("pointer-events","none");const E=document.createElementNS("http://www.w3.org/2000/svg","rect"),x=f.length*7;E.setAttribute("x",String(b-x/2-4)),E.setAttribute("y",String(B-8)),E.setAttribute("width",String(x+8)),E.setAttribute("height","16"),E.setAttribute("fill","rgba(255, 255, 255, 0.9)"),E.setAttribute("rx","2"),E.setAttribute("pointer-events","none"),E.setAttribute("data-edge-pair-key",t.key),this.edgeLabelsGroup.appendChild(E),C.textContent=f,this.edgeLabelsGroup.appendChild(C)}else if(e.label){const b=(g.x+u.x)/2,B=(g.y+u.y)/2,C=document.createElementNS("http://www.w3.org/2000/svg","text");C.setAttribute("x",String(b)),C.setAttribute("y",String(B)),C.setAttribute("text-anchor","middle"),C.setAttribute("dominant-baseline","middle"),C.setAttribute("font-size","12"),C.setAttribute("fill","#333"),C.setAttribute("font-weight","bold"),C.setAttribute("pointer-events","none"),C.setAttribute("data-edge-pair-key",t.key);const E=document.createElementNS("http://www.w3.org/2000/svg","rect"),x=e.label.length*7;E.setAttribute("x",String(b-x/2-4)),E.setAttribute("y",String(B-8)),E.setAttribute("width",String(x+8)),E.setAttribute("height","16"),E.setAttribute("fill","rgba(255, 255, 255, 0.9)"),E.setAttribute("rx","2"),E.setAttribute("pointer-events","none"),E.setAttribute("data-edge-pair-key",t.key),this.edgeLabelsGroup.appendChild(E),C.textContent=e.label,this.edgeLabelsGroup.appendChild(C)}}setMode(t){!this.editable&&t==="edit"||(t==="edit"&&this.mode==="view"&&this.saveSnapshot(),this.mode=t,this.render(),t==="view"&&this.deselectEdge(),this.updateEditToggleButtonIcon(),this.updateControlButtons(),this.onModeChange&&this.onModeChange())}setModeChangeCallback(t){this.onModeChange=t}setAlwaysShowEdgesChangeCallback(t){this.onAlwaysShowEdgesChange=t}setGraphButtonsUpdateCallback(t){this.onGraphButtonsUpdate=t}getAlwaysShowEdges(){return this.alwaysShowEdges}setAlwaysShowEdges(t){this.alwaysShowEdges!==t&&(this.alwaysShowEdges=t,this.updateAlwaysShowEdgesButton(),this.alwaysShowEdges||(this.hoveredEdgePairKey=null,this.tappedEdgePairKey=null),this.render())}clearSelection(){this.deselectEdge()}cancelEdit(){this.restoreSnapshot(),this.setMode("view")}getSelectedEdgeId(){return this.selectedEdgeId}getEdges(){return this.edges}isEditable(){return this.editable}getEditToggleButton(){return this.editToggleButton}getMode(){return this.mode}show(){this.container.style.display="block",this.nodes.length>0&&setTimeout(()=>{const t=this.container.getBoundingClientRect();t.width>0&&t.height>0&&this.fitAndCenter()},100),this.resize()}createPopup(){const t=document.createElement("div");t.className="relatos-graph-popup",t.style.cssText=`
      position: absolute;
      background: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 8px 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      pointer-events: none;
      z-index: 10000;
      font-size: 14px;
      line-height: 1.4;
      max-width: 300px;
      word-wrap: break-word;
      overflow-wrap: break-word;
      white-space: normal;
      opacity: 0;
      transition: opacity 0.2s;
    `;const e=document.createElement("div");return e.style.cssText=`
      position: absolute;
      bottom: -8px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 8px solid transparent;
      border-right: 8px solid transparent;
      border-top: 8px solid white;
    `,t.appendChild(e),this.container.appendChild(t),t}showPopup(t){!t||!t.position||(this.hidePopup(),this.popupElement||(this.popupElement=this.createPopup()),this.popupElement.textContent=t.label,this.popupElement.style.opacity="1",this.popupElement.style.display="block",this.popupNodeId=t.id,requestAnimationFrame(()=>{this.popupElement&&this.popupNodeId===t.id&&this.updatePopupPosition(t)}))}updatePopupPosition(t){if(!this.popupElement||!t||!t.position)return;const e=t.style||{};e.width||this.DEFAULT_NODE_WIDTH;const i=e.height||this.DEFAULT_NODE_HEIGHT,s=this.nodeElements.get(t.id);if(!s){this.container.getBoundingClientRect(),this.svg.getBoundingClientRect();const u=isFinite(this.zoom)&&this.zoom>0?this.zoom:1,w=isFinite(this.offsetX)?this.offsetX:0,y=isFinite(this.offsetY)?this.offsetY:0,f=(t.position.x+w)*u,p=(t.position.y+y)*u,m=this.popupElement.getBoundingClientRect(),T=m.width||200,b=m.height||50,B=f-T/2,C=p-i*u/2-b-10;this.popupElement.style.left=`${B}px`,this.popupElement.style.top=`${C}px`;return}const n=s.getBoundingClientRect(),o=this.container.getBoundingClientRect(),l=n.left+n.width/2-o.left,a=n.top+n.height/2-o.top,c=this.popupElement.getBoundingClientRect(),d=c.width||200,r=c.height||50,h=l-d/2,g=a-n.height/2-r-10;this.popupElement.style.left=`${h}px`,this.popupElement.style.top=`${g}px`}hidePopup(){this.popupElement&&(this.popupElement.style.opacity="0",setTimeout(()=>{this.popupElement&&this.popupElement.style.opacity==="0"&&(this.popupElement.style.display="none")},200)),this.popupNodeId=null}hide(){this.container.style.display="none",this.hidePopup()}resize(){const t=this.container.getBoundingClientRect();if(this.svg.setAttribute("width",String(t.width)),this.svg.setAttribute("height",String(t.height)),this.popupNodeId&&this.popupElement){const e=this.nodes.find(i=>i.id===this.popupNodeId);e&&this.updatePopupPosition(e)}}destroy(){this.nodeElements.clear(),this.edgeElements.clear(),this.container.contains(this.svg)&&this.container.removeChild(this.svg)}}function W(k,t=16){return D(),`<svg width="${t}" height="${t}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <use href="#${k}"></use>
  </svg>`}class K{constructor(t,e,i,s,n,o){this.viewer=null,this.Cesium=null,this.nodes=[],this.edges=[],this.selectedNodeId=null,this.lastSelectedNodeId=null,this.nodeEntities=new Map,this.edgeEntities=new Map,this.rectEntity=null,this.fitCenterButton=null,this.lightingToggleButton=null,this.alwaysShowEdgesButton=null,this.alwaysShowEdges=!0,this.tileTypeButton=null,this.baseImageryLayer=null,this.timeISO=null,this.customTileUrls=[],this.currentCustomTileIndex=0,this.popupElement=null,this.popupEntity=null,this.popupUpdateListener=null,this.container=t,this.onNodeClick=e,this.cesiumLoader=i,this.globe3dOptions=s,this.onEdgeClick=o;const l=n&&n.length>0?n:s?.customTileUrls;l&&l.length>0?this.customTileUrls=l.map(a=>typeof a=="string"?{url:a}:a):s?.customTileUrl&&(this.customTileUrls=[{url:s.customTileUrl}]),this.container.style.position="relative",this.container.style.width="100%",this.container.style.height="100%"}async initializeCesium(){if(this.viewer)return;if(!this.cesiumLoader)throw new Error("Cesium loader is not provided. Please provide options.loaders.cesium.");const t=await this.cesiumLoader();this.Cesium=t.default||t;const e=new this.Cesium.EllipsoidTerrainProvider;this.Cesium.Ion&&(this.Cesium.Ion.defaultAccessToken=""),this.viewer=new this.Cesium.Viewer(this.container,{terrainProvider:e,baseLayerPicker:!1,animation:!1,timeline:!1,fullscreenButton:!1,vrButton:!1,geocoder:!1,homeButton:!1,infoBox:!1,sceneModePicker:!1,selectionIndicator:!1,navigationHelpButton:!1,requestRenderMode:!1});try{this.viewer.imageryLayers.removeAll()}catch{}this.setupCameraLimits(),this.setTileTypeInternal(!0),this.setupTimeAndLighting(),this.setupClickHandler(),(this.nodes.length>0||this.edges.length>0)&&this.render()}setupTimeAndLighting(){!this.viewer||this.Cesium}setTime(t){if(this.timeISO=t,!(!this.viewer||!this.Cesium))try{let e;t.startsWith("-")?e=this.parseBCDate(t):e=this.Cesium.JulianDate.fromIso8601(t),e&&(this.viewer.clock.currentTime=e,this.viewer.clock.startTime=e,this.viewer.clock.stopTime=e,this.viewer.clock.shouldAnimate=!1)}catch{}}parseBCDate(t){if(!this.Cesium)return null;try{const e=t.match(/^-(\d+)-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})(Z|[+-]\d{2}:\d{2})?/);if(!e)throw new Error("Invalid BC date format");const i=`2000-${e[2]}-${e[3]}T${e[4]}:${e[5]}:${e[6]}${e[7]||"Z"}`;return this.Cesium.JulianDate.fromIso8601(i)}catch{return null}}setLighting(t){if(!this.viewer||!this.Cesium||this.isLightingEnabled()===t)return;const i=this.viewer.scene.globe;i.enableLighting=t,i.dynamicAtmosphereLighting=t,i.dynamicAtmosphereLightingFromSun=t,i.showGroundAtmosphere=!0,t&&(i.lightingFadeOutDistance=0,i.lightingFadeInDistance=0,i.nightFadeInDistance=0,i.nightFadeOutDistance=0,this.viewer.imageryLayers.length>0&&this.baseImageryLayer&&(this.baseImageryLayer.nightAlpha=.9)),this.updateLightingButton()}isLightingEnabled(){return this.viewer?this.viewer.scene.globe.enableLighting===!0:!1}getAlwaysShowEdges(){return this.alwaysShowEdges}setAlwaysShowEdges(t){this.alwaysShowEdges!==t&&(this.alwaysShowEdges=t,this.updateAlwaysShowEdgesButton(),this.renderWithoutFit())}getLightingEnabled(){return this.isLightingEnabled()}setLightingEnabled(t,e=!0){const i=this.isLightingEnabled();this.setLighting(t),e&&this.onLightingChange&&this.isLightingEnabled()!==i&&this.onLightingChange(this.isLightingEnabled())}setAlwaysShowEdgesChangeCallback(t){this.onAlwaysShowEdgesChange=t}setLightingChangeCallback(t){this.onLightingChange=t}getTileServerCount(){return this.customTileUrls.length}getTileServerIndex(){return this.currentCustomTileIndex}setTileServerIndex(t){if(this.customTileUrls.length===0)return;const e=this.customTileUrls.length,i=(t%e+e)%e;this.currentCustomTileIndex!==i&&(this.currentCustomTileIndex=i,this.viewer&&this.Cesium&&(this.setTileTypeInternal(!0),this.updateTileTypeButton()))}cycleTileServer(){this.switchTileType()}setupCameraLimits(){if(!this.viewer||!this.Cesium)return;const t=5e5,e=4e7,i=this.viewer.scene.screenSpaceCameraController;i.minimumZoomDistance=t,i.maximumZoomDistance=e;let s=!1;this.viewer.scene.camera.changed.addEventListener(()=>{if(s)return;const n=this.viewer.scene.camera,o=this.Cesium.Cartographic.fromCartesian(n.position),l=o.height;if(l<t||l>e){s=!0;const a=Math.max(t,Math.min(e,l)),c=this.Cesium.Cartesian3.fromRadians(o.longitude,o.latitude,a);n.setView({destination:c}),setTimeout(()=>{s=!1},0)}})}setupClickHandler(){if(!this.viewer||!this.Cesium)return;new this.Cesium.ScreenSpaceEventHandler(this.viewer.canvas).setInputAction(e=>{const i=this.viewer.scene.pick(e.position);if(i&&i.id&&i.id.nodeId){const n=i.id.nodeId,o=this.nodes.find(a=>a.id===n),l=this.nodeEntities.get(n);if(o&&l&&(this.showPopup(l,o),this.onNodeClick)){const a=this.viewer.camera.pickEllipsoid(e.position,this.viewer.scene.globe.ellipsoid);if(a){const c=this.Cesium.Cartographic.fromCartesian(a),d=this.Cesium.Math.toDegrees(c.longitude),r=this.Cesium.Math.toDegrees(c.latitude);this.onNodeClick({node:o,position:{x:d,y:r},originalEvent:e.originalEvent})}}return}const s=this.viewer.scene.drillPick(e.position);for(const n of s)if(n.id&&n.id.nodeId){const o=n.id.nodeId,l=this.nodes.find(c=>c.id===o),a=this.nodeEntities.get(o);if(l&&a&&(this.showPopup(a,l),this.onNodeClick)){const c=this.viewer.camera.pickEllipsoid(e.position,this.viewer.scene.globe.ellipsoid);if(c){const d=this.Cesium.Cartographic.fromCartesian(c),r=this.Cesium.Math.toDegrees(d.longitude),h=this.Cesium.Math.toDegrees(d.latitude);this.onNodeClick({node:l,position:{x:r,y:h},originalEvent:e.originalEvent})}}return}s.length===0&&this.hidePopup();for(const n of s)if(n.id&&n.id.edgeId){const o=n.id.edgeId,l=this.edges.find(a=>a.id===o);if(l&&this.onEdgeClick){const a=this.viewer.camera.pickEllipsoid(e.position,this.viewer.scene.globe.ellipsoid);if(a){const c=this.Cesium.Cartographic.fromCartesian(a),d=this.Cesium.Math.toDegrees(c.longitude),r=this.Cesium.Math.toDegrees(c.latitude);this.onEdgeClick({edge:l,position:{x:d,y:r},originalEvent:e.originalEvent})}}return}!i&&(!s||s.length===0)&&this.hidePopup()},this.Cesium.ScreenSpaceEventType.LEFT_CLICK)}setData(t,e){this.nodes=t,this.edges=e,this.viewer&&this.Cesium&&this.render()}selectNode(t){if(!t){this.selectedNodeId=null,this.lastSelectedNodeId=null,this.hidePopup(),this.render();return}if(!this.viewer||!this.Cesium)return;if(t===this.lastSelectedNodeId){this.selectedNodeId=null,this.lastSelectedNodeId=null,this.hidePopup(),this.fitToNodes(),this.render();return}this.lastSelectedNodeId=t,this.selectedNodeId=t,this.render();const e=this.nodes.find(s=>s.id===t);if(!e)return;if(e.coordinates&&e.coordinates.length===2){const[s,n]=e.coordinates;if(Number.isFinite(s)&&Number.isFinite(n)){const[o,l]=e.coordinates,a=3e6,c=this.nodeEntities.get(t);c&&e&&this.showPopup(c,e),this.viewer.camera.flyTo({destination:this.Cesium.Cartesian3.fromDegrees(l,o,a),orientation:{heading:this.Cesium.Math.toRadians(0),pitch:this.Cesium.Math.toRadians(-90),roll:0},duration:1});return}}const i=this.nodes.filter(s=>{if(!s.coordinates||!Array.isArray(s.coordinates)||s.coordinates.length!==2)return!0;const[n,o]=s.coordinates;return!Number.isFinite(n)||!Number.isFinite(o)});if(i.length>0){const a=Math.ceil(Math.sqrt(i.length)),d=50/(Math.ceil(i.length/a)+1),r=32/(a+1),h=i.findIndex(g=>g.id===t);if(h>=0){const g=Math.floor(h/a),u=h%a,w=-50+(g+1)*d,y=-32+(u+1)*r,f=3e6,p=this.nodeEntities.get(t);p&&e&&this.showPopup(p,e),this.viewer.camera.flyTo({destination:this.Cesium.Cartesian3.fromDegrees(y,w,f),orientation:{heading:this.Cesium.Math.toRadians(0),pitch:this.Cesium.Math.toRadians(-90),roll:0},duration:1})}}}render(){if(!this.viewer||!this.Cesium)return;this.viewer.entities.removeAll(),this.nodeEntities.clear(),this.edgeEntities.clear(),this.rectEntity=null;const t=this.nodes.filter(i=>{if(!i.coordinates||!Array.isArray(i.coordinates)||i.coordinates.length!==2)return!0;const[s,n]=i.coordinates;return!Number.isFinite(s)||!Number.isFinite(n)}),e=this.nodes.filter(i=>{if(!i.coordinates||!Array.isArray(i.coordinates)||i.coordinates.length!==2)return!1;const[s,n]=i.coordinates;return Number.isFinite(s)&&Number.isFinite(n)});if(t.length>0){const l=[this.Cesium.Cartesian3.fromDegrees(-32,-50,0),this.Cesium.Cartesian3.fromDegrees(0,-50,0),this.Cesium.Cartesian3.fromDegrees(0,0,0),this.Cesium.Cartesian3.fromDegrees(-32,0,0)];this.rectEntity=this.viewer.entities.add({polygon:{hierarchy:l,material:this.Cesium.Color.fromCssColorString("#f0f0f0").withAlpha(.1),outline:!0,outlineColor:this.Cesium.Color.fromCssColorString("#666"),height:0}});const a=Math.ceil(Math.sqrt(t.length)),d=50/(Math.ceil(t.length/a)+1),r=32/(a+1);t.forEach((h,g)=>{const u=Math.floor(g/a),w=g%a,y=-50+(u+1)*d,f=-32+(w+1)*r,p=this.selectedNodeId===h.id,m=h.style?.color||"#ffffff",T=p?"#2196f3":h.style?.borderColor||"#333333";let b;const B=m.match(/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/i);if(B){const x=parseInt(B[1],16)/255,S=parseInt(B[2],16)/255,A=parseInt(B[3],16)/255;b=new this.Cesium.Color(x,S,A,1)}else b=this.Cesium.Color.fromCssColorString(m),b=b.withAlpha(1);const C=this.Cesium.Color.fromCssColorString(T),E=this.viewer.entities.add({position:this.Cesium.Cartesian3.fromDegrees(f,y,0),point:{pixelSize:p?15:10,color:b,outlineColor:C,outlineWidth:2,heightReference:this.Cesium.HeightReference.CLAMP_TO_GROUND},label:{text:h.label,font:"14px sans-serif",fillColor:this.Cesium.Color.WHITE,outlineColor:this.Cesium.Color.BLACK,outlineWidth:2,style:this.Cesium.LabelStyle.FILL_AND_OUTLINE,verticalOrigin:this.Cesium.VerticalOrigin.BOTTOM,pixelOffset:new this.Cesium.Cartesian2(0,-20),heightReference:this.Cesium.HeightReference.CLAMP_TO_GROUND,show:!1},nodeId:h.id});this.nodeEntities.set(h.id,E)})}for(const i of e){const[s,n]=i.coordinates,o=this.selectedNodeId===i.id,l=i.style?.color||"#ffffff",a=o?"#2196f3":i.style?.borderColor||"#333333";let c;const d=l.match(/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/i);if(d){const g=parseInt(d[1],16)/255,u=parseInt(d[2],16)/255,w=parseInt(d[3],16)/255;c=new this.Cesium.Color(g,u,w,1)}else c=this.Cesium.Color.fromCssColorString(l),c=c.withAlpha(1);const r=this.Cesium.Color.fromCssColorString(a),h=this.viewer.entities.add({position:this.Cesium.Cartesian3.fromDegrees(n,s,0),point:{pixelSize:o?15:10,color:c,outlineColor:r,outlineWidth:2,heightReference:this.Cesium.HeightReference.CLAMP_TO_GROUND},label:{text:i.label,font:"14px sans-serif",fillColor:this.Cesium.Color.WHITE,outlineColor:this.Cesium.Color.BLACK,outlineWidth:2,style:this.Cesium.LabelStyle.FILL_AND_OUTLINE,verticalOrigin:this.Cesium.VerticalOrigin.BOTTOM,pixelOffset:new this.Cesium.Cartesian2(0,-20),heightReference:this.Cesium.HeightReference.CLAMP_TO_GROUND,show:!1},nodeId:i.id});this.nodeEntities.set(i.id,h)}if(this.alwaysShowEdges)for(const i of this.edges){const s=this.nodes.find(u=>u.id===i.src),n=this.nodes.find(u=>u.id===i.dst);if(!s?.coordinates||!n?.coordinates)continue;const[o,l]=s.coordinates,[a,c]=n.coordinates,d=i.style?.color||"#999999",r=i.style?.weight||1,h=Math.max(1,Math.min(5,r)),g=this.viewer.entities.add({polyline:{positions:[this.Cesium.Cartesian3.fromDegrees(l,o,0),this.Cesium.Cartesian3.fromDegrees(c,a,0)],width:h,material:this.Cesium.Color.fromCssColorString(d),clampToGround:!0},edgeId:i.id});this.edgeEntities.set(i.id,g)}this.fitToNodes()}renderWithoutFit(){if(!this.viewer||!this.Cesium)return;this.viewer.entities.removeAll(),this.nodeEntities.clear(),this.edgeEntities.clear(),this.rectEntity=null;const t=this.nodes.filter(i=>{if(!i.coordinates||!Array.isArray(i.coordinates)||i.coordinates.length!==2)return!0;const[s,n]=i.coordinates;return!Number.isFinite(s)||!Number.isFinite(n)}),e=this.nodes.filter(i=>{if(!i.coordinates||!Array.isArray(i.coordinates)||i.coordinates.length!==2)return!1;const[s,n]=i.coordinates;return Number.isFinite(s)&&Number.isFinite(n)});if(t.length>0){const l=[this.Cesium.Cartesian3.fromDegrees(-32,-50,0),this.Cesium.Cartesian3.fromDegrees(0,-50,0),this.Cesium.Cartesian3.fromDegrees(0,0,0),this.Cesium.Cartesian3.fromDegrees(-32,0,0)];this.rectEntity=this.viewer.entities.add({polygon:{hierarchy:l,material:this.Cesium.Color.fromCssColorString("#f0f0f0").withAlpha(.1),outline:!0,outlineColor:this.Cesium.Color.fromCssColorString("#666"),height:0}});const a=Math.ceil(Math.sqrt(t.length)),d=50/(Math.ceil(t.length/a)+1),r=32/(a+1);t.forEach((h,g)=>{const u=Math.floor(g/a),w=g%a,y=-50+(u+1)*d,f=-32+(w+1)*r,p=this.selectedNodeId===h.id,m=h.style?.color||"#ffffff",T=p?"#2196f3":h.style?.borderColor||"#333333";let b;const B=m.match(/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/i);if(B){const x=parseInt(B[1],16)/255,S=parseInt(B[2],16)/255,A=parseInt(B[3],16)/255;b=new this.Cesium.Color(x,S,A,1)}else b=this.Cesium.Color.fromCssColorString(m),b=b.withAlpha(1);const C=this.Cesium.Color.fromCssColorString(T),E=this.viewer.entities.add({position:this.Cesium.Cartesian3.fromDegrees(f,y,0),point:{pixelSize:p?15:10,color:b,outlineColor:C,outlineWidth:2,heightReference:this.Cesium.HeightReference.CLAMP_TO_GROUND},label:{text:h.label,font:"14px sans-serif",fillColor:this.Cesium.Color.WHITE,outlineColor:this.Cesium.Color.BLACK,outlineWidth:2,style:this.Cesium.LabelStyle.FILL_AND_OUTLINE,verticalOrigin:this.Cesium.VerticalOrigin.BOTTOM,pixelOffset:new this.Cesium.Cartesian2(0,-20),heightReference:this.Cesium.HeightReference.CLAMP_TO_GROUND,show:!1},nodeId:h.id});this.nodeEntities.set(h.id,E)})}for(const i of e){const[s,n]=i.coordinates,o=this.selectedNodeId===i.id,l=i.style?.color||"#ffffff",a=o?"#2196f3":i.style?.borderColor||"#333333";let c;const d=l.match(/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/i);if(d){const g=parseInt(d[1],16)/255,u=parseInt(d[2],16)/255,w=parseInt(d[3],16)/255;c=new this.Cesium.Color(g,u,w,1)}else c=this.Cesium.Color.fromCssColorString(l),c=c.withAlpha(1);const r=this.Cesium.Color.fromCssColorString(a),h=this.viewer.entities.add({position:this.Cesium.Cartesian3.fromDegrees(n,s,0),point:{pixelSize:o?15:10,color:c,outlineColor:r,outlineWidth:2,heightReference:this.Cesium.HeightReference.CLAMP_TO_GROUND},label:{text:i.label,font:"14px sans-serif",fillColor:this.Cesium.Color.WHITE,outlineColor:this.Cesium.Color.BLACK,outlineWidth:2,style:this.Cesium.LabelStyle.FILL_AND_OUTLINE,verticalOrigin:this.Cesium.VerticalOrigin.BOTTOM,pixelOffset:new this.Cesium.Cartesian2(0,-20),heightReference:this.Cesium.HeightReference.CLAMP_TO_GROUND,show:!1},nodeId:i.id});this.nodeEntities.set(i.id,h)}if(this.alwaysShowEdges)for(const i of this.edges){const s=this.nodes.find(u=>u.id===i.src),n=this.nodes.find(u=>u.id===i.dst);if(!s?.coordinates||!n?.coordinates)continue;const[o,l]=s.coordinates,[a,c]=n.coordinates,d=i.style?.color||"#999999",r=i.style?.weight||1,h=Math.max(1,Math.min(5,r)),g=this.viewer.entities.add({polyline:{positions:[this.Cesium.Cartesian3.fromDegrees(l,o,0),this.Cesium.Cartesian3.fromDegrees(c,a,0)],width:h,material:this.Cesium.Color.fromCssColorString(d),clampToGround:!0},edgeId:i.id});this.edgeEntities.set(i.id,g)}}createControlButtons(){if(!this.container)return;let t=this.container.querySelector(".relatos-globe3d-controls");t||(t=document.createElement("div"),t.className="relatos-globe3d-controls",t.style.position="absolute",t.style.top="8px",t.style.right="8px",t.style.display="flex",t.style.gap="4px",t.style.zIndex="1000",t.style.pointerEvents="none",this.container.appendChild(t)),this.alwaysShowEdgesButton=document.createElement("button"),this.alwaysShowEdgesButton.innerHTML=W("icon-relations",16),this.alwaysShowEdgesButton.setAttribute("aria-label","Toggle edges"),this.alwaysShowEdgesButton.setAttribute("title","Toggle edges"),this.alwaysShowEdgesButton.style.padding="6px",this.alwaysShowEdgesButton.style.border="1px solid #ccc",this.alwaysShowEdgesButton.style.borderRadius="4px",this.alwaysShowEdgesButton.style.backgroundColor="#fff",this.alwaysShowEdgesButton.style.cursor="pointer",this.alwaysShowEdgesButton.style.fontSize="16px",this.alwaysShowEdgesButton.style.width="32px",this.alwaysShowEdgesButton.style.height="32px",this.alwaysShowEdgesButton.style.display="flex",this.alwaysShowEdgesButton.style.alignItems="center",this.alwaysShowEdgesButton.style.justifyContent="center",this.alwaysShowEdgesButton.style.pointerEvents="auto",this.alwaysShowEdgesButton.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)",this.alwaysShowEdgesButton.style.transition="0.2s",this.alwaysShowEdgesButton.style.color="#000000",this.alwaysShowEdgesButton.addEventListener("click",()=>{this.alwaysShowEdges=!this.alwaysShowEdges,this.updateAlwaysShowEdgesButton(),this.onAlwaysShowEdgesChange&&this.onAlwaysShowEdgesChange(this.alwaysShowEdges),this.renderWithoutFit()}),this.lightingToggleButton=document.createElement("button"),this.lightingToggleButton.innerHTML=W("icon-sun",16),this.lightingToggleButton.setAttribute("aria-label","Toggle lighting"),this.lightingToggleButton.setAttribute("title","Toggle lighting"),this.lightingToggleButton.style.padding="6px",this.lightingToggleButton.style.border="1px solid #ccc",this.lightingToggleButton.style.borderRadius="4px",this.lightingToggleButton.style.backgroundColor="#fff",this.lightingToggleButton.style.cursor="pointer",this.lightingToggleButton.style.fontSize="16px",this.lightingToggleButton.style.width="32px",this.lightingToggleButton.style.height="32px",this.lightingToggleButton.style.display="flex",this.lightingToggleButton.style.alignItems="center",this.lightingToggleButton.style.justifyContent="center",this.lightingToggleButton.style.pointerEvents="auto",this.lightingToggleButton.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)",this.lightingToggleButton.style.transition="0.2s",this.lightingToggleButton.addEventListener("click",()=>{const e=this.isLightingEnabled();this.setLighting(!e),this.onLightingChange&&this.onLightingChange(!e)}),this.fitCenterButton=document.createElement("button"),this.fitCenterButton.innerHTML=W("icon-home",16),this.fitCenterButton.setAttribute("aria-label","Fit and center"),this.fitCenterButton.setAttribute("title","Fit and center"),this.fitCenterButton.style.padding="6px",this.fitCenterButton.style.border="1px solid #ccc",this.fitCenterButton.style.borderRadius="4px",this.fitCenterButton.style.backgroundColor="#fff",this.fitCenterButton.style.cursor="pointer",this.fitCenterButton.style.fontSize="16px",this.fitCenterButton.style.width="32px",this.fitCenterButton.style.height="32px",this.fitCenterButton.style.display="flex",this.fitCenterButton.style.alignItems="center",this.fitCenterButton.style.justifyContent="center",this.fitCenterButton.style.pointerEvents="auto",this.fitCenterButton.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)",this.fitCenterButton.style.transition="0.2s",this.fitCenterButton.addEventListener("click",()=>{this.fitToNodes()}),this.tileTypeButton=document.createElement("button"),this.tileTypeButton.innerHTML="ðŸ—ºï¸",this.tileTypeButton.setAttribute("aria-label","Switch tile type"),this.tileTypeButton.style.padding="6px",this.tileTypeButton.style.border="1px solid #ccc",this.tileTypeButton.style.borderRadius="4px",this.tileTypeButton.style.backgroundColor="#fff",this.tileTypeButton.style.cursor="pointer",this.tileTypeButton.style.fontSize="16px",this.tileTypeButton.style.width="32px",this.tileTypeButton.style.height="32px",this.tileTypeButton.style.display="flex",this.tileTypeButton.style.alignItems="center",this.tileTypeButton.style.justifyContent="center",this.tileTypeButton.style.pointerEvents="auto",this.tileTypeButton.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)",this.tileTypeButton.style.transition="0.2s",this.tileTypeButton.addEventListener("click",()=>{this.switchTileType()}),t.appendChild(this.alwaysShowEdgesButton),t.appendChild(this.lightingToggleButton),t.appendChild(this.tileTypeButton),t.appendChild(this.fitCenterButton),this.updateAlwaysShowEdgesButton(),this.updateLightingButton(),this.updateTileTypeButton()}switchTileType(){if(!(!this.viewer||!this.Cesium)&&this.customTileUrls.length>1){this.currentCustomTileIndex=(this.currentCustomTileIndex+1)%this.customTileUrls.length,this.setTileTypeInternal(!0),this.updateTileTypeButton();return}}setTileTypeInternal(t=!1){if(!this.viewer||!this.Cesium)return;const e=(l,a,c,d=!1)=>{const r=g=>String(g).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"),h=`<a href="${r(c)}" target="_blank" rel="noopener noreferrer">${r(a)}</a>`;return new l.Credit(h,d)};if(this.baseImageryLayer)try{this.viewer.imageryLayers.remove(this.baseImageryLayer)}catch(l){console.debug("[Globe3D] Failed to remove baseImageryLayer:",l)}if(this.customTileUrls.length>0){const l=this.customTileUrls[this.currentCustomTileIndex],a=l.url.includes("NaturalEarthII"),c=l.maximumLevel??(a?2:19);let d;if(l.credit){const g=l.credit;g.href?d=e(this.Cesium,g.label,g.href,g.showOnScreen??!1):d=new this.Cesium.Credit(g.label,g.showOnScreen??!1)}else d=new this.Cesium.Credit(`Custom tile server (${this.currentCustomTileIndex+1}/${this.customTileUrls.length})`);const r={url:l.url,maximumLevel:c,credit:d};a&&this.Cesium?.GeographicTilingScheme&&(r.tilingScheme=new this.Cesium.GeographicTilingScheme);const h=new this.Cesium.UrlTemplateImageryProvider(r);this.baseImageryLayer=this.viewer.imageryLayers.addImageryProvider(h,0),this.updateTileTypeButton();return}const i=new this.Cesium.Credit("Â© NASA",!0),s=new this.Cesium.GeographicTilingScheme({rectangle:this.Cesium.Rectangle.fromDegrees(-180,-90,180,90),numberOfLevelZeroTilesX:2,numberOfLevelZeroTilesY:1}),n="/cesium/Assets/Textures/NaturalEarthII/{z}/{x}/{reverseY}.jpg",o=new this.Cesium.UrlTemplateImageryProvider({url:n,maximumLevel:2,tilingScheme:s,credit:i,customTags:{reverseY:(l,a,c,d)=>{const h=Math.pow(2,d)-1-c;return String(h)}}});this.baseImageryLayer=this.viewer.imageryLayers.addImageryProvider(o,0),this.updateTileTypeButton()}updateTileTypeButton(){if(this.tileTypeButton){if(this.customTileUrls.length>1){this.tileTypeButton.style.display="flex";const t=this.currentCustomTileIndex+1,e=this.customTileUrls.length;this.tileTypeButton.setAttribute("title",`Custom tile ${t}/${e}`),this.tileTypeButton.style.backgroundColor="#fff",this.tileTypeButton.style.borderColor="#ccc",this.tileTypeButton.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)",this.tileTypeButton.style.transform="translateY(0)";return}if(this.customTileUrls.length>0){this.tileTypeButton.style.display="none";return}this.tileTypeButton.style.display="none"}}updateAlwaysShowEdgesButton(){this.alwaysShowEdgesButton&&(this.alwaysShowEdges?(this.alwaysShowEdgesButton.setAttribute("aria-label","Hide edges"),this.alwaysShowEdgesButton.setAttribute("title","Hide edges"),this.alwaysShowEdgesButton.style.backgroundColor="#fff9c4",this.alwaysShowEdgesButton.style.color="#000000",this.alwaysShowEdgesButton.style.borderColor="#999",this.alwaysShowEdgesButton.style.boxShadow="inset 0 2px 4px rgba(0, 0, 0, 0.2)",this.alwaysShowEdgesButton.style.transform="translateY(1px)"):(this.alwaysShowEdgesButton.setAttribute("aria-label","Show edges"),this.alwaysShowEdgesButton.setAttribute("title","Show edges"),this.alwaysShowEdgesButton.style.backgroundColor="#fff",this.alwaysShowEdgesButton.style.color="#000000",this.alwaysShowEdgesButton.style.borderColor="#ccc",this.alwaysShowEdgesButton.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)",this.alwaysShowEdgesButton.style.transform="translateY(0)"))}updateLightingButton(){if(!this.lightingToggleButton)return;const t=this.isLightingEnabled();this.lightingToggleButton.innerHTML=W("icon-sun",16),t?(this.lightingToggleButton.style.backgroundColor="#fff9c4",this.lightingToggleButton.style.boxShadow="inset 0 2px 4px rgba(0, 0, 0, 0.2)",this.lightingToggleButton.style.transform="translateY(1px)"):(this.lightingToggleButton.style.backgroundColor="#fff",this.lightingToggleButton.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)",this.lightingToggleButton.style.transform="translateY(0)"),this.lightingToggleButton.style.color="#333"}fitAndCenter(){this.fitToNodes()}fitToNodes(){if(!this.viewer||!this.Cesium||this.nodes.length===0)return;const t=this.nodes.filter(p=>{if(!p.coordinates||!Array.isArray(p.coordinates)||p.coordinates.length!==2)return!1;const[m,T]=p.coordinates;return Number.isFinite(m)&&Number.isFinite(T)}),e=this.nodes.filter(p=>{if(!p.coordinates||!Array.isArray(p.coordinates)||p.coordinates.length!==2)return!0;const[m,T]=p.coordinates;return!Number.isFinite(m)||!Number.isFinite(T)}),i=[],s=[];if(t.forEach(p=>{if(p.coordinates&&p.coordinates.length===2){const[m,T]=p.coordinates;Number.isFinite(m)&&Number.isFinite(T)&&(i.push(m),s.push(T))}}),e.length>0){const B=Math.ceil(Math.sqrt(e.length)),E=50/(Math.ceil(e.length/B)+1),x=32/(B+1);e.forEach((S,A)=>{const v=Math.floor(A/B),L=A%B,I=-50+(v+1)*E,N=-32+(L+1)*x;i.push(I),s.push(N)})}if(i.length===0)return;const n=Math.min(...i),o=Math.max(...i),l=Math.min(...s),a=Math.max(...s),c=(n+o)/2,d=(l+a)/2,r=o-n,h=a-l,g=Math.max(r,h),u=Math.max(1e6,g*111e3*2),f=Math.max(5e5,Math.min(4e7,u));this.viewer.camera.flyTo({destination:this.Cesium.Cartesian3.fromDegrees(d,c,f),orientation:{heading:0,pitch:this.Cesium.Math.toRadians(-90),roll:0},duration:1})}show(){this.container.style.display="block",this.viewer?this.viewer.resize():this.cesiumLoader&&this.initializeCesium().catch(()=>{})}hide(){this.container.style.display="none"}resize(){this.viewer&&this.viewer.resize()}destroy(){this.hidePopup(),this.popupElement&&this.popupElement.parentNode&&(this.popupElement.parentNode.removeChild(this.popupElement),this.popupElement=null),this.viewer&&(this.viewer.destroy(),this.viewer=null),this.nodeEntities.clear(),this.edgeEntities.clear()}createPopup(){const t=document.createElement("div");t.className="relatos-globe3d-popup",t.style.cssText=`
      position: absolute;
      background: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 8px 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      pointer-events: none;
      z-index: 10000;
      font-size: 14px;
      line-height: 1.4;
      max-width: 200px;
      word-wrap: break-word;
      overflow-wrap: break-word;
      white-space: normal;
      opacity: 0;
      transition: opacity 0.2s;
    `;const e=document.createElement("div");return e.style.cssText=`
      position: absolute;
      bottom: -8px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 8px solid transparent;
      border-right: 8px solid transparent;
      border-top: 8px solid white;
    `,t.appendChild(e),this.container.appendChild(t),t}showPopup(t,e){if(!(!this.viewer||!this.Cesium||!t)&&(this.hidePopup(),this.popupElement||(this.popupElement=this.createPopup()),this.popupElement.textContent=e.label,this.popupElement.style.opacity="1",this.popupEntity=t,this.updatePopupPosition(),!this.popupUpdateListener)){const i=()=>{this.popupEntity&&this.popupElement&&this.updatePopupPosition()};this.viewer.scene.postRender.addEventListener(i),this.popupUpdateListener=()=>{this.viewer?.scene.postRender.removeEventListener(i)}}}hidePopup(){this.popupElement&&(this.popupElement.style.opacity="0",setTimeout(()=>{this.popupElement&&this.popupElement.style.opacity==="0"&&(this.popupElement.style.display="none")},200)),this.popupEntity=null,this.popupUpdateListener&&(this.popupUpdateListener(),this.popupUpdateListener=null)}updatePopupPosition(){if(!this.viewer||!this.Cesium||!this.popupEntity||!this.popupElement)return;const t=this.popupEntity.position?.getValue(this.viewer.clock.currentTime);if(!t)return;let e=null;if(this.Cesium.SceneTransforms&&this.Cesium.SceneTransforms.worldToWindowCoordinates?e=this.Cesium.SceneTransforms.worldToWindowCoordinates(this.viewer.scene,t):this.Cesium.SceneTransforms&&this.Cesium.SceneTransforms.wgs84ToWindowCoordinates?e=this.Cesium.SceneTransforms.wgs84ToWindowCoordinates(this.viewer.scene,t):e=this.viewer.camera.project(t),!e){this.popupElement.style.display="none";return}this.popupElement.style.display="block";const i=e.x-this.popupElement.offsetWidth/2,s=e.y-this.popupElement.offsetHeight-15;this.popupElement.style.left=`${i}px`,this.popupElement.style.top=`${s}px`}isEditable(){return!1}}function Y(k,t=16){return D(),`<svg width="${t}" height="${t}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <use href="#${k}"></use>
  </svg>`}class Z{constructor(t,e,i,s,n,o){this.map=null,this.Leaflet=null,this.nodes=[],this.edges=[],this.selectedNodeId=null,this.lastSelectedNodeId=null,this.markers=new Map,this.polylines=new Map,this.rectLayer=null,this.fitCenterButton=null,this.lightingToggleButton=null,this.alwaysShowEdgesButton=null,this.alwaysShowEdges=!0,this.tileTypeButton=null,this.baseTileLayer=null,this.nightShadeLayer=null,this.nightShadeDebugLayer=null,this.lightingEnabled=!1,this.timeISO=null,this.customTileUrls=[],this.currentCustomTileIndex=0,this.container=t,this.onNodeClick=e,this.leafletLoader=i,this.map2dOptions=n,this.onEdgeClick=o;const l=s&&s.length>0?s:n?.customTileUrls;l&&l.length>0?this.customTileUrls=l.map(a=>typeof a=="string"?{url:a}:a):n?.customTileUrl&&(this.customTileUrls=[{url:n.customTileUrl}]),this.container.style.position="relative",this.container.style.width="100%",this.container.style.height="100%"}async initializeLeaflet(){if(this.map)return;if(!this.leafletLoader)throw new Error("Leaflet loader is not provided. Please provide options.loaders.leaflet.");const t=await this.leafletLoader();this.Leaflet=t.default||t;const e=this.map2dOptions?.center||[0,0],i=this.map2dOptions?.zoom||2;let s=5;if(this.customTileUrls.length>0){const o=this.customTileUrls.map(l=>l.maxZoom??l.maximumLevel??19);s=Math.min(...o)}const n={center:e,zoom:i,zoomControl:!1,attributionControl:!0,maxZoom:s};this.customTileUrls.length===0&&(n.crs=this.Leaflet.CRS.EPSG4326),this.map=this.Leaflet.map(this.container,n),this.setupBaseTileLayer(),this.setupTimeAndLighting(),this.lightingEnabled&&this.updateNightShade(),this.setupClickHandler(),(this.nodes.length>0||this.edges.length>0)&&this.render()}setupBaseTileLayer(){if(!this.map||!this.Leaflet)return;this.baseTileLayer&&this.map.removeLayer(this.baseTileLayer);let t;if(this.customTileUrls.length>0){const s=this.customTileUrls[this.currentCustomTileIndex],n=s.maxZoom??s.maximumLevel??19,o=s.tms??!1,l=s.attribution??`Custom tile server (${this.currentCustomTileIndex+1}/${this.customTileUrls.length})`;t=this.Leaflet.tileLayer(s.url,{maxZoom:n,tms:o,attribution:l}),t.addTo(this.map),this.baseTileLayer=t;return}const e="/cesium/Assets/Textures/NaturalEarthII/{z}/{x}/{y}.jpg",i=this.Leaflet.latLngBounds([[-90,-180],[90,180]]);t=this.Leaflet.tileLayer(e,{minZoom:0,maxNativeZoom:2,tms:!0,bounds:i,noWrap:!0,continuousWorld:!1,attribution:"Â© NASA"}),t.addTo(this.map),this.baseTileLayer=t}setupTimeAndLighting(){!this.map||this.Leaflet}setTime(t){this.timeISO=t,this.lightingEnabled&&this.updateNightShade()}setLighting(t){if(this.lightingEnabled!==t){if(this.lightingEnabled=t,!this.map||!this.Leaflet){this.updateLightingButton();return}t?this.updateNightShade():(this.nightShadeLayer&&(this.map.removeLayer(this.nightShadeLayer),this.nightShadeLayer=null),this.nightShadeDebugLayer&&(this.map.removeLayer(this.nightShadeDebugLayer),this.nightShadeDebugLayer=null)),this.updateLightingButton()}}isLightingEnabled(){return this.lightingEnabled}getAlwaysShowEdges(){return this.alwaysShowEdges}setAlwaysShowEdges(t){this.alwaysShowEdges!==t&&(this.alwaysShowEdges=t,this.updateAlwaysShowEdgesButton(),this.renderWithoutFit())}getLightingEnabled(){return this.isLightingEnabled()}setLightingEnabled(t,e=!0){const i=this.lightingEnabled;this.setLighting(t),e&&this.onLightingChange&&this.lightingEnabled!==i&&this.onLightingChange(this.lightingEnabled)}setAlwaysShowEdgesChangeCallback(t){this.onAlwaysShowEdgesChange=t}setLightingChangeCallback(t){this.onLightingChange=t}getTileServerCount(){return this.customTileUrls.length}getTileServerIndex(){return this.currentCustomTileIndex}setTileServerIndex(t){if(this.customTileUrls.length===0)return;const e=this.customTileUrls.length,i=(t%e+e)%e;this.currentCustomTileIndex!==i&&(this.currentCustomTileIndex=i,this.map&&this.Leaflet&&(this.setupBaseTileLayer(),this.updateTileTypeButton()))}cycleTileServer(){this.switchTileType()}updateNightShade(){if(!this.map||!this.Leaflet||(this.nightShadeLayer&&(this.map.removeLayer(this.nightShadeLayer),this.nightShadeLayer=null),this.nightShadeDebugLayer&&(this.map.removeLayer(this.nightShadeDebugLayer),this.nightShadeDebugLayer=null),!this.lightingEnabled))return;const t=this.timeISO||new Date().toISOString(),s=this.calculateTerminatorBoundary(t,720,2);if(!s||s.length===0)return;const n=this.unwrapLongitudes(s);let o=n.map(g=>[g.lat,g.lng]);o.length>0&&(o[0][0]!==o[o.length-1][0]||o[0][1]!==o[o.length-1][1])&&o.push([o[0][0],o[0][1]]);const l=o.map(([g,u])=>({lat:g,lng:u}));this.isCounterClockwise(l)?(o.reverse(),this.map2dOptions?.debugNightShading&&console.debug("[night-shade] Original boundary is CCW, reversed to CW for hole")):this.map2dOptions?.debugNightShading&&console.debug("[night-shade] Original boundary is already CW, using as-is for hole");const c=o.map(([g,u])=>({lat:g,lng:u}));if(this.isCounterClockwise(c)){o.reverse();const g=o.map(([w,y])=>({lat:w,lng:y}));this.isCounterClockwise(g)?this.map2dOptions?.debugNightShading&&console.debug("[night-shade] Warning: Inner ring direction check inconclusive, using current order"):this.map2dOptions?.debugNightShading&&console.debug("[night-shade] Inner ring is CW after second reverse")}else this.map2dOptions?.debugNightShading&&console.debug("[night-shade] Inner ring is CW, ready for use as hole");const r=n.map(g=>[g.lat,g.lng]);r.length>0&&(r[0][0]!==r[r.length-1][0]||r[0][1]!==r[r.length-1][1])&&r.push([r[0][0],r[0][1]]);const h=this.Leaflet.polygon(r,{fillColor:"#000000",fillOpacity:.3,color:"#000000",weight:0,interactive:!1});if(h.addTo(this.map),this.nightShadeLayer=h,this.map2dOptions?.debugNightShading){const g=this.Leaflet.polyline(o,{color:"#ff0000",weight:2,opacity:.8,interactive:!1});g.addTo(this.map),this.nightShadeDebugLayer=g}}isCounterClockwise(t){if(t.length<3)return!1;let e=0;for(let i=0;i<t.length-1;i++){const s=t[i],n=t[i+1];e+=(n.lng-s.lng)*(n.lat+s.lat)}return e>0}unwrapLongitudes(t){if(t.length===0)return t;const e=[{...t[0]}];for(let i=1;i<t.length;i++){let{lat:s,lng:n}=t[i];const o=e[i-1].lng;for(;n-o>180;)n-=360,this.map2dOptions?.debugNightShading&&console.debug("[night-shade] unwrap: adjusted longitude",{index:i,from:t[i].lng,to:n,prevLng:o});for(;n-o<-180;)n+=360,this.map2dOptions?.debugNightShading&&console.debug("[night-shade] unwrap: adjusted longitude",{index:i,from:t[i].lng,to:n,prevLng:o});e.push({lat:s,lng:n})}return e}julian(t){return t.getTime()/864e5+24405875e-1}GMST(t){return(18.697374558+24.06570982441908*(t-2451545))%24}sunEclipticPosition(t){const e=t-2451545;let i=280.46+.9856474*e;i=(i%360+360)%360;let s=357.528+.9856003*e;s=(s%360+360)%360;const n=Math.PI/180,o=i+1.915*Math.sin(s*n)+.02*Math.sin(2*s*n),l=1.00014-.01671*Math.cos(s*n)-.0014*Math.cos(2*s*n);return{lambda:o,R:l}}eclipticObliquity(t){const i=(t-2451545)/36525;return 23.43929111-i*(46.836769/3600-i*(1831e-7/3600+i*(.0020034/3600-i*(576e-9/3600-i*434e-10/3600))))}sunEquatorialPosition(t,e){const i=Math.PI/180,s=180/Math.PI,n=Math.atan(Math.cos(e*i)*Math.tan(t*i))*s,o=Math.asin(Math.sin(e*i)*Math.sin(t*i))*s,l=Math.floor(t/90)*90,a=Math.floor(n/90)*90;return{alpha:n+(l-a),delta:o}}hourAngle(t,e,i){return(i+t/15)*15-e.alpha}terminatorLatitude(t,e){const i=Math.PI/180,s=180/Math.PI;return Math.atan(-Math.cos(t*i)/Math.tan(e.delta*i))*s}calculateTerminatorBoundary(t,e=720,i=2){try{let s;if(t.startsWith("-")){if(s=new Date(t),isNaN(s.getTime()))return null}else if(s=new Date(t),isNaN(s.getTime()))return null;const n=this.julian(s),o=this.GMST(n),l=this.sunEclipticPosition(n),a=this.eclipticObliquity(n),c=this.sunEquatorialPosition(l.lambda,a),d=[];for(let r=0;r<=e*i;r++){const h=-e/2+r/i,g=this.hourAngle(h,c,o),u=this.terminatorLatitude(g,c);d.push({lat:u,lng:h})}return c.delta<0?(d.unshift({lat:90,lng:-e/2}),d.push({lat:90,lng:e/2})):(d.unshift({lat:-90,lng:-e/2}),d.push({lat:-90,lng:e/2})),d.length>0?d:null}catch{return null}}getDayOfYear(t){const e=new Date(t.getFullYear(),0,0),i=t.getTime()-e.getTime(),s=1e3*60*60*24;return Math.floor(i/s)}calculateSolarDeclination(t){return 23.45*Math.PI/180*Math.sin(2*Math.PI*(284+t)/365)*180/Math.PI}setupClickHandler(){!this.map||!this.Leaflet||this.map.on("click",t=>{})}setData(t,e){this.nodes=t,this.edges=e,this.map&&this.Leaflet&&this.render()}selectNode(t){if(!t){this.selectedNodeId=null,this.lastSelectedNodeId=null,this.renderWithoutFit();return}if(!this.map||!this.Leaflet)return;if(t===this.lastSelectedNodeId){this.selectedNodeId=null,this.lastSelectedNodeId=null,this.fitToNodes(),this.renderWithoutFit();return}this.lastSelectedNodeId=t,this.selectedNodeId=t;const e=this.nodes.find(s=>s.id===t);if(!e)return;if(e.coordinates&&e.coordinates.length===2){const[s,n]=e.coordinates;if(Number.isFinite(s)&&Number.isFinite(n)){const[o,l]=e.coordinates;this.renderWithoutFit(),this.map.flyTo([o,l],4,{duration:1,easeLinearity:.25});const a=()=>{const c=this.markers.get(t);c&&c.openPopup(),this.map.off("moveend",a)};this.map.once("moveend",a);return}}const i=this.nodes.filter(s=>{if(!s.coordinates||!Array.isArray(s.coordinates)||s.coordinates.length!==2)return!0;const[n,o]=s.coordinates;return!Number.isFinite(n)||!Number.isFinite(o)});if(i.length>0){const a=Math.ceil(Math.sqrt(i.length)),d=50/(Math.ceil(i.length/a)+1),r=32/(a+1),h=i.findIndex(g=>g.id===t);if(h>=0){const g=Math.floor(h/a),u=h%a,w=-50+(g+1)*d,y=-32+(u+1)*r;this.renderWithoutFit(),this.map.flyTo([w,y],4,{duration:1,easeLinearity:.25});const f=()=>{const p=this.markers.get(t);p&&p.openPopup(),this.map.off("moveend",f)};this.map.once("moveend",f)}}else this.renderWithoutFit()}render(){if(!this.map||!this.Leaflet)return;this.markers.forEach(i=>{this.map.removeLayer(i)}),this.markers.clear(),this.polylines.forEach(i=>{this.map.removeLayer(i)}),this.polylines.clear();const t=this.nodes.filter(i=>{if(!i.coordinates||!Array.isArray(i.coordinates)||i.coordinates.length!==2)return!0;const[s,n]=i.coordinates;return!Number.isFinite(s)||!Number.isFinite(n)}),e=this.nodes.filter(i=>{if(!i.coordinates||!Array.isArray(i.coordinates)||i.coordinates.length!==2)return!1;const[s,n]=i.coordinates;return Number.isFinite(s)&&Number.isFinite(n)});if(t.length>0){const l=this.Leaflet.latLngBounds([-50,-32],[0,0]);this.rectLayer=this.Leaflet.rectangle(l,{color:"#666",fillColor:"#f0f0f0",fillOpacity:.1,weight:1,dashArray:"5,5"}),this.rectLayer.addTo(this.map);const a=Math.ceil(Math.sqrt(t.length)),d=50/(Math.ceil(t.length/a)+1),r=32/(a+1);t.forEach((h,g)=>{const u=Math.floor(g/a),w=g%a,y=-50+(u+1)*d,f=-32+(w+1)*r,p=this.selectedNodeId===h.id,m=h.style?.color||"#ffffff",T=p?"#2196f3":h.style?.borderColor||"#333333",b=`
          <div style="
            width: ${p?15:10}px;
            height: ${p?15:10}px;
            background-color: ${m};
            border: 2px solid ${T};
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
          "></div>
        `,B=this.Leaflet.divIcon({html:b,className:"relatos-node-marker",iconSize:[p?15:10,p?15:10],iconAnchor:[p?7.5:5,p?7.5:5]}),C=this.Leaflet.marker([y,f],{icon:B});C.bindPopup(h.label,{closeButton:!1,offset:[0,-10]}),C.on("click",E=>{if(this.onNodeClick){const x=E.latlng;this.onNodeClick({node:h,position:{x:x.lng,y:x.lat},originalEvent:E.originalEvent})}}),C.addTo(this.map),this.markers.set(h.id,C)})}for(const i of e){const[s,n]=i.coordinates,o=this.selectedNodeId===i.id,l=i.style?.color||"#ffffff",a=o?"#2196f3":i.style?.borderColor||"#333333",c=`
        <div style="
          width: ${o?15:10}px;
          height: ${o?15:10}px;
          background-color: ${l};
          border: 2px solid ${a};
          border-radius: 50%;
          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        "></div>
      `,d=this.Leaflet.divIcon({html:c,className:"relatos-node-marker",iconSize:[o?15:10,o?15:10],iconAnchor:[o?7.5:5,o?7.5:5]}),r=this.Leaflet.marker([s,n],{icon:d});r.bindPopup(i.label,{closeButton:!1,offset:[0,-10]}),r.on("click",h=>{if(this.onNodeClick){const g=h.latlng;this.onNodeClick({node:i,position:{x:g.lng,y:g.lat},originalEvent:h.originalEvent,view:"map2d"})}}),r.addTo(this.map),this.markers.set(i.id,r)}if(this.alwaysShowEdges)for(const i of this.edges){const s=this.nodes.find(u=>u.id===i.src),n=this.nodes.find(u=>u.id===i.dst);if(!s?.coordinates||!n?.coordinates)continue;const[o,l]=s.coordinates,[a,c]=n.coordinates,d=i.style?.color||"#999999",r=i.style?.weight||1,h=Math.max(1,Math.min(5,r)),g=this.Leaflet.polyline([[o,l],[a,c]],{color:d,weight:h,opacity:.7});g.on("click",u=>{if(this.onEdgeClick){const w=u.latlng;this.onEdgeClick({edge:i,position:{x:w.lng,y:w.lat},originalEvent:u.originalEvent,view:"map2d"})}}),g.addTo(this.map),this.polylines.set(i.id,g)}this.fitToNodes()}renderWithoutFit(){if(!this.map||!this.Leaflet)return;this.markers.forEach(i=>{this.map.removeLayer(i)}),this.markers.clear(),this.polylines.forEach(i=>{this.map.removeLayer(i)}),this.polylines.clear(),this.rectLayer&&(this.map.removeLayer(this.rectLayer),this.rectLayer=null);const t=this.nodes.filter(i=>{if(!i.coordinates||!Array.isArray(i.coordinates)||i.coordinates.length!==2)return!0;const[s,n]=i.coordinates;return!Number.isFinite(s)||!Number.isFinite(n)}),e=this.nodes.filter(i=>{if(!i.coordinates||!Array.isArray(i.coordinates)||i.coordinates.length!==2)return!1;const[s,n]=i.coordinates;return Number.isFinite(s)&&Number.isFinite(n)});if(t.length>0){const l=this.Leaflet.latLngBounds([-50,-32],[0,0]);this.rectLayer=this.Leaflet.rectangle(l,{color:"#666",fillColor:"#f0f0f0",fillOpacity:.1,weight:1,dashArray:"5,5"}),this.rectLayer.addTo(this.map);const a=Math.ceil(Math.sqrt(t.length)),d=50/(Math.ceil(t.length/a)+1),r=32/(a+1);t.forEach((h,g)=>{const u=Math.floor(g/a),w=g%a,y=-50+(u+1)*d,f=-32+(w+1)*r,p=this.selectedNodeId===h.id,m=h.style?.color||"#ffffff",T=p?"#2196f3":h.style?.borderColor||"#333333",b=`
          <div style="
            width: ${p?15:10}px;
            height: ${p?15:10}px;
            background-color: ${m};
            border: 2px solid ${T};
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
          "></div>
        `,B=this.Leaflet.divIcon({html:b,className:"relatos-node-marker",iconSize:[p?15:10,p?15:10],iconAnchor:[p?7.5:5,p?7.5:5]}),C=this.Leaflet.marker([y,f],{icon:B});C.bindPopup(h.label,{closeButton:!1,offset:[0,-10]}),C.on("click",E=>{if(this.onNodeClick){const x=E.latlng;this.onNodeClick({node:h,position:{x:x.lng,y:x.lat},originalEvent:E.originalEvent,view:"map2d"})}}),C.addTo(this.map),this.markers.set(h.id,C)})}for(const i of e){const[s,n]=i.coordinates,o=this.selectedNodeId===i.id,l=i.style?.color||"#ffffff",a=o?"#2196f3":i.style?.borderColor||"#333333",c=`
        <div style="
          width: ${o?15:10}px;
          height: ${o?15:10}px;
          background-color: ${l};
          border: 2px solid ${a};
          border-radius: 50%;
          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        "></div>
      `,d=this.Leaflet.divIcon({html:c,className:"relatos-node-marker",iconSize:[o?15:10,o?15:10],iconAnchor:[o?7.5:5,o?7.5:5]}),r=this.Leaflet.marker([s,n],{icon:d});r.bindPopup(i.label,{closeButton:!1,offset:[0,-10]}),r.on("click",h=>{if(this.onNodeClick){const g=h.latlng;this.onNodeClick({node:i,position:{x:g.lng,y:g.lat},originalEvent:h.originalEvent})}}),r.addTo(this.map),this.markers.set(i.id,r)}if(this.alwaysShowEdges)for(const i of this.edges){const s=this.nodes.find(u=>u.id===i.src),n=this.nodes.find(u=>u.id===i.dst);if(!s?.coordinates||!n?.coordinates)continue;const[o,l]=s.coordinates,[a,c]=n.coordinates,d=i.style?.color||"#999999",r=i.style?.weight||1,h=Math.max(1,Math.min(5,r)),g=this.Leaflet.polyline([[o,l],[a,c]],{color:d,weight:h,opacity:.7});g.on("click",u=>{if(this.onEdgeClick){const w=u.latlng;this.onEdgeClick({edge:i,position:{x:w.lng,y:w.lat},originalEvent:u.originalEvent,view:"map2d"})}}),g.addTo(this.map),this.polylines.set(i.id,g)}}createControlButtons(){if(!this.container)return;let t=this.container.querySelector(".relatos-map2d-controls");t||(t=document.createElement("div"),t.className="relatos-map2d-controls",t.style.position="absolute",t.style.top="8px",t.style.right="8px",t.style.display="flex",t.style.gap="4px",t.style.zIndex="1000",t.style.pointerEvents="none",this.container.appendChild(t)),this.alwaysShowEdgesButton=document.createElement("button"),this.alwaysShowEdgesButton.innerHTML=Y("icon-relations",16),this.alwaysShowEdgesButton.setAttribute("aria-label","Toggle edges"),this.alwaysShowEdgesButton.setAttribute("title","Toggle edges"),this.alwaysShowEdgesButton.style.padding="6px",this.alwaysShowEdgesButton.style.border="1px solid #ccc",this.alwaysShowEdgesButton.style.borderRadius="4px",this.alwaysShowEdgesButton.style.backgroundColor="#fff",this.alwaysShowEdgesButton.style.cursor="pointer",this.alwaysShowEdgesButton.style.fontSize="16px",this.alwaysShowEdgesButton.style.width="32px",this.alwaysShowEdgesButton.style.height="32px",this.alwaysShowEdgesButton.style.display="flex",this.alwaysShowEdgesButton.style.alignItems="center",this.alwaysShowEdgesButton.style.justifyContent="center",this.alwaysShowEdgesButton.style.pointerEvents="auto",this.alwaysShowEdgesButton.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)",this.alwaysShowEdgesButton.style.transition="0.2s",this.alwaysShowEdgesButton.style.color="#000000",this.alwaysShowEdgesButton.addEventListener("click",()=>{this.alwaysShowEdges=!this.alwaysShowEdges,this.updateAlwaysShowEdgesButton(),this.onAlwaysShowEdgesChange&&this.onAlwaysShowEdgesChange(this.alwaysShowEdges),this.renderWithoutFit()}),this.lightingToggleButton=document.createElement("button"),this.lightingToggleButton.innerHTML=Y("icon-sun",16),this.lightingToggleButton.setAttribute("aria-label","Toggle lighting"),this.lightingToggleButton.setAttribute("title","Toggle lighting"),this.lightingToggleButton.style.padding="6px",this.lightingToggleButton.style.border="1px solid #ccc",this.lightingToggleButton.style.borderRadius="4px",this.lightingToggleButton.style.backgroundColor="#fff",this.lightingToggleButton.style.cursor="pointer",this.lightingToggleButton.style.fontSize="16px",this.lightingToggleButton.style.width="32px",this.lightingToggleButton.style.height="32px",this.lightingToggleButton.style.display="flex",this.lightingToggleButton.style.alignItems="center",this.lightingToggleButton.style.justifyContent="center",this.lightingToggleButton.style.pointerEvents="auto",this.lightingToggleButton.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)",this.lightingToggleButton.style.transition="0.2s",this.lightingToggleButton.addEventListener("click",()=>{const e=this.isLightingEnabled();this.setLighting(!e),this.onLightingChange&&this.onLightingChange(!e)}),this.fitCenterButton=document.createElement("button"),this.fitCenterButton.innerHTML=Y("icon-home",16),this.fitCenterButton.setAttribute("aria-label","Fit and center"),this.fitCenterButton.setAttribute("title","Fit and center"),this.fitCenterButton.style.padding="6px",this.fitCenterButton.style.border="1px solid #ccc",this.fitCenterButton.style.borderRadius="4px",this.fitCenterButton.style.backgroundColor="#fff",this.fitCenterButton.style.cursor="pointer",this.fitCenterButton.style.fontSize="16px",this.fitCenterButton.style.width="32px",this.fitCenterButton.style.height="32px",this.fitCenterButton.style.display="flex",this.fitCenterButton.style.alignItems="center",this.fitCenterButton.style.justifyContent="center",this.fitCenterButton.style.pointerEvents="auto",this.fitCenterButton.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)",this.fitCenterButton.style.transition="0.2s",this.fitCenterButton.addEventListener("click",()=>{this.fitToNodes()}),this.tileTypeButton=document.createElement("button"),this.tileTypeButton.innerHTML="ðŸ—ºï¸",this.tileTypeButton.setAttribute("aria-label","Switch tile type"),this.tileTypeButton.style.padding="6px",this.tileTypeButton.style.border="1px solid #ccc",this.tileTypeButton.style.borderRadius="4px",this.tileTypeButton.style.backgroundColor="#fff",this.tileTypeButton.style.cursor="pointer",this.tileTypeButton.style.fontSize="16px",this.tileTypeButton.style.width="32px",this.tileTypeButton.style.height="32px",this.tileTypeButton.style.display="flex",this.tileTypeButton.style.alignItems="center",this.tileTypeButton.style.justifyContent="center",this.tileTypeButton.style.pointerEvents="auto",this.tileTypeButton.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)",this.tileTypeButton.style.transition="0.2s",this.tileTypeButton.addEventListener("click",()=>{this.switchTileType()}),t.appendChild(this.alwaysShowEdgesButton),t.appendChild(this.lightingToggleButton),t.appendChild(this.tileTypeButton),t.appendChild(this.fitCenterButton),this.updateAlwaysShowEdgesButton(),this.updateLightingButton(),this.updateTileTypeButton()}switchTileType(){if(this.customTileUrls.length>1){this.currentCustomTileIndex=(this.currentCustomTileIndex+1)%this.customTileUrls.length,this.setupBaseTileLayer(),this.updateTileTypeButton();return}}updateTileTypeButton(){if(this.tileTypeButton){if(this.customTileUrls.length>1){this.tileTypeButton.style.display="flex";const t=this.currentCustomTileIndex+1,e=this.customTileUrls.length;this.tileTypeButton.setAttribute("title",`Custom tile ${t}/${e}`),this.tileTypeButton.style.backgroundColor="#fff",this.tileTypeButton.style.borderColor="#ccc",this.tileTypeButton.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)",this.tileTypeButton.style.transform="translateY(0)";return}if(this.customTileUrls.length>0){this.tileTypeButton.style.display="none";return}this.tileTypeButton.style.display="none"}}updateAlwaysShowEdgesButton(){this.alwaysShowEdgesButton&&(this.alwaysShowEdges?(this.alwaysShowEdgesButton.setAttribute("aria-label","Hide edges"),this.alwaysShowEdgesButton.setAttribute("title","Hide edges"),this.alwaysShowEdgesButton.style.backgroundColor="#fff9c4",this.alwaysShowEdgesButton.style.color="#000000",this.alwaysShowEdgesButton.style.borderColor="#999",this.alwaysShowEdgesButton.style.boxShadow="inset 0 2px 4px rgba(0, 0, 0, 0.2)",this.alwaysShowEdgesButton.style.transform="translateY(1px)"):(this.alwaysShowEdgesButton.setAttribute("aria-label","Show edges"),this.alwaysShowEdgesButton.setAttribute("title","Show edges"),this.alwaysShowEdgesButton.style.backgroundColor="#fff",this.alwaysShowEdgesButton.style.color="#000000",this.alwaysShowEdgesButton.style.borderColor="#ccc",this.alwaysShowEdgesButton.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)",this.alwaysShowEdgesButton.style.transform="translateY(0)"))}updateLightingButton(){if(!this.lightingToggleButton)return;const t=this.isLightingEnabled();this.lightingToggleButton.innerHTML=Y("icon-sun",16),t?(this.lightingToggleButton.style.backgroundColor="#fff9c4",this.lightingToggleButton.style.boxShadow="inset 0 2px 4px rgba(0, 0, 0, 0.2)",this.lightingToggleButton.style.transform="translateY(1px)"):(this.lightingToggleButton.style.backgroundColor="#fff",this.lightingToggleButton.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)",this.lightingToggleButton.style.transform="translateY(0)"),this.lightingToggleButton.style.color="#333"}fitAndCenter(){this.fitToNodes()}fitToNodes(){if(!this.map||!this.Leaflet||this.nodes.length===0)return;const t=this.nodes.filter(d=>{if(!d.coordinates||!Array.isArray(d.coordinates)||d.coordinates.length!==2)return!1;const[r,h]=d.coordinates;return Number.isFinite(r)&&Number.isFinite(h)}),e=this.nodes.filter(d=>{if(!d.coordinates||!Array.isArray(d.coordinates)||d.coordinates.length!==2)return!0;const[r,h]=d.coordinates;return!Number.isFinite(r)||!Number.isFinite(h)}),i=[],s=[];if(t.forEach(d=>{if(d.coordinates&&d.coordinates.length===2){const[r,h]=d.coordinates;Number.isFinite(r)&&Number.isFinite(h)&&(i.push(r),s.push(h))}}),e.length>0){const u=Math.ceil(Math.sqrt(e.length)),y=50/(Math.ceil(e.length/u)+1),f=32/(u+1);e.forEach((p,m)=>{const T=Math.floor(m/u),b=m%u,B=-50+(T+1)*y,C=-32+(b+1)*f;i.push(B),s.push(C)})}if(i.length===0)return;const n=Math.min(...i),o=Math.max(...i),l=Math.min(...s),a=Math.max(...s),c=this.Leaflet.latLngBounds([n,l],[o,a]);this.map.flyToBounds(c,{padding:[20,20],maxZoom:5,duration:1,easeLinearity:.25})}show(){this.container.style.display="block",this.map?this.map.invalidateSize():this.leafletLoader&&this.initializeLeaflet().catch(()=>{})}hide(){this.container.style.display="none"}resize(){this.map&&this.map.invalidateSize()}destroy(){this.map&&(this.map.remove(),this.map=null),this.markers.clear(),this.polylines.clear()}isEditable(){return!1}}function J(k,t={}){D();let e;if(typeof k=="string"){const r=document.querySelector(k);if(!r||!(r instanceof HTMLElement))throw new Error(`Container element not found: ${k}`);e=r}else e=k;const i=t.enabledViews||["graph","map2d","globe3d"],s=t.initialView||(i.includes("map2d")?"map2d":i[0]),n=t.graph?.mode||"view",o=t.graph?.editable||!1,l=t.tileServers,a=new j(e,i);t.time&&a.setTime(t.time),typeof t.enableLighting=="boolean"&&a.setLightingEnabled(t.enableLighting),t.tables&&a.setTableOptions(t.tables),t.events?.onNodeClick&&a.setOnNodeClickCallback(t.events.onNodeClick);const c=t.events?.onNodeClick?r=>{t.events.onNodeClick(r),a.highlightNodeRow(r.node.id)}:void 0,d=r=>{t.events?.onEdgeClick&&t.events.onEdgeClick(r),a.highlightEdgeRow(r.edge.id)};if(i.includes("graph")){const r=document.createElement("div");r.style.width="100%",r.style.height="100%",a.getViewContainer().appendChild(r);const h=new q(r,c||t.events?.onNodeClick,t.events?.onSave,o,d);h.setModeChangeCallback(()=>{a.updateEditToggleButton(),a.updateGraphButtons()}),h.setAlwaysShowEdgesChangeCallback(g=>{a.setAlwaysShowEdges(g)}),h.setGraphButtonsUpdateCallback(()=>{a.updateGraphButtons()}),h.setMode(n),t.data&&h.setData(t.data.nodes,t.data.edges),a.registerView("graph",h)}if(i.includes("map2d")&&t.loaders?.leaflet){const r=document.createElement("div");r.style.width="100%",r.style.height="100%",a.getViewContainer().appendChild(r);const h=new Z(r,c||t.events?.onNodeClick,t.loaders.leaflet,l,t.map2d,d);h.setAlwaysShowEdgesChangeCallback(g=>{a.setAlwaysShowEdges(g)}),h.setLightingChangeCallback(g=>{a.setLightingEnabled(g)}),t.data&&h.setData(t.data.nodes,t.data.edges),a.registerView("map2d",h)}if(i.includes("globe3d")&&t.loaders?.cesium)try{const r=document.createElement("div");r.style.width="100%",r.style.height="100%",a.getViewContainer().appendChild(r);const h=new K(r,c||t.events?.onNodeClick,t.loaders.cesium,t.globe3d?{customTileUrl:t.globe3d.customTileUrl,customTileUrls:t.globe3d.customTileUrls}:void 0,l,d);h.setAlwaysShowEdgesChangeCallback(g=>{a.setAlwaysShowEdges(g)}),h.setLightingChangeCallback(g=>{a.setLightingEnabled(g)}),t.data&&h.setData(t.data.nodes,t.data.edges),a.registerView("globe3d",h)}catch{}return a.setInitialView(s),t.data&&a.setData(t.data.nodes,t.data.edges),{setData(r){const h=a.getView("graph");h&&h.setData(r.nodes,r.edges);const g=a.getView("map2d");g&&g.setData(r.nodes,r.edges);const u=a.getView("globe3d");u&&u.setData(r.nodes,r.edges),a.setData(r.nodes,r.edges)},setView(r){a.switchView(r)},getView(){const r=a.getCurrentView();if(!r)throw new Error("No view is currently active");return r},setMode(r){const h=a.getView("graph");h&&h.setMode(r)},getMode(){const r=a.getView("graph");return r?r.getMode():null},resize(){a.resize()},destroy(){a.destroy()},selectNode(r){const h=a.getView("graph");h&&h.selectNode&&h.selectNode(r);const g=a.getView("map2d");g&&g.selectNode&&g.selectNode(r);const u=a.getView("globe3d");u&&u.selectNode&&u.selectNode(r)},setTime(r){a.setTime(r)},setLighting(r){a.setLightingEnabled(r)}}}_.createRelatosViewer=J,Object.defineProperty(_,Symbol.toStringTag,{value:"Module"})}));
