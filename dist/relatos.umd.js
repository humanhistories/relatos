(function(F,Ht){typeof exports=="object"&&typeof module<"u"?Ht(exports):typeof define=="function"&&define.amd?define(["exports"],Ht):(F=typeof globalThis<"u"?globalThis:F||self,Ht(F.Relatos={}))})(this,(function(F){"use strict";const Ht=`<!-- relatos/src/assets/icons/icons.svg -->
<svg xmlns="http://www.w3.org/2000/svg" style="display:none">
  <!-- =========================================
       Edit (pencil) : toggle "edit relations"
       ========================================= -->
  <symbol id="icon-edit" viewBox="0 0 24 24">
    <path
      d="M12 20h9"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
    <path
      d="M16.5 3.5a2.12 2.12 0 0 1 3 3L8 18l-4 1 1-4 11.5-11.5z"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
  </symbol>

  <!-- =========================================
       Sun (day/night shading toggle)
       ========================================= -->
  <symbol id="icon-sun" viewBox="0 0 24 24">
    <circle
      cx="12"
      cy="12"
      r="4"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
    <path
      d="M12 2v2"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
    <path
      d="M12 20v2"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
    <path
      d="M2 12h2"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
    <path
      d="M20 12h2"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
    <path
      d="M4.93 4.93l1.41 1.41"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
    <path
      d="M17.66 17.66l1.41 1.41"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
    <path
      d="M19.07 4.93l-1.41 1.41"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
    <path
      d="M6.34 17.66l-1.41 1.41"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
  </symbol>

  <!-- =========================================
       Home (fit to graph / reset view)
       ========================================= -->
  <symbol id="icon-home" viewBox="0 0 24 24">
    <path
      d="M3 10.5l9-7 9 7"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
    <path
      d="M5 9.8V20a1 1 0 0 0 1 1h4v-6h4v6h4a1 1 0 0 0 1-1V9.8"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
  </symbol>

  <!-- =========================================
       Relations (edges show/hide toggle)
       - Universal: 3 nodes + connections
       ========================================= -->
  <symbol id="icon-relations" viewBox="0 0 24 24">
    <circle
      cx="6.5"
      cy="7"
      r="2.5"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
    <circle
      cx="17.5"
      cy="6.5"
      r="2.5"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
    <circle
      cx="12"
      cy="17.5"
      r="2.5"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
    <path
      d="M8.8 7.7l6.4-0.6"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
    <path
      d="M8.2 9.1l2.7 6"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
    <path
      d="M16.2 8.6l-2.6 6.1"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
  </symbol>

  <!-- Close / Cancel: circle with X (for Cancel edit button) -->
  <symbol id="icon-close" viewBox="0 0 24 24">
    <circle
      cx="12"
      cy="12"
      r="10"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
    />
    <path
      d="M8 8l8 8M16 8l-8 8"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
    />
  </symbol>

  <!-- =========================================
       Undo / Restore previous state
       - Universal: curved left arrow (undo)
       ========================================= -->
  <symbol id="icon-undo" viewBox="0 0 24 24">
    <path
      d="M7 7L10.5 3.5"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
    <path
      d="M7 7L10.5 10.5"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />

    <path
      d="M7 7h6.5a7.5 7.5 0 0 1 0 15H6"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
  </symbol>

  <!-- =========================================
       Redo: curved right arrow (mirror of undo)
       ========================================= -->
  <symbol id="icon-redo" viewBox="0 0 24 24">
    <path
      d="M17 7L13.5 3.5"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
    <path
      d="M17 7L13.5 10.5"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
    <path
      d="M17 7h-6.5a7.5 7.5 0 0 0 0 15H18"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
  </symbol>

  <symbol id="icon-view-graph" viewBox="0 0 24 24">
    <!-- Left node (pushed to the left) -->
    <rect
      x="2.5"
      y="8.5"
      width="5"
      height="7"
      rx="1.5"
      ry="1.5"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
    />

    <!-- Right node (pushed to the right) -->
    <rect
      x="16.5"
      y="8.5"
      width="5"
      height="7"
      rx="1.5"
      ry="1.5"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
    />

    <!-- Bidirectional arrow (long and clear) -->
    <path
      d="M8.8 12h6.4"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
    />

    <!-- Left arrow head (points left) -->
    <path
      d="M8.8 12l1.8-1.8"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
    <path
      d="M8.8 12l1.8 1.8"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />

    <!-- Right arrow head (points right) -->
    <path
      d="M15.2 12l-1.8-1.8"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
    <path
      d="M15.2 12l-1.8 1.8"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
  </symbol>

  <symbol id="icon-view-globe3d" viewBox="0 0 24 24">
    <!-- Globe outline: as large as possible inside viewBox -->
    <circle
      cx="12"
      cy="12"
      r="11"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
    />

    <!-- Left node (pushed left) -->
    <rect
      x="4.2"
      y="8.5"
      width="4.6"
      height="7"
      rx="1.3"
      ry="1.3"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
    />
    <!-- Right node (pushed right) -->
    <rect
      x="15.2"
      y="8.5"
      width="4.6"
      height="7"
      rx="1.3"
      ry="1.3"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
    />

    <!-- Bidirectional arrow (longer, not crushed) -->
    <path
      d="M9.6 12h4.8"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
    />
    <!-- Left arrow head (points left) -->
    <path
      d="M9.6 12l1.6-1.6"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
    <path
      d="M9.6 12l1.6 1.6"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
    <!-- Right arrow head (points right) -->
    <path
      d="M14.4 12l-1.6-1.6"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
    <path
      d="M14.4 12l-1.6 1.6"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
  </symbol>

  <symbol id="icon-view-map" viewBox="0 0 24 24">
    <!-- Map frame: as large as possible inside viewBox -->
    <rect
      x="1"
      y="3"
      width="22"
      height="18"
      rx="3"
      ry="3"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
    />

    <!-- Left node (pushed left) -->
    <rect
      x="4.2"
      y="8.5"
      width="4.6"
      height="7"
      rx="1.3"
      ry="1.3"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
    />
    <!-- Right node (pushed right) -->
    <rect
      x="15.2"
      y="8.5"
      width="4.6"
      height="7"
      rx="1.3"
      ry="1.3"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
    />

    <!-- Bidirectional arrow (longer, not crushed) -->
    <path
      d="M9.6 12h4.8"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
    />
    <!-- Left arrow head (points left) -->
    <path
      d="M9.6 12l1.6-1.6"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
    <path
      d="M9.6 12l1.6 1.6"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
    <!-- Right arrow head (points right) -->
    <path
      d="M14.4 12l-1.6-1.6"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
    <path
      d="M14.4 12l-1.6 1.6"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
  </symbol>

  <symbol id="icon-map-tiles" viewBox="0 0 24 24">
    <!-- Top-left (filled) -->
    <rect
      x="4"
      y="4"
      width="7"
      height="7"
      rx="1.2"
      ry="1.2"
      fill="currentColor"
      stroke="currentColor"
      stroke-width="2"
    />
    <!-- Top-right (outline) -->
    <rect
      x="14"
      y="4"
      width="7"
      height="7"
      rx="1.2"
      ry="1.2"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
    />
    <!-- Bottom-left (outline) -->
    <rect
      x="4"
      y="14"
      width="7"
      height="7"
      rx="1.2"
      ry="1.2"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
    />
    <!-- Bottom-right (filled) -->
    <rect
      x="14"
      y="14"
      width="7"
      height="7"
      rx="1.2"
      ry="1.2"
      fill="currentColor"
      stroke="currentColor"
      stroke-width="2"
    />
  </symbol>

  <!-- =========================================
       Export (share/external link icon)
       - For PlantUML export functionality
       ========================================= -->
  <symbol id="icon-export" viewBox="0 0 24 24">
    <!-- Box -->
    <path
      d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
    <!-- Arrow up -->
    <polyline
      points="17 8 12 3 7 8"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
    <line
      x1="12"
      y1="3"
      x2="12"
      y2="15"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
  </symbol>

  <!-- =========================================
       Trash (delete bend point / remove)
       - Universal: trash can with lid
       ========================================= -->
  <symbol id="icon-trash" viewBox="0 0 24 24">
    <!-- Lid -->
    <path
      d="M4 7h16"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
    <!-- Handle -->
    <path
      d="M10 4h4"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
    <!-- Top cap -->
    <path
      d="M9 6h6"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
    <!-- Can body -->
    <path
      d="M7 7l1 14h8l1-14"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linejoin="round"
    />
    <!-- Inner lines -->
    <path
      d="M10 11v7"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
    />
    <path
      d="M14 11v7"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
    />
  </symbol>

</svg>`;let Ae=!1;const di="relatos-icons-sprite";function St(){if(Ae)return;if(document.getElementById(di)){Ae=!0;return}const i=document.createElement("div");i.id=di,i.style.display="none",i.innerHTML=Ht,document.body.appendChild(i),Ae=!0}const Fn=4,ci=0,ui=1,Yn=2;function kt(i){let e=i.length;for(;--e>=0;)i[e]=0}const $n=0,gi=1,Wn=2,Vn=3,jn=258,Be=29,Gt=256,Ut=Gt+1+Be,Lt=30,Se=19,fi=2*Ut+1,bt=15,ke=16,Zn=7,Le=256,pi=16,yi=17,mi=18,Me=new Uint8Array([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0]),le=new Uint8Array([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13]),Kn=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7]),wi=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),qn=512,ot=new Array((Ut+2)*2);kt(ot);const Xt=new Array(Lt*2);kt(Xt);const Ft=new Array(qn);kt(Ft);const Yt=new Array(jn-Vn+1);kt(Yt);const Ie=new Array(Be);kt(Ie);const he=new Array(Lt);kt(he);function Ne(i,e,t,n,s){this.static_tree=i,this.extra_bits=e,this.extra_base=t,this.elems=n,this.max_length=s,this.has_stree=i&&i.length}let bi,_i,Ei;function De(i,e){this.dyn_tree=i,this.max_code=0,this.stat_desc=e}const Ci=i=>i<256?Ft[i]:Ft[256+(i>>>7)],$t=(i,e)=>{i.pending_buf[i.pending++]=e&255,i.pending_buf[i.pending++]=e>>>8&255},X=(i,e,t)=>{i.bi_valid>ke-t?(i.bi_buf|=e<<i.bi_valid&65535,$t(i,i.bi_buf),i.bi_buf=e>>ke-i.bi_valid,i.bi_valid+=t-ke):(i.bi_buf|=e<<i.bi_valid&65535,i.bi_valid+=t)},K=(i,e,t)=>{X(i,t[e*2],t[e*2+1])},xi=(i,e)=>{let t=0;do t|=i&1,i>>>=1,t<<=1;while(--e>0);return t>>>1},Jn=i=>{i.bi_valid===16?($t(i,i.bi_buf),i.bi_buf=0,i.bi_valid=0):i.bi_valid>=8&&(i.pending_buf[i.pending++]=i.bi_buf&255,i.bi_buf>>=8,i.bi_valid-=8)},Qn=(i,e)=>{const t=e.dyn_tree,n=e.max_code,s=e.stat_desc.static_tree,o=e.stat_desc.has_stree,a=e.stat_desc.extra_bits,r=e.stat_desc.extra_base,h=e.stat_desc.max_length;let l,d,f,c,u,g,p=0;for(c=0;c<=bt;c++)i.bl_count[c]=0;for(t[i.heap[i.heap_max]*2+1]=0,l=i.heap_max+1;l<fi;l++)d=i.heap[l],c=t[t[d*2+1]*2+1]+1,c>h&&(c=h,p++),t[d*2+1]=c,!(d>n)&&(i.bl_count[c]++,u=0,d>=r&&(u=a[d-r]),g=t[d*2],i.opt_len+=g*(c+u),o&&(i.static_len+=g*(s[d*2+1]+u)));if(p!==0){do{for(c=h-1;i.bl_count[c]===0;)c--;i.bl_count[c]--,i.bl_count[c+1]+=2,i.bl_count[h]--,p-=2}while(p>0);for(c=h;c!==0;c--)for(d=i.bl_count[c];d!==0;)f=i.heap[--l],!(f>n)&&(t[f*2+1]!==c&&(i.opt_len+=(c-t[f*2+1])*t[f*2],t[f*2+1]=c),d--)}},Ti=(i,e,t)=>{const n=new Array(bt+1);let s=0,o,a;for(o=1;o<=bt;o++)s=s+t[o-1]<<1,n[o]=s;for(a=0;a<=e;a++){let r=i[a*2+1];r!==0&&(i[a*2]=xi(n[r]++,r))}},ts=()=>{let i,e,t,n,s;const o=new Array(bt+1);for(t=0,n=0;n<Be-1;n++)for(Ie[n]=t,i=0;i<1<<Me[n];i++)Yt[t++]=n;for(Yt[t-1]=n,s=0,n=0;n<16;n++)for(he[n]=s,i=0;i<1<<le[n];i++)Ft[s++]=n;for(s>>=7;n<Lt;n++)for(he[n]=s<<7,i=0;i<1<<le[n]-7;i++)Ft[256+s++]=n;for(e=0;e<=bt;e++)o[e]=0;for(i=0;i<=143;)ot[i*2+1]=8,i++,o[8]++;for(;i<=255;)ot[i*2+1]=9,i++,o[9]++;for(;i<=279;)ot[i*2+1]=7,i++,o[7]++;for(;i<=287;)ot[i*2+1]=8,i++,o[8]++;for(Ti(ot,Ut+1,o),i=0;i<Lt;i++)Xt[i*2+1]=5,Xt[i*2]=xi(i,5);bi=new Ne(ot,Me,Gt+1,Ut,bt),_i=new Ne(Xt,le,0,Lt,bt),Ei=new Ne(new Array(0),Kn,0,Se,Zn)},vi=i=>{let e;for(e=0;e<Ut;e++)i.dyn_ltree[e*2]=0;for(e=0;e<Lt;e++)i.dyn_dtree[e*2]=0;for(e=0;e<Se;e++)i.bl_tree[e*2]=0;i.dyn_ltree[Le*2]=1,i.opt_len=i.static_len=0,i.sym_next=i.matches=0},Ai=i=>{i.bi_valid>8?$t(i,i.bi_buf):i.bi_valid>0&&(i.pending_buf[i.pending++]=i.bi_buf),i.bi_buf=0,i.bi_valid=0},Bi=(i,e,t,n)=>{const s=e*2,o=t*2;return i[s]<i[o]||i[s]===i[o]&&n[e]<=n[t]},Re=(i,e,t)=>{const n=i.heap[t];let s=t<<1;for(;s<=i.heap_len&&(s<i.heap_len&&Bi(e,i.heap[s+1],i.heap[s],i.depth)&&s++,!Bi(e,n,i.heap[s],i.depth));)i.heap[t]=i.heap[s],t=s,s<<=1;i.heap[t]=n},Si=(i,e,t)=>{let n,s,o=0,a,r;if(i.sym_next!==0)do n=i.pending_buf[i.sym_buf+o++]&255,n+=(i.pending_buf[i.sym_buf+o++]&255)<<8,s=i.pending_buf[i.sym_buf+o++],n===0?K(i,s,e):(a=Yt[s],K(i,a+Gt+1,e),r=Me[a],r!==0&&(s-=Ie[a],X(i,s,r)),n--,a=Ci(n),K(i,a,t),r=le[a],r!==0&&(n-=he[a],X(i,n,r)));while(o<i.sym_next);K(i,Le,e)},Pe=(i,e)=>{const t=e.dyn_tree,n=e.stat_desc.static_tree,s=e.stat_desc.has_stree,o=e.stat_desc.elems;let a,r,h=-1,l;for(i.heap_len=0,i.heap_max=fi,a=0;a<o;a++)t[a*2]!==0?(i.heap[++i.heap_len]=h=a,i.depth[a]=0):t[a*2+1]=0;for(;i.heap_len<2;)l=i.heap[++i.heap_len]=h<2?++h:0,t[l*2]=1,i.depth[l]=0,i.opt_len--,s&&(i.static_len-=n[l*2+1]);for(e.max_code=h,a=i.heap_len>>1;a>=1;a--)Re(i,t,a);l=o;do a=i.heap[1],i.heap[1]=i.heap[i.heap_len--],Re(i,t,1),r=i.heap[1],i.heap[--i.heap_max]=a,i.heap[--i.heap_max]=r,t[l*2]=t[a*2]+t[r*2],i.depth[l]=(i.depth[a]>=i.depth[r]?i.depth[a]:i.depth[r])+1,t[a*2+1]=t[r*2+1]=l,i.heap[1]=l++,Re(i,t,1);while(i.heap_len>=2);i.heap[--i.heap_max]=i.heap[1],Qn(i,e),Ti(t,h,i.bl_count)},ki=(i,e,t)=>{let n,s=-1,o,a=e[1],r=0,h=7,l=4;for(a===0&&(h=138,l=3),e[(t+1)*2+1]=65535,n=0;n<=t;n++)o=a,a=e[(n+1)*2+1],!(++r<h&&o===a)&&(r<l?i.bl_tree[o*2]+=r:o!==0?(o!==s&&i.bl_tree[o*2]++,i.bl_tree[pi*2]++):r<=10?i.bl_tree[yi*2]++:i.bl_tree[mi*2]++,r=0,s=o,a===0?(h=138,l=3):o===a?(h=6,l=3):(h=7,l=4))},Li=(i,e,t)=>{let n,s=-1,o,a=e[1],r=0,h=7,l=4;for(a===0&&(h=138,l=3),n=0;n<=t;n++)if(o=a,a=e[(n+1)*2+1],!(++r<h&&o===a)){if(r<l)do K(i,o,i.bl_tree);while(--r!==0);else o!==0?(o!==s&&(K(i,o,i.bl_tree),r--),K(i,pi,i.bl_tree),X(i,r-3,2)):r<=10?(K(i,yi,i.bl_tree),X(i,r-3,3)):(K(i,mi,i.bl_tree),X(i,r-11,7));r=0,s=o,a===0?(h=138,l=3):o===a?(h=6,l=3):(h=7,l=4)}},es=i=>{let e;for(ki(i,i.dyn_ltree,i.l_desc.max_code),ki(i,i.dyn_dtree,i.d_desc.max_code),Pe(i,i.bl_desc),e=Se-1;e>=3&&i.bl_tree[wi[e]*2+1]===0;e--);return i.opt_len+=3*(e+1)+5+5+4,e},is=(i,e,t,n)=>{let s;for(X(i,e-257,5),X(i,t-1,5),X(i,n-4,4),s=0;s<n;s++)X(i,i.bl_tree[wi[s]*2+1],3);Li(i,i.dyn_ltree,e-1),Li(i,i.dyn_dtree,t-1)},ns=i=>{let e=4093624447,t;for(t=0;t<=31;t++,e>>>=1)if(e&1&&i.dyn_ltree[t*2]!==0)return ci;if(i.dyn_ltree[18]!==0||i.dyn_ltree[20]!==0||i.dyn_ltree[26]!==0)return ui;for(t=32;t<Gt;t++)if(i.dyn_ltree[t*2]!==0)return ui;return ci};let Mi=!1;const ss=i=>{Mi||(ts(),Mi=!0),i.l_desc=new De(i.dyn_ltree,bi),i.d_desc=new De(i.dyn_dtree,_i),i.bl_desc=new De(i.bl_tree,Ei),i.bi_buf=0,i.bi_valid=0,vi(i)},Ii=(i,e,t,n)=>{X(i,($n<<1)+(n?1:0),3),Ai(i),$t(i,t),$t(i,~t),t&&i.pending_buf.set(i.window.subarray(e,e+t),i.pending),i.pending+=t},os=i=>{X(i,gi<<1,3),K(i,Le,ot),Jn(i)},rs=(i,e,t,n)=>{let s,o,a=0;i.level>0?(i.strm.data_type===Yn&&(i.strm.data_type=ns(i)),Pe(i,i.l_desc),Pe(i,i.d_desc),a=es(i),s=i.opt_len+3+7>>>3,o=i.static_len+3+7>>>3,o<=s&&(s=o)):s=o=t+5,t+4<=s&&e!==-1?Ii(i,e,t,n):i.strategy===Fn||o===s?(X(i,(gi<<1)+(n?1:0),3),Si(i,ot,Xt)):(X(i,(Wn<<1)+(n?1:0),3),is(i,i.l_desc.max_code+1,i.d_desc.max_code+1,a+1),Si(i,i.dyn_ltree,i.dyn_dtree)),vi(i),n&&Ai(i)},as=(i,e,t)=>(i.pending_buf[i.sym_buf+i.sym_next++]=e,i.pending_buf[i.sym_buf+i.sym_next++]=e>>8,i.pending_buf[i.sym_buf+i.sym_next++]=t,e===0?i.dyn_ltree[t*2]++:(i.matches++,e--,i.dyn_ltree[(Yt[t]+Gt+1)*2]++,i.dyn_dtree[Ci(e)*2]++),i.sym_next===i.sym_end);var ls=ss,hs=Ii,ds=rs,cs=as,us=os,gs={_tr_init:ls,_tr_stored_block:hs,_tr_flush_block:ds,_tr_tally:cs,_tr_align:us},Wt=(i,e,t,n)=>{let s=i&65535|0,o=i>>>16&65535|0,a=0;for(;t!==0;){a=t>2e3?2e3:t,t-=a;do s=s+e[n++]|0,o=o+s|0;while(--a);s%=65521,o%=65521}return s|o<<16|0};const fs=()=>{let i,e=[];for(var t=0;t<256;t++){i=t;for(var n=0;n<8;n++)i=i&1?3988292384^i>>>1:i>>>1;e[t]=i}return e},ps=new Uint32Array(fs());var z=(i,e,t,n)=>{const s=ps,o=n+t;i^=-1;for(let a=n;a<o;a++)i=i>>>8^s[(i^e[a])&255];return i^-1},_t={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},Vt={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8};const{_tr_init:ys,_tr_stored_block:ze,_tr_flush_block:ms,_tr_tally:dt,_tr_align:ws}=gs,{Z_NO_FLUSH:ct,Z_PARTIAL_FLUSH:bs,Z_FULL_FLUSH:_s,Z_FINISH:V,Z_BLOCK:Ni,Z_OK:H,Z_STREAM_END:Di,Z_STREAM_ERROR:q,Z_DATA_ERROR:Es,Z_BUF_ERROR:Oe,Z_DEFAULT_COMPRESSION:Cs,Z_FILTERED:xs,Z_HUFFMAN_ONLY:de,Z_RLE:Ts,Z_FIXED:vs,Z_DEFAULT_STRATEGY:As,Z_UNKNOWN:Bs,Z_DEFLATED:ce}=Vt,Ss=9,ks=15,Ls=8,He=256+1+29,Ms=30,Is=19,Ns=2*He+1,Ds=15,M=3,ut=258,J=ut+M+1,Rs=32,Mt=42,Ge=57,Ue=69,Xe=73,Fe=91,Ye=103,Et=113,jt=666,G=1,It=2,Ct=3,Nt=4,Ps=3,xt=(i,e)=>(i.msg=_t[e],e),Ri=i=>i*2-(i>4?9:0),gt=i=>{let e=i.length;for(;--e>=0;)i[e]=0},zs=i=>{let e,t,n,s=i.w_size;e=i.hash_size,n=e;do t=i.head[--n],i.head[n]=t>=s?t-s:0;while(--e);e=s,n=e;do t=i.prev[--n],i.prev[n]=t>=s?t-s:0;while(--e)};let ft=(i,e,t)=>(e<<i.hash_shift^t)&i.hash_mask;const Y=i=>{const e=i.state;let t=e.pending;t>i.avail_out&&(t=i.avail_out),t!==0&&(i.output.set(e.pending_buf.subarray(e.pending_out,e.pending_out+t),i.next_out),i.next_out+=t,e.pending_out+=t,i.total_out+=t,i.avail_out-=t,e.pending-=t,e.pending===0&&(e.pending_out=0))},$=(i,e)=>{ms(i,i.block_start>=0?i.block_start:-1,i.strstart-i.block_start,e),i.block_start=i.strstart,Y(i.strm)},I=(i,e)=>{i.pending_buf[i.pending++]=e},Zt=(i,e)=>{i.pending_buf[i.pending++]=e>>>8&255,i.pending_buf[i.pending++]=e&255},$e=(i,e,t,n)=>{let s=i.avail_in;return s>n&&(s=n),s===0?0:(i.avail_in-=s,e.set(i.input.subarray(i.next_in,i.next_in+s),t),i.state.wrap===1?i.adler=Wt(i.adler,e,s,t):i.state.wrap===2&&(i.adler=z(i.adler,e,s,t)),i.next_in+=s,i.total_in+=s,s)},Pi=(i,e)=>{let t=i.max_chain_length,n=i.strstart,s,o,a=i.prev_length,r=i.nice_match;const h=i.strstart>i.w_size-J?i.strstart-(i.w_size-J):0,l=i.window,d=i.w_mask,f=i.prev,c=i.strstart+ut;let u=l[n+a-1],g=l[n+a];i.prev_length>=i.good_match&&(t>>=2),r>i.lookahead&&(r=i.lookahead);do if(s=e,!(l[s+a]!==g||l[s+a-1]!==u||l[s]!==l[n]||l[++s]!==l[n+1])){n+=2,s++;do;while(l[++n]===l[++s]&&l[++n]===l[++s]&&l[++n]===l[++s]&&l[++n]===l[++s]&&l[++n]===l[++s]&&l[++n]===l[++s]&&l[++n]===l[++s]&&l[++n]===l[++s]&&n<c);if(o=ut-(c-n),n=c-ut,o>a){if(i.match_start=e,a=o,o>=r)break;u=l[n+a-1],g=l[n+a]}}while((e=f[e&d])>h&&--t!==0);return a<=i.lookahead?a:i.lookahead},Dt=i=>{const e=i.w_size;let t,n,s;do{if(n=i.window_size-i.lookahead-i.strstart,i.strstart>=e+(e-J)&&(i.window.set(i.window.subarray(e,e+e-n),0),i.match_start-=e,i.strstart-=e,i.block_start-=e,i.insert>i.strstart&&(i.insert=i.strstart),zs(i),n+=e),i.strm.avail_in===0)break;if(t=$e(i.strm,i.window,i.strstart+i.lookahead,n),i.lookahead+=t,i.lookahead+i.insert>=M)for(s=i.strstart-i.insert,i.ins_h=i.window[s],i.ins_h=ft(i,i.ins_h,i.window[s+1]);i.insert&&(i.ins_h=ft(i,i.ins_h,i.window[s+M-1]),i.prev[s&i.w_mask]=i.head[i.ins_h],i.head[i.ins_h]=s,s++,i.insert--,!(i.lookahead+i.insert<M)););}while(i.lookahead<J&&i.strm.avail_in!==0)},zi=(i,e)=>{let t=i.pending_buf_size-5>i.w_size?i.w_size:i.pending_buf_size-5,n,s,o,a=0,r=i.strm.avail_in;do{if(n=65535,o=i.bi_valid+42>>3,i.strm.avail_out<o||(o=i.strm.avail_out-o,s=i.strstart-i.block_start,n>s+i.strm.avail_in&&(n=s+i.strm.avail_in),n>o&&(n=o),n<t&&(n===0&&e!==V||e===ct||n!==s+i.strm.avail_in)))break;a=e===V&&n===s+i.strm.avail_in?1:0,ze(i,0,0,a),i.pending_buf[i.pending-4]=n,i.pending_buf[i.pending-3]=n>>8,i.pending_buf[i.pending-2]=~n,i.pending_buf[i.pending-1]=~n>>8,Y(i.strm),s&&(s>n&&(s=n),i.strm.output.set(i.window.subarray(i.block_start,i.block_start+s),i.strm.next_out),i.strm.next_out+=s,i.strm.avail_out-=s,i.strm.total_out+=s,i.block_start+=s,n-=s),n&&($e(i.strm,i.strm.output,i.strm.next_out,n),i.strm.next_out+=n,i.strm.avail_out-=n,i.strm.total_out+=n)}while(a===0);return r-=i.strm.avail_in,r&&(r>=i.w_size?(i.matches=2,i.window.set(i.strm.input.subarray(i.strm.next_in-i.w_size,i.strm.next_in),0),i.strstart=i.w_size,i.insert=i.strstart):(i.window_size-i.strstart<=r&&(i.strstart-=i.w_size,i.window.set(i.window.subarray(i.w_size,i.w_size+i.strstart),0),i.matches<2&&i.matches++,i.insert>i.strstart&&(i.insert=i.strstart)),i.window.set(i.strm.input.subarray(i.strm.next_in-r,i.strm.next_in),i.strstart),i.strstart+=r,i.insert+=r>i.w_size-i.insert?i.w_size-i.insert:r),i.block_start=i.strstart),i.high_water<i.strstart&&(i.high_water=i.strstart),a?Nt:e!==ct&&e!==V&&i.strm.avail_in===0&&i.strstart===i.block_start?It:(o=i.window_size-i.strstart,i.strm.avail_in>o&&i.block_start>=i.w_size&&(i.block_start-=i.w_size,i.strstart-=i.w_size,i.window.set(i.window.subarray(i.w_size,i.w_size+i.strstart),0),i.matches<2&&i.matches++,o+=i.w_size,i.insert>i.strstart&&(i.insert=i.strstart)),o>i.strm.avail_in&&(o=i.strm.avail_in),o&&($e(i.strm,i.window,i.strstart,o),i.strstart+=o,i.insert+=o>i.w_size-i.insert?i.w_size-i.insert:o),i.high_water<i.strstart&&(i.high_water=i.strstart),o=i.bi_valid+42>>3,o=i.pending_buf_size-o>65535?65535:i.pending_buf_size-o,t=o>i.w_size?i.w_size:o,s=i.strstart-i.block_start,(s>=t||(s||e===V)&&e!==ct&&i.strm.avail_in===0&&s<=o)&&(n=s>o?o:s,a=e===V&&i.strm.avail_in===0&&n===s?1:0,ze(i,i.block_start,n,a),i.block_start+=n,Y(i.strm)),a?Ct:G)},We=(i,e)=>{let t,n;for(;;){if(i.lookahead<J){if(Dt(i),i.lookahead<J&&e===ct)return G;if(i.lookahead===0)break}if(t=0,i.lookahead>=M&&(i.ins_h=ft(i,i.ins_h,i.window[i.strstart+M-1]),t=i.prev[i.strstart&i.w_mask]=i.head[i.ins_h],i.head[i.ins_h]=i.strstart),t!==0&&i.strstart-t<=i.w_size-J&&(i.match_length=Pi(i,t)),i.match_length>=M)if(n=dt(i,i.strstart-i.match_start,i.match_length-M),i.lookahead-=i.match_length,i.match_length<=i.max_lazy_match&&i.lookahead>=M){i.match_length--;do i.strstart++,i.ins_h=ft(i,i.ins_h,i.window[i.strstart+M-1]),t=i.prev[i.strstart&i.w_mask]=i.head[i.ins_h],i.head[i.ins_h]=i.strstart;while(--i.match_length!==0);i.strstart++}else i.strstart+=i.match_length,i.match_length=0,i.ins_h=i.window[i.strstart],i.ins_h=ft(i,i.ins_h,i.window[i.strstart+1]);else n=dt(i,0,i.window[i.strstart]),i.lookahead--,i.strstart++;if(n&&($(i,!1),i.strm.avail_out===0))return G}return i.insert=i.strstart<M-1?i.strstart:M-1,e===V?($(i,!0),i.strm.avail_out===0?Ct:Nt):i.sym_next&&($(i,!1),i.strm.avail_out===0)?G:It},Rt=(i,e)=>{let t,n,s;for(;;){if(i.lookahead<J){if(Dt(i),i.lookahead<J&&e===ct)return G;if(i.lookahead===0)break}if(t=0,i.lookahead>=M&&(i.ins_h=ft(i,i.ins_h,i.window[i.strstart+M-1]),t=i.prev[i.strstart&i.w_mask]=i.head[i.ins_h],i.head[i.ins_h]=i.strstart),i.prev_length=i.match_length,i.prev_match=i.match_start,i.match_length=M-1,t!==0&&i.prev_length<i.max_lazy_match&&i.strstart-t<=i.w_size-J&&(i.match_length=Pi(i,t),i.match_length<=5&&(i.strategy===xs||i.match_length===M&&i.strstart-i.match_start>4096)&&(i.match_length=M-1)),i.prev_length>=M&&i.match_length<=i.prev_length){s=i.strstart+i.lookahead-M,n=dt(i,i.strstart-1-i.prev_match,i.prev_length-M),i.lookahead-=i.prev_length-1,i.prev_length-=2;do++i.strstart<=s&&(i.ins_h=ft(i,i.ins_h,i.window[i.strstart+M-1]),t=i.prev[i.strstart&i.w_mask]=i.head[i.ins_h],i.head[i.ins_h]=i.strstart);while(--i.prev_length!==0);if(i.match_available=0,i.match_length=M-1,i.strstart++,n&&($(i,!1),i.strm.avail_out===0))return G}else if(i.match_available){if(n=dt(i,0,i.window[i.strstart-1]),n&&$(i,!1),i.strstart++,i.lookahead--,i.strm.avail_out===0)return G}else i.match_available=1,i.strstart++,i.lookahead--}return i.match_available&&(n=dt(i,0,i.window[i.strstart-1]),i.match_available=0),i.insert=i.strstart<M-1?i.strstart:M-1,e===V?($(i,!0),i.strm.avail_out===0?Ct:Nt):i.sym_next&&($(i,!1),i.strm.avail_out===0)?G:It},Os=(i,e)=>{let t,n,s,o;const a=i.window;for(;;){if(i.lookahead<=ut){if(Dt(i),i.lookahead<=ut&&e===ct)return G;if(i.lookahead===0)break}if(i.match_length=0,i.lookahead>=M&&i.strstart>0&&(s=i.strstart-1,n=a[s],n===a[++s]&&n===a[++s]&&n===a[++s])){o=i.strstart+ut;do;while(n===a[++s]&&n===a[++s]&&n===a[++s]&&n===a[++s]&&n===a[++s]&&n===a[++s]&&n===a[++s]&&n===a[++s]&&s<o);i.match_length=ut-(o-s),i.match_length>i.lookahead&&(i.match_length=i.lookahead)}if(i.match_length>=M?(t=dt(i,1,i.match_length-M),i.lookahead-=i.match_length,i.strstart+=i.match_length,i.match_length=0):(t=dt(i,0,i.window[i.strstart]),i.lookahead--,i.strstart++),t&&($(i,!1),i.strm.avail_out===0))return G}return i.insert=0,e===V?($(i,!0),i.strm.avail_out===0?Ct:Nt):i.sym_next&&($(i,!1),i.strm.avail_out===0)?G:It},Hs=(i,e)=>{let t;for(;;){if(i.lookahead===0&&(Dt(i),i.lookahead===0)){if(e===ct)return G;break}if(i.match_length=0,t=dt(i,0,i.window[i.strstart]),i.lookahead--,i.strstart++,t&&($(i,!1),i.strm.avail_out===0))return G}return i.insert=0,e===V?($(i,!0),i.strm.avail_out===0?Ct:Nt):i.sym_next&&($(i,!1),i.strm.avail_out===0)?G:It};function Q(i,e,t,n,s){this.good_length=i,this.max_lazy=e,this.nice_length=t,this.max_chain=n,this.func=s}const Kt=[new Q(0,0,0,0,zi),new Q(4,4,8,4,We),new Q(4,5,16,8,We),new Q(4,6,32,32,We),new Q(4,4,16,16,Rt),new Q(8,16,32,32,Rt),new Q(8,16,128,128,Rt),new Q(8,32,128,256,Rt),new Q(32,128,258,1024,Rt),new Q(32,258,258,4096,Rt)],Gs=i=>{i.window_size=2*i.w_size,gt(i.head),i.max_lazy_match=Kt[i.level].max_lazy,i.good_match=Kt[i.level].good_length,i.nice_match=Kt[i.level].nice_length,i.max_chain_length=Kt[i.level].max_chain,i.strstart=0,i.block_start=0,i.lookahead=0,i.insert=0,i.match_length=i.prev_length=M-1,i.match_available=0,i.ins_h=0};function Us(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=ce,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new Uint16Array(Ns*2),this.dyn_dtree=new Uint16Array((2*Ms+1)*2),this.bl_tree=new Uint16Array((2*Is+1)*2),gt(this.dyn_ltree),gt(this.dyn_dtree),gt(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new Uint16Array(Ds+1),this.heap=new Uint16Array(2*He+1),gt(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new Uint16Array(2*He+1),gt(this.depth),this.sym_buf=0,this.lit_bufsize=0,this.sym_next=0,this.sym_end=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}const qt=i=>{if(!i)return 1;const e=i.state;return!e||e.strm!==i||e.status!==Mt&&e.status!==Ge&&e.status!==Ue&&e.status!==Xe&&e.status!==Fe&&e.status!==Ye&&e.status!==Et&&e.status!==jt?1:0},Oi=i=>{if(qt(i))return xt(i,q);i.total_in=i.total_out=0,i.data_type=Bs;const e=i.state;return e.pending=0,e.pending_out=0,e.wrap<0&&(e.wrap=-e.wrap),e.status=e.wrap===2?Ge:e.wrap?Mt:Et,i.adler=e.wrap===2?0:1,e.last_flush=-2,ys(e),H},Hi=i=>{const e=Oi(i);return e===H&&Gs(i.state),e},Xs=(i,e)=>qt(i)||i.state.wrap!==2?q:(i.state.gzhead=e,H),Gi=(i,e,t,n,s,o)=>{if(!i)return q;let a=1;if(e===Cs&&(e=6),n<0?(a=0,n=-n):n>15&&(a=2,n-=16),s<1||s>Ss||t!==ce||n<8||n>15||e<0||e>9||o<0||o>vs||n===8&&a!==1)return xt(i,q);n===8&&(n=9);const r=new Us;return i.state=r,r.strm=i,r.status=Mt,r.wrap=a,r.gzhead=null,r.w_bits=n,r.w_size=1<<r.w_bits,r.w_mask=r.w_size-1,r.hash_bits=s+7,r.hash_size=1<<r.hash_bits,r.hash_mask=r.hash_size-1,r.hash_shift=~~((r.hash_bits+M-1)/M),r.window=new Uint8Array(r.w_size*2),r.head=new Uint16Array(r.hash_size),r.prev=new Uint16Array(r.w_size),r.lit_bufsize=1<<s+6,r.pending_buf_size=r.lit_bufsize*4,r.pending_buf=new Uint8Array(r.pending_buf_size),r.sym_buf=r.lit_bufsize,r.sym_end=(r.lit_bufsize-1)*3,r.level=e,r.strategy=o,r.method=t,Hi(i)},Fs=(i,e)=>Gi(i,e,ce,ks,Ls,As),Ys=(i,e)=>{if(qt(i)||e>Ni||e<0)return i?xt(i,q):q;const t=i.state;if(!i.output||i.avail_in!==0&&!i.input||t.status===jt&&e!==V)return xt(i,i.avail_out===0?Oe:q);const n=t.last_flush;if(t.last_flush=e,t.pending!==0){if(Y(i),i.avail_out===0)return t.last_flush=-1,H}else if(i.avail_in===0&&Ri(e)<=Ri(n)&&e!==V)return xt(i,Oe);if(t.status===jt&&i.avail_in!==0)return xt(i,Oe);if(t.status===Mt&&t.wrap===0&&(t.status=Et),t.status===Mt){let s=ce+(t.w_bits-8<<4)<<8,o=-1;if(t.strategy>=de||t.level<2?o=0:t.level<6?o=1:t.level===6?o=2:o=3,s|=o<<6,t.strstart!==0&&(s|=Rs),s+=31-s%31,Zt(t,s),t.strstart!==0&&(Zt(t,i.adler>>>16),Zt(t,i.adler&65535)),i.adler=1,t.status=Et,Y(i),t.pending!==0)return t.last_flush=-1,H}if(t.status===Ge){if(i.adler=0,I(t,31),I(t,139),I(t,8),t.gzhead)I(t,(t.gzhead.text?1:0)+(t.gzhead.hcrc?2:0)+(t.gzhead.extra?4:0)+(t.gzhead.name?8:0)+(t.gzhead.comment?16:0)),I(t,t.gzhead.time&255),I(t,t.gzhead.time>>8&255),I(t,t.gzhead.time>>16&255),I(t,t.gzhead.time>>24&255),I(t,t.level===9?2:t.strategy>=de||t.level<2?4:0),I(t,t.gzhead.os&255),t.gzhead.extra&&t.gzhead.extra.length&&(I(t,t.gzhead.extra.length&255),I(t,t.gzhead.extra.length>>8&255)),t.gzhead.hcrc&&(i.adler=z(i.adler,t.pending_buf,t.pending,0)),t.gzindex=0,t.status=Ue;else if(I(t,0),I(t,0),I(t,0),I(t,0),I(t,0),I(t,t.level===9?2:t.strategy>=de||t.level<2?4:0),I(t,Ps),t.status=Et,Y(i),t.pending!==0)return t.last_flush=-1,H}if(t.status===Ue){if(t.gzhead.extra){let s=t.pending,o=(t.gzhead.extra.length&65535)-t.gzindex;for(;t.pending+o>t.pending_buf_size;){let r=t.pending_buf_size-t.pending;if(t.pending_buf.set(t.gzhead.extra.subarray(t.gzindex,t.gzindex+r),t.pending),t.pending=t.pending_buf_size,t.gzhead.hcrc&&t.pending>s&&(i.adler=z(i.adler,t.pending_buf,t.pending-s,s)),t.gzindex+=r,Y(i),t.pending!==0)return t.last_flush=-1,H;s=0,o-=r}let a=new Uint8Array(t.gzhead.extra);t.pending_buf.set(a.subarray(t.gzindex,t.gzindex+o),t.pending),t.pending+=o,t.gzhead.hcrc&&t.pending>s&&(i.adler=z(i.adler,t.pending_buf,t.pending-s,s)),t.gzindex=0}t.status=Xe}if(t.status===Xe){if(t.gzhead.name){let s=t.pending,o;do{if(t.pending===t.pending_buf_size){if(t.gzhead.hcrc&&t.pending>s&&(i.adler=z(i.adler,t.pending_buf,t.pending-s,s)),Y(i),t.pending!==0)return t.last_flush=-1,H;s=0}t.gzindex<t.gzhead.name.length?o=t.gzhead.name.charCodeAt(t.gzindex++)&255:o=0,I(t,o)}while(o!==0);t.gzhead.hcrc&&t.pending>s&&(i.adler=z(i.adler,t.pending_buf,t.pending-s,s)),t.gzindex=0}t.status=Fe}if(t.status===Fe){if(t.gzhead.comment){let s=t.pending,o;do{if(t.pending===t.pending_buf_size){if(t.gzhead.hcrc&&t.pending>s&&(i.adler=z(i.adler,t.pending_buf,t.pending-s,s)),Y(i),t.pending!==0)return t.last_flush=-1,H;s=0}t.gzindex<t.gzhead.comment.length?o=t.gzhead.comment.charCodeAt(t.gzindex++)&255:o=0,I(t,o)}while(o!==0);t.gzhead.hcrc&&t.pending>s&&(i.adler=z(i.adler,t.pending_buf,t.pending-s,s))}t.status=Ye}if(t.status===Ye){if(t.gzhead.hcrc){if(t.pending+2>t.pending_buf_size&&(Y(i),t.pending!==0))return t.last_flush=-1,H;I(t,i.adler&255),I(t,i.adler>>8&255),i.adler=0}if(t.status=Et,Y(i),t.pending!==0)return t.last_flush=-1,H}if(i.avail_in!==0||t.lookahead!==0||e!==ct&&t.status!==jt){let s=t.level===0?zi(t,e):t.strategy===de?Hs(t,e):t.strategy===Ts?Os(t,e):Kt[t.level].func(t,e);if((s===Ct||s===Nt)&&(t.status=jt),s===G||s===Ct)return i.avail_out===0&&(t.last_flush=-1),H;if(s===It&&(e===bs?ws(t):e!==Ni&&(ze(t,0,0,!1),e===_s&&(gt(t.head),t.lookahead===0&&(t.strstart=0,t.block_start=0,t.insert=0))),Y(i),i.avail_out===0))return t.last_flush=-1,H}return e!==V?H:t.wrap<=0?Di:(t.wrap===2?(I(t,i.adler&255),I(t,i.adler>>8&255),I(t,i.adler>>16&255),I(t,i.adler>>24&255),I(t,i.total_in&255),I(t,i.total_in>>8&255),I(t,i.total_in>>16&255),I(t,i.total_in>>24&255)):(Zt(t,i.adler>>>16),Zt(t,i.adler&65535)),Y(i),t.wrap>0&&(t.wrap=-t.wrap),t.pending!==0?H:Di)},$s=i=>{if(qt(i))return q;const e=i.state.status;return i.state=null,e===Et?xt(i,Es):H},Ws=(i,e)=>{let t=e.length;if(qt(i))return q;const n=i.state,s=n.wrap;if(s===2||s===1&&n.status!==Mt||n.lookahead)return q;if(s===1&&(i.adler=Wt(i.adler,e,t,0)),n.wrap=0,t>=n.w_size){s===0&&(gt(n.head),n.strstart=0,n.block_start=0,n.insert=0);let h=new Uint8Array(n.w_size);h.set(e.subarray(t-n.w_size,t),0),e=h,t=n.w_size}const o=i.avail_in,a=i.next_in,r=i.input;for(i.avail_in=t,i.next_in=0,i.input=e,Dt(n);n.lookahead>=M;){let h=n.strstart,l=n.lookahead-(M-1);do n.ins_h=ft(n,n.ins_h,n.window[h+M-1]),n.prev[h&n.w_mask]=n.head[n.ins_h],n.head[n.ins_h]=h,h++;while(--l);n.strstart=h,n.lookahead=M-1,Dt(n)}return n.strstart+=n.lookahead,n.block_start=n.strstart,n.insert=n.lookahead,n.lookahead=0,n.match_length=n.prev_length=M-1,n.match_available=0,i.next_in=a,i.input=r,i.avail_in=o,n.wrap=s,H};var Vs=Fs,js=Gi,Zs=Hi,Ks=Oi,qs=Xs,Js=Ys,Qs=$s,to=Ws,eo="pako deflate (from Nodeca project)",Jt={deflateInit:Vs,deflateInit2:js,deflateReset:Zs,deflateResetKeep:Ks,deflateSetHeader:qs,deflate:Js,deflateEnd:Qs,deflateSetDictionary:to,deflateInfo:eo};const io=(i,e)=>Object.prototype.hasOwnProperty.call(i,e);var no=function(i){const e=Array.prototype.slice.call(arguments,1);for(;e.length;){const t=e.shift();if(t){if(typeof t!="object")throw new TypeError(t+"must be non-object");for(const n in t)io(t,n)&&(i[n]=t[n])}}return i},so=i=>{let e=0;for(let n=0,s=i.length;n<s;n++)e+=i[n].length;const t=new Uint8Array(e);for(let n=0,s=0,o=i.length;n<o;n++){let a=i[n];t.set(a,s),s+=a.length}return t},ue={assign:no,flattenChunks:so};let Ui=!0;try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{Ui=!1}const Qt=new Uint8Array(256);for(let i=0;i<256;i++)Qt[i]=i>=252?6:i>=248?5:i>=240?4:i>=224?3:i>=192?2:1;Qt[254]=Qt[254]=1;var oo=i=>{if(typeof TextEncoder=="function"&&TextEncoder.prototype.encode)return new TextEncoder().encode(i);let e,t,n,s,o,a=i.length,r=0;for(s=0;s<a;s++)t=i.charCodeAt(s),(t&64512)===55296&&s+1<a&&(n=i.charCodeAt(s+1),(n&64512)===56320&&(t=65536+(t-55296<<10)+(n-56320),s++)),r+=t<128?1:t<2048?2:t<65536?3:4;for(e=new Uint8Array(r),o=0,s=0;o<r;s++)t=i.charCodeAt(s),(t&64512)===55296&&s+1<a&&(n=i.charCodeAt(s+1),(n&64512)===56320&&(t=65536+(t-55296<<10)+(n-56320),s++)),t<128?e[o++]=t:t<2048?(e[o++]=192|t>>>6,e[o++]=128|t&63):t<65536?(e[o++]=224|t>>>12,e[o++]=128|t>>>6&63,e[o++]=128|t&63):(e[o++]=240|t>>>18,e[o++]=128|t>>>12&63,e[o++]=128|t>>>6&63,e[o++]=128|t&63);return e};const ro=(i,e)=>{if(e<65534&&i.subarray&&Ui)return String.fromCharCode.apply(null,i.length===e?i:i.subarray(0,e));let t="";for(let n=0;n<e;n++)t+=String.fromCharCode(i[n]);return t};var ao=(i,e)=>{const t=e||i.length;if(typeof TextDecoder=="function"&&TextDecoder.prototype.decode)return new TextDecoder().decode(i.subarray(0,e));let n,s;const o=new Array(t*2);for(s=0,n=0;n<t;){let a=i[n++];if(a<128){o[s++]=a;continue}let r=Qt[a];if(r>4){o[s++]=65533,n+=r-1;continue}for(a&=r===2?31:r===3?15:7;r>1&&n<t;)a=a<<6|i[n++]&63,r--;if(r>1){o[s++]=65533;continue}a<65536?o[s++]=a:(a-=65536,o[s++]=55296|a>>10&1023,o[s++]=56320|a&1023)}return ro(o,s)},lo=(i,e)=>{e=e||i.length,e>i.length&&(e=i.length);let t=e-1;for(;t>=0&&(i[t]&192)===128;)t--;return t<0||t===0?e:t+Qt[i[t]]>e?t:e},te={string2buf:oo,buf2string:ao,utf8border:lo};function ho(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}var Xi=ho;const Fi=Object.prototype.toString,{Z_NO_FLUSH:co,Z_SYNC_FLUSH:uo,Z_FULL_FLUSH:go,Z_FINISH:fo,Z_OK:ge,Z_STREAM_END:po,Z_DEFAULT_COMPRESSION:yo,Z_DEFAULT_STRATEGY:mo,Z_DEFLATED:wo}=Vt;function ee(i){this.options=ue.assign({level:yo,method:wo,chunkSize:16384,windowBits:15,memLevel:8,strategy:mo},i||{});let e=this.options;e.raw&&e.windowBits>0?e.windowBits=-e.windowBits:e.gzip&&e.windowBits>0&&e.windowBits<16&&(e.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new Xi,this.strm.avail_out=0;let t=Jt.deflateInit2(this.strm,e.level,e.method,e.windowBits,e.memLevel,e.strategy);if(t!==ge)throw new Error(_t[t]);if(e.header&&Jt.deflateSetHeader(this.strm,e.header),e.dictionary){let n;if(typeof e.dictionary=="string"?n=te.string2buf(e.dictionary):Fi.call(e.dictionary)==="[object ArrayBuffer]"?n=new Uint8Array(e.dictionary):n=e.dictionary,t=Jt.deflateSetDictionary(this.strm,n),t!==ge)throw new Error(_t[t]);this._dict_set=!0}}ee.prototype.push=function(i,e){const t=this.strm,n=this.options.chunkSize;let s,o;if(this.ended)return!1;for(e===~~e?o=e:o=e===!0?fo:co,typeof i=="string"?t.input=te.string2buf(i):Fi.call(i)==="[object ArrayBuffer]"?t.input=new Uint8Array(i):t.input=i,t.next_in=0,t.avail_in=t.input.length;;){if(t.avail_out===0&&(t.output=new Uint8Array(n),t.next_out=0,t.avail_out=n),(o===uo||o===go)&&t.avail_out<=6){this.onData(t.output.subarray(0,t.next_out)),t.avail_out=0;continue}if(s=Jt.deflate(t,o),s===po)return t.next_out>0&&this.onData(t.output.subarray(0,t.next_out)),s=Jt.deflateEnd(this.strm),this.onEnd(s),this.ended=!0,s===ge;if(t.avail_out===0){this.onData(t.output);continue}if(o>0&&t.next_out>0){this.onData(t.output.subarray(0,t.next_out)),t.avail_out=0;continue}if(t.avail_in===0)break}return!0},ee.prototype.onData=function(i){this.chunks.push(i)},ee.prototype.onEnd=function(i){i===ge&&(this.result=ue.flattenChunks(this.chunks)),this.chunks=[],this.err=i,this.msg=this.strm.msg};function Ve(i,e){const t=new ee(e);if(t.push(i,!0),t.err)throw t.msg||_t[t.err];return t.result}function bo(i,e){return e=e||{},e.raw=!0,Ve(i,e)}function _o(i,e){return e=e||{},e.gzip=!0,Ve(i,e)}var Eo=ee,Co=Ve,xo=bo,To=_o,vo={Deflate:Eo,deflate:Co,deflateRaw:xo,gzip:To};const fe=16209,Ao=16191;var Bo=function(e,t){let n,s,o,a,r,h,l,d,f,c,u,g,p,y,m,w,b,_,C,E,v,B,x,T;const A=e.state;n=e.next_in,x=e.input,s=n+(e.avail_in-5),o=e.next_out,T=e.output,a=o-(t-e.avail_out),r=o+(e.avail_out-257),h=A.dmax,l=A.wsize,d=A.whave,f=A.wnext,c=A.window,u=A.hold,g=A.bits,p=A.lencode,y=A.distcode,m=(1<<A.lenbits)-1,w=(1<<A.distbits)-1;t:do{g<15&&(u+=x[n++]<<g,g+=8,u+=x[n++]<<g,g+=8),b=p[u&m];e:for(;;){if(_=b>>>24,u>>>=_,g-=_,_=b>>>16&255,_===0)T[o++]=b&65535;else if(_&16){C=b&65535,_&=15,_&&(g<_&&(u+=x[n++]<<g,g+=8),C+=u&(1<<_)-1,u>>>=_,g-=_),g<15&&(u+=x[n++]<<g,g+=8,u+=x[n++]<<g,g+=8),b=y[u&w];i:for(;;){if(_=b>>>24,u>>>=_,g-=_,_=b>>>16&255,_&16){if(E=b&65535,_&=15,g<_&&(u+=x[n++]<<g,g+=8,g<_&&(u+=x[n++]<<g,g+=8)),E+=u&(1<<_)-1,E>h){e.msg="invalid distance too far back",A.mode=fe;break t}if(u>>>=_,g-=_,_=o-a,E>_){if(_=E-_,_>d&&A.sane){e.msg="invalid distance too far back",A.mode=fe;break t}if(v=0,B=c,f===0){if(v+=l-_,_<C){C-=_;do T[o++]=c[v++];while(--_);v=o-E,B=T}}else if(f<_){if(v+=l+f-_,_-=f,_<C){C-=_;do T[o++]=c[v++];while(--_);if(v=0,f<C){_=f,C-=_;do T[o++]=c[v++];while(--_);v=o-E,B=T}}}else if(v+=f-_,_<C){C-=_;do T[o++]=c[v++];while(--_);v=o-E,B=T}for(;C>2;)T[o++]=B[v++],T[o++]=B[v++],T[o++]=B[v++],C-=3;C&&(T[o++]=B[v++],C>1&&(T[o++]=B[v++]))}else{v=o-E;do T[o++]=T[v++],T[o++]=T[v++],T[o++]=T[v++],C-=3;while(C>2);C&&(T[o++]=T[v++],C>1&&(T[o++]=T[v++]))}}else if((_&64)===0){b=y[(b&65535)+(u&(1<<_)-1)];continue i}else{e.msg="invalid distance code",A.mode=fe;break t}break}}else if((_&64)===0){b=p[(b&65535)+(u&(1<<_)-1)];continue e}else if(_&32){A.mode=Ao;break t}else{e.msg="invalid literal/length code",A.mode=fe;break t}break}}while(n<s&&o<r);C=g>>3,n-=C,g-=C<<3,u&=(1<<g)-1,e.next_in=n,e.next_out=o,e.avail_in=n<s?5+(s-n):5-(n-s),e.avail_out=o<r?257+(r-o):257-(o-r),A.hold=u,A.bits=g};const Pt=15,Yi=852,$i=592,Wi=0,je=1,Vi=2,So=new Uint16Array([3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0]),ko=new Uint8Array([16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78]),Lo=new Uint16Array([1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0]),Mo=new Uint8Array([16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64]);var ie=(i,e,t,n,s,o,a,r)=>{const h=r.bits;let l=0,d=0,f=0,c=0,u=0,g=0,p=0,y=0,m=0,w=0,b,_,C,E,v,B=null,x;const T=new Uint16Array(Pt+1),A=new Uint16Array(Pt+1);let L=null,S,k,N;for(l=0;l<=Pt;l++)T[l]=0;for(d=0;d<n;d++)T[e[t+d]]++;for(u=h,c=Pt;c>=1&&T[c]===0;c--);if(u>c&&(u=c),c===0)return s[o++]=1<<24|64<<16|0,s[o++]=1<<24|64<<16|0,r.bits=1,0;for(f=1;f<c&&T[f]===0;f++);for(u<f&&(u=f),y=1,l=1;l<=Pt;l++)if(y<<=1,y-=T[l],y<0)return-1;if(y>0&&(i===Wi||c!==1))return-1;for(A[1]=0,l=1;l<Pt;l++)A[l+1]=A[l]+T[l];for(d=0;d<n;d++)e[t+d]!==0&&(a[A[e[t+d]]++]=d);if(i===Wi?(B=L=a,x=20):i===je?(B=So,L=ko,x=257):(B=Lo,L=Mo,x=0),w=0,d=0,l=f,v=o,g=u,p=0,C=-1,m=1<<u,E=m-1,i===je&&m>Yi||i===Vi&&m>$i)return 1;for(;;){S=l-p,a[d]+1<x?(k=0,N=a[d]):a[d]>=x?(k=L[a[d]-x],N=B[a[d]-x]):(k=96,N=0),b=1<<l-p,_=1<<g,f=_;do _-=b,s[v+(w>>p)+_]=S<<24|k<<16|N|0;while(_!==0);for(b=1<<l-1;w&b;)b>>=1;if(b!==0?(w&=b-1,w+=b):w=0,d++,--T[l]===0){if(l===c)break;l=e[t+a[d]]}if(l>u&&(w&E)!==C){for(p===0&&(p=u),v+=f,g=l-p,y=1<<g;g+p<c&&(y-=T[g+p],!(y<=0));)g++,y<<=1;if(m+=1<<g,i===je&&m>Yi||i===Vi&&m>$i)return 1;C=w&E,s[C]=u<<24|g<<16|v-o|0}}return w!==0&&(s[v+w]=l-p<<24|64<<16|0),r.bits=u,0};const Io=0,ji=1,Zi=2,{Z_FINISH:Ki,Z_BLOCK:No,Z_TREES:pe,Z_OK:Tt,Z_STREAM_END:Do,Z_NEED_DICT:Ro,Z_STREAM_ERROR:j,Z_DATA_ERROR:qi,Z_MEM_ERROR:Ji,Z_BUF_ERROR:Po,Z_DEFLATED:Qi}=Vt,ye=16180,tn=16181,en=16182,nn=16183,sn=16184,on=16185,rn=16186,an=16187,ln=16188,hn=16189,me=16190,rt=16191,Ze=16192,dn=16193,Ke=16194,cn=16195,un=16196,gn=16197,fn=16198,we=16199,be=16200,pn=16201,yn=16202,mn=16203,wn=16204,bn=16205,qe=16206,_n=16207,En=16208,D=16209,Cn=16210,xn=16211,zo=852,Oo=592,Ho=15,Tn=i=>(i>>>24&255)+(i>>>8&65280)+((i&65280)<<8)+((i&255)<<24);function Go(){this.strm=null,this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}const vt=i=>{if(!i)return 1;const e=i.state;return!e||e.strm!==i||e.mode<ye||e.mode>xn?1:0},vn=i=>{if(vt(i))return j;const e=i.state;return i.total_in=i.total_out=e.total=0,i.msg="",e.wrap&&(i.adler=e.wrap&1),e.mode=ye,e.last=0,e.havedict=0,e.flags=-1,e.dmax=32768,e.head=null,e.hold=0,e.bits=0,e.lencode=e.lendyn=new Int32Array(zo),e.distcode=e.distdyn=new Int32Array(Oo),e.sane=1,e.back=-1,Tt},An=i=>{if(vt(i))return j;const e=i.state;return e.wsize=0,e.whave=0,e.wnext=0,vn(i)},Bn=(i,e)=>{let t;if(vt(i))return j;const n=i.state;return e<0?(t=0,e=-e):(t=(e>>4)+5,e<48&&(e&=15)),e&&(e<8||e>15)?j:(n.window!==null&&n.wbits!==e&&(n.window=null),n.wrap=t,n.wbits=e,An(i))},Sn=(i,e)=>{if(!i)return j;const t=new Go;i.state=t,t.strm=i,t.window=null,t.mode=ye;const n=Bn(i,e);return n!==Tt&&(i.state=null),n},Uo=i=>Sn(i,Ho);let kn=!0,Je,Qe;const Xo=i=>{if(kn){Je=new Int32Array(512),Qe=new Int32Array(32);let e=0;for(;e<144;)i.lens[e++]=8;for(;e<256;)i.lens[e++]=9;for(;e<280;)i.lens[e++]=7;for(;e<288;)i.lens[e++]=8;for(ie(ji,i.lens,0,288,Je,0,i.work,{bits:9}),e=0;e<32;)i.lens[e++]=5;ie(Zi,i.lens,0,32,Qe,0,i.work,{bits:5}),kn=!1}i.lencode=Je,i.lenbits=9,i.distcode=Qe,i.distbits=5},Ln=(i,e,t,n)=>{let s;const o=i.state;return o.window===null&&(o.wsize=1<<o.wbits,o.wnext=0,o.whave=0,o.window=new Uint8Array(o.wsize)),n>=o.wsize?(o.window.set(e.subarray(t-o.wsize,t),0),o.wnext=0,o.whave=o.wsize):(s=o.wsize-o.wnext,s>n&&(s=n),o.window.set(e.subarray(t-n,t-n+s),o.wnext),n-=s,n?(o.window.set(e.subarray(t-n,t),0),o.wnext=n,o.whave=o.wsize):(o.wnext+=s,o.wnext===o.wsize&&(o.wnext=0),o.whave<o.wsize&&(o.whave+=s))),0},Fo=(i,e)=>{let t,n,s,o,a,r,h,l,d,f,c,u,g,p,y=0,m,w,b,_,C,E,v,B;const x=new Uint8Array(4);let T,A;const L=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);if(vt(i)||!i.output||!i.input&&i.avail_in!==0)return j;t=i.state,t.mode===rt&&(t.mode=Ze),a=i.next_out,s=i.output,h=i.avail_out,o=i.next_in,n=i.input,r=i.avail_in,l=t.hold,d=t.bits,f=r,c=h,B=Tt;t:for(;;)switch(t.mode){case ye:if(t.wrap===0){t.mode=Ze;break}for(;d<16;){if(r===0)break t;r--,l+=n[o++]<<d,d+=8}if(t.wrap&2&&l===35615){t.wbits===0&&(t.wbits=15),t.check=0,x[0]=l&255,x[1]=l>>>8&255,t.check=z(t.check,x,2,0),l=0,d=0,t.mode=tn;break}if(t.head&&(t.head.done=!1),!(t.wrap&1)||(((l&255)<<8)+(l>>8))%31){i.msg="incorrect header check",t.mode=D;break}if((l&15)!==Qi){i.msg="unknown compression method",t.mode=D;break}if(l>>>=4,d-=4,v=(l&15)+8,t.wbits===0&&(t.wbits=v),v>15||v>t.wbits){i.msg="invalid window size",t.mode=D;break}t.dmax=1<<t.wbits,t.flags=0,i.adler=t.check=1,t.mode=l&512?hn:rt,l=0,d=0;break;case tn:for(;d<16;){if(r===0)break t;r--,l+=n[o++]<<d,d+=8}if(t.flags=l,(t.flags&255)!==Qi){i.msg="unknown compression method",t.mode=D;break}if(t.flags&57344){i.msg="unknown header flags set",t.mode=D;break}t.head&&(t.head.text=l>>8&1),t.flags&512&&t.wrap&4&&(x[0]=l&255,x[1]=l>>>8&255,t.check=z(t.check,x,2,0)),l=0,d=0,t.mode=en;case en:for(;d<32;){if(r===0)break t;r--,l+=n[o++]<<d,d+=8}t.head&&(t.head.time=l),t.flags&512&&t.wrap&4&&(x[0]=l&255,x[1]=l>>>8&255,x[2]=l>>>16&255,x[3]=l>>>24&255,t.check=z(t.check,x,4,0)),l=0,d=0,t.mode=nn;case nn:for(;d<16;){if(r===0)break t;r--,l+=n[o++]<<d,d+=8}t.head&&(t.head.xflags=l&255,t.head.os=l>>8),t.flags&512&&t.wrap&4&&(x[0]=l&255,x[1]=l>>>8&255,t.check=z(t.check,x,2,0)),l=0,d=0,t.mode=sn;case sn:if(t.flags&1024){for(;d<16;){if(r===0)break t;r--,l+=n[o++]<<d,d+=8}t.length=l,t.head&&(t.head.extra_len=l),t.flags&512&&t.wrap&4&&(x[0]=l&255,x[1]=l>>>8&255,t.check=z(t.check,x,2,0)),l=0,d=0}else t.head&&(t.head.extra=null);t.mode=on;case on:if(t.flags&1024&&(u=t.length,u>r&&(u=r),u&&(t.head&&(v=t.head.extra_len-t.length,t.head.extra||(t.head.extra=new Uint8Array(t.head.extra_len)),t.head.extra.set(n.subarray(o,o+u),v)),t.flags&512&&t.wrap&4&&(t.check=z(t.check,n,u,o)),r-=u,o+=u,t.length-=u),t.length))break t;t.length=0,t.mode=rn;case rn:if(t.flags&2048){if(r===0)break t;u=0;do v=n[o+u++],t.head&&v&&t.length<65536&&(t.head.name+=String.fromCharCode(v));while(v&&u<r);if(t.flags&512&&t.wrap&4&&(t.check=z(t.check,n,u,o)),r-=u,o+=u,v)break t}else t.head&&(t.head.name=null);t.length=0,t.mode=an;case an:if(t.flags&4096){if(r===0)break t;u=0;do v=n[o+u++],t.head&&v&&t.length<65536&&(t.head.comment+=String.fromCharCode(v));while(v&&u<r);if(t.flags&512&&t.wrap&4&&(t.check=z(t.check,n,u,o)),r-=u,o+=u,v)break t}else t.head&&(t.head.comment=null);t.mode=ln;case ln:if(t.flags&512){for(;d<16;){if(r===0)break t;r--,l+=n[o++]<<d,d+=8}if(t.wrap&4&&l!==(t.check&65535)){i.msg="header crc mismatch",t.mode=D;break}l=0,d=0}t.head&&(t.head.hcrc=t.flags>>9&1,t.head.done=!0),i.adler=t.check=0,t.mode=rt;break;case hn:for(;d<32;){if(r===0)break t;r--,l+=n[o++]<<d,d+=8}i.adler=t.check=Tn(l),l=0,d=0,t.mode=me;case me:if(t.havedict===0)return i.next_out=a,i.avail_out=h,i.next_in=o,i.avail_in=r,t.hold=l,t.bits=d,Ro;i.adler=t.check=1,t.mode=rt;case rt:if(e===No||e===pe)break t;case Ze:if(t.last){l>>>=d&7,d-=d&7,t.mode=qe;break}for(;d<3;){if(r===0)break t;r--,l+=n[o++]<<d,d+=8}switch(t.last=l&1,l>>>=1,d-=1,l&3){case 0:t.mode=dn;break;case 1:if(Xo(t),t.mode=we,e===pe){l>>>=2,d-=2;break t}break;case 2:t.mode=un;break;case 3:i.msg="invalid block type",t.mode=D}l>>>=2,d-=2;break;case dn:for(l>>>=d&7,d-=d&7;d<32;){if(r===0)break t;r--,l+=n[o++]<<d,d+=8}if((l&65535)!==(l>>>16^65535)){i.msg="invalid stored block lengths",t.mode=D;break}if(t.length=l&65535,l=0,d=0,t.mode=Ke,e===pe)break t;case Ke:t.mode=cn;case cn:if(u=t.length,u){if(u>r&&(u=r),u>h&&(u=h),u===0)break t;s.set(n.subarray(o,o+u),a),r-=u,o+=u,h-=u,a+=u,t.length-=u;break}t.mode=rt;break;case un:for(;d<14;){if(r===0)break t;r--,l+=n[o++]<<d,d+=8}if(t.nlen=(l&31)+257,l>>>=5,d-=5,t.ndist=(l&31)+1,l>>>=5,d-=5,t.ncode=(l&15)+4,l>>>=4,d-=4,t.nlen>286||t.ndist>30){i.msg="too many length or distance symbols",t.mode=D;break}t.have=0,t.mode=gn;case gn:for(;t.have<t.ncode;){for(;d<3;){if(r===0)break t;r--,l+=n[o++]<<d,d+=8}t.lens[L[t.have++]]=l&7,l>>>=3,d-=3}for(;t.have<19;)t.lens[L[t.have++]]=0;if(t.lencode=t.lendyn,t.lenbits=7,T={bits:t.lenbits},B=ie(Io,t.lens,0,19,t.lencode,0,t.work,T),t.lenbits=T.bits,B){i.msg="invalid code lengths set",t.mode=D;break}t.have=0,t.mode=fn;case fn:for(;t.have<t.nlen+t.ndist;){for(;y=t.lencode[l&(1<<t.lenbits)-1],m=y>>>24,w=y>>>16&255,b=y&65535,!(m<=d);){if(r===0)break t;r--,l+=n[o++]<<d,d+=8}if(b<16)l>>>=m,d-=m,t.lens[t.have++]=b;else{if(b===16){for(A=m+2;d<A;){if(r===0)break t;r--,l+=n[o++]<<d,d+=8}if(l>>>=m,d-=m,t.have===0){i.msg="invalid bit length repeat",t.mode=D;break}v=t.lens[t.have-1],u=3+(l&3),l>>>=2,d-=2}else if(b===17){for(A=m+3;d<A;){if(r===0)break t;r--,l+=n[o++]<<d,d+=8}l>>>=m,d-=m,v=0,u=3+(l&7),l>>>=3,d-=3}else{for(A=m+7;d<A;){if(r===0)break t;r--,l+=n[o++]<<d,d+=8}l>>>=m,d-=m,v=0,u=11+(l&127),l>>>=7,d-=7}if(t.have+u>t.nlen+t.ndist){i.msg="invalid bit length repeat",t.mode=D;break}for(;u--;)t.lens[t.have++]=v}}if(t.mode===D)break;if(t.lens[256]===0){i.msg="invalid code -- missing end-of-block",t.mode=D;break}if(t.lenbits=9,T={bits:t.lenbits},B=ie(ji,t.lens,0,t.nlen,t.lencode,0,t.work,T),t.lenbits=T.bits,B){i.msg="invalid literal/lengths set",t.mode=D;break}if(t.distbits=6,t.distcode=t.distdyn,T={bits:t.distbits},B=ie(Zi,t.lens,t.nlen,t.ndist,t.distcode,0,t.work,T),t.distbits=T.bits,B){i.msg="invalid distances set",t.mode=D;break}if(t.mode=we,e===pe)break t;case we:t.mode=be;case be:if(r>=6&&h>=258){i.next_out=a,i.avail_out=h,i.next_in=o,i.avail_in=r,t.hold=l,t.bits=d,Bo(i,c),a=i.next_out,s=i.output,h=i.avail_out,o=i.next_in,n=i.input,r=i.avail_in,l=t.hold,d=t.bits,t.mode===rt&&(t.back=-1);break}for(t.back=0;y=t.lencode[l&(1<<t.lenbits)-1],m=y>>>24,w=y>>>16&255,b=y&65535,!(m<=d);){if(r===0)break t;r--,l+=n[o++]<<d,d+=8}if(w&&(w&240)===0){for(_=m,C=w,E=b;y=t.lencode[E+((l&(1<<_+C)-1)>>_)],m=y>>>24,w=y>>>16&255,b=y&65535,!(_+m<=d);){if(r===0)break t;r--,l+=n[o++]<<d,d+=8}l>>>=_,d-=_,t.back+=_}if(l>>>=m,d-=m,t.back+=m,t.length=b,w===0){t.mode=bn;break}if(w&32){t.back=-1,t.mode=rt;break}if(w&64){i.msg="invalid literal/length code",t.mode=D;break}t.extra=w&15,t.mode=pn;case pn:if(t.extra){for(A=t.extra;d<A;){if(r===0)break t;r--,l+=n[o++]<<d,d+=8}t.length+=l&(1<<t.extra)-1,l>>>=t.extra,d-=t.extra,t.back+=t.extra}t.was=t.length,t.mode=yn;case yn:for(;y=t.distcode[l&(1<<t.distbits)-1],m=y>>>24,w=y>>>16&255,b=y&65535,!(m<=d);){if(r===0)break t;r--,l+=n[o++]<<d,d+=8}if((w&240)===0){for(_=m,C=w,E=b;y=t.distcode[E+((l&(1<<_+C)-1)>>_)],m=y>>>24,w=y>>>16&255,b=y&65535,!(_+m<=d);){if(r===0)break t;r--,l+=n[o++]<<d,d+=8}l>>>=_,d-=_,t.back+=_}if(l>>>=m,d-=m,t.back+=m,w&64){i.msg="invalid distance code",t.mode=D;break}t.offset=b,t.extra=w&15,t.mode=mn;case mn:if(t.extra){for(A=t.extra;d<A;){if(r===0)break t;r--,l+=n[o++]<<d,d+=8}t.offset+=l&(1<<t.extra)-1,l>>>=t.extra,d-=t.extra,t.back+=t.extra}if(t.offset>t.dmax){i.msg="invalid distance too far back",t.mode=D;break}t.mode=wn;case wn:if(h===0)break t;if(u=c-h,t.offset>u){if(u=t.offset-u,u>t.whave&&t.sane){i.msg="invalid distance too far back",t.mode=D;break}u>t.wnext?(u-=t.wnext,g=t.wsize-u):g=t.wnext-u,u>t.length&&(u=t.length),p=t.window}else p=s,g=a-t.offset,u=t.length;u>h&&(u=h),h-=u,t.length-=u;do s[a++]=p[g++];while(--u);t.length===0&&(t.mode=be);break;case bn:if(h===0)break t;s[a++]=t.length,h--,t.mode=be;break;case qe:if(t.wrap){for(;d<32;){if(r===0)break t;r--,l|=n[o++]<<d,d+=8}if(c-=h,i.total_out+=c,t.total+=c,t.wrap&4&&c&&(i.adler=t.check=t.flags?z(t.check,s,c,a-c):Wt(t.check,s,c,a-c)),c=h,t.wrap&4&&(t.flags?l:Tn(l))!==t.check){i.msg="incorrect data check",t.mode=D;break}l=0,d=0}t.mode=_n;case _n:if(t.wrap&&t.flags){for(;d<32;){if(r===0)break t;r--,l+=n[o++]<<d,d+=8}if(t.wrap&4&&l!==(t.total&4294967295)){i.msg="incorrect length check",t.mode=D;break}l=0,d=0}t.mode=En;case En:B=Do;break t;case D:B=qi;break t;case Cn:return Ji;case xn:default:return j}return i.next_out=a,i.avail_out=h,i.next_in=o,i.avail_in=r,t.hold=l,t.bits=d,(t.wsize||c!==i.avail_out&&t.mode<D&&(t.mode<qe||e!==Ki))&&Ln(i,i.output,i.next_out,c-i.avail_out),f-=i.avail_in,c-=i.avail_out,i.total_in+=f,i.total_out+=c,t.total+=c,t.wrap&4&&c&&(i.adler=t.check=t.flags?z(t.check,s,c,i.next_out-c):Wt(t.check,s,c,i.next_out-c)),i.data_type=t.bits+(t.last?64:0)+(t.mode===rt?128:0)+(t.mode===we||t.mode===Ke?256:0),(f===0&&c===0||e===Ki)&&B===Tt&&(B=Po),B},Yo=i=>{if(vt(i))return j;let e=i.state;return e.window&&(e.window=null),i.state=null,Tt},$o=(i,e)=>{if(vt(i))return j;const t=i.state;return(t.wrap&2)===0?j:(t.head=e,e.done=!1,Tt)},Wo=(i,e)=>{const t=e.length;let n,s,o;return vt(i)||(n=i.state,n.wrap!==0&&n.mode!==me)?j:n.mode===me&&(s=1,s=Wt(s,e,t,0),s!==n.check)?qi:(o=Ln(i,e,t,t),o?(n.mode=Cn,Ji):(n.havedict=1,Tt))};var Vo=An,jo=Bn,Zo=vn,Ko=Uo,qo=Sn,Jo=Fo,Qo=Yo,tr=$o,er=Wo,ir="pako inflate (from Nodeca project)",at={inflateReset:Vo,inflateReset2:jo,inflateResetKeep:Zo,inflateInit:Ko,inflateInit2:qo,inflate:Jo,inflateEnd:Qo,inflateGetHeader:tr,inflateSetDictionary:er,inflateInfo:ir};function nr(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}var sr=nr;const Mn=Object.prototype.toString,{Z_NO_FLUSH:or,Z_FINISH:rr,Z_OK:ne,Z_STREAM_END:ti,Z_NEED_DICT:ei,Z_STREAM_ERROR:ar,Z_DATA_ERROR:In,Z_MEM_ERROR:lr}=Vt;function se(i){this.options=ue.assign({chunkSize:1024*64,windowBits:15,to:""},i||{});const e=this.options;e.raw&&e.windowBits>=0&&e.windowBits<16&&(e.windowBits=-e.windowBits,e.windowBits===0&&(e.windowBits=-15)),e.windowBits>=0&&e.windowBits<16&&!(i&&i.windowBits)&&(e.windowBits+=32),e.windowBits>15&&e.windowBits<48&&(e.windowBits&15)===0&&(e.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new Xi,this.strm.avail_out=0;let t=at.inflateInit2(this.strm,e.windowBits);if(t!==ne)throw new Error(_t[t]);if(this.header=new sr,at.inflateGetHeader(this.strm,this.header),e.dictionary&&(typeof e.dictionary=="string"?e.dictionary=te.string2buf(e.dictionary):Mn.call(e.dictionary)==="[object ArrayBuffer]"&&(e.dictionary=new Uint8Array(e.dictionary)),e.raw&&(t=at.inflateSetDictionary(this.strm,e.dictionary),t!==ne)))throw new Error(_t[t])}se.prototype.push=function(i,e){const t=this.strm,n=this.options.chunkSize,s=this.options.dictionary;let o,a,r;if(this.ended)return!1;for(e===~~e?a=e:a=e===!0?rr:or,Mn.call(i)==="[object ArrayBuffer]"?t.input=new Uint8Array(i):t.input=i,t.next_in=0,t.avail_in=t.input.length;;){for(t.avail_out===0&&(t.output=new Uint8Array(n),t.next_out=0,t.avail_out=n),o=at.inflate(t,a),o===ei&&s&&(o=at.inflateSetDictionary(t,s),o===ne?o=at.inflate(t,a):o===In&&(o=ei));t.avail_in>0&&o===ti&&t.state.wrap>0&&i[t.next_in]!==0;)at.inflateReset(t),o=at.inflate(t,a);switch(o){case ar:case In:case ei:case lr:return this.onEnd(o),this.ended=!0,!1}if(r=t.avail_out,t.next_out&&(t.avail_out===0||o===ti))if(this.options.to==="string"){let h=te.utf8border(t.output,t.next_out),l=t.next_out-h,d=te.buf2string(t.output,h);t.next_out=l,t.avail_out=n-l,l&&t.output.set(t.output.subarray(h,h+l),0),this.onData(d)}else this.onData(t.output.length===t.next_out?t.output:t.output.subarray(0,t.next_out));if(!(o===ne&&r===0)){if(o===ti)return o=at.inflateEnd(this.strm),this.onEnd(o),this.ended=!0,!0;if(t.avail_in===0)break}}return!0},se.prototype.onData=function(i){this.chunks.push(i)},se.prototype.onEnd=function(i){i===ne&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=ue.flattenChunks(this.chunks)),this.chunks=[],this.err=i,this.msg=this.strm.msg};function ii(i,e){const t=new se(e);if(t.push(i),t.err)throw t.msg||_t[t.err];return t.result}function hr(i,e){return e=e||{},e.raw=!0,ii(i,e)}var dr=se,cr=ii,ur=hr,gr=ii,fr={Inflate:dr,inflate:cr,inflateRaw:ur,ungzip:gr};const{Deflate:pr,deflate:yr,deflateRaw:mr,gzip:wr}=vo,{Inflate:br,inflate:_r,inflateRaw:Er,ungzip:Cr}=fr;var xr=pr,Tr=yr,vr=mr,Ar=wr,Br=br,Sr=_r,kr=Er,Lr=Cr,Mr=Vt,Nn={Deflate:xr,deflate:Tr,deflateRaw:vr,gzip:Ar,Inflate:Br,inflate:Sr,inflateRaw:kr,ungzip:Lr,constants:Mr};function ni(i){return i<=26?String.fromCharCode(64+i):i%26===0?ni(Math.floor(i/26)-1)+"Z":ni(Math.floor(i/26))+String.fromCharCode(64+i%26)}class Ir{constructor(){this.count=0,this.idMap=new Map,this.reverseMap=new Map}getShortId(e){if(!this.idMap.has(e)){this.count++;const t=ni(this.count);this.idMap.set(e,t),this.reverseMap.set(t,e)}return this.idMap.get(e)}getOriginalId(e){return this.reverseMap.get(e)}reset(){this.count=0,this.idMap.clear(),this.reverseMap.clear()}}function _e(i){return i<10?String.fromCharCode(48+i):(i-=10,i<26?String.fromCharCode(65+i):(i-=26,i<26?String.fromCharCode(97+i):(i-=26,i===0?"-":i===1?"_":"?")))}function oe(i){const e=i.charCodeAt(0);return e>=48&&e<=57?e-48:e>=65&&e<=90?e-65+10:e>=97&&e<=122?e-97+36:i==="-"?62:i==="_"?63:-1}function si(i,e,t){const n=i>>2,s=(i&3)<<4|e>>4,o=(e&15)<<2|t>>6,a=t&63;return _e(n&63)+_e(s&63)+_e(o&63)+_e(a&63)}function Dn(i){const t=new TextEncoder().encode(i),n=Nn.deflateRaw(t,{level:9});let s="";for(let o=0;o<n.length;o+=3)o+2===n.length?s+=si(n[o],n[o+1],0):o+1===n.length?s+=si(n[o],0,0):s+=si(n[o],n[o+1],n[o+2]);return s}function Nr(i){try{const e=[];for(let o=0;o<i.length;o+=4){const a=oe(i[o]||"0"),r=oe(i[o+1]||"0"),h=oe(i[o+2]||"0"),l=oe(i[o+3]||"0");if(a<0||r<0)return null;e.push(a<<2|r>>4),o+2<i.length&&h>=0&&e.push((r&15)<<4|h>>2),o+3<i.length&&l>=0&&e.push((h&3)<<6|l)}const t=new Uint8Array(e),n=Nn.inflateRaw(t);return new TextDecoder("utf-8").decode(n)}catch(e){return console.error("Deflate decompression failed:",e),null}}function Dr(i){const e=i.trim();if(e.startsWith("@startuml")||e.startsWith("'"))return!1;for(const t of e)if(oe(t)<0)return!1;return e.length>0}function Rr(i,e="https://www.plantuml.com/plantuml/svg/"){return e+i}const oi={default:"rectangle",server:"node",database:"database",client:"agent",cloud:"cloud",storage:"storage",folder:"folder",file:"file",component:"component",queue:"queue",stack:"stack",actor:"actor",boundary:"boundary",control:"control",entity:"entity",card:"card",frame:"frame",package:"package",usecase:"usecase",artifact:"artifact",rectangle:"rectangle",hexagon:"hexagon"};function Pr(i){return i&&oi[i.toLowerCase()]||oi.default}function pt(i){return i.replace(/[^\w]/g,"_")}function ri(i){return i.replace(/"/g,'\\"')}function zr(i){const e=new Map;for(const t of i){const n=t.parentId||null;e.has(n)||e.set(n,[]),e.get(n).push(t)}return e}function Or(i,e){if(!e)return"";const t={id:i.id};i.type&&(t.type=i.type),i.coordinates&&(t.coordinates=i.coordinates),i.meta&&Object.keys(i.meta).length>0&&(t.meta=i.meta),i.info&&Object.keys(i.info).length>0&&(t.info=i.info);const n=i;if(n.style&&typeof n.style=="object"){const s=n.style,o={};s.color!==void 0&&(o.color=s.color),s.borderColor!==void 0&&(o.borderColor=s.borderColor),s.width!==void 0&&(o.width=s.width),s.height!==void 0&&(o.height=s.height),Object.keys(o).length>0&&(t.style=o)}return`' @relatos:node ${JSON.stringify(t)}`}function Hr(i,e){return!e||!i.position?"":`' @relatos:layout:node ${JSON.stringify({id:i.id,position:i.position})}`}function Gr(i,e){if(!e)return"";const t={id:i.id};return i.parentId&&(t.parentId=i.parentId),i.nodeIds&&i.nodeIds.length>0&&(t.nodeIds=i.nodeIds),i.meta&&Object.keys(i.meta).length>0&&(t.meta=i.meta),`' @relatos:group ${JSON.stringify(t)}`}function Ur(i,e){return!e||!i.layout?"":`' @relatos:layout:group ${JSON.stringify({id:i.id,layout:i.layout})}`}function Xr(i,e){if(!e)return"";const t={id:i.id,src:i.src,dst:i.dst};i.relType&&(t.relType=i.relType),i.meta&&Object.keys(i.meta).length>0&&(t.meta=i.meta),i.info&&Object.keys(i.info).length>0&&(t.info=i.info);const n=i;if(n.style&&typeof n.style=="object"){const s=n.style,o={};s.color!==void 0&&(o.color=s.color),s.weight!==void 0&&(o.weight=s.weight),s.label!==void 0&&(o.label=s.label),s.srcLabel!==void 0&&(o.srcLabel=s.srcLabel),s.dstLabel!==void 0&&(o.dstLabel=s.dstLabel),Object.keys(o).length>0&&(t.style=o)}return`' @relatos:edge ${JSON.stringify(t)}`}function Fr(i,e){if(!e)return"";const t=i;if(!(t.srcAnchor||t.dstAnchor||i.bends&&i.bends.length>0))return"";const s={id:i.id};return t.srcAnchor&&(s.srcAnchor=t.srcAnchor),t.dstAnchor&&(s.dstAnchor=t.dstAnchor),i.bends&&i.bends.length>0&&(s.bends=i.bends),`' @relatos:layout:edge ${JSON.stringify(s)}`}function Yr(i){const e=i;if(!e.style)return"";const t=[];if(e.style.color){let n=e.style.color.replace(/^#/,"");/^[0-9A-Fa-f]{6}$/.test(n)&&(n=`${n}7F`),t.push(`#${n}`)}if(e.style.borderColor){const n=e.style.borderColor.replace(/^#/,"");t.length===0?t.push(`#white;line:${n}`):t[0]=`${t[0]};line:${n}`}return t.length>0?` ${t.join("")}`:""}function Rn(i,e="",t=null,n=!0){const s=Pr(i.type),o=t?t.getShortId(i.id):pt(i.id),a=ri(i.label),r=Yr(i),h=Or(i,n),l=Hr(i,n),d=[];h&&d.push(`${e}${h}`),l&&d.push(`${e}${l}`);const f=`${e}${s} "${a}" as ${o}${r}`;return d.length>0?d.join(`
`)+`
`+f:f}function Pn(i,e,t,n,s,o="",a=null,r=!0){const h=[],l=a?a.getShortId(i.id):pt(i.id),d=ri(i.label),f=Gr(i,r),c=Ur(i,r);f&&h.push(`${o}${f}`),c&&h.push(`${o}${c}`),h.push(`${o}package "${d}" as ${l} {`);const u=o+"  ",g=new Set(i.nodeIds||[]);for(const y of g){const m=t.find(w=>w.id===y);m&&(h.push(Rn(m,u,a,r)),s.add(y))}const p=n.get(i.id)||[];for(const y of p)h.push(""),h.push(Pn(y,e,t,n,s,u,a,r));return h.push(`${o}}`),h.join(`
`)}function $r(i){const e=i;if(!e.style)return"-->";const t=[];if(e.style.color){const n=e.style.color.replace(/^#/,"");t.push(`#${n}`)}if(e.style.weight!==void 0){const n=e.style.weight;(n>=5||n>=3)&&t.push("bold")}return t.length>0?`-[${t.join(",")}]->`:"-->"}function Wr(i,e=null,t=!0){const n=e?e.getShortId(i.src):pt(i.src),s=e?e.getShortId(i.dst):pt(i.dst),o=i.relType?` : ${ri(i.relType)}`:"",a=$r(i),r=Xr(i,t),h=Fr(i,t),l=[];r&&l.push(r),h&&l.push(h);const d=`${n} ${a} ${s}${o}`;return l.length>0?l.join(`
`)+`
`+d:d}function Ee(i,e,t,n){const s=n?.useShortIds??!1,o=n?.includeMetadata??!0,a=n?.outputFormat??"plain";n?.serverUrlPrefix;const r=s?new Ir:null,h=[];h.push("@startuml"),h.push(""),h.push("skinparam backgroundColor #efefef"),h.push("skinparam componentStyle uml2"),h.push("left to right direction"),h.push("");const l=new Set;if(t&&t.length>0){o&&(h.push("' === GROUPS ==="),h.push(""));const c=zr(t),u=c.get(null)||[];for(const g of u)h.push(Pn(g,t,i,c,l,"",r,o)),h.push("")}const d=i.filter(c=>!l.has(c.id));if(d.length>0){o&&(h.push("' === STANDALONE NODES ==="),h.push(""));for(const c of d)h.push(Rn(c,"",r,o)),h.push("")}if(e.length>0){o&&(h.push("' === EDGES ==="),h.push(""));for(const c of e)h.push(Wr(c,r,o)),h.push("")}h.push("@enduml");const f=h.join(`
`);return a==="deflate"?Dn(f):f}function Vr(i){const e=i.match(/^'\s*@relatos:(\w+)\s+(.+)$/);if(!e||e[1]==="layout")return null;try{const t=e[1],n=JSON.parse(e[2]);return{type:t,data:n}}catch{return null}}function jr(i){const e=i.match(/^'\s*@relatos:layout:(node|group|edge)\s+(.+)$/);if(!e)return null;try{const t=e[1],n=JSON.parse(e[2]);return{kind:t,data:n}}catch{return null}}function Zr(i){const e=i.match(/^\s*(\w+)\s+"([^"]+)"\s+as\s+(\w+)(?:\s+(#[^;\s]+(?:;line:[^;\s]+)?))?\s*$/);if(!e)return null;const t={type:e[1],label:e[2].replace(/\\"/g,'"'),id:e[3]};if(e[4]){const n=e[4],s={},o=n.match(/^(#[0-9A-Fa-f]{8}|#[0-9A-Fa-f]{6}|#[0-9A-Fa-f]{3}|#\w+)/);if(o){let r=o[1];/^#[0-9A-Fa-f]{8}$/.test(r)&&(r=r.slice(0,7)),s.color=r}const a=n.match(/;line:(#?[0-9A-Fa-f]{6}|#?[0-9A-Fa-f]{3}|#?\w+)/);a&&(s.borderColor=a[1].startsWith("#")?a[1]:`#${a[1]}`),Object.keys(s).length>0&&(t.style=s)}return t}function Kr(i){const e=i.match(/^\s*(?:package|rectangle)\s+"([^"]+)"\s+as\s+(\w+)\s*\{?\s*$/);return e?{label:e[1].replace(/\\"/g,'"'),id:e[2]}:null}function qr(i){const e={src:"",dst:""},t=i.match(/^\s*(\w+)\s+-\[([^\]]+)\]->\s+(\w+)(?:\s+:\s+(.+?))?\s*$/);if(t){e.src=t[1],e.dst=t[3],t[4]&&(e.label=t[4].replace(/\\"/g,'"'));const o=t[2],a={},r=o.match(/#([0-9A-Fa-f]{6}|[0-9A-Fa-f]{3}|\w+)/);return r&&(a.color=`#${r[1]}`),o.includes("bold")&&(a.weight=4),Object.keys(a).length>0&&(e.style=a),e}const n=i.match(/^\s*(\w+)\s+-->\s+(\w+)\s+:\s+(.+?)\s*$/);if(n)return{src:n[1],dst:n[2],label:n[3].replace(/\\"/g,'"')};const s=i.match(/^\s*(\w+)\s+-->\s+(\w+)\s*$/);return s?{src:s[1],dst:s[2]}:null}function zn(i){const e=[],t=[],n=[],s=new Map,o=new Map,a=new Map,r=new Map,h=new Map,l=new Map,d=new Map,f=new Map;let c=null;const u=[],g=i.split(`
`);for(let p=0;p<g.length;p++){const y=g[p].trim();if(!y||y.startsWith("'")&&!y.includes("@relatos:")||y==="@startuml"||y==="@enduml"||y.startsWith("skinparam")||y.startsWith("left to right"))continue;const m=jr(y);if(m){const E=m.data.id;E&&(m.kind==="node"?r.set(pt(E),m.data.position):m.kind==="group"?h.set(pt(E),m.data.layout):m.kind==="edge"&&l.set(E,m.data));continue}const w=Vr(y);if(w){c=w;const E=w.data.id;E&&(w.type==="node"?s.set(pt(E),w.data):w.type==="edge"?o.set(E,w.data):w.type==="group"&&a.set(pt(E),w.data));continue}if(y==="}"){u.pop(),c=null;continue}const b=Kr(y);if(b){const E=c?.type==="group"?c.data:a.get(b.id),v=E?.id||b.id;f.set(b.id,v);const B={id:v,label:b.label,nodeIds:E?.nodeIds||[],parentId:u.length>0?f.get(u[u.length-1]):E?.parentId,layout:h.get(b.id)??E?.layout??void 0,meta:E?.meta||void 0};n.push(B),u.push(b.id),c=null;continue}const _=Zr(y);if(_){const E=c?.type==="node"?c.data:s.get(_.id),v=E?.id||_.id;d.set(_.id,v);const B={id:v,label:_.label,type:E?.type||_.type,coordinates:E?.coordinates||void 0,position:r.get(_.id)??E?.position??void 0,meta:E?.meta||void 0,info:E?.info||void 0};E?.style&&typeof E.style=="object"?B.style=E.style:_.style&&(B.style=_.style),e.push(B),c=null;continue}const C=qr(y);if(C){const E=d.get(C.src)||C.src,v=d.get(C.dst)||C.dst,B=`${C.src}_${C.dst}`,x=c?.type==="edge"?c.data:null,T=x?.id||B,A=l.get(T)??l.get(B),L={id:T,src:x?.src||E,dst:x?.dst||v,relType:x?.relType||C.label||"",bends:A?.bends??x?.bends??void 0,meta:x?.meta||void 0,info:x?.info||void 0};x?.style&&typeof x.style=="object"?L.style=x.style:C.style&&(L.style=C.style);const S=L;A?.srcAnchor!=null&&(S.srcAnchor=A.srcAnchor),A?.dstAnchor!=null&&(S.dstAnchor=A.dstAnchor),A?.srcAnchor==null&&x?.srcAnchor!=null&&(S.srcAnchor=x.srcAnchor),A?.dstAnchor==null&&x?.dstAnchor!=null&&(S.dstAnchor=x.dstAnchor),t.push(L),c=null;continue}}return{nodes:e,edges:t,groups:n}}async function Jr(i){try{if(navigator.clipboard&&window.isSecureContext)return await navigator.clipboard.writeText(i),!0;{const e=document.createElement("textarea");e.value=i,e.style.position="fixed",e.style.left="-999999px",e.style.top="-999999px",document.body.appendChild(e),e.focus(),e.select();const t=document.execCommand("copy");return document.body.removeChild(e),t}}catch(e){return console.error("Failed to copy to clipboard:",e),!1}}function tt(i,e=16){return St(),`<svg width="${e}" height="${e}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <use href="#${i}"></use>
  </svg>`}class Qr{constructor(e,t){this.currentView=null,this.views=new Map,this.tabButtons=new Map,this.editToggleButton=null,this.alwaysShowEdgesButton=null,this.lightingToggleButton=null,this.tileTypeButton=null,this.moonToggleButton=null,this.fitCenterButton=null,this.deleteBendButton=null,this.undoButton=null,this.redoButton=null,this.cancelEditButton=null,this.exportButton=null,this.plantUMLExportOptions={useShortIds:!0,includeMetadata:!0,outputFormat:"plain"},this.tableContainer=null,this.nodesTableContainer=null,this.edgesTableContainer=null,this.groupsTableContainer=null,this.tableOptions=null,this.nodes=[],this.edges=[],this.groups=[],this.isExternalTableContainer=!1,this.hasEdges=!1,this.sharedAlwaysShowEdges=!1,this.sharedLightingEnabled=!1,this.sharedTime=null,this.sharedTileServerIndex=0,this.container=e,this.enabledViews=t,St(),this.container.style.display="flex",this.container.style.flexDirection="column",this.container.style.width="100%",this.tabContainer=document.createElement("div"),this.tabContainer.style.display="flex",this.tabContainer.style.gap="4px",this.tabContainer.style.padding="8px",this.tabContainer.style.borderBottom="none",this.tabContainer.style.backgroundColor="transparent",this.tabContainer.style.position="absolute",this.tabContainer.style.top="0",this.tabContainer.style.left="0",this.tabContainer.style.right="0",this.tabContainer.style.zIndex="1000",this.tabContainer.style.pointerEvents="none",this.viewContainer=document.createElement("div"),this.viewContainer.style.flex="1 1 0%",this.viewContainer.style.position="relative",this.viewContainer.style.overflow="hidden",this.viewContainer.style.minHeight="0",this.createTabButtons(),this.createCommonControlsContainer(),this.container.appendChild(this.viewContainer),this.viewContainer.appendChild(this.tabContainer)}setTableOptions(e){this.tableOptions=e,e&&(e.nodes?.format||e.edges?.format||e.groups?.format)?this.createTableContainer():this.tableContainer&&(this.isExternalTableContainer?(this.tableContainer.innerHTML="",this.tableContainer=null,this.isExternalTableContainer=!1):this.container.contains(this.tableContainer)&&(this.container.removeChild(this.tableContainer),this.tableContainer=null),this.nodesTableContainer=null,this.edgesTableContainer=null,this.groupsTableContainer=null)}setOnNodeClickCallback(e){this.onNodeClickCallback=e}createTableContainer(){if(!this.tableContainer){if(this.tableOptions&&"container"in this.tableOptions&&this.tableOptions.container){const e=this.tableOptions.container;let t=null;if(typeof e=="string"?t=document.querySelector(e):e instanceof HTMLElement&&(t=e),t){this.tableContainer=t,this.isExternalTableContainer=!0;return}}this.tableContainer=document.createElement("div"),this.tableContainer.style.height="300px",this.tableContainer.style.overflowY="auto",this.tableContainer.style.backgroundColor="#fff",this.tableContainer.style.borderTop="1px solid #ddd",this.isExternalTableContainer=!1,this.container.appendChild(this.tableContainer)}}setData(e,t,n){this.nodes=e,this.edges=t,this.groups=n||[],this.hasEdges=Array.isArray(t)&&t.length>0,this.updateTables(),this.updateAlwaysShowEdgesButtonVisibility()}getData(){return{nodes:this.nodes,edges:this.edges,groups:this.groups}}updateTables(){!this.tableOptions||!this.tableContainer||(this.tableContainer.innerHTML="",this.tableOptions.nodes?.format&&(this.nodesTableContainer=this.createTable("nodes",this.tableOptions.nodes.header||"",this.tableOptions.nodes.format,this.nodes,"node"),this.tableContainer.appendChild(this.nodesTableContainer)),this.tableOptions.edges?.format&&(this.edgesTableContainer=this.createTable("edges",this.tableOptions.edges.header||"",this.tableOptions.edges.format,this.edges,"edge"),this.tableContainer.appendChild(this.edgesTableContainer)),this.tableOptions.groups?.format&&(this.groupsTableContainer=this.createTable("groups",this.tableOptions.groups.header||"",this.tableOptions.groups.format,this.groups,"group"),this.tableContainer.appendChild(this.groupsTableContainer)))}createTable(e,t,n,s,o){const a=document.createElement("div"),r=document.createElement("table");if(r.style.width="100%",r.style.borderCollapse="collapse",!document.getElementById("relatos-table-styles")){const d=document.createElement("style");d.id="relatos-table-styles",d.textContent=`
        .relatos-table tr {
          border-bottom: 1px solid #ddd;
        }
        .relatos-table tr:hover {
          background-color: #f9f9f9;
        }
        .relatos-table tr.highlight {
          background-color: #fff9c4;
          animation: relatos-highlight-fade 2s ease-out;
        }
        @keyframes relatos-highlight-fade {
          from {
            background-color: #fff9c4;
          }
          to {
            background-color: transparent;
          }
        }
        .relatos-table th,
        .relatos-table td {
          padding: 12px;
          text-align: left;
        }
        .relatos-table th {
          background-color: #f5f5f5;
          font-weight: 600;
          color: #333;
          position: sticky;
          top: 0;
          z-index: 1;
        }
      `,document.head.appendChild(d)}r.className="relatos-table";const h=document.createElement("thead");if(t)h.innerHTML=t;else{const d=document.createElement("tr");h.appendChild(d)}r.appendChild(h);const l=document.createElement("tbody");for(const d of s){const f=document.createElement("tr");f.id=`${o}-${d.id}`,f.style.cursor="pointer";let c=n;if("info"in d&&d.info)for(const[u,g]of Object.entries(d.info)){const p=new RegExp(`\\{\\{info\\.${u}\\}\\}`,"g");c=c.replace(p,String(g||""))}if(c=c.replace(/\{\{info\.[^}]+\}\}/g,""),c=c.replace(/\{\{id\}\}/g,String(d.id||"")),c=c.replace(/\{\{label\}\}/g,String("label"in d&&d.label||"")),c=c.replace(/\{\{type\}\}/g,String("type"in d&&d.type||"")),"coordinates"in d&&d.coordinates&&(c=c.replace(/\{\{coordinates\.0\}\}/g,String(d.coordinates[0]||"")),c=c.replace(/\{\{coordinates\.1\}\}/g,String(d.coordinates[1]||"")),c=c.replace(/\{\{latitude\}\}/g,String(d.coordinates[0]||"")),c=c.replace(/\{\{longitude\}\}/g,String(d.coordinates[1]||""))),d.style&&typeof d.style=="object"){const u=d.style;c=c.replace(/\{\{style\.color\}\}/g,String(u.color??"")),c=c.replace(/\{\{style\.borderColor\}\}/g,String(u.borderColor??"")),c=c.replace(/\{\{style\.width\}\}/g,String(u.width??"")),c=c.replace(/\{\{style\.height\}\}/g,String(u.height??"")),c=c.replace(/\{\{style\.weight\}\}/g,String(u.weight??"")),c=c.replace(/\{\{style\.label\}\}/g,String(u.label??"")),c=c.replace(/\{\{style\.srcLabel\}\}/g,String(u.srcLabel??"")),c=c.replace(/\{\{style\.dstLabel\}\}/g,String(u.dstLabel??""))}if("src"in d&&(c=c.replace(/\{\{src\}\}/g,String(d.src||"")),c=c.replace(/\{\{dst\}\}/g,String(d.dst||"")),c=c.replace(/\{\{relType\}\}/g,String(d.relType||""))),"nodeIds"in d){const u=d;if(c=c.replace(/\{\{nodeIds\}\}/g,String(u.nodeIds?.join(", ")||"")),c=c.replace(/\{\{nodeCount\}\}/g,String(u.nodeIds?.length||0)),c=c.replace(/\{\{parentId\}\}/g,String(u.parentId||"")),u.meta&&typeof u.meta=="object")for(const[g,p]of Object.entries(u.meta)){const y=new RegExp(`\\{\\{meta\\.${g}\\}\\}`,"g");c=c.replace(y,String(p||""))}u.layout&&(c=c.replace(/\{\{layout\.position\.x\}\}/g,String(u.layout.position.x||"")),c=c.replace(/\{\{layout\.position\.y\}\}/g,String(u.layout.position.y||"")),c=c.replace(/\{\{layout\.size\.width\}\}/g,String(u.layout.size.width||"")),c=c.replace(/\{\{layout\.size\.height\}\}/g,String(u.layout.size.height||"")))}f.innerHTML=c,f.addEventListener("click",()=>{if(o==="node"){if(this.highlightAndScrollToRow(f),!this.currentView)return;const u=this.views.get(this.currentView);u?.selectNode&&u.selectNode(d.id)}}),l.appendChild(f)}return r.appendChild(l),a.appendChild(r),a}highlightAndScrollToRow(e){const t=this.tableContainer?.querySelector(".highlight");t&&t.classList.remove("highlight"),e.classList.add("highlight"),setTimeout(()=>{e.classList.remove("highlight")},2e3),e.scrollIntoView({behavior:"smooth",block:"center"})}highlightNodeRow(e){if(!e||!this.tableContainer)return;const t=this.tableContainer.querySelector(`#node-${e}`);t&&this.highlightAndScrollToRow(t)}highlightNodeRows(e){if(!e||e.length===0||!this.tableContainer)return;this.tableContainer.querySelectorAll(".highlight").forEach(s=>s.classList.remove("highlight"));let n=null;for(const s of e){const o=this.tableContainer?.querySelector(`#node-${s}`);o&&(o.classList.add("highlight"),n||(n=o),setTimeout(()=>{o.classList.remove("highlight")},2e3))}n&&n.scrollIntoView({behavior:"smooth",block:"center"})}highlightEdgeRow(e){if(!e||!this.tableContainer)return;const t=this.tableContainer.querySelector(`#edge-${e}`);t&&this.highlightAndScrollToRow(t)}highlightGroupRow(e){if(!e||!this.tableContainer)return;const t=this.tableContainer.querySelector(`#group-${e}`);t&&this.highlightAndScrollToRow(t)}createCommonControlsContainer(){this.commonControlsContainer=document.createElement("div"),this.commonControlsContainer.style.display="flex",this.commonControlsContainer.style.gap="4px",this.commonControlsContainer.style.marginLeft="auto",this.commonControlsContainer.style.pointerEvents="none",this.createCancelEditButton(),this.createUndoButton(),this.createRedoButton(),this.createEditToggleButton(),this.createAlwaysShowEdgesButton(),this.createDeleteBendButton(),this.createLightingToggleButton(),this.createTileTypeButton(),this.createMoonToggleButton(),this.createFitCenterButton(),this.createExportButton(),this.tabContainer.appendChild(this.commonControlsContainer)}createEditToggleButton(){this.editToggleButton=document.createElement("button"),this.editToggleButton.className="relatos-edit-toggle",this.editToggleButton.style.padding="6px",this.editToggleButton.style.border="1px solid #ccc",this.editToggleButton.style.borderRadius="4px",this.editToggleButton.style.backgroundColor="#fff",this.editToggleButton.style.cursor="pointer",this.editToggleButton.style.fontSize="16px",this.editToggleButton.style.width="32px",this.editToggleButton.style.height="32px",this.editToggleButton.style.display="none",this.editToggleButton.style.alignItems="center",this.editToggleButton.style.justifyContent="center",this.editToggleButton.style.pointerEvents="auto",this.editToggleButton.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)",this.editToggleButton.style.transition="0.2s",this.editToggleButton.style.color="#333",this.commonControlsContainer.insertBefore(this.editToggleButton,this.commonControlsContainer.firstChild)}createAlwaysShowEdgesButton(){this.alwaysShowEdgesButton=document.createElement("button"),this.alwaysShowEdgesButton.className="relatos-always-show-edges-toggle",this.alwaysShowEdgesButton.innerHTML=tt("icon-relations",16),this.alwaysShowEdgesButton.setAttribute("aria-label","Toggle edges"),this.alwaysShowEdgesButton.setAttribute("title","Toggle edges"),this.alwaysShowEdgesButton.style.padding="6px",this.alwaysShowEdgesButton.style.border="1px solid #ccc",this.alwaysShowEdgesButton.style.borderRadius="4px",this.alwaysShowEdgesButton.style.backgroundColor="#fff",this.alwaysShowEdgesButton.style.cursor="pointer",this.alwaysShowEdgesButton.style.fontSize="16px",this.alwaysShowEdgesButton.style.width="32px",this.alwaysShowEdgesButton.style.height="32px",this.alwaysShowEdgesButton.style.display="flex",this.alwaysShowEdgesButton.style.alignItems="center",this.alwaysShowEdgesButton.style.justifyContent="center",this.alwaysShowEdgesButton.style.pointerEvents="auto",this.alwaysShowEdgesButton.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)",this.alwaysShowEdgesButton.style.transition="0.2s",this.alwaysShowEdgesButton.style.color="#000000",this.alwaysShowEdgesButton.addEventListener("click",()=>{if(!this.currentView)return;const e=this.views.get(this.currentView);if(e?.getAlwaysShowEdges){const t=e.getAlwaysShowEdges();this.setAlwaysShowEdges(!t)}}),this.commonControlsContainer.appendChild(this.alwaysShowEdgesButton)}createLightingToggleButton(){this.lightingToggleButton=document.createElement("button"),this.lightingToggleButton.innerHTML=tt("icon-sun",16),this.lightingToggleButton.setAttribute("aria-label","Toggle lighting"),this.lightingToggleButton.setAttribute("title","Toggle lighting"),this.lightingToggleButton.style.padding="6px",this.lightingToggleButton.style.border="1px solid #ccc",this.lightingToggleButton.style.borderRadius="4px",this.lightingToggleButton.style.backgroundColor="#fff",this.lightingToggleButton.style.cursor="pointer",this.lightingToggleButton.style.fontSize="16px",this.lightingToggleButton.style.width="32px",this.lightingToggleButton.style.height="32px",this.lightingToggleButton.style.display="none",this.lightingToggleButton.style.alignItems="center",this.lightingToggleButton.style.justifyContent="center",this.lightingToggleButton.style.pointerEvents="auto",this.lightingToggleButton.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)",this.lightingToggleButton.style.transition="0.2s",this.lightingToggleButton.addEventListener("click",()=>{if(!this.currentView)return;const e=this.views.get(this.currentView);if(e?.getLightingEnabled){const t=e.getLightingEnabled();this.setLightingEnabled(!t)}}),this.commonControlsContainer.appendChild(this.lightingToggleButton)}createTileTypeButton(){this.tileTypeButton=document.createElement("button"),this.tileTypeButton.innerHTML=tt("icon-map-tiles",16),this.tileTypeButton.setAttribute("aria-label","Switch tile type"),this.tileTypeButton.setAttribute("title","Switch tile type"),this.tileTypeButton.style.padding="6px",this.tileTypeButton.style.border="1px solid #ccc",this.tileTypeButton.style.borderRadius="4px",this.tileTypeButton.style.backgroundColor="#fff",this.tileTypeButton.style.cursor="pointer",this.tileTypeButton.style.fontSize="16px",this.tileTypeButton.style.width="32px",this.tileTypeButton.style.height="32px",this.tileTypeButton.style.display="none",this.tileTypeButton.style.alignItems="center",this.tileTypeButton.style.justifyContent="center",this.tileTypeButton.style.pointerEvents="auto",this.tileTypeButton.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)",this.tileTypeButton.style.transition="0.2s",this.tileTypeButton.addEventListener("click",()=>{if(!this.currentView)return;let e=0;for(const t of this.views.values())if(t.getTileServerCount){const n=t.getTileServerCount();n>e&&(e=n)}if(!(e<2)){this.sharedTileServerIndex=(this.sharedTileServerIndex+1)%e;for(const t of this.views.values())if(t.getTileServerCount&&t.setTileServerIndex){const n=t.getTileServerCount();if(n>0){const s=this.sharedTileServerIndex%n;t.setTileServerIndex(s)}}this.updateTileTypeButton()}}),this.commonControlsContainer.appendChild(this.tileTypeButton)}createMoonToggleButton(){this.moonToggleButton=document.createElement("button"),this.moonToggleButton.setAttribute("aria-label","Toggle moon"),this.moonToggleButton.setAttribute("title","Toggle moon"),this.moonToggleButton.style.padding="6px",this.moonToggleButton.style.border="1px solid #ccc",this.moonToggleButton.style.borderRadius="4px",this.moonToggleButton.style.backgroundColor="#fff",this.moonToggleButton.style.cursor="pointer",this.moonToggleButton.style.fontSize="16px",this.moonToggleButton.style.width="32px",this.moonToggleButton.style.height="32px",this.moonToggleButton.style.display="none",this.moonToggleButton.style.alignItems="center",this.moonToggleButton.style.justifyContent="center",this.moonToggleButton.style.pointerEvents="auto",this.moonToggleButton.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)",this.moonToggleButton.style.transition="0.2s",this.moonToggleButton.addEventListener("click",()=>{if(this.currentView==="map2d"){const e=this.views.get("map2d");e&&e.toggleMoon&&(e.toggleMoon(),this.updateMoonButton())}}),this.commonControlsContainer.appendChild(this.moonToggleButton)}updateMoonButton(){if(!this.moonToggleButton||this.currentView!=="map2d")return;const e=this.views.get("map2d");if(!e)return;const t=e.isMoonEnabled?.()||!1,n=e.getTime?.()||null,s=n?new Date(n):new Date,o=e.getMoonPhase?.(s)||0,a=e.getMoonPhaseIcon?.(o,16)||"";this.moonToggleButton.innerHTML=a,t?(this.moonToggleButton.style.backgroundColor="#fff9c4",this.moonToggleButton.style.boxShadow="inset 0 2px 4px rgba(0, 0, 0, 0.2)",this.moonToggleButton.style.transform="translateY(1px)",this.moonToggleButton.setAttribute("title","Hide moon")):(this.moonToggleButton.style.backgroundColor="#fff",this.moonToggleButton.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)",this.moonToggleButton.style.transform="translateY(0)",this.moonToggleButton.setAttribute("title","Show moon"))}createFitCenterButton(){this.fitCenterButton=document.createElement("button"),this.fitCenterButton.innerHTML=tt("icon-home",16),this.fitCenterButton.setAttribute("aria-label","Fit and center"),this.fitCenterButton.setAttribute("title","Fit and center"),this.fitCenterButton.style.padding="6px",this.fitCenterButton.style.border="1px solid #ccc",this.fitCenterButton.style.borderRadius="4px",this.fitCenterButton.style.backgroundColor="#fff",this.fitCenterButton.style.cursor="pointer",this.fitCenterButton.style.fontSize="16px",this.fitCenterButton.style.width="32px",this.fitCenterButton.style.height="32px",this.fitCenterButton.style.display="flex",this.fitCenterButton.style.alignItems="center",this.fitCenterButton.style.justifyContent="center",this.fitCenterButton.style.pointerEvents="auto",this.fitCenterButton.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)",this.fitCenterButton.style.transition="0.2s",this.fitCenterButton.addEventListener("click",()=>{if(!this.currentView)return;const e=this.views.get(this.currentView);e?.fitAndCenter&&e.fitAndCenter()}),this.commonControlsContainer.appendChild(this.fitCenterButton)}createExportButton(){this.exportButton=document.createElement("button"),this.exportButton.innerHTML=tt("icon-export",16),this.exportButton.setAttribute("aria-label","Export to PlantUML"),this.exportButton.setAttribute("title","Export to PlantUML (copy to clipboard)"),this.exportButton.style.padding="6px",this.exportButton.style.border="1px solid #ccc",this.exportButton.style.borderRadius="4px",this.exportButton.style.backgroundColor="#fff",this.exportButton.style.cursor="pointer",this.exportButton.style.fontSize="16px",this.exportButton.style.width="32px",this.exportButton.style.height="32px",this.exportButton.style.display="flex",this.exportButton.style.alignItems="center",this.exportButton.style.justifyContent="center",this.exportButton.style.pointerEvents="auto",this.exportButton.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)",this.exportButton.style.transition="0.2s",this.exportButton.addEventListener("click",async()=>{await this.exportToPlantUMLAndCopy()}),this.commonControlsContainer.appendChild(this.exportButton)}async exportToPlantUMLAndCopy(){try{const e=Ee(this.nodes,this.edges,this.groups,this.plantUMLExportOptions);console.log("Exported PlantUML length:",e.length);const t=await Jr(e);this.exportButton&&(t?(this.exportButton.style.backgroundColor="#c8e6c9",this.exportButton.style.borderColor="#4caf50",this.exportButton.setAttribute("title","Copied to clipboard!"),setTimeout(()=>{this.exportButton&&(this.exportButton.style.backgroundColor="#fff",this.exportButton.style.borderColor="#ccc",this.exportButton.setAttribute("title","Export to PlantUML (copy to clipboard)"))},2e3)):(this.exportButton.style.backgroundColor="#ffcdd2",this.exportButton.style.borderColor="#f44336",this.exportButton.setAttribute("title","Failed to copy"),setTimeout(()=>{this.exportButton&&(this.exportButton.style.backgroundColor="#fff",this.exportButton.style.borderColor="#ccc",this.exportButton.setAttribute("title","Export to PlantUML (copy to clipboard)"))},2e3)))}catch(e){console.error("Export failed:",e),this.exportButton&&(this.exportButton.style.backgroundColor="#ffcdd2",this.exportButton.style.borderColor="#f44336",this.exportButton.setAttribute("title",`Export failed: ${e instanceof Error?e.message:String(e)}`),setTimeout(()=>{this.exportButton&&(this.exportButton.style.backgroundColor="#fff",this.exportButton.style.borderColor="#ccc",this.exportButton.setAttribute("title","Export to PlantUML (copy to clipboard)"))},3e3))}}setPlantUMLExportOptions(e){this.plantUMLExportOptions={...this.plantUMLExportOptions,...e}}getPlantUMLExportOptions(){return{...this.plantUMLExportOptions}}getPlantUMLExport(e){const t=e||this.plantUMLExportOptions;return Ee(this.nodes,this.edges,this.groups,t)}createDeleteBendButton(){this.deleteBendButton=document.createElement("button"),this.deleteBendButton.innerHTML=tt("icon-trash",16),this.deleteBendButton.setAttribute("aria-label","Delete bend point"),this.deleteBendButton.setAttribute("title","Delete bend point"),this.deleteBendButton.style.padding="6px",this.deleteBendButton.style.border="1px solid #ccc",this.deleteBendButton.style.borderRadius="4px",this.deleteBendButton.style.backgroundColor="#fff",this.deleteBendButton.style.cursor="pointer",this.deleteBendButton.style.fontSize="16px",this.deleteBendButton.style.width="32px",this.deleteBendButton.style.height="32px",this.deleteBendButton.style.display="none",this.deleteBendButton.style.alignItems="center",this.deleteBendButton.style.justifyContent="center",this.deleteBendButton.style.pointerEvents="auto",this.deleteBendButton.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)",this.deleteBendButton.style.transition="0.2s",this.deleteBendButton.addEventListener("click",()=>{if(!this.currentView)return;const e=this.views.get(this.currentView);e?.deleteNearestBendPoint&&e.deleteNearestBendPoint()})}createCancelEditButton(){this.cancelEditButton=document.createElement("button"),this.cancelEditButton.innerHTML=tt("icon-close",16),this.cancelEditButton.setAttribute("aria-label","Cancel edit"),this.cancelEditButton.setAttribute("title","Cancel edit and restore previous state"),this.cancelEditButton.style.padding="6px",this.cancelEditButton.style.border="1px solid #ccc",this.cancelEditButton.style.borderRadius="4px",this.cancelEditButton.style.backgroundColor="#fff",this.cancelEditButton.style.cursor="pointer",this.cancelEditButton.style.fontSize="16px",this.cancelEditButton.style.width="32px",this.cancelEditButton.style.height="32px",this.cancelEditButton.style.display="none",this.cancelEditButton.style.alignItems="center",this.cancelEditButton.style.justifyContent="center",this.cancelEditButton.style.pointerEvents="auto",this.cancelEditButton.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)",this.cancelEditButton.style.transition="0.2s",this.cancelEditButton.addEventListener("click",()=>{if(!this.currentView)return;const e=this.views.get(this.currentView);e?.cancelEdit&&e.cancelEdit()}),this.commonControlsContainer.appendChild(this.cancelEditButton)}createUndoButton(){this.undoButton=document.createElement("button"),this.undoButton.innerHTML=tt("icon-undo",16),this.undoButton.setAttribute("aria-label","Undo"),this.undoButton.setAttribute("title","Undo (Ctrl+Z)"),this.undoButton.style.padding="6px",this.undoButton.style.border="1px solid #ccc",this.undoButton.style.borderRadius="4px",this.undoButton.style.backgroundColor="#fff",this.undoButton.style.cursor="pointer",this.undoButton.style.fontSize="16px",this.undoButton.style.width="32px",this.undoButton.style.height="32px",this.undoButton.style.display="none",this.undoButton.style.alignItems="center",this.undoButton.style.justifyContent="center",this.undoButton.style.pointerEvents="auto",this.undoButton.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)",this.undoButton.style.transition="0.2s",this.undoButton.addEventListener("click",()=>{if(!this.currentView)return;const e=this.views.get(this.currentView);e?.undo&&e.undo()}),this.commonControlsContainer.appendChild(this.undoButton)}createRedoButton(){this.redoButton=document.createElement("button"),this.redoButton.innerHTML=tt("icon-redo",16),this.redoButton.setAttribute("aria-label","Redo"),this.redoButton.setAttribute("title","Redo (Ctrl+Shift+Z)"),this.redoButton.style.padding="6px",this.redoButton.style.border="1px solid #ccc",this.redoButton.style.borderRadius="4px",this.redoButton.style.backgroundColor="#fff",this.redoButton.style.cursor="pointer",this.redoButton.style.fontSize="16px",this.redoButton.style.width="32px",this.redoButton.style.height="32px",this.redoButton.style.display="none",this.redoButton.style.alignItems="center",this.redoButton.style.justifyContent="center",this.redoButton.style.pointerEvents="auto",this.redoButton.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)",this.redoButton.style.transition="0.2s",this.redoButton.addEventListener("click",()=>{if(!this.currentView)return;const e=this.views.get(this.currentView);e?.redo&&e.redo()}),this.commonControlsContainer.appendChild(this.redoButton)}updateEditToggleButton(){if(!this.editToggleButton||!this.currentView)return;const e=this.views.get(this.currentView);if(!e)return;if((e.isEditable?.()||!1)&&this.currentView==="graph"){this.editToggleButton.style.display="flex";const n=e.getEditToggleButton?.();n&&(this.editToggleButton.innerHTML=n.innerHTML,this.editToggleButton.setAttribute("aria-label",n.getAttribute("aria-label")||"Toggle edit mode"),this.editToggleButton.setAttribute("title",n.getAttribute("title")||"Toggle edit mode"),this.editToggleButton.className=n.className,this.editToggleButton.style.padding="6px",this.editToggleButton.style.border=n.style.border||"1px solid #ccc",this.editToggleButton.style.borderRadius=n.style.borderRadius||"4px",this.editToggleButton.style.backgroundColor=n.style.backgroundColor||"#fff",this.editToggleButton.style.color=n.style.color||"#333",this.editToggleButton.style.borderColor=n.style.borderColor||"#ccc",this.editToggleButton.style.cursor=n.style.cursor||"pointer",this.editToggleButton.style.fontSize="16px",this.editToggleButton.style.width="32px",this.editToggleButton.style.height="32px",this.editToggleButton.style.alignItems="center",this.editToggleButton.style.justifyContent="center",this.editToggleButton.style.transition=n.style.transition||"0.2s",this.editToggleButton.style.boxShadow=n.style.boxShadow||"0 2px 4px rgba(0, 0, 0, 0.1)",this.editToggleButton.style.transform=n.style.transform||"translateY(0)",this.editToggleButton.onclick=()=>{n.click()})}else this.editToggleButton.style.display="none"}createTabButtons(){const e={graph:"icon-view-graph",map2d:"icon-view-map",globe3d:"icon-view-globe3d"},t={graph:"Graph",map2d:"Map 2D",globe3d:"Globe 3D"};for(const n of this.enabledViews){const s=document.createElement("button");s.innerHTML=tt(e[n],16),s.setAttribute("aria-label",t[n]),s.setAttribute("title",t[n]),s.style.padding="8px 16px",s.style.border="1px solid #ccc",s.style.borderRadius="4px 4px 0 0",s.style.backgroundColor="#fff",s.style.cursor="pointer",s.style.fontSize="14px",s.style.display="flex",s.style.alignItems="center",s.style.justifyContent="center",s.style.color="#000000",s.style.pointerEvents="auto",s.style.visibility="visible",s.style.opacity="1",s.addEventListener("click",()=>{this.switchView(n)}),this.tabButtons.set(n,s),this.tabContainer.appendChild(s)}}registerView(e,t){this.views.set(e,t),t.hide(),this.applySharedToggleStates(t),this.updateEditToggleButton()}switchView(e){if(!this.enabledViews.includes(e)||this.currentView===e)return;if(this.currentView){const s=this.views.get(this.currentView);s&&s.hide();const o=this.tabButtons.get(this.currentView);o&&(o.style.backgroundColor="#fff",o.style.fontWeight="normal",o.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)",o.style.transform="translateY(0)")}const t=this.views.get(e);t&&(this.applySharedToggleStates(t),t.show(),setTimeout(()=>{this.currentView===e&&(this.applySharedToggleStates(t),this.updateLightingButton(),this.updateTileTypeButton(),this.updateMoonButton())},e==="globe3d"?500:100),t.resize());const n=this.tabButtons.get(e);n&&(n.style.backgroundColor="#fff9c4",n.style.fontWeight="bold",n.style.boxShadow="inset 0 2px 4px rgba(0, 0, 0, 0.2)",n.style.transform="translateY(1px)"),this.currentView=e,this.updateEditToggleButton(),this.updateCommonControlsVisibility(),this.updateAlwaysShowEdgesButton(),this.updateLightingButton(),this.updateTileTypeButton(),this.updateCancelEditButton(),this.updateDeleteBendButton()}setInitialView(e){if(!this.enabledViews.includes(e)){this.switchView(this.enabledViews[0]);return}this.switchView(e)}getCurrentView(){return this.currentView}getViewContainer(){return this.viewContainer}getView(e){return this.views.get(e)}resize(){if(this.currentView){const e=this.views.get(this.currentView);e&&e.resize()}}applySharedToggleStates(e){if(e.setAlwaysShowEdges&&e.setAlwaysShowEdges(this.sharedAlwaysShowEdges),e.setLightingEnabled){const t=e.setLightingEnabled;t&&t.call(e,this.sharedLightingEnabled,!1)}if(e.setTime&&this.sharedTime!==null&&e.setTime(this.sharedTime),e.getTileServerCount&&e.setTileServerIndex){const t=e.getTileServerCount();if(t>0){const n=this.sharedTileServerIndex%t;e.setTileServerIndex(n)}}}setAlwaysShowEdges(e){this.sharedAlwaysShowEdges=e;for(const t of this.views.values())t.setAlwaysShowEdges&&t.setAlwaysShowEdges(e);this.updateAlwaysShowEdgesButton()}getAlwaysShowEdges(){return this.sharedAlwaysShowEdges}setLightingEnabled(e){this.sharedLightingEnabled=e;for(const t of this.views.values())t.setLightingEnabled&&t.setLightingEnabled(e);this.updateLightingButton()}getLightingEnabled(){return this.sharedLightingEnabled}setTime(e){this.sharedTime=e;for(const t of this.views.values())t.setTime&&t.setTime(e);this.currentView==="map2d"&&this.updateMoonButton()}getTime(){return this.sharedTime}updateCommonControlsVisibility(){const e=this.currentView==="graph",t=this.currentView==="map2d"||this.currentView==="globe3d";this.cancelEditButton&&t&&(this.cancelEditButton.style.display="none"),this.editToggleButton&&t&&(this.editToggleButton.style.display="none"),this.deleteBendButton&&(e?this.updateDeleteBendButton():this.deleteBendButton.style.display="none"),this.lightingToggleButton&&(this.lightingToggleButton.style.display=t?"flex":"none"),this.tileTypeButton&&(this.tileTypeButton.style.display=t?"flex":"none"),this.moonToggleButton&&(this.moonToggleButton.style.display=this.currentView==="map2d"?"flex":"none"),this.alwaysShowEdgesButton&&(this.alwaysShowEdgesButton.style.display=this.hasEdges?"flex":"none"),this.fitCenterButton&&(this.fitCenterButton.style.display="flex"),this.reorderButtons()}reorderButtons(){const e=this.currentView==="graph",t=this.currentView==="map2d"||this.currentView==="globe3d";if(!this.commonControlsContainer)return;const n=[];for(this.cancelEditButton&&n.push(this.cancelEditButton),this.undoButton&&n.push(this.undoButton),this.redoButton&&n.push(this.redoButton),this.editToggleButton&&n.push(this.editToggleButton),this.deleteBendButton&&n.push(this.deleteBendButton),this.lightingToggleButton&&n.push(this.lightingToggleButton),this.moonToggleButton&&n.push(this.moonToggleButton),this.tileTypeButton&&n.push(this.tileTypeButton),this.alwaysShowEdgesButton&&this.hasEdges&&n.push(this.alwaysShowEdgesButton),this.fitCenterButton&&n.push(this.fitCenterButton),this.exportButton&&n.push(this.exportButton);this.commonControlsContainer.firstChild;)this.commonControlsContainer.removeChild(this.commonControlsContainer.firstChild);e?(this.undoButton&&this.commonControlsContainer.appendChild(this.undoButton),this.redoButton&&this.commonControlsContainer.appendChild(this.redoButton),this.deleteBendButton&&this.commonControlsContainer.appendChild(this.deleteBendButton),this.cancelEditButton&&this.commonControlsContainer.appendChild(this.cancelEditButton),this.editToggleButton&&this.commonControlsContainer.appendChild(this.editToggleButton),this.alwaysShowEdgesButton&&this.hasEdges&&this.commonControlsContainer.appendChild(this.alwaysShowEdgesButton),this.fitCenterButton&&this.commonControlsContainer.appendChild(this.fitCenterButton),this.exportButton&&this.commonControlsContainer.appendChild(this.exportButton)):t&&(this.moonToggleButton&&this.currentView==="map2d"&&this.commonControlsContainer.appendChild(this.moonToggleButton),this.lightingToggleButton&&this.commonControlsContainer.appendChild(this.lightingToggleButton),this.tileTypeButton&&this.commonControlsContainer.appendChild(this.tileTypeButton),this.alwaysShowEdgesButton&&this.hasEdges&&this.commonControlsContainer.appendChild(this.alwaysShowEdgesButton),this.fitCenterButton&&this.commonControlsContainer.appendChild(this.fitCenterButton),this.exportButton&&this.commonControlsContainer.appendChild(this.exportButton))}updateAlwaysShowEdgesButtonVisibility(){this.alwaysShowEdgesButton&&(this.alwaysShowEdgesButton.style.display=this.hasEdges?"flex":"none",this.reorderButtons())}updateAlwaysShowEdgesButton(){if(!this.alwaysShowEdgesButton)return;if(!this.hasEdges){this.alwaysShowEdgesButton.style.display="none";return}if(!this.currentView)return;const e=this.views.get(this.currentView);if(!e)return;e.getAlwaysShowEdges?.()??this.sharedAlwaysShowEdges?(this.alwaysShowEdgesButton.setAttribute("aria-label","Hide edges"),this.alwaysShowEdgesButton.setAttribute("title","Hide edges"),this.alwaysShowEdgesButton.classList.add("relatos-always-show-edges-active"),this.alwaysShowEdgesButton.style.backgroundColor="#fff9c4",this.alwaysShowEdgesButton.style.color="#000000",this.alwaysShowEdgesButton.style.borderColor="#999",this.alwaysShowEdgesButton.style.boxShadow="inset 0 2px 4px rgba(0, 0, 0, 0.2)",this.alwaysShowEdgesButton.style.transform="translateY(1px)"):(this.alwaysShowEdgesButton.setAttribute("aria-label","Show edges"),this.alwaysShowEdgesButton.setAttribute("title","Show edges"),this.alwaysShowEdgesButton.classList.remove("relatos-always-show-edges-active"),this.alwaysShowEdgesButton.style.backgroundColor="#fff",this.alwaysShowEdgesButton.style.color="#333",this.alwaysShowEdgesButton.style.borderColor="#ccc",this.alwaysShowEdgesButton.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)",this.alwaysShowEdgesButton.style.transform="translateY(0)")}updateLightingButton(){if(!this.lightingToggleButton)return;this.sharedLightingEnabled?(this.lightingToggleButton.style.backgroundColor="#fff9c4",this.lightingToggleButton.style.boxShadow="inset 0 2px 4px rgba(0, 0, 0, 0.2)",this.lightingToggleButton.style.transform="translateY(1px)"):(this.lightingToggleButton.style.backgroundColor="#fff",this.lightingToggleButton.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)",this.lightingToggleButton.style.transform="translateY(0)")}updateTileTypeButton(){if(!this.tileTypeButton)return;let e=0;for(const t of this.views.values())if(t.getTileServerCount){const n=t.getTileServerCount();n>e&&(e=n)}if(e>=2){this.tileTypeButton.style.display="flex";const t=this.sharedTileServerIndex%e;this.tileTypeButton.setAttribute("title",`Tile server ${t+1}/${e} (click to switch)`);return}this.tileTypeButton.style.display="none",this.tileTypeButton.removeAttribute("title")}updateCancelEditButton(){if(!this.cancelEditButton)return;if(!this.currentView||this.currentView!=="graph"){this.cancelEditButton.style.display="none";return}const e=this.views.get(this.currentView);if(!e){this.cancelEditButton.style.display="none";return}const n=e.getMode?.()==="edit";this.cancelEditButton.style.display=n?"flex":"none"}updateDeleteBendButton(){if(!this.deleteBendButton)return;if(!this.currentView||this.currentView!=="graph"){this.deleteBendButton.style.display="none";return}const e=this.views.get(this.currentView);if(!e){this.deleteBendButton.style.display="none";return}const t=e,n=t.getSelectedEdgeId?.();if(n&&t.hasBendPoints){const s=t.hasBendPoints(n);this.deleteBendButton.style.display=s?"flex":"none"}else this.deleteBendButton.style.display="none"}updateUndoRedoButtons(){if(!this.undoButton||!this.redoButton)return;if(!this.currentView||this.currentView!=="graph"){this.undoButton.style.display="none",this.redoButton.style.display="none";return}const e=this.views.get(this.currentView);if(!e){this.undoButton.style.display="none",this.redoButton.style.display="none";return}const t=e;if(!(t.getMode?.()==="edit")){this.undoButton.style.display="none",this.redoButton.style.display="none";return}this.undoButton.style.display="flex",this.redoButton.style.display="flex",this.undoButton.disabled=!t.canUndo?.(),this.redoButton.disabled=!t.canRedo?.()}updateGraphButtons(){this.updateCancelEditButton(),this.updateUndoRedoButtons(),this.updateDeleteBendButton()}destroy(){for(const e of this.views.values())e.destroy();this.views.clear(),this.tabButtons.clear(),this.container.contains(this.tabContainer)&&this.container.removeChild(this.tabContainer),this.container.contains(this.viewContainer)&&this.container.removeChild(this.viewContainer)}}function re(i,e=16){return St(),`<svg width="${e}" height="${e}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <use href="#${i}"></use>
  </svg>`}const Ce=class Ce{constructor(e,t,n,s=!1,o,a){this.nodes=[],this.edges=[],this.groups=[],this.mode="view",this.editable=!1,this.nodeElements=new Map,this.edgeElements=new Map,this.selectedEdgeId=null,this.selectedNodeId=null,this.zoomedNodeId=null,this.anchorHandles=new Map,this.draggingAnchor=null,this.bendHandles=new Map,this.draggingBend=null,this.draggingNode=null,this.draggingGroup=null,this.panning=null,this.lastPanEndTime=0,this.resizingNode=null,this.resizingGroup=null,this.saveDebounceTimer=null,this.SAVE_DEBOUNCE_MS=500,this.resizeRenderTimer=null,this.editToggleButton=null,this.alwaysShowEdgesButton=null,this.alwaysShowEdges=!1,this.hoveredEdgePairKey=null,this.tappedEdgePairKey=null,this.snapshotBeforeEdit=null,this.edgeClickTimers=new WeakMap,this.undoStack=[],this.redoStack=[],this.offsetX=0,this.offsetY=0,this.zoom=1,this.pinchDistance=null,this.pinchCenter=null,this.initialZoom=1,this.popupElement=null,this.popupNodeId=null,this.DEFAULT_NODE_WIDTH=120,this.DEFAULT_NODE_HEIGHT=60,this.EDGE_DEFAULT_COLOR="#999",this.EDGE_HOVER_COLOR="#333",this.EDGE_DEFAULT_WIDTH=1.5,this.EDGE_HOVER_WIDTH=3,this.EDGE_MIN_WEIGHT=1,this.EDGE_MAX_WEIGHT=10,this.NODE_PADDING=10,this.HANDLE_RADIUS=8,this.BEND_HANDLE_RADIUS=7,this.HIT_PATH_WIDTH=32,this.controlButtonsContainer=null,this.deleteBendButton=null,this.fitCenterButton=null,this.cancelEditButton=null,this.container=e,this.onNodeClick=t?r=>{this.popupNodeId===r.node.id&&this.popupElement&&this.popupElement.style.opacity==="1"?this.hidePopup():this.showPopup(r.node),t(r)}:void 0,this.onSave=n,this.editable=s,this.onEdgeClick=o,this.onGroupClick=a,this.container.style.position="relative",this.container.style.width="100%",this.container.style.height="100%",this.container.style.overflow="visible",this.createAlwaysShowEdgesButton(),this.alwaysShowEdgesButton&&(this.alwaysShowEdgesButton.style.display="none",this.alwaysShowEdgesButton.parentNode&&this.alwaysShowEdgesButton.parentNode.removeChild(this.alwaysShowEdgesButton)),this.createEditToggleButton(),this.editToggleButton&&(this.editToggleButton.style.display="none",this.editToggleButton.parentNode&&this.editToggleButton.parentNode.removeChild(this.editToggleButton)),this.createControlButtons(),this.controlButtonsContainer&&(this.controlButtonsContainer.style.display="none",this.controlButtonsContainer.parentNode&&this.controlButtonsContainer.parentNode.removeChild(this.controlButtonsContainer)),this.createAttributionLabel(),this.svgWrapper=document.createElement("div"),this.svgWrapper.style.position="absolute",this.svgWrapper.style.top="0",this.svgWrapper.style.left="0",this.svgWrapper.style.width="100%",this.svgWrapper.style.height="100%",this.svgWrapper.style.transformOrigin="0 0",this.svgWrapper.style.pointerEvents="none",this.container.appendChild(this.svgWrapper),this.svg=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.svg.style.width="100%",this.svg.style.height="100%",this.svg.style.display="block",this.svg.style.pointerEvents="auto",this.svgWrapper.appendChild(this.svg),this.svgDefs=document.createElementNS("http://www.w3.org/2000/svg","defs"),this.createArrowMarkers(),this.svg.appendChild(this.svgDefs),this.groupsGroup=document.createElementNS("http://www.w3.org/2000/svg","g"),this.groupsGroup.setAttribute("class","groups"),this.svg.appendChild(this.groupsGroup),this.edgesGroup=document.createElementNS("http://www.w3.org/2000/svg","g"),this.edgesGroup.setAttribute("class","edges"),this.svg.appendChild(this.edgesGroup),this.nodesGroup=document.createElementNS("http://www.w3.org/2000/svg","g"),this.nodesGroup.setAttribute("class","nodes"),this.svg.appendChild(this.nodesGroup),this.anchorHandlesGroup=document.createElementNS("http://www.w3.org/2000/svg","g"),this.anchorHandlesGroup.setAttribute("class","anchor-handles"),this.anchorHandlesGroup.style.display="none",this.svg.appendChild(this.anchorHandlesGroup),this.bendHandlesGroup=document.createElementNS("http://www.w3.org/2000/svg","g"),this.bendHandlesGroup.setAttribute("class","bend-handles"),this.bendHandlesGroup.style.display="none",this.svg.appendChild(this.bendHandlesGroup),this.edgeLabelsGroup=document.createElementNS("http://www.w3.org/2000/svg","g"),this.edgeLabelsGroup.setAttribute("class","edge-labels"),this.svg.appendChild(this.edgeLabelsGroup),this.updateTransform(),this.setupEventListeners()}createAlwaysShowEdgesButton(){this.alwaysShowEdgesButton=document.createElement("button"),this.alwaysShowEdgesButton.className="relatos-always-show-edges-toggle",this.alwaysShowEdgesButton.setAttribute("aria-label","Always show all edges"),this.alwaysShowEdgesButton.setAttribute("title","Always show all edges"),this.alwaysShowEdgesButton.style.padding="6px",this.alwaysShowEdgesButton.style.border="1px solid #ccc",this.alwaysShowEdgesButton.style.borderRadius="4px",this.alwaysShowEdgesButton.style.backgroundColor="#fff",this.alwaysShowEdgesButton.style.cursor="pointer",this.alwaysShowEdgesButton.style.fontSize="16px",this.alwaysShowEdgesButton.style.lineHeight="1",this.alwaysShowEdgesButton.style.width="32px",this.alwaysShowEdgesButton.style.height="32px",this.alwaysShowEdgesButton.style.display="flex",this.alwaysShowEdgesButton.style.alignItems="center",this.alwaysShowEdgesButton.style.justifyContent="center",this.alwaysShowEdgesButton.style.transition="all 0.2s",this.alwaysShowEdgesButton.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)",this.alwaysShowEdgesButton.style.pointerEvents="auto",this.alwaysShowEdgesButton.style.color="#000000",this.alwaysShowEdgesButton.innerHTML=re("icon-relations",16),this.alwaysShowEdgesButton.addEventListener("click",()=>{this.alwaysShowEdges=!this.alwaysShowEdges,this.updateAlwaysShowEdgesButton(),this.alwaysShowEdges||(this.hoveredEdgePairKey=null,this.tappedEdgePairKey=null),this.onAlwaysShowEdgesChange&&this.onAlwaysShowEdgesChange(this.alwaysShowEdges),this.render()}),this.updateAlwaysShowEdgesButton()}updateAlwaysShowEdgesButton(){this.alwaysShowEdgesButton&&(this.alwaysShowEdges?(this.alwaysShowEdgesButton.setAttribute("aria-label","Hide edge labels"),this.alwaysShowEdgesButton.setAttribute("title","Hide edge labels"),this.alwaysShowEdgesButton.classList.add("relatos-always-show-edges-active"),this.alwaysShowEdgesButton.style.backgroundColor="#fff9c4",this.alwaysShowEdgesButton.style.color="#000000",this.alwaysShowEdgesButton.style.borderColor="#999",this.alwaysShowEdgesButton.style.boxShadow="inset 0 2px 4px rgba(0, 0, 0, 0.2)",this.alwaysShowEdgesButton.style.transform="translateY(1px)"):(this.alwaysShowEdgesButton.setAttribute("aria-label","Always show all edges"),this.alwaysShowEdgesButton.setAttribute("title","Always show all edges"),this.alwaysShowEdgesButton.classList.remove("relatos-always-show-edges-active"),this.alwaysShowEdgesButton.style.backgroundColor="#fff",this.alwaysShowEdgesButton.style.color="#333",this.alwaysShowEdgesButton.style.borderColor="#ccc",this.alwaysShowEdgesButton.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)",this.alwaysShowEdgesButton.style.transform="translateY(0)"))}createEditToggleButton(){this.editToggleButton=document.createElement("button"),this.editToggleButton.className="relatos-edit-toggle",this.editToggleButton.setAttribute("aria-label","Toggle edit mode"),this.editToggleButton.setAttribute("title","Toggle edit mode"),this.editToggleButton.style.position="relative",this.editToggleButton.style.zIndex="1000",this.editToggleButton.style.padding="6px",this.editToggleButton.style.border="1px solid #ccc",this.editToggleButton.style.borderRadius="4px",this.editToggleButton.style.backgroundColor="#fff",this.editToggleButton.style.cursor="pointer",this.editToggleButton.style.fontSize="16px",this.editToggleButton.style.lineHeight="1",this.editToggleButton.style.width="28px",this.editToggleButton.style.height="28px",this.editToggleButton.style.display="flex",this.editToggleButton.style.alignItems="center",this.editToggleButton.style.justifyContent="center",this.editToggleButton.style.transition="all 0.2s",this.editToggleButton.style.boxShadow="0 1px 2px rgba(0, 0, 0, 0.1)",this.updateEditToggleButtonIcon(),this.editToggleButton.addEventListener("click",()=>{this.toggleEditMode()})}updateEditToggleButtonIcon(){this.editToggleButton&&(this.editToggleButton.innerHTML=re("icon-edit",16),this.mode==="edit"?(this.editToggleButton.setAttribute("aria-label","Exit edit mode"),this.editToggleButton.setAttribute("title","Exit edit mode"),this.editToggleButton.classList.add("relatos-edit-toggle-active"),this.editToggleButton.style.backgroundColor="#fff9c4",this.editToggleButton.style.color="red",this.editToggleButton.style.borderColor="#999",this.editToggleButton.style.boxShadow="inset 0 2px 4px rgba(0, 0, 0, 0.2)",this.editToggleButton.style.transform="translateY(1px)"):(this.editToggleButton.setAttribute("aria-label","Enter edit mode"),this.editToggleButton.setAttribute("title","Enter edit mode"),this.editToggleButton.classList.remove("relatos-edit-toggle-active"),this.editToggleButton.style.backgroundColor="#fff",this.editToggleButton.style.color="#333",this.editToggleButton.style.borderColor="#ccc",this.editToggleButton.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)",this.editToggleButton.style.transform="translateY(0)"))}toggleEditMode(){this.editable&&this.setMode(this.mode==="edit"?"view":"edit")}createControlButtons(){this.controlButtonsContainer=document.createElement("div"),this.controlButtonsContainer.style.position="absolute",this.controlButtonsContainer.style.top="8px",this.controlButtonsContainer.style.right="8px",this.controlButtonsContainer.style.display="flex",this.controlButtonsContainer.style.gap="4px",this.controlButtonsContainer.style.zIndex="1000",this.controlButtonsContainer.style.pointerEvents="none",this.deleteBendButton=this.createIconButton(re("icon-trash",16),"Delete bend point","Delete bend point",()=>{this.selectedEdgeId&&this.deleteNearestBendPoint()}),this.deleteBendButton.style.display="none",this.fitCenterButton=this.createIconButton(re("icon-home",16),"Fit and center","Fit and center",()=>{this.fitAndCenter()}),this.fitCenterButton.style.display="none",this.cancelEditButton=this.createIconButton(re("icon-close",16),"Cancel edit","Cancel edit and restore previous state",()=>{this.restoreSnapshot(),this.setMode("view")}),this.cancelEditButton.style.display="none",this.controlButtonsContainer.appendChild(this.deleteBendButton),this.controlButtonsContainer.appendChild(this.fitCenterButton),this.controlButtonsContainer.appendChild(this.cancelEditButton)}createAttributionLabel(){const e=document.createElement("div");e.style.position="absolute",e.style.bottom="8px",e.style.left="8px",e.style.zIndex="1000",e.style.pointerEvents="auto",e.style.fontSize="12px",e.style.fontFamily="Arial, sans-serif",e.style.color="#333",e.style.backgroundColor="rgba(255, 255, 255, 0.8)",e.style.padding="4px 8px",e.style.borderRadius="4px",e.style.boxShadow="0 1px 3px rgba(0, 0, 0, 0.2)";const t=document.createElement("a");t.href="https://humanhistories.org/en/histoverse/",t.target="_blank",t.rel="noopener noreferrer",t.textContent="Relatos",t.style.color="#333",t.style.textDecoration="none",t.style.cursor="pointer",t.addEventListener("mouseenter",()=>{t.style.textDecoration="underline",t.style.color="#0066cc"}),t.addEventListener("mouseleave",()=>{t.style.textDecoration="none",t.style.color="#333"}),e.appendChild(t),this.container.appendChild(e)}createIconButton(e,t,n,s){const o=document.createElement("button");return o.innerHTML=e,o.setAttribute("aria-label",t),o.setAttribute("title",n),o.style.padding="6px",o.style.border="1px solid #ccc",o.style.borderRadius="4px",o.style.backgroundColor="#fff",o.style.cursor="pointer",o.style.fontSize="16px",o.style.width="32px",o.style.height="32px",o.style.display="flex",o.style.alignItems="center",o.style.justifyContent="center",o.style.pointerEvents="auto",o.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)",o.style.transition="all 0.2s",o.addEventListener("click",a=>{a.stopPropagation(),s()}),o.addEventListener("mouseenter",()=>{o.style.backgroundColor="#f5f5f5"}),o.addEventListener("mouseleave",()=>{o.style.backgroundColor="#fff"}),o}updateControlButtons(){this.onGraphButtonsUpdate&&this.onGraphButtonsUpdate()}zoomToPoint(e,t,n){const s=this.screenToSvg(t,n);this.zoom,this.zoom=e;const o=this.container.getBoundingClientRect(),a=t-o.left,r=n-o.top,h={x:a/this.zoom-this.offsetX,y:r/this.zoom-this.offsetY},l=s.x-h.x,d=s.y-h.y;this.offsetX+=l,this.offsetY+=d}screenToSvg(e,t){const n=this.container.getBoundingClientRect(),s=e-n.left,o=t-n.top,a=s/this.zoom,r=o/this.zoom;return{x:a-this.offsetX,y:r-this.offsetY}}updateTransform(){if(this.popupNodeId&&this.popupElement){const a=this.nodes.find(r=>r.id===this.popupNodeId);a&&this.updatePopupPosition(a)}const e=isFinite(this.zoom)&&this.zoom>0?this.zoom:1,t=isFinite(this.offsetX)?this.offsetX:0,n=isFinite(this.offsetY)?this.offsetY:0,s=1/e;this.svgWrapper.style.width=`${s*100}%`,this.svgWrapper.style.height=`${s*100}%`,this.svgWrapper.style.transform=`scale(${e})`;const o=`translate(${-t}, ${-n})`;this.nodesGroup.setAttribute("transform",o),this.edgesGroup.setAttribute("transform",o),this.groupsGroup.setAttribute("transform",o),this.anchorHandlesGroup.setAttribute("transform",o),this.bendHandlesGroup.setAttribute("transform",o),this.edgeLabelsGroup&&this.edgeLabelsGroup.setAttribute("transform",o)}fitAndCenter(){if(this.nodes.length===0)return;const e=this.container.getBoundingClientRect();if(e.width<=0||e.height<=0||!isFinite(e.width)||!isFinite(e.height))return;let t=1/0,n=1/0,s=-1/0,o=-1/0;for(const m of this.nodes)if(m.position){const w=m.style||{},b=w.width||this.DEFAULT_NODE_WIDTH,_=w.height||this.DEFAULT_NODE_HEIGHT;t=Math.min(t,m.position.x-b/2),n=Math.min(n,m.position.y-_/2),s=Math.max(s,m.position.x+b/2),o=Math.max(o,m.position.y+_/2)}for(const m of this.edges){const w=this.getEdgePoints(m);for(const b of w)t=Math.min(t,b.x),n=Math.min(n,b.y),s=Math.max(s,b.x),o=Math.max(o,b.y)}if(t===1/0)return;const a=60;t-=a,n-=a,s+=a,o+=a;const r=(t+s)/2,h=(n+o)/2,l=s-t,d=o-n,f=this.container.getBoundingClientRect();if(f.width<=0||f.height<=0||!isFinite(l)||!isFinite(d)||l<=0||d<=0)return;const c=f.width/l,u=f.height/d;if(!isFinite(c)||!isFinite(u))return;const g=Math.min(c,u,1);this.zoom=g;const p=f.width/(2*this.zoom),y=f.height/(2*this.zoom);!isFinite(r)||!isFinite(h)||!isFinite(p)||!isFinite(y)||(this.offsetX=r-p,this.offsetY=h-y,this.svg.removeAttribute("viewBox"),this.updateTransform(),this.render())}animateFitAndCenter(){if(this.nodes.length===0)return;const e=this.container.getBoundingClientRect();if(e.width<=0||e.height<=0||!isFinite(e.width)||!isFinite(e.height))return;let t=1/0,n=1/0,s=-1/0,o=-1/0;for(const m of this.nodes)if(m.position){const w=m.style||{},b=w.width||this.DEFAULT_NODE_WIDTH,_=w.height||this.DEFAULT_NODE_HEIGHT;t=Math.min(t,m.position.x-b/2),n=Math.min(n,m.position.y-_/2),s=Math.max(s,m.position.x+b/2),o=Math.max(o,m.position.y+_/2)}if(t===1/0)return;const a=60;t-=a,n-=a,s+=a,o+=a;const r=(t+s)/2,h=(n+o)/2,l=s-t,d=o-n,f=this.container.getBoundingClientRect();if(f.width<=0||f.height<=0||!isFinite(l)||!isFinite(d)||l<=0||d<=0)return;const c=f.width/l,u=f.height/d;if(!isFinite(c)||!isFinite(u))return;const g=Math.min(c,u,1),p=f.width/2,y=f.height/2;this.animateZoomToPoint(g,p,y,r,h)}setupEventListeners(){this.svg.addEventListener("click",s=>{const o=s.target;o.closest("[data-node-id]")||o.getAttribute("data-edge-pair-key")||o.getAttribute("data-hit-edge-pair-key")||Date.now()-(this.lastPanEndTime||0)<100||this.mode==="view"&&this.hidePopup()}),this.svg.addEventListener("pointerdown",s=>{const o=s.target,a=o.closest("[data-node-id]")?.getAttribute("data-node-id"),r=o.getAttribute("data-edge-pair-key")||o.getAttribute("data-hit-edge-pair-key"),h=o.getAttribute("data-handle-type"),l=o.getAttribute("data-bend-index");if(this.mode==="edit"){const d=o.getAttribute("data-resize-side");if(d){const f=o.getAttribute("data-node-id");if(f){const c=this.nodes.find(u=>u.id===f);if(c?.position){this.pushUndoState();const u=c.style||{},g=u.width||this.DEFAULT_NODE_WIDTH,p=u.height||this.DEFAULT_NODE_HEIGHT,y=this.screenToSvg(s.clientX,s.clientY);this.resizingNode={nodeId:f,side:d,startX:y.x,startY:y.y,startWidth:g,startHeight:p,startNodeX:c.position.x,startNodeY:c.position.y},s.target.setPointerCapture(s.pointerId),s.preventDefault(),s.stopPropagation();return}}}if(a){const f=this.nodes.find(c=>c.id===a);if(f?.position){this.pushUndoState();const c=this.screenToSvg(s.clientX,s.clientY);this.draggingNode={nodeId:a,offsetX:c.x-f.position.x,offsetY:c.y-f.position.y},s.target.setPointerCapture(s.pointerId),s.preventDefault(),s.stopPropagation();return}}else if(l!==null){const f=o.getAttribute("data-edge-id");if(f){const c=this.screenToSvg(s.clientX,s.clientY),u=this.edges.find(g=>g.id===f);if(u){const[g,p]=u.src<u.dst?[u.src,u.dst]:[u.dst,u.src],y=`${g}||${p}`,m=this.groupEdgesByPair(this.edges).find(w=>w.key===y);if(m&&m.bends){const w=parseInt(l,10);if(w>=0&&w<m.bends.length){this.pushUndoState();const b=m.bends[w];this.draggingBend={edgeId:f,bendIndex:w,offsetX:c.x-b.x,offsetY:c.y-b.y},s.preventDefault(),s.stopPropagation();return}}}}}else if(h){const f=o.getAttribute("data-edge-id");if(f){const c=this.screenToSvg(s.clientX,s.clientY),u=this.edges.find(g=>g.id===f);if(u){const[g,p]=u.src<u.dst?[u.src,u.dst]:[u.dst,u.src],y=`${g}||${p}`,m=this.groupEdgesByPair(this.edges).find(w=>w.key===y);if(m){const w=h==="src"?m.a:m.b,b=this.nodes.find(_=>_.id===w);if(b){const _=h==="src"?m.b:m.a,C=this.nodes.find(E=>E.id===_);if(C){this.pushUndoState();const E=h==="src"?m.srcAnchor||this.estimateAnchor(b,C):m.dstAnchor||this.estimateAnchor(b,C),v=b.style||{},B=v.width||this.DEFAULT_NODE_WIDTH,x=v.height||this.DEFAULT_NODE_HEIGHT,T=this.calculateAnchorPosition(b,E,B,x);this.draggingAnchor={edgeId:f,type:h,offsetX:c.x-T.x,offsetY:c.y-T.y},s.preventDefault(),s.stopPropagation();return}}}}}}else r||this.deselectEdge()}else if(a){const d=this.nodes.find(f=>f.id===a);if(d&&this.onNodeClick){const f=this.screenToSvg(s.clientX,s.clientY);this.onNodeClick({node:d,position:{x:f.x,y:f.y},originalEvent:s})}}else r||(this.deselectEdge(),this.tappedEdgePairKey&&(this.tappedEdgePairKey=null,this.render()))});let e=0,t=null;this.svg.addEventListener("pointerdown",s=>{const o=s.target,a=o.getAttribute("data-edge-pair-key")||o.getAttribute("data-hit-edge-pair-key");if(this.mode==="edit"&&a){const r=Date.now();if(r-e<300&&t===o){const l=this.groupEdgesByPair(this.edges).find(d=>d.key===a);if(l&&l.edges.length>0){this.insertBendPoint(l.edges[0].id,s),s.preventDefault(),s.stopPropagation(),e=0,t=null;return}}e=r,t=o}}),this.container.addEventListener("dblclick",s=>{if(this.mode!=="edit")return;const o=s.target;if(!o||!this.container.contains(o))return;const a=o.getAttribute("data-hit-edge-pair-key")||o.getAttribute("data-edge-pair-key");if(a){const h=this.groupEdgesByPair(this.edges).find(l=>l.key===a);if(h&&h.edges.length>0){this.insertBendPoint(h.edges[0].id,s),s.preventDefault(),s.stopPropagation();return}}let r=o;for(;r&&r!==this.svg;){const h=r.getAttribute("data-hit-edge-pair-key")||r.getAttribute("data-edge-pair-key");if(h){const l=this.groupEdgesByPair(this.edges).find(d=>d.key===h);if(l&&l.edges.length>0){this.insertBendPoint(l.edges[0].id,s),s.preventDefault(),s.stopPropagation();return}}r=r.parentElement}},!0);const n=new Map;this.svg.addEventListener("pointerdown",s=>{if(s.pointerType==="touch"&&(n.set(s.pointerId,s),n.size===2)){const o=Array.from(n.values()),[a,r]=o;this.pinchDistance=Math.hypot(r.clientX-a.clientX,r.clientY-a.clientY),this.pinchCenter={x:(a.clientX+r.clientX)/2,y:(a.clientY+r.clientY)/2},this.initialZoom=this.zoom,s.preventDefault()}}),this.svg.addEventListener("pointermove",s=>{if(s.pointerType==="touch"&&n.set(s.pointerId,s),this.pinchDistance!==null&&this.pinchCenter!==null&&n.size===2){const l=Array.from(n.values()),[d,f]=l,u=Math.hypot(f.clientX-d.clientX,f.clientY-d.clientY)/this.pinchDistance,g=Math.pow(u,1.5),p=Math.max(.1,Math.min(5,this.initialZoom*g));this.zoomToPoint(p,this.pinchCenter.x,this.pinchCenter.y),this.updateTransform(),this.render(),s.preventDefault();return}const o=s.target,a=o instanceof HTMLButtonElement||o.closest("button")!==null||o.closest(".relatos-always-show-edges-toggle")!==null||o.closest(".relatos-edit-toggle")!==null||o.closest(".relatos-control-buttons")!==null,r=s.pointerType==="touch"&&n.size===1,h=s.pointerType==="mouse"&&s.buttons===1;if(!a&&!this.resizingNode&&!this.resizingGroup&&!this.draggingNode&&!this.draggingGroup&&!this.draggingAnchor&&!this.draggingBend&&(r||h)){if(!this.panning)this.panning={startX:s.clientX,startY:s.clientY,startOffsetX:this.offsetX,startOffsetY:this.offsetY};else{const l=s.clientX-this.panning.startX,d=s.clientY-this.panning.startY,f=l/this.zoom,c=d/this.zoom;this.offsetX=this.panning.startOffsetX+f,this.offsetY=this.panning.startOffsetY+c,this.updateTransform(),this.render()}s.preventDefault();return}this.resizingNode?this.updateNodeSize(s):this.resizingGroup?this.updateGroupSize(s):this.draggingNode?this.updateNodePosition(s):this.draggingGroup?this.updateGroupPosition(s):this.draggingAnchor?this.updateAnchorPosition(s):this.draggingBend&&this.updateBendPosition(s)}),document.addEventListener("pointermove",s=>{s.pointerType==="touch"&&n.set(s.pointerId,s);const o=s.target;if(!(o instanceof HTMLButtonElement||o.closest("button")!==null||o.closest(".relatos-always-show-edges-toggle")!==null||o.closest(".relatos-edit-toggle")!==null||o.closest(".relatos-control-buttons")!==null)&&this.panning&&!this.resizingNode&&!this.resizingGroup&&!this.draggingNode&&!this.draggingGroup&&!this.draggingAnchor&&!this.draggingBend){const r=s.pointerType==="touch"&&n.size===1,h=s.pointerType==="mouse"&&(s.buttons===1||s.button===0);if(r||h){const l=s.clientX-this.panning.startX,d=s.clientY-this.panning.startY,f=l/this.zoom,c=d/this.zoom;this.offsetX=this.panning.startOffsetX-f,this.offsetY=this.panning.startOffsetY-c,this.updateTransform(),this.render(),s.preventDefault();return}}this.resizingNode?this.updateNodeSize(s):this.resizingGroup?this.updateGroupSize(s):this.draggingNode?this.updateNodePosition(s):this.draggingGroup?this.updateGroupPosition(s):this.draggingAnchor?this.updateAnchorPosition(s):this.draggingBend&&this.updateBendPosition(s)}),this.svg.addEventListener("pointerup",s=>{s.pointerType==="touch"&&(n.delete(s.pointerId),n.size<2&&(this.pinchDistance=null,this.pinchCenter=null)),s.target instanceof SVGElement&&s.target.releasePointerCapture(s.pointerId),this.resizingNode&&this.handleResizeEnd(),this.panning&&(this.lastPanEndTime=Date.now()),this.panning=null,this.resizingNode?this.handleResizeEnd():this.resizingGroup&&this.handleGroupResizeEnd(),this.resizingNode=null,this.resizingGroup=null,this.draggingNode=null,this.draggingGroup=null,this.draggingAnchor=null,this.draggingBend=null}),document.addEventListener("pointerup",s=>{s.pointerType==="touch"&&(n.delete(s.pointerId),n.size<2&&(this.pinchDistance=null,this.pinchCenter=null)),this.resizingNode&&this.handleResizeEnd(),this.panning&&(this.lastPanEndTime=Date.now()),this.panning=null,this.resizingNode?this.handleResizeEnd():this.resizingGroup&&this.handleGroupResizeEnd(),this.resizingNode=null,this.resizingGroup=null,this.draggingNode=null,this.draggingGroup=null,this.draggingAnchor=null,this.draggingBend=null}),this.svg.addEventListener("pointercancel",s=>{s.pointerType==="touch"&&(n.delete(s.pointerId),n.size<2&&(this.pinchDistance=null,this.pinchCenter=null)),s.target instanceof SVGElement&&s.target.releasePointerCapture(s.pointerId),this.resizingNode&&this.handleResizeEnd(),this.panning&&(this.lastPanEndTime=Date.now()),this.panning=null,this.resizingNode?this.handleResizeEnd():this.resizingGroup&&this.handleGroupResizeEnd(),this.resizingNode=null,this.resizingGroup=null,this.draggingNode=null,this.draggingGroup=null,this.draggingAnchor=null,this.draggingBend=null}),this.container.addEventListener("keydown",s=>{if(this.mode==="edit"){if((s.ctrlKey||s.metaKey)&&s.key==="z"&&!s.shiftKey){this.canUndo()&&(this.undo(),s.preventDefault());return}if((s.ctrlKey||s.metaKey)&&(s.key==="y"||s.key==="z"&&s.shiftKey)){this.canRedo()&&(this.redo(),s.preventDefault());return}this.selectedEdgeId&&(s.key==="Delete"||s.key==="Backspace")&&(this.deleteNearestBendPoint(),s.preventDefault())}}),this.container.setAttribute("tabindex","0"),this.container.addEventListener("wheel",s=>{if(s.ctrlKey||s.metaKey){s.preventDefault();const o=Math.pow(1.5,-s.deltaY/60),a=Math.max(.1,Math.min(5,this.zoom*o));this.zoomToPoint(a,s.clientX,s.clientY),this.updateTransform(),this.render()}else{s.preventDefault();const o=Math.pow(1.5,s.deltaY/60),a=Math.max(.1,Math.min(5,this.zoom*o));this.zoomToPoint(a,s.clientX,s.clientY),this.updateTransform(),this.render()}},{passive:!1})}createArrowMarkers(){const e=document.createElementNS("http://www.w3.org/2000/svg","marker");e.setAttribute("id","arrow-end"),e.setAttribute("viewBox","0 0 10 10"),e.setAttribute("refX","9"),e.setAttribute("refY","5"),e.setAttribute("markerWidth","6"),e.setAttribute("markerHeight","6"),e.setAttribute("orient","auto");const t=document.createElementNS("http://www.w3.org/2000/svg","path");t.setAttribute("d","M 0 0 L 10 5 L 0 10 z"),t.setAttribute("fill","#333"),e.appendChild(t),this.svgDefs.appendChild(e);const n=document.createElementNS("http://www.w3.org/2000/svg","marker");n.setAttribute("id","arrow-start"),n.setAttribute("viewBox","0 0 10 10"),n.setAttribute("refX","1"),n.setAttribute("refY","5"),n.setAttribute("markerWidth","6"),n.setAttribute("markerHeight","6"),n.setAttribute("orient","auto");const s=document.createElementNS("http://www.w3.org/2000/svg","path");s.setAttribute("d","M 10 0 L 0 5 L 10 10 z"),s.setAttribute("fill","#333"),n.appendChild(s),this.svgDefs.appendChild(n)}setData(e,t,n){this.nodes=e,this.edges=t,this.groups=n||[],this.ensureNodePositions(),this.render(),this.container.style.display!=="none"&&this.container.offsetParent!==null&&setTimeout(()=>{const s=this.container.getBoundingClientRect();s.width>0&&s.height>0&&this.fitAndCenter()},100)}selectNode(e,t=!0){if(e&&t&&this.zoomedNodeId===e){this.zoomedNodeId=null,this.selectedNodeId=e,this.render(),this.animateFitAndCenter();return}if(this.selectedNodeId=e,e?this.zoomedNodeId=e:this.zoomedNodeId=null,this.render(),e&&t){this.zoomToNode(e);const n=this.nodes.find(s=>s.id===e);n&&this.showPopup(n)}else e||(this.zoomedNodeId=null,this.hidePopup())}zoomToNode(e){const t=this.nodes.find(w=>w.id===e);if(!t||!t.position)return;const n=this.container.getBoundingClientRect();if(n.width<=0||n.height<=0)return;const s=t.style||{},o=s.width||this.DEFAULT_NODE_WIDTH,a=s.height||this.DEFAULT_NODE_HEIGHT,r=t.position.x+o/2,h=t.position.y+a/2;o*this.zoom,a*this.zoom;const l=Math.min(n.width*.3,n.height*.3),d=l/o,f=l/a,c=Math.min(d,f),p=Math.max(.5,Math.min(3,c)),y=n.width/2,m=n.height/2;this.animateZoomToPoint(p,y,m,r,h)}animateZoomToPoint(e,t,n,s,o){const a=this.zoom,r=this.offsetX,h=this.offsetY,l=this.container.getBoundingClientRect(),d=l.width/(2*e),f=l.height/(2*e),c=s-d,u=o-f,g=500,p=performance.now(),y=m=>{const w=m-p,b=Math.min(w/g,1),_=1-Math.pow(1-b,3),C=a+(e-a)*_,E=r+(c-r)*_,v=h+(u-h)*_;if(this.zoom=C,this.offsetX=E,this.offsetY=v,this.updateTransform(),this.render(),b>=1){const B=this.container.getBoundingClientRect(),x=B.width/2,T=B.height/2;x/this.zoom-this.offsetX,T/this.zoom-this.offsetY}b<1&&requestAnimationFrame(y)};requestAnimationFrame(y)}ensureNodePositions(){const e=this.nodes.filter(w=>w.coordinates&&w.coordinates.length===2),t=this.nodes.filter(w=>!w.coordinates||w.coordinates.length!==2),n=this.nodes.filter(w=>!w.position),s=this.nodes.every(w=>w.position),o=this.groups.every(w=>w.layout);if(s&&o||n.length===0&&e.length===0&&t.length===0)return;const a=this.container.getBoundingClientRect(),r=a.width||1e3,h=a.height||600,l=2,d=r*l*.25,f=r*l*.75,c=h*l,u=d,g=h*l,p=0,y=[];for(const w of this.nodes)if(w.position){const b=w.style||{},_=b.width||this.DEFAULT_NODE_WIDTH,C=b.height||this.DEFAULT_NODE_HEIGHT;if(y.push({x:w.position.x-_/2,y:w.position.y-C/2,width:_,height:C}),w.coordinates&&w.coordinates.length===2){const[E,v]=w.coordinates}}if(e.length>0){const w=e.map(k=>k.coordinates[0]),b=e.map(k=>k.coordinates[1]),_=Math.min(...w),C=Math.max(...w),E=Math.min(...b),v=Math.max(...b),B=C-_,x=v-E,T=Math.max(B,x)*.1||.01,A={minLat:_-T,maxLat:C+T,minLon:E-T,maxLon:v+T},L=new Map,S=new Map;for(const k of e){const[N,P]=k.coordinates,U=(P-A.minLon)/(A.maxLon-A.minLon),et=1-(N-A.minLat)/(A.maxLat-A.minLat),Z={x:u+U*f,y:et*c},it=k.style||{},yt=it.width||this.DEFAULT_NODE_WIDTH,At=it.height||this.DEFAULT_NODE_HEIGHT,W=Z.x,R=Z.y;L.set(k.id,{originalCenterX:W,originalCenterY:R}),S.set(k.id,{node:k,width:yt,height:At,originalCenterX:W,originalCenterY:R})}this.resolveNodePositionsWithVectorConstraints(S,L)}const m=t.filter(w=>!w.position);if(m.length>0){const b=Math.ceil(Math.sqrt(m.length)),_=Math.ceil(m.length/b),C=d-40,E=g-40,v=C/b,B=E/_;m.forEach((x,T)=>{const A=x.style||{},L=A.width||this.DEFAULT_NODE_WIDTH,S=A.height||this.DEFAULT_NODE_HEIGHT,k=Math.floor(T/b),N=T%b,P=p+20+(N+.5)*v,U=20+(k+.5)*B;x.position={x:P,y:U},y.push({x:P-L/2,y:U-S/2,width:L,height:S})})}}resolveNodePositionsWithVectorConstraints(e,t){const l=new Set,d=new Set;for(const p of this.groups)p.layout&&d.add(p.id);const f=new Map,c=new Map;for(const[p,y]of e){const m=y.node,w=t.get(p);m.position?(f.set(p,{centerX:m.position.x,centerY:m.position.y}),l.add(p)):f.set(p,{centerX:w.originalCenterX,centerY:w.originalCenterY});const b=f.get(p);c.set(p,{x:b.centerX-y.width/2,y:b.centerY-y.height/2,width:y.width,height:y.height})}const u=p=>{const y=[];for(const m of this.groups){const w=new Set,b=_=>{for(const E of _.nodeIds)w.add(E);const C=this.groups.filter(E=>E.parentId===_.id);for(const E of C)b(E)};b(m),w.has(p)&&y.push(m)}return y},g=p=>{if(d.has(p.id)&&p.layout)return{minX:p.layout.position.x,maxX:p.layout.position.x+p.layout.size.width,minY:p.layout.position.y,maxY:p.layout.position.y+p.layout.size.height};const y=this.groups.some(x=>x.parentId===p.id),m=new Set;if(y){const x=this.groups.filter(T=>T.parentId===p.id);for(const T of x){const A=L=>{for(const k of L.nodeIds)m.add(k);const S=this.groups.filter(k=>k.parentId===L.id);for(const k of S)A(k)};A(T)}}let w=1/0,b=-1/0,_=1/0,C=-1/0,E=!1;for(const x of p.nodeIds){if(y&&m.has(x))continue;const T=c.get(x);T&&(E=!0,w=Math.min(w,T.x),b=Math.max(b,T.x+T.width),_=Math.min(_,T.y),C=Math.max(C,T.y+T.height))}if(y){const x=this.groups.filter(T=>T.parentId===p.id);for(const T of x){const A=g(T);A&&(E=!0,w=Math.min(w,A.minX),b=Math.max(b,A.maxX),_=Math.min(_,A.minY),C=Math.max(C,A.maxY))}}if(!E)return null;const v=y?50:30,B=v+25;return{minX:w-v,maxX:b+v,minY:_-B,maxY:C+v}};for(let p=0;p<100;p++){let y=!1;const m=Array.from(e.entries());for(let w=0;w<m.length;w++){const[b,_]=m[w],C=f.get(b),E=c.get(b),v=u(b);for(let B=w+1;B<m.length;B++){const[x,T]=m[B],A=f.get(x),L=c.get(x),S=u(x),k=t.get(b),N=t.get(x),P=N.originalCenterX-k.originalCenterX,U=N.originalCenterY-k.originalCenterY,et=Math.sqrt(P*P+U*U);if(et===0)continue;const Z=P/et,it=U/et;let yt=!1,At=0;for(const W of v){const R=g(W);if(R)for(const Bt of S){let mt=!1;if(W.id===Bt.id)mt=!0;else{const nt=(lt,wt)=>{if(wt.parentId===lt.id)return!0;if(!wt.parentId)return!1;const st=this.groups.find(ht=>ht.id===wt.parentId);return st?nt(lt,st):!1};mt=nt(W,Bt)||nt(Bt,W)}if(mt)continue;const O=g(Bt);if(!O)continue;const zt=R.minX<O.maxX+60&&R.maxX+60>O.minX,Ot=R.minY<O.maxY+60&&R.maxY+60>O.minY;if(zt&&Ot){yt=!0;const nt=(R.minX+R.maxX)/2,lt=(R.minY+R.maxY)/2,wt=(O.minX+O.maxX)/2,st=(O.minY+O.maxY)/2,ht=wt-nt,xe=st-lt,li=Math.sqrt(ht*ht+xe*xe),hi=R.maxX-R.minX,Te=R.maxY-R.minY,ve=O.maxX-O.minX,ua=O.maxY-O.minY,ga=Math.abs(hi*Z)+Math.abs(Te*it),fa=Math.abs(ve*Z)+Math.abs(ua*it),Xn=(ga+fa)/2+60;li<Xn&&(At=Math.max(At,Xn))}}}if(yt&&At>0){y=!0;const W=A.centerX-C.centerX,R=A.centerY-C.centerY;if(Math.sqrt(W*W+R*R)<At){const mt=l.has(b),O=l.has(x);if(mt&&O)continue;const zt=At/et,Ot=P*zt,nt=U*zt,lt=k.originalCenterX+Ot,wt=k.originalCenterY+nt,st=(lt-A.centerX)/2,ht=(wt-A.centerY)/2;mt||(C.centerX-=st,C.centerY-=ht,E.x=C.centerX-_.width/2,E.y=C.centerY-_.height/2),O||(A.centerX+=st,A.centerY+=ht,L.x=A.centerX-T.width/2,L.y=A.centerY-T.height/2)}}if(!yt){const W=l.has(b),R=l.has(x);if(W&&R)continue;const Bt=E.x<L.x+L.width+20&&E.x+E.width+20>L.x,mt=E.y<L.y+L.height+20&&E.y+E.height+20>L.y;if(Bt&&mt){y=!0;const O=Math.abs(_.width*Z)+Math.abs(_.height*it),zt=Math.abs(T.width*Z)+Math.abs(T.height*it),Ot=(O+zt)/2+20,nt=A.centerX-C.centerX,lt=A.centerY-C.centerY;if(Math.sqrt(nt*nt+lt*lt)<Ot){const st=Ot/et,ht=P*st,xe=U*st,li=k.originalCenterX+ht,hi=k.originalCenterY+xe,Te=(li-A.centerX)/2,ve=(hi-A.centerY)/2;W||(C.centerX-=Te,C.centerY-=ve,E.x=C.centerX-_.width/2,E.y=C.centerY-_.height/2),R||(A.centerX+=Te,A.centerY+=ve,L.x=A.centerX-T.width/2,L.y=A.centerY-T.height/2)}}}}}if(!y)break}for(const[p,y]of e){if(l.has(p))continue;const m=f.get(p);y.node.position={x:m.centerX,y:m.centerY}}for(const p of this.groups){const y=g(p);y&&(p.layout={position:{x:y.minX,y:y.minY},size:{width:y.maxX-y.minX,height:y.maxY-y.minY}})}}resolveGroupPositionsWithOrderConstraints(e){const s=[],o=h=>{const l=new Set,d=g=>{for(const y of g.nodeIds)l.add(y);const p=this.groups.filter(y=>y.parentId===g.id);for(const y of p)d(y)};if(d(h),l.size===0)return null;let f=0,c=0,u=0;for(const g of l){const p=e.get(g);p&&(f+=p.originalCenterX,c+=p.originalCenterY,u++)}return u===0?null:{x:f/u,y:c/u}},a=h=>{if(!h.parentId)return 0;const l=this.groups.find(d=>d.id===h.parentId);return l?1+a(l):0};for(const h of this.groups){const l=this.getGroupLayout(h);if(!l)continue;const d=o(h);d&&s.push({group:h,layout:l,originalCenter:d,level:a(h)})}const r=new Map;for(const h of s){r.has(h.level)||r.set(h.level,new Map);const l=r.get(h.level),d=h.group.parentId||null;l.has(d)||l.set(d,[]),l.get(d).push(h)}for(const[h,l]of r)for(const[d,f]of l)if(!(f.length<2)){f.sort((c,u)=>{const g=c.originalCenter.y-u.originalCenter.y;return Math.abs(g)>10?g:c.originalCenter.x-u.originalCenter.x});for(let c=0;c<50;c++){let u=!1;for(let g=1;g<f.length;g++){const p=f[g],y=p.layout.position.x,m=y+p.layout.size.width;for(let w=0;w<g;w++){const b=f[w],_=b.layout.position.x,C=_+b.layout.size.width;if(y<C+60&&m+60>_){const E=p.layout.position.y,v=E+p.layout.size.height,B=b.layout.position.y,x=B+b.layout.size.height;if(E<x+60&&v+60>B){u=!0;const T=C+60-y;p.layout.position.x+=T;const A=this.calculateGroupBounds(p.group.nodeIds,p.group.id);A&&(p.layout.size={width:A.maxX-A.minX,height:A.maxY-A.minY})}}}}for(let g=1;g<f.length;g++){const p=f[g],y=p.layout.position.y,m=y+p.layout.size.height;for(let w=0;w<g;w++){const b=f[w],_=b.layout.position.y,C=_+b.layout.size.height;if(y<C+60&&m+60>_){const E=p.layout.position.x,v=E+p.layout.size.width,B=b.layout.position.x,x=B+b.layout.size.width;if(E<x+60&&v+60>B){u=!0;const T=C+60-y;p.layout.position.y+=T;const A=this.calculateGroupBounds(p.group.nodeIds,p.group.id);A&&(p.layout.size={width:A.maxX-A.minX,height:A.maxY-A.minY})}}}}if(!u)break}for(const c of f)c.group.layout=c.layout}}compactLayout(e){const s=h=>{const l=new Set,d=g=>{for(const y of g.nodeIds)l.add(y);const p=this.groups.filter(y=>y.parentId===g.id);for(const y of p)d(y)};if(d(h),l.size===0)return null;let f=0,c=0,u=0;for(const g of l){const p=e.get(g);p&&(f+=p.originalCenterX,c+=p.originalCenterY,u++)}return u>0?{x:f/u,y:c/u}:null},o=h=>{if(!h.parentId)return 0;const l=this.groups.find(d=>d.id===h.parentId);return l?1+o(l):0},a=Array.from(this.nodes).filter(h=>h.position);a.sort((h,l)=>{const d=e.get(h.id),f=e.get(l.id);if(!d||!f)return 0;const c=d.originalCenterY-f.originalCenterY;return Math.abs(c)>10?c:d.originalCenterX-f.originalCenterX});for(let h=1;h<a.length;h++){const l=a[h];if(!l.position)continue;const f=(l.style||{}).width||this.DEFAULT_NODE_WIDTH,c=l.position.x-f/2;let u=-1/0;for(let g=0;g<h;g++){const p=a[g];if(!p.position)continue;const m=(p.style||{}).width||this.DEFAULT_NODE_WIDTH,w=p.position.x+m/2;u=Math.max(u,w)}if(u>-1/0){const g=u+20;if(c>g){const p=g-c;l.position.x+=p}}}for(let h=1;h<a.length;h++){const l=a[h];if(!l.position)continue;const f=(l.style||{}).height||this.DEFAULT_NODE_HEIGHT,c=l.position.y-f/2;let u=-1/0;for(let g=0;g<h;g++){const p=a[g];if(!p.position)continue;const m=(p.style||{}).height||this.DEFAULT_NODE_HEIGHT,w=p.position.y+m/2;u=Math.max(u,w)}if(u>-1/0){const g=u+20;if(c>g){const p=g-c;l.position.y+=p}}}const r=new Map;for(const h of this.groups){const l=o(h);r.has(l)||r.set(l,new Map);const d=r.get(l),f=h.parentId||null;d.has(f)||d.set(f,[]),d.get(f).push(h)}for(const[h,l]of r)for(const[d,f]of l)if(!(f.length<2)){f.sort((c,u)=>{const g=s(c),p=s(u);if(!g||!p)return 0;const y=g.y-p.y;return Math.abs(y)>10?y:g.x-p.x});for(let c=1;c<f.length;c++){const u=f[c],g=this.getGroupLayout(u);if(!g)continue;const p=g.position.x;let y=-1/0;for(let m=0;m<c;m++){const w=f[m],b=this.getGroupLayout(w);if(!b)continue;const _=b.position.x+b.size.width;y=Math.max(y,_)}if(y>-1/0){const m=y+60;if(p>m){const w=m-p;g.position.x+=w,u.layout=g}}}for(let c=1;c<f.length;c++){const u=f[c],g=this.getGroupLayout(u);if(!g)continue;const p=g.position.y;let y=-1/0;for(let m=0;m<c;m++){const w=f[m],b=this.getGroupLayout(w);if(!b)continue;const _=b.position.y+b.size.height;y=Math.max(y,_)}if(y>-1/0){const m=y+60;if(p>m){const w=m-p;g.position.y+=w,u.layout=g}}}}}adjustNodePosition(e,t,n,s,o=20){let r=e.x,h=e.y;const l=e.width,d=e.height,f=n?.originalX??e.x,c=n?.originalY??e.y,u=t.map((g,p)=>{const y=g.width||this.DEFAULT_NODE_WIDTH,m=g.height||this.DEFAULT_NODE_HEIGHT,w=g.x+y/2,b=g.y+m/2,_=w-f,C=b-c;return{x:g.x,y:g.y,width:y,height:m,centerX:w,centerY:b,relativeDx:_,relativeDy:C,originalCenterX:w,originalCenterY:b}});for(let g=0;g<o;g++){let p=!1,y=r,m=h,w=1/0;for(const b of u)if(r<b.x+b.width+20&&r+l+20>b.x&&h<b.y+b.height+20&&h+d+20>b.y){p=!0;const _=r+l/2,C=h+d/2,E=b.centerX-_,v=b.centerY-C,B=Math.sqrt(E*E+v*v);if(B>0){const x=(l+b.width)/2+20;let T=E,A=v;if(Math.abs(b.relativeDx)>.1||Math.abs(b.relativeDy)>.1)if(Math.abs(b.relativeDx)>Math.abs(b.relativeDy))T=(b.relativeDx>0?-1:1)*Math.abs(E)/B*x,A=v/B*x*.5;else{const yt=b.relativeDy>0?-1:1;T=E/B*x*.5,A=yt*Math.abs(v)/B*x}else T=E/B*x,A=v/B*x;const L=r+T,S=h+A,k=Math.sqrt(Math.pow(L-f,2)+Math.pow(S-c,2)),N=L+l/2,P=S+d/2,U=N-f,et=P-c;let Z=0;(b.relativeDx>0&&U<b.relativeDx||b.relativeDx<0&&U>b.relativeDx)&&(Z+=1e3),(b.relativeDy>0&&et<b.relativeDy||b.relativeDy<0&&et>b.relativeDy)&&(Z+=1e3);const it=k+Z;it<w&&(w=it,y=L,m=S)}else{const x=(l+b.width)/2+20;let T=0,A=0;if(b.relativeDx!==0||b.relativeDy!==0){const N=b.relativeDx>0?-1:1,P=b.relativeDy>0?-1:1;T=N*x,A=P*x}else{const N=Math.random()*Math.PI*2;T=Math.cos(N)*x,A=Math.sin(N)*x}const L=r+T,S=h+A,k=Math.sqrt(Math.pow(L-f,2)+Math.pow(S-c,2));k<w&&(w=k,y=L,m=S)}}if(!p)break;r=y,h=m}return{x:r,y:h}}groupEdgesByPair(e){const t=new Map;for(const n of e){const[s,o]=n.src<n.dst?[n.src,n.dst]:[n.dst,n.src],a=`${s}||${o}`;let r=t.get(a);r||(r={key:a,a:s,b:o,edges:[]},t.set(a,r)),r.edges.push(n),n.src===s&&n.dst===o?(n.srcAnchor&&!r.srcAnchor&&(r.srcAnchor=n.srcAnchor),n.dstAnchor&&!r.dstAnchor&&(r.dstAnchor=n.dstAnchor),n.bends&&!r.bends&&(r.bends=n.bends)):(n.srcAnchor&&!r.dstAnchor&&(r.dstAnchor=n.srcAnchor),n.dstAnchor&&!r.srcAnchor&&(r.srcAnchor=n.dstAnchor),n.bends&&!r.bends&&(r.bends=n.bends))}return Array.from(t.values())}getEdgePairDirection(e){let t=!1,n=!1;for(const s of e.edges)s.src===e.a&&s.dst===e.b?t=!0:s.src===e.b&&s.dst===e.a&&(n=!0);return{hasAtoB:t,hasBtoA:n}}calculateEdgePairPath(e){const t=this.nodes.find(y=>y.id===e.a),n=this.nodes.find(y=>y.id===e.b);if(!t?.position||!n?.position)return"";const s=e.srcAnchor||this.estimateAnchor(t,n),o=e.dstAnchor||this.estimateAnchor(n,t),a=t.style||{},r=n.style||{},h=a.width||this.DEFAULT_NODE_WIDTH,l=a.height||this.DEFAULT_NODE_HEIGHT,d=r.width||this.DEFAULT_NODE_WIDTH,f=r.height||this.DEFAULT_NODE_HEIGHT,c=this.calculateAnchorPosition(t,s,h,l),u=this.calculateAnchorPosition(n,o,d,f),g=[c];e.bends&&g.push(...e.bends),g.push(u);const p=[`M ${g[0].x} ${g[0].y}`];for(let y=1;y<g.length;y++)p.push(`L ${g[y].x} ${g[y].y}`);return p.join(" ")}calculateAnchorPosition(e,t,n,s){if(!e.position)return{x:0,y:0};const o=e.position.x,a=e.position.y,r=n||e.style?.width||this.DEFAULT_NODE_WIDTH,h=s||e.style?.height||this.DEFAULT_NODE_HEIGHT;let l=0,d=0;switch(t.side){case"top":l=o-r/2+r*t.t,d=a-h/2;break;case"right":l=o+r/2,d=a-h/2+h*t.t;break;case"bottom":l=o-r/2+r*t.t,d=a+h/2;break;case"left":l=o-r/2,d=a-h/2+h*t.t;break}return{x:l,y:d}}estimateAnchor(e,t){if(!e.position||!t.position)return{side:"right",t:.5};const n=e.style||{},s=n.width||this.DEFAULT_NODE_WIDTH,o=n.height||this.DEFAULT_NODE_HEIGHT,a=t.position.x-e.position.x,r=t.position.y-e.position.y,h=Math.atan2(r,a),l=h<0?h+2*Math.PI:h;let d,f;return l>=7*Math.PI/4||l<Math.PI/4?(d="right",f=.5+r/o*.5):l>=Math.PI/4&&l<3*Math.PI/4?(d="bottom",f=.5+a/s*.5):l>=3*Math.PI/4&&l<5*Math.PI/4?(d="left",f=.5-r/o*.5):(d="top",f=.5-a/s*.5),f=Math.max(0,Math.min(1,f)),{side:d,t:f}}getEdgePoints(e){const t=this.nodes.find(p=>p.id===e.src),n=this.nodes.find(p=>p.id===e.dst);if(!t?.position||!n?.position)return[];const s=e.srcAnchor||this.estimateAnchor(t,n),o=e.dstAnchor||this.estimateAnchor(n,t),a=t.style||{},r=n.style||{},h=a.width||this.DEFAULT_NODE_WIDTH,l=a.height||this.DEFAULT_NODE_HEIGHT,d=r.width||this.DEFAULT_NODE_WIDTH,f=r.height||this.DEFAULT_NODE_HEIGHT,c=this.calculateAnchorPosition(t,s,h,l),u=this.calculateAnchorPosition(n,o,d,f),g=[c];return e.bends&&g.push(...e.bends),g.push(u),g}calculateEdgePath(e){const t=this.getEdgePoints(e);if(t.length<2)return"";const n=[`M ${t[0].x} ${t[0].y}`];for(let s=1;s<t.length;s++)n.push(`L ${t[s].x} ${t[s].y}`);return n.join(" ")}getEdgePairMarkerAttributes(e){const{hasAtoB:t,hasBtoA:n}=this.getEdgePairDirection(e),s={};return t&&(s.markerEnd="url(#arrow-end)"),n&&(s.markerStart="url(#arrow-start)"),s}deselectEdge(){this.selectedEdgeId=null,this.anchorHandlesGroup.style.display="none",this.bendHandlesGroup.style.display="none",this.anchorHandles.clear(),this.bendHandles.clear(),this.updateControlButtons()}selectEdge(e,t){this.selectedEdgeId===e&&t?this.rotateAnchorSide(e):(this.selectedEdgeId=e,this.updateAnchorHandles(),this.updateBendHandles())}rotateAnchorSide(e){const t=this.edges.find(l=>l.id===e);if(!t)return;this.pushUndoState();const[n,s]=t.src<t.dst?[t.src,t.dst]:[t.dst,t.src],o=`${n}||${s}`,a=this.groupEdgesByPair(this.edges).find(l=>l.key===o);if(!a)return;const r=["top","right","bottom","left"],h=l=>{const d=r.indexOf(l);return r[(d+1)%4]};a.srcAnchor&&(a.srcAnchor.side=h(a.srcAnchor.side)),a.dstAnchor&&(a.dstAnchor.side=h(a.dstAnchor.side));for(const l of a.edges)l.src===a.a&&l.dst===a.b?(l.srcAnchor=a.srcAnchor,l.dstAnchor=a.dstAnchor):(l.srcAnchor=a.dstAnchor,l.dstAnchor=a.srcAnchor);this.render(),this.updateAnchorHandles(),this.updateBendHandles()}updateAnchorHandles(){if(this.anchorHandles.clear(),this.anchorHandlesGroup.innerHTML="",!this.selectedEdgeId||this.mode!=="edit"){this.anchorHandlesGroup.style.display="none";return}const e=this.edges.find(w=>w.id===this.selectedEdgeId);if(!e)return;const[t,n]=e.src<e.dst?[e.src,e.dst]:[e.dst,e.src],s=`${t}||${n}`,o=this.groupEdgesByPair(this.edges).find(w=>w.key===s);if(!o)return;const a=this.nodes.find(w=>w.id===o.a),r=this.nodes.find(w=>w.id===o.b);if(!a||!r)return;const h=o.srcAnchor||this.estimateAnchor(a,r),l=o.dstAnchor||this.estimateAnchor(r,a),d=a.style||{},f=r.style||{},c=d.width||this.DEFAULT_NODE_WIDTH,u=d.height||this.DEFAULT_NODE_HEIGHT,g=f.width||this.DEFAULT_NODE_WIDTH,p=f.height||this.DEFAULT_NODE_HEIGHT,y=this.calculateAnchorPosition(a,h,c,u),m=this.calculateAnchorPosition(r,l,g,p);this.createAnchorHandle(e.id,"src",y.x,y.y),this.createAnchorHandle(e.id,"dst",m.x,m.y),this.anchorHandlesGroup.style.display="block",this.anchorHandlesGroup.style.pointerEvents="auto"}updateBendHandles(){if(this.bendHandles.clear(),this.bendHandlesGroup.innerHTML="",!this.selectedEdgeId||this.mode!=="edit"){this.bendHandlesGroup.style.display="none",this.updateControlButtons();return}const e=this.edges.find(a=>a.id===this.selectedEdgeId);if(!e){this.updateControlButtons();return}const[t,n]=e.src<e.dst?[e.src,e.dst]:[e.dst,e.src],s=`${t}||${n}`,o=this.groupEdgesByPair(this.edges).find(a=>a.key===s);if(!o||!o.bends||o.bends.length===0){this.bendHandlesGroup.style.display="none",this.updateControlButtons();return}o.bends.forEach((a,r)=>{this.createBendHandle(e.id,r,a.x,a.y)}),this.bendHandlesGroup.style.display="block",this.bendHandlesGroup.style.pointerEvents="auto",this.updateControlButtons()}createAnchorHandle(e,t,n,s){const o=document.createElementNS("http://www.w3.org/2000/svg","circle");o.setAttribute("cx",String(n)),o.setAttribute("cy",String(s)),o.setAttribute("r",String(this.HANDLE_RADIUS)),o.setAttribute("fill","#2196f3"),o.setAttribute("stroke","#fff"),o.setAttribute("stroke-width","2"),o.setAttribute("data-edge-id",e),o.setAttribute("data-handle-type",t),o.style.cursor="move",this.anchorHandles.set(t,o),this.anchorHandlesGroup.appendChild(o)}createBendHandle(e,t,n,s){const o=document.createElementNS("http://www.w3.org/2000/svg","circle");o.setAttribute("cx",String(n)),o.setAttribute("cy",String(s)),o.setAttribute("r",String(this.BEND_HANDLE_RADIUS)),o.setAttribute("fill","#ff9800"),o.setAttribute("stroke","#fff"),o.setAttribute("stroke-width","2"),o.setAttribute("data-edge-id",e),o.setAttribute("data-bend-index",String(t)),o.style.cursor="move",this.bendHandles.set(t,o),this.bendHandlesGroup.appendChild(o)}updateNodePosition(e){if(!this.draggingNode)return;const t=this.nodes.find(a=>a.id===this.draggingNode.nodeId);if(!t)return;const n=this.screenToSvg(e.clientX,e.clientY),s=n.x,o=n.y;t.position||(t.position={x:0,y:0}),t.position.x=s-this.draggingNode.offsetX,t.position.y=o-this.draggingNode.offsetY,this.updateGroupLayouts(t.id,void 0),this.render(),this.updateAnchorHandles(),this.updateBendHandles()}updateNodeSize(e){if(!this.resizingNode)return;const t=this.nodes.find(l=>l.id===this.resizingNode.nodeId);if(!t?.position)return;const n=this.screenToSvg(e.clientX,e.clientY),s=n.x,o=n.y;t.style||(t.style={});const a=s-this.resizingNode.startX,r=o-this.resizingNode.startY;switch(this.resizingNode.side){case"right":{const l=Math.max(60,this.resizingNode.startWidth+a);t.style.width=l,t.position.x=this.resizingNode.startNodeX+a/2;break}case"left":{const l=Math.max(60,this.resizingNode.startWidth-a);t.style.width=l,t.position.x=this.resizingNode.startNodeX+a/2;break}case"bottom":{const l=Math.max(40,this.resizingNode.startHeight+r);t.style.height=l,t.position.y=this.resizingNode.startNodeY+r/2;break}case"top":{const l=Math.max(40,this.resizingNode.startHeight-r);t.style.height=l,t.position.y=this.resizingNode.startNodeY+r/2;break}}const h=this.nodeElements.get(t.id);if(h){const l=t.style||{},d=l.width||this.DEFAULT_NODE_WIDTH,f=l.height||this.DEFAULT_NODE_HEIGHT,c=t.position.x-d/2,u=t.position.y-f/2;h.setAttribute("x",String(c)),h.setAttribute("y",String(u)),h.setAttribute("width",String(d)),h.setAttribute("height",String(f));const g=h.parentElement;if(g){const p=g.querySelector("foreignObject");if(p){const y=t.style||{},m=y.width||this.DEFAULT_NODE_WIDTH,w=y.height||this.DEFAULT_NODE_HEIGHT,b=t.position.x-m/2,_=t.position.y-w/2;p.setAttribute("x",String(b)),p.setAttribute("y",String(_))}t.position&&g.querySelectorAll("[data-resize-side]").forEach(m=>{const w=m.getAttribute("data-resize-side");w==="top"?(m.setAttribute("cx",String(t.position.x)),m.setAttribute("cy",String(t.position.y-f/2))):w==="right"?(m.setAttribute("cx",String(t.position.x+d/2)),m.setAttribute("cy",String(t.position.y))):w==="bottom"?(m.setAttribute("cx",String(t.position.x)),m.setAttribute("cy",String(t.position.y+f/2))):w==="left"&&(m.setAttribute("cx",String(t.position.x-d/2)),m.setAttribute("cy",String(t.position.y)))})}}}handleResizeEnd(){this.resizeRenderTimer&&(clearTimeout(this.resizeRenderTimer),this.resizeRenderTimer=null),this.resizingNode&&this.updateGroupLayouts(this.resizingNode.nodeId,void 0),this.render()}saveSnapshot(){this.snapshotBeforeEdit={nodes:this.nodes.map(e=>({...e,position:e.position?{...e.position}:void 0,style:e.style?{...e.style}:void 0,meta:e.meta?{...e.meta}:void 0})),edges:this.edges.map(e=>({...e,srcAnchor:e.srcAnchor?{...e.srcAnchor}:void 0,dstAnchor:e.dstAnchor?{...e.dstAnchor}:void 0,bends:e.bends?e.bends.map(t=>({...t})):void 0,style:e.style?{...e.style}:void 0,meta:e.meta?{...e.meta}:void 0})),groups:this.groups.map(e=>({...e,layout:e.layout?{position:{...e.layout.position},size:{...e.layout.size}}:void 0,meta:e.meta?{...e.meta}:void 0}))}}restoreSnapshot(){this.snapshotBeforeEdit&&(this.nodes=this.snapshotBeforeEdit.nodes.map(e=>({...e,position:e.position?{...e.position}:void 0,style:e.style?{...e.style}:void 0,meta:e.meta?{...e.meta}:void 0})),this.edges=this.snapshotBeforeEdit.edges.map(e=>({...e,srcAnchor:e.srcAnchor?{...e.srcAnchor}:void 0,dstAnchor:e.dstAnchor?{...e.dstAnchor}:void 0,bends:e.bends?e.bends.map(t=>({...t})):void 0,style:e.style?{...e.style}:void 0,meta:e.meta?{...e.meta}:void 0})),this.groups=this.snapshotBeforeEdit.groups.map(e=>({...e,layout:e.layout?{position:{...e.layout.position},size:{...e.layout.size}}:void 0,meta:e.meta?{...e.meta}:void 0})),this.render(),this.deselectEdge())}cloneState(){return{nodes:this.nodes.map(e=>({...e,position:e.position?{...e.position}:void 0,style:e.style?{...e.style}:void 0,meta:e.meta?{...e.meta}:void 0})),edges:this.edges.map(e=>({...e,srcAnchor:e.srcAnchor?{...e.srcAnchor}:void 0,dstAnchor:e.dstAnchor?{...e.dstAnchor}:void 0,bends:e.bends?e.bends.map(t=>({...t})):void 0,style:e.style?{...e.style}:void 0,meta:e.meta?{...e.meta}:void 0})),groups:this.groups.map(e=>({...e,layout:e.layout?{position:{...e.layout.position},size:{...e.layout.size}}:void 0,meta:e.meta?{...e.meta}:void 0}))}}pushUndoState(){if(this.mode!=="edit")return;const e=this.cloneState();this.undoStack.push(e),this.undoStack.length>Ce.MAX_UNDO_LEVELS&&this.undoStack.shift(),this.redoStack=[],this.onGraphButtonsUpdate?.()}applyState(e){this.nodes=e.nodes.map(t=>({...t,position:t.position?{...t.position}:void 0,style:t.style?{...t.style}:void 0,meta:t.meta?{...t.meta}:void 0})),this.edges=e.edges.map(t=>({...t,srcAnchor:t.srcAnchor?{...t.srcAnchor}:void 0,dstAnchor:t.dstAnchor?{...t.dstAnchor}:void 0,bends:t.bends?t.bends.map(n=>({...n})):void 0,style:t.style?{...t.style}:void 0,meta:t.meta?{...t.meta}:void 0})),this.groups=e.groups.map(t=>({...t,layout:t.layout?{position:{...t.layout.position},size:{...t.layout.size}}:void 0,meta:t.meta?{...t.meta}:void 0}))}undo(){if(this.mode!=="edit"||this.undoStack.length===0)return;const e=this.cloneState();this.redoStack.push(e);const t=this.undoStack.pop();this.applyState(t),this.render(),this.updateAnchorHandles(),this.updateBendHandles(),this.updateControlButtons(),this.debouncedSave(),this.onGraphButtonsUpdate?.()}redo(){if(this.mode!=="edit"||this.redoStack.length===0)return;const e=this.cloneState();this.undoStack.push(e);const t=this.redoStack.pop();this.applyState(t),this.render(),this.updateAnchorHandles(),this.updateBendHandles(),this.updateControlButtons(),this.debouncedSave(),this.onGraphButtonsUpdate?.()}canUndo(){return this.mode==="edit"&&this.undoStack.length>0}canRedo(){return this.mode==="edit"&&this.redoStack.length>0}updateAnchorPosition(e){if(!this.draggingAnchor)return;const t=this.edges.find(C=>C.id===this.draggingAnchor.edgeId);if(!t)return;const[n,s]=t.src<t.dst?[t.src,t.dst]:[t.dst,t.src],o=`${n}||${s}`,a=this.groupEdgesByPair(this.edges).find(C=>C.key===o);if(!a)return;const r=this.draggingAnchor.type==="src"?a.a:a.b,h=this.nodes.find(C=>C.id===r);if(!h?.position)return;const l=this.screenToSvg(e.clientX,e.clientY),d=l.x-this.draggingAnchor.offsetX,f=l.y-this.draggingAnchor.offsetY,c=h.position.x,u=h.position.y,g=h.style||{},p=g.width||this.DEFAULT_NODE_WIDTH,y=g.height||this.DEFAULT_NODE_HEIGHT,m={top:Math.abs(f-(u-y/2)),right:Math.abs(d-(c+p/2)),bottom:Math.abs(f-(u+y/2)),left:Math.abs(d-(c-p/2))};let w="right",b=m.right;for(const[C,E]of Object.entries(m))E<b&&(b=E,w=C);let _=.5;switch(w){case"top":case"bottom":_=(d-(c-p/2))/p;break;case"left":case"right":_=(f-(u-y/2))/y;break}_=Math.max(0,Math.min(1,_)),this.draggingAnchor.type==="src"?a.srcAnchor={side:w,t:_}:a.dstAnchor={side:w,t:_};for(const C of a.edges)C.src===a.a&&C.dst===a.b?(C.srcAnchor=a.srcAnchor,C.dstAnchor=a.dstAnchor):(C.srcAnchor=a.dstAnchor,C.dstAnchor=a.srcAnchor);this.render(),this.updateAnchorHandles(),this.updateBendHandles()}updateBendPosition(e){if(!this.draggingBend)return;const t=this.edges.find(f=>f.id===this.draggingBend.edgeId);if(!t)return;const[n,s]=t.src<t.dst?[t.src,t.dst]:[t.dst,t.src],o=`${n}||${s}`,a=this.groupEdgesByPair(this.edges).find(f=>f.key===o);if(!a||!a.bends)return;const r=this.draggingBend.bendIndex;if(r<0||r>=a.bends.length)return;const h=this.screenToSvg(e.clientX,e.clientY),l=h.x-this.draggingBend.offsetX,d=h.y-this.draggingBend.offsetY;a.bends[r]={x:l,y:d};for(const f of a.edges)f.bends=[...a.bends];this.render(),this.updateBendHandles()}insertBendPoint(e,t){const n=this.edges.find(S=>S.id===e);if(!n)return;this.pushUndoState();const[s,o]=n.src<n.dst?[n.src,n.dst]:[n.dst,n.src],a=`${s}||${o}`,r=this.groupEdgesByPair(this.edges).find(S=>S.key===a);if(!r)return;const h=this.svg.getBoundingClientRect(),l=t.clientX-h.left,d=t.clientY-h.top,f=[],c=this.nodes.find(S=>S.id===r.a),u=this.nodes.find(S=>S.id===r.b);if(!c?.position||!u?.position)return;const g=r.srcAnchor||this.estimateAnchor(c,u),p=r.dstAnchor||this.estimateAnchor(u,c),y=c.style||{},m=u.style||{},w=y.width||this.DEFAULT_NODE_WIDTH,b=y.height||this.DEFAULT_NODE_HEIGHT,_=m.width||this.DEFAULT_NODE_WIDTH,C=m.height||this.DEFAULT_NODE_HEIGHT,E=this.calculateAnchorPosition(c,g,w,b),v=this.calculateAnchorPosition(u,p,_,C);f.push(E),r.bends&&f.push(...r.bends),f.push(v);let B=0,x=1/0;for(let S=0;S<f.length-1;S++){const k=f[S],N=f[S+1],P=this.pointToLineSegmentDistance(l,d,k.x,k.y,N.x,N.y);P<x&&(x=P,B=S)}const T=f[B],A=f[B+1],L={x:(T.x+A.x)/2,y:(T.y+A.y)/2};r.bends||(r.bends=[]),r.bends.splice(B,0,L);for(const S of r.edges)S.bends=[...r.bends];this.selectedEdgeId!==e&&this.selectEdge(e,!1),this.render(),this.updateBendHandles()}pointToLineSegmentDistance(e,t,n,s,o,a){const r=o-n,h=a-s,l=r*r+h*h;if(l===0)return Math.sqrt((e-n)**2+(t-s)**2);const d=Math.max(0,Math.min(1,((e-n)*r+(t-s)*h)/l)),f=n+d*r,c=s+d*h;return Math.sqrt((e-f)**2+(t-c)**2)}deleteNearestBendPoint(){if(!this.selectedEdgeId)return;const e=this.edges.find(a=>a.id===this.selectedEdgeId);if(!e)return;const[t,n]=e.src<e.dst?[e.src,e.dst]:[e.dst,e.src],s=`${t}||${n}`,o=this.groupEdgesByPair(this.edges).find(a=>a.key===s);if(!(!o||!o.bends||o.bends.length===0)){this.pushUndoState(),o.bends.pop(),o.bends.length===0&&delete o.bends;for(const a of o.edges)o.bends?a.bends=[...o.bends]:delete a.bends;this.render(),this.updateBendHandles(),this.updateControlButtons()}}debouncedSave(){this.onSave&&(this.saveDebounceTimer!==null&&clearTimeout(this.saveDebounceTimer),this.saveDebounceTimer=window.setTimeout(()=>{this.onSave({nodes:this.nodes,edges:this.edges,groups:this.groups.length>0?this.groups:void 0}),this.saveDebounceTimer=null},this.SAVE_DEBOUNCE_MS))}render(){this.updateTransform(),this.nodeElements.clear(),this.edgeElements.clear(),this.edgesGroup.innerHTML="",this.groupsGroup.innerHTML="",this.nodesGroup.innerHTML="",this.edgeLabelsGroup.innerHTML="";const e=this.groupEdgesByPair(this.edges);for(const t of e){const n=t.edges.some(C=>C.id===this.selectedEdgeId),s=this.mode==="view"&&t.key===this.hoveredEdgePairKey,o=this.mode==="view"&&t.key===this.tappedEdgePairKey,a=this.alwaysShowEdges||n||s||o,h=t.edges[0].style||{},l=h.color||this.EDGE_DEFAULT_COLOR,d=h.weight||1,f=Math.max(this.EDGE_MIN_WEIGHT,Math.min(this.EDGE_MAX_WEIGHT,d)),c=this.EDGE_DEFAULT_WIDTH+(f-1)*.5,u=a?Math.max(c,this.EDGE_HOVER_WIDTH):c,g=n?"#2196f3":l,p=a?1:.3,y=this.calculateEdgePairPath(t);if(!y)continue;const m=document.createElementNS("http://www.w3.org/2000/svg","path");m.setAttribute("d",y),m.setAttribute("stroke","transparent"),m.setAttribute("stroke-width",String(this.HIT_PATH_WIDTH)),m.setAttribute("fill","none"),m.setAttribute("data-hit-edge-pair-key",t.key),m.style.cursor="pointer",m.style.pointerEvents="stroke",this.edgesGroup.appendChild(m);const w=document.createElementNS("http://www.w3.org/2000/svg","path");w.setAttribute("d",y),w.setAttribute("stroke",g),w.setAttribute("stroke-width",String(u)),w.setAttribute("stroke-opacity",String(p)),w.setAttribute("fill","none"),w.setAttribute("data-edge-pair-key",t.key),w.style.pointerEvents="none",w.style.transition="stroke-opacity 0.2s, stroke-width 0.2s";const b=this.getEdgePairMarkerAttributes(t);if(b.markerStart&&w.setAttribute("marker-start",b.markerStart),b.markerEnd&&w.setAttribute("marker-end",b.markerEnd),this.edgeElements.set(t.key,w),this.edgesGroup.appendChild(w),this.mode==="view")this.setupEdgeInteraction(m,t,h);else if(this.mode==="edit"){this.setupEdgeInteractionForEdit(m,t);const C=t.key;m.addEventListener("click",E=>{const v=this.edgeClickTimers.get(m);if(v!=null){clearTimeout(v),this.edgeClickTimers.set(m,null);return}const B=window.setTimeout(()=>{if(this.edgeClickTimers.set(m,null),this.mode==="edit"){const x=this.groupEdgesByPair(this.edges).find(T=>T.key===C);x&&x.edges.length>0&&(this.selectEdge(x.edges[0].id,E.shiftKey),this.render())}},300);this.edgeClickTimers.set(m,B)})}const _=t.key;m.addEventListener("dblclick",C=>{if(this.mode!=="edit")return;const E=this.edgeClickTimers.get(m);E!=null&&(clearTimeout(E),this.edgeClickTimers.set(m,null));const v=this.groupEdgesByPair(this.edges).find(B=>B.key===_);v&&v.edges.length>0&&(this.insertBendPoint(v.edges[0].id,C),C.preventDefault(),C.stopPropagation())}),a&&this.renderEdgeLabels(t,h)}this.renderGroups();for(const t of this.nodes){if(!t.position)continue;const n=t.style||{},s=n.width||this.DEFAULT_NODE_WIDTH,o=n.height||this.DEFAULT_NODE_HEIGHT,a=n.color||"#fff",r=n.borderColor||"#333",h=document.createElementNS("http://www.w3.org/2000/svg","g");h.setAttribute("data-node-id",t.id);const l=document.createElementNS("http://www.w3.org/2000/svg","rect"),d=t.position.x-s/2,f=t.position.y-o/2;l.setAttribute("x",String(d)),l.setAttribute("y",String(f)),l.setAttribute("width",String(s)),l.setAttribute("height",String(o));const c=a.match(/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/i);if(c){const y=parseInt(c[1],16),m=parseInt(c[2],16),w=parseInt(c[3],16);l.setAttribute("fill",`rgba(${y}, ${m}, ${w}, 0.5)`)}else l.setAttribute("fill",a);const u=this.selectedNodeId===t.id;l.setAttribute("stroke",u?"#2196f3":r),l.setAttribute("stroke-width",u?"4":"2"),l.setAttribute("rx","4"),l.style.cursor=this.mode==="view"?"pointer":"move";const g=document.createElementNS("http://www.w3.org/2000/svg","foreignObject");g.setAttribute("x",String(d)),g.setAttribute("y",String(f)),g.setAttribute("width",String(s)),g.setAttribute("height",String(o));const p=document.createElement("div");p.style.width="100%",p.style.height="100%",p.style.display="flex",p.style.alignItems="flex-start",p.style.justifyContent="center",p.style.textAlign="center",p.style.fontSize="14px",p.style.color="#333",p.style.padding="4px",p.style.wordWrap="break-word",p.style.overflowWrap="break-word",p.style.whiteSpace="normal",p.style.overflow="hidden",p.style.textOverflow="ellipsis",p.textContent=t.label,g.appendChild(p),h.appendChild(l),h.appendChild(g),this.mode==="edit"&&this.addResizeHandles(h,t,s,o),this.nodesGroup.appendChild(h),this.nodeElements.set(t.id,l),this.mode==="view"&&this.onNodeClick&&h.addEventListener("click",y=>{y.stopPropagation(),y.preventDefault();const m=this.svg.getBoundingClientRect(),w=y.clientX-m.left,b=y.clientY-m.top;this.onNodeClick({node:t,position:{x:w,y:b},originalEvent:y})},!0)}this.mode==="edit"&&(this.updateAnchorHandles(),this.updateBendHandles(),this.updateControlButtons())}calculateGroupBounds(e,t){let a=1/0,r=-1/0,h=1/0,l=-1/0,d=!1;const f=t?this.groups.some(p=>p.parentId===t):!1,c=new Set;if(f&&t){const p=this.groups.filter(y=>y.parentId===t);for(const y of p){const m=w=>{for(const _ of w.nodeIds)c.add(_);const b=this.groups.filter(_=>_.parentId===w.id);for(const _ of b)m(_)};m(y)}}for(const p of e){if(f&&c.has(p))continue;const y=this.nodes.find(B=>B.id===p);if(!y||!y.position)continue;d=!0;const m=y.style||{},w=m.width||this.DEFAULT_NODE_WIDTH,b=m.height||this.DEFAULT_NODE_HEIGHT,_=y.position.x-w/2,C=y.position.x+w/2,E=y.position.y-b/2,v=y.position.y+b/2;a=Math.min(a,_),r=Math.max(r,C),h=Math.min(h,E),l=Math.max(l,v)}if(f&&t){const p=this.groups.filter(y=>y.parentId===t);for(const y of p){const m=this.getGroupLayout(y);if(m){d=!0;const w=m.position.x,b=m.position.x+m.size.width,_=m.position.y,C=m.position.y+m.size.height;a=Math.min(a,w),r=Math.max(r,b),h=Math.min(h,_),l=Math.max(l,C)}}}if(!d)return null;const u=f?50:30,g=u+25;return{minX:a-u,maxX:r+u,minY:h-g,maxY:l+u}}getGroupLayout(e){if(e.layout)return e.layout;const t=this.calculateGroupBounds(e.nodeIds,e.id);return t?{position:{x:t.minX,y:t.minY},size:{width:t.maxX-t.minX,height:t.maxY-t.minY}}:null}renderGroups(){if(this.groups.length===0)return;const e=[...this.groups].sort((t,n)=>{const s=o=>{if(!o.parentId)return 0;const a=this.groups.find(r=>r.id===o.parentId);return a?1+s(a):0};return s(t)-s(n)});for(const t of e){let n=this.getGroupLayout(t);if(n)t.layout||(t.layout=n);else{const r=this.calculateGroupBounds(t.nodeIds,t.id);if(r)n={position:{x:r.minX,y:r.minY},size:{width:r.maxX-r.minX,height:r.maxY-r.minY}},t.layout=n;else continue}const s=document.createElementNS("http://www.w3.org/2000/svg","g");s.setAttribute("data-group-id",t.id),s.setAttribute("class","group");const o=document.createElementNS("http://www.w3.org/2000/svg","rect");o.setAttribute("x",String(n.position.x)),o.setAttribute("y",String(n.position.y)),o.setAttribute("width",String(n.size.width)),o.setAttribute("height",String(n.size.height)),o.setAttribute("fill","rgba(200, 200, 200, 0.1)"),o.setAttribute("stroke","#999"),o.setAttribute("stroke-width","2"),o.setAttribute("stroke-dasharray","5,5"),o.setAttribute("rx","4"),o.style.pointerEvents="auto",o.style.cursor=this.mode==="edit"?"move":"pointer";const a=document.createElementNS("http://www.w3.org/2000/svg","text");a.setAttribute("x",String(n.position.x+10)),a.setAttribute("y",String(n.position.y+25)),a.setAttribute("font-size","14"),a.setAttribute("font-weight","bold"),a.setAttribute("fill","#666"),a.textContent=t.label,a.style.pointerEvents="none",s.appendChild(o),s.appendChild(a),this.mode==="edit"&&this.setupGroupEditInteractions(s,t,o),this.mode==="view"&&this.onGroupClick&&s.addEventListener("click",r=>{if(r.target.getAttribute("data-resize-side"))return;r.stopPropagation(),r.preventDefault();const l=this.svg.getBoundingClientRect(),d=r.clientX-l.left,f=r.clientY-l.top;this.onGroupClick({group:t,position:{x:d,y:f},originalEvent:r})},!0),this.groupsGroup.appendChild(s)}}updateGroupLayouts(e,t,n=!1){const s=new Set,o=n&&t?t:null;if(e){const r=this.groups.filter(h=>h.nodeIds.includes(e));r.forEach(h=>s.add(h));for(const h of r)this.addParentGroupsToUpdate(h,s)}if(t){const r=this.groups.find(h=>h.id===t);r&&(n||s.add(r),this.addParentGroupsToUpdate(r,s))}const a=Array.from(s).sort((r,h)=>{const l=d=>{if(!d.parentId)return 0;const f=this.groups.find(c=>c.id===d.parentId);return f?1+l(f):0};return l(h)-l(r)});for(const r of a){if(o&&r.id===o)continue;const h=this.calculateGroupBounds(r.nodeIds,r.id);h&&(r.layout||(r.layout={position:{x:0,y:0},size:{width:0,height:0}}),r.layout.position.x=h.minX,r.layout.position.y=h.minY,r.layout.size.width=h.maxX-h.minX,r.layout.size.height=h.maxY-h.minY)}}addParentGroupsToUpdate(e,t){if(e.parentId){const n=this.groups.find(s=>s.id===e.parentId);n&&(t.add(n),this.addParentGroupsToUpdate(n,t))}}moveDescendantGroups(e,t,n){const s=this.groups.filter(o=>o.parentId===e);for(const o of s){o.layout&&(o.layout.position.x+=t,o.layout.position.y+=n);for(const a of o.nodeIds){const r=this.nodes.find(h=>h.id===a);r&&r.position&&(r.position.x+=t,r.position.y+=n)}this.moveDescendantGroups(o.id,t,n)}}setupGroupEditInteractions(e,t,n){t.layout&&(n.addEventListener("pointerdown",s=>{if(this.mode!=="edit"||s.target.getAttribute("data-resize-side"))return;s.stopPropagation(),s.preventDefault(),n.setPointerCapture(s.pointerId);const a=this.screenToSvg(s.clientX,s.clientY),r=a.x,h=a.y;if(!t.layout)return;this.pushUndoState();const l=t.layout.position.x,d=t.layout.position.y;this.draggingGroup={groupId:t.id,offsetX:r-l,offsetY:h-d},n.style.cursor="grabbing"}),this.addGroupResizeHandles(e,t,n))}addGroupResizeHandles(e,t,n){if(!t.layout)return;const s=12,o=["top","right","bottom","left"];for(const a of o){const r=document.createElementNS("http://www.w3.org/2000/svg","circle");r.setAttribute("r",String(s/2)),r.setAttribute("fill","#2196f3"),r.setAttribute("stroke","#fff"),r.setAttribute("stroke-width","2"),r.setAttribute("data-resize-side",a),r.setAttribute("data-group-id",t.id),r.style.cursor=this.getResizeCursor(a),r.style.pointerEvents="auto";const h=t.layout.position.x,l=t.layout.position.y,d=t.layout.size.width,f=t.layout.size.height;switch(a){case"top":r.setAttribute("cx",String(h+d/2)),r.setAttribute("cy",String(l));break;case"right":r.setAttribute("cx",String(h+d)),r.setAttribute("cy",String(l+f/2));break;case"bottom":r.setAttribute("cx",String(h+d/2)),r.setAttribute("cy",String(l+f));break;case"left":r.setAttribute("cx",String(h)),r.setAttribute("cy",String(l+f/2));break}r.addEventListener("pointerdown",c=>{if(this.mode!=="edit")return;c.stopPropagation(),c.preventDefault(),r.setPointerCapture(c.pointerId);const u=this.screenToSvg(c.clientX,c.clientY),g=u.x,p=u.y;t.layout&&(this.pushUndoState(),this.resizingGroup={groupId:t.id,side:a,startX:g,startY:p,startWidth:t.layout.size.width,startHeight:t.layout.size.height,startPosX:t.layout.position.x,startPosY:t.layout.position.y})}),e.appendChild(r)}}updateEdgeHighlight(e){const t=this.groupEdgesByPair(this.edges);for(const n of t){const s=this.edgeElements.get(n.key);if(!s)continue;const o=n.edges.some(w=>w.id===this.selectedEdgeId),a=this.mode==="view"&&n.key===this.hoveredEdgePairKey,r=this.mode==="view"&&n.key===this.tappedEdgePairKey,h=this.alwaysShowEdges||o||a||r,d=n.edges[0].style||{},f=d.color||this.EDGE_DEFAULT_COLOR,c=d.weight||1,u=Math.max(this.EDGE_MIN_WEIGHT,Math.min(this.EDGE_MAX_WEIGHT,c)),g=this.EDGE_DEFAULT_WIDTH+(u-1)*.5,p=h?Math.max(g,this.EDGE_HOVER_WIDTH):g,y=o?"#2196f3":f,m=h?1:.3;s.setAttribute("stroke",y),s.setAttribute("stroke-width",String(p)),s.setAttribute("stroke-opacity",String(m)),h?(this.edgeLabelsGroup.querySelectorAll(`[data-edge-pair-key="${n.key}"]`).forEach(b=>b.remove()),this.renderEdgeLabels(n,d)):this.edgeLabelsGroup.querySelectorAll(`[data-edge-pair-key="${n.key}"]`).forEach(b=>b.remove())}}setupEdgeInteraction(e,t,n){e.addEventListener("pointerenter",()=>{this.tappedEdgePairKey!==t.key&&(this.hoveredEdgePairKey=t.key,this.updateEdgeHighlight(t.key))}),e.addEventListener("pointerleave",()=>{this.tappedEdgePairKey!==t.key&&(this.hoveredEdgePairKey=null,this.updateEdgeHighlight(null))}),e.addEventListener("click",s=>{if(this.mode==="view"&&t.edges.length>0&&(this.tappedEdgePairKey=t.key,this.updateEdgeHighlight(t.key),this.onEdgeClick)){const o=this.screenToSvg(s.clientX,s.clientY),a=t.edges[0];this.onEdgeClick({edge:a,position:{x:o.x,y:o.y},originalEvent:s})}})}setupEdgeInteractionForEdit(e,t){e.addEventListener("pointerenter",()=>{if(t.edges.length>0){if(this.selectedEdgeId!==null&&!t.edges.some(s=>s.id===this.selectedEdgeId))return;this.selectedEdgeId=t.edges[0].id,this.updateAnchorHandles(),this.updateBendHandles(),this.updateControlButtons()}}),e.addEventListener("pointerleave",()=>{}),e.addEventListener("pointerdown",n=>{t.edges.length>0&&(this.selectedEdgeId=t.edges[0].id,this.updateAnchorHandles(),this.updateBendHandles(),this.updateControlButtons())})}addResizeHandles(e,t,n,s){const o=[{side:"top",x:t.position.x,y:t.position.y-s/2},{side:"right",x:t.position.x+n/2,y:t.position.y},{side:"bottom",x:t.position.x,y:t.position.y+s/2},{side:"left",x:t.position.x-n/2,y:t.position.y}];for(const a of o){const r=document.createElementNS("http://www.w3.org/2000/svg","circle");r.setAttribute("cx",String(a.x)),r.setAttribute("cy",String(a.y)),r.setAttribute("r","6"),r.setAttribute("fill","#4CAF50"),r.setAttribute("stroke","#fff"),r.setAttribute("stroke-width","2"),r.setAttribute("data-resize-side",a.side),r.setAttribute("data-node-id",t.id),r.style.cursor=this.getResizeCursor(a.side),r.style.pointerEvents="auto",e.appendChild(r)}}getResizeCursor(e){switch(e){case"top":case"bottom":return"ns-resize";case"left":case"right":return"ew-resize"}}updateGroupPosition(e){if(!this.draggingGroup)return;const t=this.groups.find(c=>c.id===this.draggingGroup.groupId);if(!t||!t.layout)return;const n=this.screenToSvg(e.clientX,e.clientY),s=n.x,o=n.y,a=s-this.draggingGroup.offsetX,r=o-this.draggingGroup.offsetY,h=a-t.layout.position.x,l=r-t.layout.position.y,d=new Set,f=this.groups.filter(c=>c.parentId===t.id);for(const c of f)for(const u of c.nodeIds)d.add(u);for(const c of t.nodeIds)if(!d.has(c)){const u=this.nodes.find(g=>g.id===c);u&&u.position&&(u.position.x+=h,u.position.y+=l)}this.moveDescendantGroups(t.id,h,l),t.layout.position.x=a,t.layout.position.y=r,this.updateGroupLayouts(void 0,t.id,!0),this.render(),this.updateAnchorHandles(),this.updateBendHandles()}updateGroupSize(e){if(!this.resizingGroup)return;const t=this.groups.find(l=>l.id===this.resizingGroup.groupId);if(!t||!t.layout)return;const n=this.screenToSvg(e.clientX,e.clientY),s=n.x,o=n.y,a=s-this.resizingGroup.startX,r=o-this.resizingGroup.startY;switch(this.resizingGroup.side){case"right":{const l=Math.max(100,this.resizingGroup.startWidth+a);t.layout.size.width=l;break}case"left":{const l=Math.max(100,this.resizingGroup.startWidth-a);t.layout.size.width=l,t.layout.position.x=this.resizingGroup.startPosX+a;break}case"bottom":{const l=Math.max(100,this.resizingGroup.startHeight+r);t.layout.size.height=l;break}case"top":{const l=Math.max(100,this.resizingGroup.startHeight-r);t.layout.size.height=l,t.layout.position.y=this.resizingGroup.startPosY+r;break}}const h=this.groupsGroup.querySelector(`[data-group-id="${t.id}"]`);if(h){const l=h.querySelector("rect");if(l&&(l.setAttribute("x",String(t.layout.position.x)),l.setAttribute("y",String(t.layout.position.y)),l.setAttribute("width",String(t.layout.size.width)),l.setAttribute("height",String(t.layout.size.height))),!t.layout)return;const d=h.querySelectorAll("[data-resize-side]"),f=t.layout;d.forEach(u=>{const g=u.getAttribute("data-resize-side"),p=f.position.x,y=f.position.y,m=f.size.width,w=f.size.height;switch(g){case"top":u.setAttribute("cx",String(p+m/2)),u.setAttribute("cy",String(y));break;case"right":u.setAttribute("cx",String(p+m)),u.setAttribute("cy",String(y+w/2));break;case"bottom":u.setAttribute("cx",String(p+m/2)),u.setAttribute("cy",String(y+w));break;case"left":u.setAttribute("cx",String(p)),u.setAttribute("cy",String(y+w/2));break}});const c=h.querySelector("text");c&&(c.setAttribute("x",String(t.layout.position.x+10)),c.setAttribute("y",String(t.layout.position.y+20)))}}handleGroupResizeEnd(){this.resizingGroup&&this.updateGroupLayouts(void 0,this.resizingGroup.groupId,!0),this.render()}getPointOnPath(e,t){if(!e)return null;const n=document.createElementNS("http://www.w3.org/2000/svg","svg");n.style.position="absolute",n.style.visibility="hidden",n.style.width="0",n.style.height="0",document.body.appendChild(n);const s=document.createElementNS("http://www.w3.org/2000/svg","path");s.setAttribute("d",e),n.appendChild(s);try{const o=s.getTotalLength();if(o===0)return document.body.removeChild(n),null;const a=s.getPointAtLength(o*t);return document.body.removeChild(n),{x:a.x,y:a.y}}catch{return document.body.removeChild(n),null}}renderEdgeLabels(e,t){const n=this.nodes.find(E=>E.id===e.a),s=this.nodes.find(E=>E.id===e.b);if(!n?.position||!s?.position)return;const o=n.style||{},a=s.style||{},r=o.width||this.DEFAULT_NODE_WIDTH,h=o.height||this.DEFAULT_NODE_HEIGHT,l=a.width||this.DEFAULT_NODE_WIDTH,d=a.height||this.DEFAULT_NODE_HEIGHT,f=e.srcAnchor||this.estimateAnchor(n,s),c=e.dstAnchor||this.estimateAnchor(s,n),u=this.calculateAnchorPosition(n,f,r,h),g=this.calculateAnchorPosition(s,c,l,d),p=this.calculateEdgePairPath(e),y=e.edges.find(E=>E.src===e.a&&E.dst===e.b),m=e.edges.find(E=>E.src===e.b&&E.dst===e.a),w=y?.style?.label||y?.relType||"",b=m?.style?.label||m?.relType||"",_=w!==b&&w&&b,C=w===b&&w;if(_){const v=this.getPointOnPath(p,.75),B=this.getPointOnPath(p,.25),x=v?v.x:u.x+(g.x-u.x)*(1-.25),T=v?v.y:u.y+(g.y-u.y)*(1-.25),A=B?B.x:u.x+(g.x-u.x)*.25,L=B?B.y:u.y+(g.y-u.y)*.25;if(w){const S=document.createElementNS("http://www.w3.org/2000/svg","text");S.setAttribute("x",String(x)),S.setAttribute("y",String(T-8)),S.setAttribute("text-anchor","middle"),S.setAttribute("dominant-baseline","middle"),S.setAttribute("font-size","12"),S.setAttribute("fill","#333"),S.setAttribute("font-weight","bold"),S.setAttribute("pointer-events","none"),S.setAttribute("data-edge-pair-key",e.key);const k=document.createElementNS("http://www.w3.org/2000/svg","rect"),N=w.length*7;k.setAttribute("x",String(x-N/2-4)),k.setAttribute("y",String(T-16)),k.setAttribute("width",String(N+8)),k.setAttribute("height","16"),k.setAttribute("fill","rgba(255, 255, 255, 0.9)"),k.setAttribute("rx","2"),k.setAttribute("pointer-events","none"),k.setAttribute("data-edge-pair-key",e.key),this.edgeLabelsGroup.appendChild(k),S.textContent=w,this.edgeLabelsGroup.appendChild(S)}if(b){const S=document.createElementNS("http://www.w3.org/2000/svg","text");S.setAttribute("x",String(A)),S.setAttribute("y",String(L-8)),S.setAttribute("text-anchor","middle"),S.setAttribute("dominant-baseline","middle"),S.setAttribute("font-size","12"),S.setAttribute("fill","#333"),S.setAttribute("font-weight","bold"),S.setAttribute("pointer-events","none"),S.setAttribute("data-edge-pair-key",e.key);const k=document.createElementNS("http://www.w3.org/2000/svg","rect"),N=b.length*7;k.setAttribute("x",String(A-N/2-4)),k.setAttribute("y",String(L-16)),k.setAttribute("width",String(N+8)),k.setAttribute("height","16"),k.setAttribute("fill","rgba(255, 255, 255, 0.9)"),k.setAttribute("rx","2"),k.setAttribute("pointer-events","none"),k.setAttribute("data-edge-pair-key",e.key),this.edgeLabelsGroup.appendChild(k),S.textContent=b,this.edgeLabelsGroup.appendChild(S)}}else if(C){const E=this.getPointOnPath(p,.5),v=E?E.x:(u.x+g.x)/2,B=E?E.y:(u.y+g.y)/2,x=document.createElementNS("http://www.w3.org/2000/svg","text");x.setAttribute("x",String(v)),x.setAttribute("y",String(B)),x.setAttribute("text-anchor","middle"),x.setAttribute("dominant-baseline","middle"),x.setAttribute("data-edge-pair-key",e.key),x.setAttribute("font-size","12"),x.setAttribute("fill","#333"),x.setAttribute("font-weight","bold"),x.setAttribute("pointer-events","none");const T=document.createElementNS("http://www.w3.org/2000/svg","rect"),A=w.length*7;T.setAttribute("x",String(v-A/2-4)),T.setAttribute("y",String(B-8)),T.setAttribute("width",String(A+8)),T.setAttribute("height","16"),T.setAttribute("fill","rgba(255, 255, 255, 0.9)"),T.setAttribute("rx","2"),T.setAttribute("pointer-events","none"),T.setAttribute("data-edge-pair-key",e.key),this.edgeLabelsGroup.appendChild(T),x.textContent=w,this.edgeLabelsGroup.appendChild(x)}else if(t.label){const E=this.getPointOnPath(p,.5),v=E?E.x:(u.x+g.x)/2,B=E?E.y:(u.y+g.y)/2,x=document.createElementNS("http://www.w3.org/2000/svg","text");x.setAttribute("x",String(v)),x.setAttribute("y",String(B)),x.setAttribute("text-anchor","middle"),x.setAttribute("dominant-baseline","middle"),x.setAttribute("font-size","12"),x.setAttribute("fill","#333"),x.setAttribute("font-weight","bold"),x.setAttribute("pointer-events","none"),x.setAttribute("data-edge-pair-key",e.key);const T=document.createElementNS("http://www.w3.org/2000/svg","rect"),A=t.label.length*7;T.setAttribute("x",String(v-A/2-4)),T.setAttribute("y",String(B-8)),T.setAttribute("width",String(A+8)),T.setAttribute("height","16"),T.setAttribute("fill","rgba(255, 255, 255, 0.9)"),T.setAttribute("rx","2"),T.setAttribute("pointer-events","none"),T.setAttribute("data-edge-pair-key",e.key),this.edgeLabelsGroup.appendChild(T),x.textContent=t.label,this.edgeLabelsGroup.appendChild(x)}}setMode(e){if(!this.editable&&e==="edit")return;const t=this.mode==="edit";e==="edit"&&this.mode==="view"&&(this.saveSnapshot(),this.undoStack=[],this.redoStack=[]),this.mode=e,this.render(),e==="view"&&(this.deselectEdge(),t&&this.onSave&&this.onSave({nodes:this.nodes,edges:this.edges,groups:this.groups.length>0?this.groups:void 0})),this.updateEditToggleButtonIcon(),this.updateControlButtons(),this.onModeChange&&this.onModeChange()}setModeChangeCallback(e){this.onModeChange=e}setAlwaysShowEdgesChangeCallback(e){this.onAlwaysShowEdgesChange=e}setGraphButtonsUpdateCallback(e){this.onGraphButtonsUpdate=e}getAlwaysShowEdges(){return this.alwaysShowEdges}setAlwaysShowEdges(e){this.alwaysShowEdges!==e&&(this.alwaysShowEdges=e,this.updateAlwaysShowEdgesButton(),this.alwaysShowEdges||(this.hoveredEdgePairKey=null,this.tappedEdgePairKey=null),this.render())}clearSelection(){this.deselectEdge()}cancelEdit(){this.restoreSnapshot(),this.setMode("view")}getSelectedEdgeId(){return this.selectedEdgeId}getEdges(){return this.edges}hasBendPoints(e){const t=this.edges.find(r=>r.id===e);if(!t)return!1;const[n,s]=t.src<t.dst?[t.src,t.dst]:[t.dst,t.src],o=`${n}||${s}`,a=this.groupEdgesByPair(this.edges).find(r=>r.key===o);return!!(a&&a.bends&&a.bends.length>0)}isEditable(){return this.editable}getEditToggleButton(){return this.editToggleButton}getMode(){return this.mode}getViewAsSvg(){if(this.nodes.length===0)return null;let e=1/0,t=1/0,n=-1/0,s=-1/0;for(const c of this.nodes){if(!c.position)continue;const u=c.style||{},g=u.width??this.DEFAULT_NODE_WIDTH,p=u.height??this.DEFAULT_NODE_HEIGHT;e=Math.min(e,c.position.x-g/2),t=Math.min(t,c.position.y-p/2),n=Math.max(n,c.position.x+g/2),s=Math.max(s,c.position.y+p/2)}for(const c of this.groups){const u=this.getGroupLayout(c);u&&(e=Math.min(e,u.position.x),t=Math.min(t,u.position.y),n=Math.max(n,u.position.x+u.size.width),s=Math.max(s,u.position.y+u.size.height))}for(const c of this.edges){const u=this.getEdgePoints(c);for(const g of u)e=Math.min(e,g.x),t=Math.min(t,g.y),n=Math.max(n,g.x),s=Math.max(s,g.y)}const o=20;e-=o,t-=o,n+=o,s+=o;const a=n-e,r=s-t,h=this.svg.cloneNode(!0);h.setAttribute("viewBox",`0 0 ${a} ${r}`),h.setAttribute("width",String(Math.round(a))),h.setAttribute("height",String(Math.round(r)));const l=`translate(${-e}, ${-t})`;return[h.querySelector(".groups"),h.querySelector(".edges"),h.querySelector(".nodes"),h.querySelector(".anchor-handles"),h.querySelector(".bend-handles"),h.querySelector(".edge-labels")].forEach(c=>{c instanceof SVGGElement&&c.setAttribute("transform",l)}),h.querySelectorAll(".edges path[data-edge-pair-key]").forEach(c=>{c instanceof SVGPathElement&&(c.setAttribute("stroke-opacity","1"),(parseFloat(c.getAttribute("stroke-width")||"0")||0)<2&&c.setAttribute("stroke-width","2"))}),new XMLSerializer().serializeToString(h)}async exportViewToImage(e,t){const n=this.getViewAsSvg();if(!n)return null;const s="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(n);return new Promise(o=>{const a=new Image;a.crossOrigin="anonymous",a.onload=()=>{const r=a.naturalWidth,h=a.naturalHeight,l=document.createElement("canvas");l.width=r,l.height=h;const d=l.getContext("2d");if(!d){o(null);return}d.fillStyle="#ffffff",d.fillRect(0,0,r,h),d.drawImage(a,0,0);const f=t?.quality??.92;l.toBlob(c=>o(c??null),e==="png"?"image/png":"image/webp",f)},a.onerror=()=>o(null),a.src=s})}show(){this.container.style.display="block",this.nodes.length>0&&setTimeout(()=>{const e=this.container.getBoundingClientRect();e.width>0&&e.height>0&&this.fitAndCenter()},100),this.resize()}createPopup(){const e=document.createElement("div");e.className="relatos-graph-popup",e.style.cssText=`
      position: absolute;
      background: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 8px 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      pointer-events: none;
      z-index: 10000;
      font-size: 14px;
      line-height: 1.4;
      max-width: 300px;
      word-wrap: break-word;
      overflow-wrap: break-word;
      white-space: normal;
      opacity: 0;
      transition: opacity 0.2s;
    `;const t=document.createElement("div");return t.style.cssText=`
      position: absolute;
      bottom: -8px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 8px solid transparent;
      border-right: 8px solid transparent;
      border-top: 8px solid white;
    `,e.appendChild(t),this.container.appendChild(e),e}showPopup(e){!e||!e.position||(this.hidePopup(),this.popupElement||(this.popupElement=this.createPopup()),this.popupElement.textContent=e.label,this.popupElement.style.opacity="1",this.popupElement.style.display="block",this.popupNodeId=e.id,requestAnimationFrame(()=>{this.popupElement&&this.popupNodeId===e.id&&this.updatePopupPosition(e)}))}updatePopupPosition(e){if(!this.popupElement||!e||!e.position)return;const t=e.style||{};t.width||this.DEFAULT_NODE_WIDTH;const n=t.height||this.DEFAULT_NODE_HEIGHT,s=this.nodeElements.get(e.id);if(!s){this.container.getBoundingClientRect(),this.svg.getBoundingClientRect();const g=isFinite(this.zoom)&&this.zoom>0?this.zoom:1,p=isFinite(this.offsetX)?this.offsetX:0,y=isFinite(this.offsetY)?this.offsetY:0,m=(e.position.x+p)*g,w=(e.position.y+y)*g,b=this.popupElement.getBoundingClientRect(),_=b.width||200,C=b.height||50,E=m-_/2,v=w-n*g/2-C-10;this.popupElement.style.left=`${E}px`,this.popupElement.style.top=`${v}px`;return}const o=s.getBoundingClientRect(),a=this.container.getBoundingClientRect(),r=o.left+o.width/2-a.left,h=o.top+o.height/2-a.top,l=this.popupElement.getBoundingClientRect(),d=l.width||200,f=l.height||50,c=r-d/2,u=h-o.height/2-f-10;this.popupElement.style.left=`${c}px`,this.popupElement.style.top=`${u}px`}hidePopup(){this.popupElement&&(this.popupElement.style.opacity="0",setTimeout(()=>{this.popupElement&&this.popupElement.style.opacity==="0"&&(this.popupElement.style.display="none")},200)),this.popupNodeId=null}hide(){this.container.style.display="none",this.hidePopup()}resize(){const e=this.container.getBoundingClientRect();if(this.svg.setAttribute("width",String(e.width)),this.svg.setAttribute("height",String(e.height)),this.popupNodeId&&this.popupElement){const t=this.nodes.find(n=>n.id===this.popupNodeId);t&&this.updatePopupPosition(t)}}destroy(){this.nodeElements.clear(),this.edgeElements.clear(),this.container.contains(this.svg)&&this.container.removeChild(this.svg)}};Ce.MAX_UNDO_LEVELS=50;let ai=Ce;function ta(i,e=16){return St(),`<svg width="${e}" height="${e}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <use href="#${i}"></use>
  </svg>`}class ea{constructor(e,t,n,s,o,a){this.viewer=null,this.Cesium=null,this.nodes=[],this.edges=[],this.selectedNodeId=null,this.lastSelectedNodeId=null,this.nodeEntities=new Map,this.edgeEntities=new Map,this.rectEntity=null,this.fitCenterButton=null,this.lightingToggleButton=null,this.alwaysShowEdgesButton=null,this.alwaysShowEdges=!0,this.tileTypeButton=null,this.baseImageryLayer=null,this.timeISO=null,this.customTileUrls=[],this.currentCustomTileIndex=0,this.popupElement=null,this.popupEntity=null,this.popupUpdateListener=null,this.container=e,this.onNodeClick=t,this.cesiumLoader=n,this.globe3dOptions=s,this.onEdgeClick=a;const r=o&&o.length>0?o:s?.customTileUrls;r&&r.length>0?this.customTileUrls=r.map(h=>typeof h=="string"?{url:h}:h):s?.customTileUrl&&(this.customTileUrls=[{url:s.customTileUrl}]),this.container.style.position="relative",this.container.style.width="100%",this.container.style.height="100%"}async initializeCesium(){if(this.viewer)return;if(!this.cesiumLoader)throw new Error("Cesium loader is not provided. Please provide options.loaders.cesium.");const e=await this.cesiumLoader();this.Cesium=e.default||e;const t=new this.Cesium.EllipsoidTerrainProvider;this.Cesium.Ion&&(this.Cesium.Ion.defaultAccessToken=""),this.viewer=new this.Cesium.Viewer(this.container,{terrainProvider:t,baseLayerPicker:!1,animation:!1,timeline:!1,fullscreenButton:!1,vrButton:!1,geocoder:!1,homeButton:!1,infoBox:!1,sceneModePicker:!1,selectionIndicator:!1,navigationHelpButton:!1,requestRenderMode:!1}),this.viewer.canvas&&(this.viewer.canvas.style.touchAction="none"),this.Cesium.Moon?(this.viewer.scene.moon||(this.viewer.scene.moon=new this.Cesium.Moon),this.viewer.scene.moon.show=!0,this.viewer.scene.moon.onlySunLighting!==void 0&&(this.viewer.scene.moon.onlySunLighting=!1)):this.viewer.scene.moon&&(this.viewer.scene.moon.show=!0),this.viewer.scene.sun&&(this.viewer.scene.sun.show=!0);try{this.viewer.imageryLayers.removeAll()}catch{}this.setupCameraLimits(),this.setupTrackpadPinchZoom(),this.setTileTypeInternal(!0),this.setupTimeAndLighting(),this.setupClickHandler(),(this.nodes.length>0||this.edges.length>0)&&this.render(),this.onLightingChange&&this.isLightingEnabled()}setupTrackpadPinchZoom(){if(!this.viewer||!this.Cesium)return;const e=this.viewer.canvas,t=this.viewer.scene.camera,n=5e5,s=4e7,o=f=>{if(f.ctrlKey){f.preventDefault(),f.stopPropagation();const c=1-f.deltaY*.01,u=this.Cesium.Cartographic.fromCartesian(t.position);let p=u.height/c;p=Math.max(n,Math.min(s,p));const y=this.Cesium.Cartesian3.fromRadians(u.longitude,u.latitude,p);t.setView({destination:y,orientation:{heading:t.heading,pitch:t.pitch,roll:t.roll}})}};let a=1,r=0;const h=f=>{f.preventDefault(),a=f.scale||1,r=this.Cesium.Cartographic.fromCartesian(t.position).height},l=f=>{f.preventDefault();const u=(f.scale||1)/a;let g=r/u;g=Math.max(n,Math.min(s,g));const p=this.Cesium.Cartographic.fromCartesian(t.position),y=this.Cesium.Cartesian3.fromRadians(p.longitude,p.latitude,g);t.setView({destination:y,orientation:{heading:t.heading,pitch:t.pitch,roll:t.roll}})},d=f=>{f.preventDefault(),a=1,r=0};e.addEventListener("wheel",o,{passive:!1}),"GestureEvent"in window&&(e.addEventListener("gesturestart",h,{passive:!1}),e.addEventListener("gesturechange",l,{passive:!1}),e.addEventListener("gestureend",d,{passive:!1})),this._trackpadPinchHandlers={wheel:o,gestureStart:h,gestureChange:l,gestureEnd:d}}setupTimeAndLighting(){!this.viewer||this.Cesium}setTime(e){if(this.timeISO=e,!(!this.viewer||!this.Cesium))try{let t;e.startsWith("-")?t=this.parseBCDate(e):t=this.Cesium.JulianDate.fromIso8601(e),t&&(this.viewer.clock.currentTime=t,this.viewer.clock.startTime=t,this.viewer.clock.stopTime=t,this.viewer.clock.shouldAnimate=!1)}catch{}}parseBCDate(e){if(!this.Cesium)return null;try{const t=e.match(/^-(\d+)-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})(Z|[+-]\d{2}:\d{2})?/);if(!t)throw new Error("Invalid BC date format");const n=`2000-${t[2]}-${t[3]}T${t[4]}:${t[5]}:${t[6]}${t[7]||"Z"}`;return this.Cesium.JulianDate.fromIso8601(n)}catch{return null}}setLighting(e){if(!this.viewer||!this.Cesium||this.isLightingEnabled()===e)return;const t=this.viewer.scene.globe;t.enableLighting=e,t.dynamicAtmosphereLighting=e,t.dynamicAtmosphereLightingFromSun=e,t.showGroundAtmosphere=!0,e?(t.lightingFadeOutDistance=0,t.lightingFadeInDistance=0,t.nightFadeInDistance=0,t.nightFadeOutDistance=0,this.baseImageryLayer&&(this.baseImageryLayer.nightAlpha=.9),this.viewer.scene.sun&&(this.viewer.scene.sun.show=!0),this.viewer.scene.moon?.onlySunLighting!==void 0&&(this.viewer.scene.moon.onlySunLighting=!0)):this.viewer.scene.moon?.onlySunLighting!==void 0&&(this.viewer.scene.moon.onlySunLighting=!1),this.updateLightingButton()}isLightingEnabled(){return this.viewer?this.viewer.scene.globe.enableLighting===!0:!1}getAlwaysShowEdges(){return this.alwaysShowEdges}setAlwaysShowEdges(e){this.alwaysShowEdges!==e&&(this.alwaysShowEdges=e,this.updateAlwaysShowEdgesButton(),this.renderWithoutFit())}getLightingEnabled(){return this.isLightingEnabled()}setLightingEnabled(e,t=!0){const n=this.isLightingEnabled();this.setLighting(e),t&&this.onLightingChange&&this.isLightingEnabled()!==n&&this.onLightingChange(this.isLightingEnabled())}setAlwaysShowEdgesChangeCallback(e){this.onAlwaysShowEdgesChange=e}setLightingChangeCallback(e){this.onLightingChange=e}getTileServerCount(){return this.customTileUrls.length}getTileServerIndex(){return this.currentCustomTileIndex}setTileServerIndex(e){if(this.customTileUrls.length===0)return;const t=this.customTileUrls.length,n=(e%t+t)%t;this.currentCustomTileIndex!==n&&(this.currentCustomTileIndex=n,this.viewer&&this.Cesium&&(this.setTileTypeInternal(!0),this.updateTileTypeButton()))}cycleTileServer(){this.switchTileType()}setupCameraLimits(){if(!this.viewer||!this.Cesium)return;const e=5e5,t=4e7,n=this.viewer.scene.screenSpaceCameraController;n.minimumZoomDistance=e,n.maximumZoomDistance=t,n.enableInputs=!0,n.enableZoom=!0,n.enableRotate=!0,n.enableTilt=!0,n.enableTranslate=!0;const s=this.Cesium.CameraEventType;n.zoomEventTypes=[s.WHEEL,s.PINCH],n.rotateEventTypes=s.LEFT_DRAG,n.tiltEventTypes=[{eventType:s.LEFT_DRAG,modifier:this.Cesium.KeyboardEventModifier.CTRL},{eventType:s.MIDDLE_DRAG}],n.translateEventTypes=[s.RIGHT_DRAG];let o=!1,a=!1;this.viewer.scene.camera.changed.addEventListener(()=>{if(o||a)return;const r=this.viewer.scene.camera,h=this.Cesium.Cartographic.fromCartesian(r.position),l=h.height;if(l<e||l>t){o=!0;const d=Math.max(e,Math.min(t,l)),f=this.Cesium.Cartesian3.fromRadians(h.longitude,h.latitude,d);r.setView({destination:f,orientation:r.orientation}),setTimeout(()=>{o=!1},0)}}),this._isFlying=()=>a,this._setIsFlying=r=>{a=r}}setupClickHandler(){if(!this.viewer||!this.Cesium)return;new this.Cesium.ScreenSpaceEventHandler(this.viewer.canvas).setInputAction(t=>{const n=this.viewer.scene.pick(t.position);if(n&&n.id&&n.id.nodeId){const o=n.id.nodeId,a=this.nodes.find(h=>h.id===o),r=this.nodeEntities.get(o);if(a&&r&&(this.showPopup(r,a),this.onNodeClick)){const h=this.viewer.camera.pickEllipsoid(t.position,this.viewer.scene.globe.ellipsoid);if(h){const l=this.Cesium.Cartographic.fromCartesian(h),d=this.Cesium.Math.toDegrees(l.longitude),f=this.Cesium.Math.toDegrees(l.latitude);this.onNodeClick({node:a,position:{x:d,y:f},originalEvent:t.originalEvent})}}return}const s=this.viewer.scene.drillPick(t.position);for(const o of s)if(o.id&&o.id.nodeId){const a=o.id.nodeId,r=this.nodes.find(l=>l.id===a),h=this.nodeEntities.get(a);if(r&&h&&(this.showPopup(h,r),this.onNodeClick)){const l=this.viewer.camera.pickEllipsoid(t.position,this.viewer.scene.globe.ellipsoid);if(l){const d=this.Cesium.Cartographic.fromCartesian(l),f=this.Cesium.Math.toDegrees(d.longitude),c=this.Cesium.Math.toDegrees(d.latitude);this.onNodeClick({node:r,position:{x:f,y:c},originalEvent:t.originalEvent})}}return}s.length===0&&this.hidePopup();for(const o of s)if(o.id&&o.id.edgeId){const a=o.id.edgeId,r=this.edges.find(h=>h.id===a);if(r&&this.onEdgeClick){const h=this.viewer.camera.pickEllipsoid(t.position,this.viewer.scene.globe.ellipsoid);if(h){const l=this.Cesium.Cartographic.fromCartesian(h),d=this.Cesium.Math.toDegrees(l.longitude),f=this.Cesium.Math.toDegrees(l.latitude);this.onEdgeClick({edge:r,position:{x:d,y:f},originalEvent:t.originalEvent})}}return}!n&&(!s||s.length===0)&&this.hidePopup()},this.Cesium.ScreenSpaceEventType.LEFT_CLICK)}setData(e,t){this.nodes=e,this.edges=t,this.viewer&&this.Cesium&&this.render()}selectNode(e){if(!e){this.selectedNodeId=null,this.lastSelectedNodeId=null,this.hidePopup(),this.render();return}if(!this.viewer||!this.Cesium)return;if(e===this.lastSelectedNodeId){this.lastSelectedNodeId=null,this.nodeEntities.size>0&&this.updateNodeSelection(),this.fitToNodes();return}this.lastSelectedNodeId=e,this.selectedNodeId=e,this.nodeEntities.size>0?this.updateNodeSelection():this.render();const t=this.nodes.find(s=>s.id===e);if(!t)return;if(t.coordinates&&t.coordinates.length===2){const[s,o]=t.coordinates;if(Number.isFinite(s)&&Number.isFinite(o)){const[a,r]=t.coordinates,h=3e6,l=this.nodeEntities.get(e);l&&t&&this.showPopup(l,t);const d=this._setIsFlying;d&&d(!0),setTimeout(()=>{this.viewer.camera.flyTo({destination:this.Cesium.Cartesian3.fromDegrees(r,a,h),orientation:{heading:this.Cesium.Math.toRadians(0),pitch:this.Cesium.Math.toRadians(-90),roll:0},duration:1,complete:()=>{d&&d(!1)}})},0);return}}const n=this.nodes.filter(s=>{if(!s.coordinates||!Array.isArray(s.coordinates)||s.coordinates.length!==2)return!0;const[o,a]=s.coordinates;return!Number.isFinite(o)||!Number.isFinite(a)});if(n.length>0){const h=Math.ceil(Math.sqrt(n.length)),d=50/(Math.ceil(n.length/h)+1),f=32/(h+1),c=n.findIndex(u=>u.id===e);if(c>=0){const u=Math.floor(c/h),g=c%h,p=-50+(u+1)*d,y=-32+(g+1)*f,m=3e6,w=this.nodeEntities.get(e);w&&t&&this.showPopup(w,t);const b=this._setIsFlying;b&&b(!0),setTimeout(()=>{this.viewer.camera.flyTo({destination:this.Cesium.Cartesian3.fromDegrees(y,p,m),orientation:{heading:this.Cesium.Math.toRadians(0),pitch:this.Cesium.Math.toRadians(-90),roll:0},duration:1,complete:()=>{b&&b(!1)}})},0)}}}render(){if(!this.viewer||!this.Cesium)return;this.viewer.entities.removeAll(),this.nodeEntities.clear(),this.edgeEntities.clear(),this.rectEntity=null;const e=this.nodes.filter(s=>{if(!s.coordinates||!Array.isArray(s.coordinates)||s.coordinates.length!==2)return!0;const[o,a]=s.coordinates;return!Number.isFinite(o)||!Number.isFinite(a)}),t=this.nodes.filter(s=>{if(!s.coordinates||!Array.isArray(s.coordinates)||s.coordinates.length!==2)return!1;const[o,a]=s.coordinates;return Number.isFinite(o)&&Number.isFinite(a)}),n=new Map;if(e.length>0){const h=[this.Cesium.Cartesian3.fromDegrees(-32,-50,0),this.Cesium.Cartesian3.fromDegrees(0,-50,0),this.Cesium.Cartesian3.fromDegrees(0,0,0),this.Cesium.Cartesian3.fromDegrees(-32,0,0)];this.rectEntity=this.viewer.entities.add({polygon:{hierarchy:h,material:this.Cesium.Color.fromCssColorString("#f0f0f0").withAlpha(.1),outline:!0,outlineColor:this.Cesium.Color.fromCssColorString("#666"),height:0}});const l=Math.ceil(Math.sqrt(e.length)),f=50/(Math.ceil(e.length/l)+1),c=32/(l+1);e.forEach((u,g)=>{const p=Math.floor(g/l),y=g%l,m=-50+(p+1)*f,w=-32+(y+1)*c;n.set(u.id,[m,w]);const b=this.selectedNodeId===u.id,_=u.style?.color||"#ffffff",C=b?"#2196f3":u.style?.borderColor||"#333333";let E;const v=_.match(/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/i);if(v){const T=parseInt(v[1],16)/255,A=parseInt(v[2],16)/255,L=parseInt(v[3],16)/255;E=new this.Cesium.Color(T,A,L,1)}else E=this.Cesium.Color.fromCssColorString(_),E=E.withAlpha(1);const B=this.Cesium.Color.fromCssColorString(C),x=this.viewer.entities.add({position:this.Cesium.Cartesian3.fromDegrees(w,m,0),point:{pixelSize:b?15:10,color:E,outlineColor:B,outlineWidth:2,heightReference:this.Cesium.HeightReference.CLAMP_TO_GROUND},label:{text:u.label,font:"14px sans-serif",fillColor:this.Cesium.Color.WHITE,outlineColor:this.Cesium.Color.BLACK,outlineWidth:2,style:this.Cesium.LabelStyle.FILL_AND_OUTLINE,verticalOrigin:this.Cesium.VerticalOrigin.BOTTOM,pixelOffset:new this.Cesium.Cartesian2(0,-20),heightReference:this.Cesium.HeightReference.CLAMP_TO_GROUND,show:!1},nodeId:u.id});this.nodeEntities.set(u.id,x)})}for(const s of t){const[o,a]=s.coordinates;n.set(s.id,[o,a]);const r=this.selectedNodeId===s.id,h=s.style?.color||"#ffffff",l=r?"#2196f3":s.style?.borderColor||"#333333";let d;const f=h.match(/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/i);if(f){const g=parseInt(f[1],16)/255,p=parseInt(f[2],16)/255,y=parseInt(f[3],16)/255;d=new this.Cesium.Color(g,p,y,1)}else d=this.Cesium.Color.fromCssColorString(h),d=d.withAlpha(1);const c=this.Cesium.Color.fromCssColorString(l),u=this.viewer.entities.add({position:this.Cesium.Cartesian3.fromDegrees(a,o,0),point:{pixelSize:r?15:10,color:d,outlineColor:c,outlineWidth:2,heightReference:this.Cesium.HeightReference.CLAMP_TO_GROUND},label:{text:s.label,font:"14px sans-serif",fillColor:this.Cesium.Color.WHITE,outlineColor:this.Cesium.Color.BLACK,outlineWidth:2,style:this.Cesium.LabelStyle.FILL_AND_OUTLINE,verticalOrigin:this.Cesium.VerticalOrigin.BOTTOM,pixelOffset:new this.Cesium.Cartesian2(0,-20),heightReference:this.Cesium.HeightReference.CLAMP_TO_GROUND,show:!1},nodeId:s.id});this.nodeEntities.set(s.id,u)}if(this.alwaysShowEdges)for(const s of this.edges){const o=n.get(s.src),a=n.get(s.dst);if(!o||!a)continue;const[r,h]=o,[l,d]=a,f=s.style?.color||"#999999",c=s.style?.weight||1,u=Math.max(1,Math.min(5,c)),g=this.viewer.entities.add({polyline:{positions:[this.Cesium.Cartesian3.fromDegrees(h,r,0),this.Cesium.Cartesian3.fromDegrees(d,l,0)],width:u,material:this.Cesium.Color.fromCssColorString(f),clampToGround:!0},edgeId:s.id});this.edgeEntities.set(s.id,g)}this.fitToNodes()}updateNodeSelection(){if(!(!this.viewer||!this.Cesium))for(const[e,t]of this.nodeEntities.entries()){const n=this.nodes.find(r=>r.id===e);if(!n)continue;const s=this.selectedNodeId===e,o=n.style?.color||"#ffffff",a=s?"#2196f3":n.style?.borderColor||"#333333";if(t.point){t.point.pixelSize=s?15:10;let r;const h=o.match(/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/i);if(h){const l=parseInt(h[1],16)/255,d=parseInt(h[2],16)/255,f=parseInt(h[3],16)/255;r=new this.Cesium.Color(l,d,f,1)}else r=this.Cesium.Color.fromCssColorString(o),r=r.withAlpha(1);t.point.color=r,t.point.outlineColor=this.Cesium.Color.fromCssColorString(a)}}}renderWithoutFit(){if(!this.viewer||!this.Cesium)return;this.viewer.entities.removeAll(),this.nodeEntities.clear(),this.edgeEntities.clear(),this.rectEntity=null;const e=this.nodes.filter(s=>{if(!s.coordinates||!Array.isArray(s.coordinates)||s.coordinates.length!==2)return!0;const[o,a]=s.coordinates;return!Number.isFinite(o)||!Number.isFinite(a)}),t=this.nodes.filter(s=>{if(!s.coordinates||!Array.isArray(s.coordinates)||s.coordinates.length!==2)return!1;const[o,a]=s.coordinates;return Number.isFinite(o)&&Number.isFinite(a)}),n=new Map;if(e.length>0){const h=[this.Cesium.Cartesian3.fromDegrees(-32,-50,0),this.Cesium.Cartesian3.fromDegrees(0,-50,0),this.Cesium.Cartesian3.fromDegrees(0,0,0),this.Cesium.Cartesian3.fromDegrees(-32,0,0)];this.rectEntity=this.viewer.entities.add({polygon:{hierarchy:h,material:this.Cesium.Color.fromCssColorString("#f0f0f0").withAlpha(.1),outline:!0,outlineColor:this.Cesium.Color.fromCssColorString("#666"),height:0}});const l=Math.ceil(Math.sqrt(e.length)),f=50/(Math.ceil(e.length/l)+1),c=32/(l+1);e.forEach((u,g)=>{const p=Math.floor(g/l),y=g%l,m=-50+(p+1)*f,w=-32+(y+1)*c;n.set(u.id,[m,w]);const b=this.selectedNodeId===u.id,_=u.style?.color||"#ffffff",C=b?"#2196f3":u.style?.borderColor||"#333333";let E;const v=_.match(/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/i);if(v){const T=parseInt(v[1],16)/255,A=parseInt(v[2],16)/255,L=parseInt(v[3],16)/255;E=new this.Cesium.Color(T,A,L,1)}else E=this.Cesium.Color.fromCssColorString(_),E=E.withAlpha(1);const B=this.Cesium.Color.fromCssColorString(C),x=this.viewer.entities.add({position:this.Cesium.Cartesian3.fromDegrees(w,m,0),point:{pixelSize:b?15:10,color:E,outlineColor:B,outlineWidth:2,heightReference:this.Cesium.HeightReference.CLAMP_TO_GROUND},label:{text:u.label,font:"14px sans-serif",fillColor:this.Cesium.Color.WHITE,outlineColor:this.Cesium.Color.BLACK,outlineWidth:2,style:this.Cesium.LabelStyle.FILL_AND_OUTLINE,verticalOrigin:this.Cesium.VerticalOrigin.BOTTOM,pixelOffset:new this.Cesium.Cartesian2(0,-20),heightReference:this.Cesium.HeightReference.CLAMP_TO_GROUND,show:!1},nodeId:u.id});this.nodeEntities.set(u.id,x)})}for(const s of t){const[o,a]=s.coordinates;n.set(s.id,[o,a]);const r=this.selectedNodeId===s.id,h=s.style?.color||"#ffffff",l=r?"#2196f3":s.style?.borderColor||"#333333";let d;const f=h.match(/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/i);if(f){const g=parseInt(f[1],16)/255,p=parseInt(f[2],16)/255,y=parseInt(f[3],16)/255;d=new this.Cesium.Color(g,p,y,1)}else d=this.Cesium.Color.fromCssColorString(h),d=d.withAlpha(1);const c=this.Cesium.Color.fromCssColorString(l),u=this.viewer.entities.add({position:this.Cesium.Cartesian3.fromDegrees(a,o,0),point:{pixelSize:r?15:10,color:d,outlineColor:c,outlineWidth:2,heightReference:this.Cesium.HeightReference.CLAMP_TO_GROUND},label:{text:s.label,font:"14px sans-serif",fillColor:this.Cesium.Color.WHITE,outlineColor:this.Cesium.Color.BLACK,outlineWidth:2,style:this.Cesium.LabelStyle.FILL_AND_OUTLINE,verticalOrigin:this.Cesium.VerticalOrigin.BOTTOM,pixelOffset:new this.Cesium.Cartesian2(0,-20),heightReference:this.Cesium.HeightReference.CLAMP_TO_GROUND,show:!1},nodeId:s.id});this.nodeEntities.set(s.id,u)}if(this.alwaysShowEdges)for(const s of this.edges){const o=n.get(s.src),a=n.get(s.dst);if(!o||!a)continue;const[r,h]=o,[l,d]=a,f=s.style?.color||"#999999",c=s.style?.weight||1,u=Math.max(1,Math.min(5,c)),g=this.viewer.entities.add({polyline:{positions:[this.Cesium.Cartesian3.fromDegrees(h,r,0),this.Cesium.Cartesian3.fromDegrees(d,l,0)],width:u,material:this.Cesium.Color.fromCssColorString(f),clampToGround:!0},edgeId:s.id});this.edgeEntities.set(s.id,g)}}switchTileType(){if(!(!this.viewer||!this.Cesium)&&this.customTileUrls.length>1){this.currentCustomTileIndex=(this.currentCustomTileIndex+1)%this.customTileUrls.length,this.setTileTypeInternal(!0),this.updateTileTypeButton();return}}setTileTypeInternal(e=!1){if(!this.viewer||!this.Cesium)return;const t=(r,h,l,d=!1)=>{const f=u=>String(u).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"),c=`<a href="${f(l)}" target="_blank" rel="noopener noreferrer">${f(h)}</a>`;return new r.Credit(c,d)};if(this.baseImageryLayer)try{this.viewer.imageryLayers.remove(this.baseImageryLayer)}catch{}if(this.customTileUrls.length>0){const r=this.customTileUrls[this.currentCustomTileIndex],h=r.url.includes("NaturalEarthII"),l=r.maximumLevel??(h?2:19);let d;if(r.credit){const u=r.credit;u.href?d=t(this.Cesium,u.label,u.href,u.showOnScreen??!1):d=new this.Cesium.Credit(u.label,u.showOnScreen??!1)}else d=new this.Cesium.Credit(`Custom tile server (${this.currentCustomTileIndex+1}/${this.customTileUrls.length})`);const f={url:r.url,maximumLevel:l,credit:d};h&&this.Cesium?.GeographicTilingScheme&&(f.tilingScheme=new this.Cesium.GeographicTilingScheme);const c=new this.Cesium.UrlTemplateImageryProvider(f);this.baseImageryLayer=this.viewer.imageryLayers.addImageryProvider(c,0),this.updateTileTypeButton();return}const n=new this.Cesium.Credit(" NASA",!0),s=new this.Cesium.GeographicTilingScheme({rectangle:this.Cesium.Rectangle.fromDegrees(-180,-90,180,90),numberOfLevelZeroTilesX:2,numberOfLevelZeroTilesY:1}),o="/cesium/Assets/Textures/NaturalEarthII/{z}/{x}/{reverseY}.jpg",a=new this.Cesium.UrlTemplateImageryProvider({url:o,maximumLevel:2,tilingScheme:s,credit:n,customTags:{reverseY:(r,h,l,d)=>{const c=Math.pow(2,d)-1-l;return String(c)}}});this.baseImageryLayer=this.viewer.imageryLayers.addImageryProvider(a,0),this.updateTileTypeButton()}updateTileTypeButton(){if(this.tileTypeButton){if(this.customTileUrls.length>1){this.tileTypeButton.style.display="flex";const e=this.currentCustomTileIndex+1,t=this.customTileUrls.length;this.tileTypeButton.setAttribute("title",`Custom tile ${e}/${t}`),this.tileTypeButton.style.backgroundColor="#fff",this.tileTypeButton.style.borderColor="#ccc",this.tileTypeButton.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)",this.tileTypeButton.style.transform="translateY(0)";return}if(this.customTileUrls.length>0){this.tileTypeButton.style.display="none";return}this.tileTypeButton.style.display="none"}}updateAlwaysShowEdgesButton(){this.alwaysShowEdgesButton&&(this.alwaysShowEdges?(this.alwaysShowEdgesButton.setAttribute("aria-label","Hide edges"),this.alwaysShowEdgesButton.setAttribute("title","Hide edges"),this.alwaysShowEdgesButton.style.backgroundColor="#fff9c4",this.alwaysShowEdgesButton.style.color="#000000",this.alwaysShowEdgesButton.style.borderColor="#999",this.alwaysShowEdgesButton.style.boxShadow="inset 0 2px 4px rgba(0, 0, 0, 0.2)",this.alwaysShowEdgesButton.style.transform="translateY(1px)"):(this.alwaysShowEdgesButton.setAttribute("aria-label","Show edges"),this.alwaysShowEdgesButton.setAttribute("title","Show edges"),this.alwaysShowEdgesButton.style.backgroundColor="#fff",this.alwaysShowEdgesButton.style.color="#000000",this.alwaysShowEdgesButton.style.borderColor="#ccc",this.alwaysShowEdgesButton.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)",this.alwaysShowEdgesButton.style.transform="translateY(0)"))}updateLightingButton(){if(!this.lightingToggleButton)return;const e=this.isLightingEnabled();this.lightingToggleButton.innerHTML=ta("icon-sun",16),e?(this.lightingToggleButton.style.backgroundColor="#fff9c4",this.lightingToggleButton.style.boxShadow="inset 0 2px 4px rgba(0, 0, 0, 0.2)",this.lightingToggleButton.style.transform="translateY(1px)"):(this.lightingToggleButton.style.backgroundColor="#fff",this.lightingToggleButton.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)",this.lightingToggleButton.style.transform="translateY(0)"),this.lightingToggleButton.style.color="#333"}fitAndCenter(){this.fitToNodes()}fitToNodes(){if(!this.viewer||!this.Cesium||this.nodes.length===0)return;const e=this.nodes.filter(_=>{if(!_.coordinates||!Array.isArray(_.coordinates)||_.coordinates.length!==2)return!1;const[C,E]=_.coordinates;return Number.isFinite(C)&&Number.isFinite(E)}),t=this.nodes.filter(_=>{if(!_.coordinates||!Array.isArray(_.coordinates)||_.coordinates.length!==2)return!0;const[C,E]=_.coordinates;return!Number.isFinite(C)||!Number.isFinite(E)}),n=[],s=[];if(e.forEach(_=>{if(_.coordinates&&_.coordinates.length===2){const[C,E]=_.coordinates;Number.isFinite(C)&&Number.isFinite(E)&&(n.push(C),s.push(E))}}),t.length>0){const B=Math.ceil(Math.sqrt(t.length)),T=50/(Math.ceil(t.length/B)+1),A=32/(B+1);t.forEach((L,S)=>{const k=Math.floor(S/B),N=S%B,P=-50+(k+1)*T,U=-32+(N+1)*A;n.push(P),s.push(U)})}if(n.length===0)return;const o=Math.min(...n),a=Math.max(...n),r=Math.min(...s),h=Math.max(...s),l=(o+a)/2,d=(r+h)/2,f=a-o,c=h-r,u=Math.max(f,c),g=Math.max(1e6,u*111e3*2),m=Math.max(5e5,Math.min(4e7,g)),w=()=>new Promise(_=>{if(!this.baseImageryLayer){_();return}if(this.baseImageryLayer.imageryProvider&&this.baseImageryLayer.imageryProvider.ready){_();return}const C=setTimeout(()=>{_()},2e3);this.baseImageryLayer.imageryProvider&&this.baseImageryLayer.imageryProvider.readyPromise?this.baseImageryLayer.imageryProvider.readyPromise.then(()=>{clearTimeout(C),_()}).catch(()=>{clearTimeout(C),_()}):(clearTimeout(C),_())}),b=this._setIsFlying;b&&b(!0),w().then(()=>{this.viewer.camera.flyTo({destination:this.Cesium.Cartesian3.fromDegrees(d,l,m),orientation:{heading:0,pitch:this.Cesium.Math.toRadians(-90),roll:0},duration:1,complete:()=>{b&&b(!1);const _=this.viewer.scene.camera,C=this.Cesium.Cartographic.fromCartesian(_.position),E=C.height,v=5e5,B=4e7;if(E<v||E>B){const x=Math.max(v,Math.min(B,E)),T=this.Cesium.Cartesian3.fromRadians(C.longitude,C.latitude,x);_.setView({destination:T,orientation:_.orientation})}}})})}show(){this.container.style.display="block",this.viewer?this.viewer.resize():this.cesiumLoader&&this.initializeCesium().catch(()=>{})}hide(){this.container.style.display="none"}resize(){this.viewer&&this.viewer.resize()}destroy(){if(this.hidePopup(),this.popupElement&&this.popupElement.parentNode&&(this.popupElement.parentNode.removeChild(this.popupElement),this.popupElement=null),this.viewer&&this._trackpadPinchHandlers){const e=this.viewer.canvas,t=this._trackpadPinchHandlers;t.wheel&&e.removeEventListener("wheel",t.wheel),"GestureEvent"in window&&(t.gestureStart&&e.removeEventListener("gesturestart",t.gestureStart),t.gestureChange&&e.removeEventListener("gesturechange",t.gestureChange),t.gestureEnd&&e.removeEventListener("gestureend",t.gestureEnd)),this._trackpadPinchHandlers=null}this.viewer&&(this.viewer.destroy(),this.viewer=null),this.nodeEntities.clear(),this.edgeEntities.clear()}createPopup(){const e=document.createElement("div");e.className="relatos-globe3d-popup",e.style.cssText=`
      position: absolute;
      background: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 8px 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      pointer-events: none;
      z-index: 10000;
      font-size: 14px;
      line-height: 1.4;
      max-width: 200px;
      word-wrap: break-word;
      overflow-wrap: break-word;
      white-space: normal;
      opacity: 0;
      transition: opacity 0.2s;
    `;const t=document.createElement("div");return t.style.cssText=`
      position: absolute;
      bottom: -8px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 8px solid transparent;
      border-right: 8px solid transparent;
      border-top: 8px solid white;
    `,e.appendChild(t),this.container.appendChild(e),e}showPopup(e,t){if(!(!this.viewer||!this.Cesium||!e)&&(this.hidePopup(),this.popupElement||(this.popupElement=this.createPopup()),this.popupElement.textContent=t.label,this.popupElement.style.opacity="1",this.popupEntity=e,this.updatePopupPosition(),!this.popupUpdateListener)){const n=()=>{this.popupEntity&&this.popupElement&&this.updatePopupPosition()};this.viewer.scene.postRender.addEventListener(n),this.popupUpdateListener=()=>{this.viewer?.scene.postRender.removeEventListener(n)}}}hidePopup(){this.popupElement&&(this.popupElement.style.opacity="0",setTimeout(()=>{this.popupElement&&this.popupElement.style.opacity==="0"&&(this.popupElement.style.display="none")},200)),this.popupEntity=null,this.popupUpdateListener&&(this.popupUpdateListener(),this.popupUpdateListener=null)}updatePopupPosition(){if(!this.viewer||!this.Cesium||!this.popupEntity||!this.popupElement)return;const e=this.popupEntity.position?.getValue(this.viewer.clock.currentTime);if(!e)return;let t=null;if(this.Cesium.SceneTransforms?.worldToWindowCoordinates?t=this.Cesium.SceneTransforms.worldToWindowCoordinates(this.viewer.scene,e):this.Cesium.SceneTransforms?.wgs84ToWindowCoordinates?t=this.Cesium.SceneTransforms.wgs84ToWindowCoordinates(this.viewer.scene,e):t=this.viewer.camera.project(e),!t){this.popupElement.style.display="none";return}let n=1;const s=this.container.getBoundingClientRect(),o=this.container.offsetWidth;o>0&&s.width>0&&(n=s.width/o);const a=t.x/n,r=t.y/n;this.popupElement.style.display="block";const h=a-this.popupElement.offsetWidth/2,l=r-this.popupElement.offsetHeight-15;this.popupElement.style.left=`${h}px`,this.popupElement.style.top=`${l}px`}isEditable(){return!1}}function ia(i,e=16){return St(),`<svg width="${e}" height="${e}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <use href="#${i}"></use>
  </svg>`}class na{constructor(e,t,n,s,o,a){this.map=null,this.Leaflet=null,this.nodes=[],this.edges=[],this.selectedNodeId=null,this.lastSelectedNodeId=null,this.markers=new Map,this.polylines=new Map,this.rectLayer=null,this.fitCenterButton=null,this.lightingToggleButton=null,this.alwaysShowEdgesButton=null,this.alwaysShowEdges=!0,this.tileTypeButton=null,this.baseTileLayer=null,this.nightShadeLayer=null,this.nightShadeDebugLayer=null,this.lightingEnabled=!1,this.timeISO=null,this.moonToggleButton=null,this.moonEnabled=!1,this.moonMarker=null,this.customTileUrls=[],this.currentCustomTileIndex=0,this.container=e,this.onNodeClick=t,this.leafletLoader=n,this.map2dOptions=o,this.onEdgeClick=a;const r=s&&s.length>0?s:o?.customTileUrls;r&&r.length>0?this.customTileUrls=r.map(h=>typeof h=="string"?{url:h}:h):o?.customTileUrl&&(this.customTileUrls=[{url:o.customTileUrl}]),this.container.style.position="relative",this.container.style.width="100%",this.container.style.height="100%"}async initializeLeaflet(){if(this.map)return;if(!this.leafletLoader)throw new Error("Leaflet loader is not provided. Please provide options.loaders.leaflet.");const e=await this.leafletLoader();this.Leaflet=e.default||e;const t=this.map2dOptions?.center||[0,0],n=this.map2dOptions?.zoom||2;let s=5;if(this.customTileUrls.length>0){const a=this.customTileUrls.map(r=>r.maxZoom??r.maximumLevel??19);s=Math.min(...a)}const o={center:t,zoom:n,zoomControl:!1,attributionControl:!0,maxZoom:s};this.customTileUrls.length===0&&(o.crs=this.Leaflet.CRS.EPSG4326),this.map=this.Leaflet.map(this.container,o),this.setupBaseTileLayer(),this.setupTimeAndLighting(),this.lightingEnabled&&this.updateNightShade(),this.moonEnabled&&this.updateMoonMarker(),this.setupClickHandler(),(this.nodes.length>0||this.edges.length>0)&&this.render()}setupBaseTileLayer(){if(!this.map||!this.Leaflet)return;this.baseTileLayer&&this.map.removeLayer(this.baseTileLayer);let e;if(this.customTileUrls.length>0){const s=this.customTileUrls[this.currentCustomTileIndex],o=s.maxZoom??s.maximumLevel??19,a=s.tms??!1,r=s.attribution??`Custom tile server (${this.currentCustomTileIndex+1}/${this.customTileUrls.length})`;e=this.Leaflet.tileLayer(s.url,{maxZoom:o,tms:a,attribution:r}),e.addTo(this.map),this.baseTileLayer=e;return}const t="/cesium/Assets/Textures/NaturalEarthII/{z}/{x}/{y}.jpg",n=this.Leaflet.latLngBounds([[-90,-180],[90,180]]);e=this.Leaflet.tileLayer(t,{minZoom:0,maxNativeZoom:2,tms:!0,bounds:n,noWrap:!0,continuousWorld:!1,attribution:" NASA"}),e.addTo(this.map),this.baseTileLayer=e}setupTimeAndLighting(){!this.map||this.Leaflet}setTime(e){this.timeISO=e,this.lightingEnabled&&this.updateNightShade(),this.updateMoonButton(),this.moonEnabled&&this.updateMoonMarker()}setLighting(e){if(this.lightingEnabled!==e){if(this.lightingEnabled=e,!this.map||!this.Leaflet){this.updateLightingButton();return}e?this.updateNightShade():(this.nightShadeLayer&&(this.map.removeLayer(this.nightShadeLayer),this.nightShadeLayer=null),this.nightShadeDebugLayer&&(this.map.removeLayer(this.nightShadeDebugLayer),this.nightShadeDebugLayer=null)),this.updateLightingButton()}}isLightingEnabled(){return this.lightingEnabled}getAlwaysShowEdges(){return this.alwaysShowEdges}setAlwaysShowEdges(e){this.alwaysShowEdges!==e&&(this.alwaysShowEdges=e,this.updateAlwaysShowEdgesButton(),this.renderWithoutFit())}getLightingEnabled(){return this.isLightingEnabled()}setLightingEnabled(e,t=!0){const n=this.lightingEnabled;this.setLighting(e),t&&this.onLightingChange&&this.lightingEnabled!==n&&this.onLightingChange(this.lightingEnabled)}setAlwaysShowEdgesChangeCallback(e){this.onAlwaysShowEdgesChange=e}setLightingChangeCallback(e){this.onLightingChange=e}getTileServerCount(){return this.customTileUrls.length}getTileServerIndex(){return this.currentCustomTileIndex}setTileServerIndex(e){if(this.customTileUrls.length===0)return;const t=this.customTileUrls.length,n=(e%t+t)%t;this.currentCustomTileIndex!==n&&(this.currentCustomTileIndex=n,this.map&&this.Leaflet&&(this.setupBaseTileLayer(),this.updateTileTypeButton()))}cycleTileServer(){this.switchTileType()}updateNightShade(){if(!this.map||!this.Leaflet||(this.nightShadeLayer&&(this.map.removeLayer(this.nightShadeLayer),this.nightShadeLayer=null),this.nightShadeDebugLayer&&(this.map.removeLayer(this.nightShadeDebugLayer),this.nightShadeDebugLayer=null),!this.lightingEnabled))return;const e=this.timeISO||new Date().toISOString(),s=this.calculateTerminatorBoundary(e,720,2);if(!s||s.length===0)return;const o=this.unwrapLongitudes(s);let a=o.map(u=>[u.lat,u.lng]);a.length>0&&(a[0][0]!==a[a.length-1][0]||a[0][1]!==a[a.length-1][1])&&a.push([a[0][0],a[0][1]]);const r=a.map(([u,g])=>({lat:u,lng:g}));this.isCounterClockwise(r)&&a.reverse();const l=a.map(([u,g])=>({lat:u,lng:g}));if(this.isCounterClockwise(l)){a.reverse();const u=a.map(([g,p])=>({lat:g,lng:p}));this.isCounterClockwise(u)}const f=o.map(u=>[u.lat,u.lng]);f.length>0&&(f[0][0]!==f[f.length-1][0]||f[0][1]!==f[f.length-1][1])&&f.push([f[0][0],f[0][1]]);const c=this.Leaflet.polygon(f,{fillColor:"#000000",fillOpacity:.3,color:"#000000",weight:0,interactive:!1});if(c.addTo(this.map),this.nightShadeLayer=c,this.map2dOptions?.debugNightShading){const u=this.Leaflet.polyline(a,{color:"#ff0000",weight:2,opacity:.8,interactive:!1});u.addTo(this.map),this.nightShadeDebugLayer=u}}isCounterClockwise(e){if(e.length<3)return!1;let t=0;for(let n=0;n<e.length-1;n++){const s=e[n],o=e[n+1];t+=(o.lng-s.lng)*(o.lat+s.lat)}return t>0}unwrapLongitudes(e){if(e.length===0)return e;const t=[{...e[0]}];for(let n=1;n<e.length;n++){let{lat:s,lng:o}=e[n];const a=t[n-1].lng;for(;o-a>180;)o-=360;for(;o-a<-180;)o+=360;t.push({lat:s,lng:o})}return t}julian(e){return e.getTime()/864e5+24405875e-1}GMST(e){return(18.697374558+24.06570982441908*(e-2451545))%24}sunEclipticPosition(e){const t=e-2451545;let n=280.46+.9856474*t;n=(n%360+360)%360;let s=357.528+.9856003*t;s=(s%360+360)%360;const o=Math.PI/180,a=n+1.915*Math.sin(s*o)+.02*Math.sin(2*s*o),r=1.00014-.01671*Math.cos(s*o)-.0014*Math.cos(2*s*o);return{lambda:a,R:r}}eclipticObliquity(e){const n=(e-2451545)/36525;return 23.43929111-n*(46.836769/3600-n*(1831e-7/3600+n*(.0020034/3600-n*(576e-9/3600-n*434e-10/3600))))}sunEquatorialPosition(e,t){const n=Math.PI/180,s=180/Math.PI,o=Math.atan(Math.cos(t*n)*Math.tan(e*n))*s,a=Math.asin(Math.sin(t*n)*Math.sin(e*n))*s,r=Math.floor(e/90)*90,h=Math.floor(o/90)*90;return{alpha:o+(r-h),delta:a}}hourAngle(e,t,n){return(n+e/15)*15-t.alpha}terminatorLatitude(e,t){const n=Math.PI/180,s=180/Math.PI;return Math.atan(-Math.cos(e*n)/Math.tan(t.delta*n))*s}calculateTerminatorBoundary(e,t=720,n=2){try{let s;if(e.startsWith("-")){if(s=new Date(e),isNaN(s.getTime()))return null}else if(s=new Date(e),isNaN(s.getTime()))return null;const o=this.julian(s),a=this.GMST(o),r=this.sunEclipticPosition(o),h=this.eclipticObliquity(o),l=this.sunEquatorialPosition(r.lambda,h),d=[];for(let f=0;f<=t*n;f++){const c=-t/2+f/n,u=this.hourAngle(c,l,a),g=this.terminatorLatitude(u,l);d.push({lat:g,lng:c})}return l.delta<0?(d.unshift({lat:90,lng:-t/2}),d.push({lat:90,lng:t/2})):(d.unshift({lat:-90,lng:-t/2}),d.push({lat:-90,lng:t/2})),d.length>0?d:null}catch{return null}}getDayOfYear(e){const t=new Date(e.getFullYear(),0,0),n=e.getTime()-t.getTime(),s=1e3*60*60*24;return Math.floor(n/s)}calculateSolarDeclination(e){return 23.45*Math.PI/180*Math.sin(2*Math.PI*(284+e)/365)*180/Math.PI}setupClickHandler(){!this.map||!this.Leaflet||this.map.on("click",e=>{})}setData(e,t){this.nodes=e,this.edges=t,this.map&&this.Leaflet&&this.render()}selectNode(e){if(!e){this.selectedNodeId=null,this.lastSelectedNodeId=null,this.renderWithoutFit();return}if(!this.map||!this.Leaflet)return;if(e===this.lastSelectedNodeId){this.lastSelectedNodeId=null,this.fitToNodes();return}this.lastSelectedNodeId=e,this.selectedNodeId=e;const t=this.nodes.find(s=>s.id===e);if(!t)return;if(t.coordinates&&t.coordinates.length===2){const[s,o]=t.coordinates;if(Number.isFinite(s)&&Number.isFinite(o)){const[a,r]=t.coordinates;this.renderWithoutFit(),this.map.flyTo([a,r],4,{duration:1,easeLinearity:.25});const h=()=>{const l=this.markers.get(e);l&&l.openPopup(),this.map.off("moveend",h)};this.map.once("moveend",h);return}}const n=this.nodes.filter(s=>{if(!s.coordinates||!Array.isArray(s.coordinates)||s.coordinates.length!==2)return!0;const[o,a]=s.coordinates;return!Number.isFinite(o)||!Number.isFinite(a)});if(n.length>0){const h=Math.ceil(Math.sqrt(n.length)),d=50/(Math.ceil(n.length/h)+1),f=32/(h+1),c=n.findIndex(u=>u.id===e);if(c>=0){const u=Math.floor(c/h),g=c%h,p=-50+(u+1)*d,y=-32+(g+1)*f;this.renderWithoutFit(),this.map.flyTo([p,y],4,{duration:1,easeLinearity:.25});const m=()=>{const w=this.markers.get(e);w&&w.openPopup(),this.map.off("moveend",m)};this.map.once("moveend",m)}}else this.renderWithoutFit()}render(){if(!this.map||!this.Leaflet)return;this.markers.forEach(o=>{this.map.removeLayer(o)}),this.markers.clear(),Array.from(this.polylines.keys()).forEach(o=>{const a=this.polylines.get(o);if(a&&this.map)try{this.map.hasLayer(a)&&this.map.removeLayer(a)}catch{}this.polylines.delete(o)}),this.polylines.clear();const t=this.nodes.filter(o=>{if(!o.coordinates||!Array.isArray(o.coordinates)||o.coordinates.length!==2)return!0;const[a,r]=o.coordinates;return!Number.isFinite(a)||!Number.isFinite(r)}),n=this.nodes.filter(o=>{if(!o.coordinates||!Array.isArray(o.coordinates)||o.coordinates.length!==2)return!1;const[a,r]=o.coordinates;return Number.isFinite(a)&&Number.isFinite(r)}),s=new Map;if(t.length>0){const l=this.Leaflet.latLngBounds([-50,-32],[0,0]);this.rectLayer=this.Leaflet.rectangle(l,{color:"#666",fillColor:"#f0f0f0",fillOpacity:.1,weight:1,dashArray:"5,5"}),this.rectLayer.addTo(this.map);const d=Math.ceil(Math.sqrt(t.length)),c=50/(Math.ceil(t.length/d)+1),u=32/(d+1);t.forEach((g,p)=>{const y=Math.floor(p/d),m=p%d,w=-50+(y+1)*c,b=-32+(m+1)*u;s.set(g.id,[w,b]);const _=this.selectedNodeId===g.id,C=g.style?.color||"#ffffff",E=_?"#2196f3":g.style?.borderColor||"#333333",v=`
          <div style="
            width: ${_?15:10}px;
            height: ${_?15:10}px;
            background-color: ${C};
            border: 2px solid ${E};
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
          "></div>
        `,B=this.Leaflet.divIcon({html:v,className:"relatos-node-marker",iconSize:[_?15:10,_?15:10],iconAnchor:[_?7.5:5,_?7.5:5]}),x=this.Leaflet.marker([w,b],{icon:B});x.bindPopup(g.label,{closeButton:!1,offset:[0,-10]}),x.on("click",T=>{if(this.onNodeClick){const A=T.latlng;this.onNodeClick({node:g,position:{x:A.lng,y:A.lat},originalEvent:T.originalEvent})}}),x.addTo(this.map),this.markers.set(g.id,x)})}for(const o of n){const[a,r]=o.coordinates;s.set(o.id,[a,r]);const h=this.selectedNodeId===o.id,l=o.style?.color||"#ffffff",d=h?"#2196f3":o.style?.borderColor||"#333333",f=`
        <div style="
          width: ${h?15:10}px;
          height: ${h?15:10}px;
          background-color: ${l};
          border: 2px solid ${d};
          border-radius: 50%;
          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        "></div>
      `,c=this.Leaflet.divIcon({html:f,className:"relatos-node-marker",iconSize:[h?15:10,h?15:10],iconAnchor:[h?7.5:5,h?7.5:5]}),u=this.Leaflet.marker([a,r],{icon:c});u.bindPopup(o.label,{closeButton:!1,offset:[0,-10]}),u.on("click",g=>{if(this.onNodeClick){const p=g.latlng;this.onNodeClick({node:o,position:{x:p.lng,y:p.lat},originalEvent:g.originalEvent,view:"map2d"})}}),u.addTo(this.map),this.markers.set(o.id,u)}if(this.alwaysShowEdges)for(const o of this.edges){const a=s.get(o.src),r=s.get(o.dst);if(!a||!r)continue;const[h,l]=a,[d,f]=r,c=o.style?.color||"#999999",u=o.style?.weight||1,g=Math.max(1,Math.min(5,u)),p=this.Leaflet.polyline([[h,l],[d,f]],{color:c,weight:g,opacity:.7});p.on("click",m=>{if(this.onEdgeClick){const w=m.latlng;this.onEdgeClick({edge:o,position:{x:w.lng,y:w.lat},originalEvent:m.originalEvent,view:"map2d"})}});const y=this.polylines.get(o.id);if(y&&this.map)try{this.map.hasLayer(y)&&this.map.removeLayer(y)}catch{}p.addTo(this.map),this.polylines.set(o.id,p)}this.fitToNodes()}renderWithoutFit(){if(!this.map||!this.Leaflet)return;this.markers.forEach(o=>{this.map.removeLayer(o)}),this.markers.clear(),Array.from(this.polylines.keys()).forEach(o=>{const a=this.polylines.get(o);if(a&&this.map)try{this.map.hasLayer(a)&&this.map.removeLayer(a)}catch{}this.polylines.delete(o)}),this.polylines.clear(),this.rectLayer&&(this.map.removeLayer(this.rectLayer),this.rectLayer=null);const t=this.nodes.filter(o=>{if(!o.coordinates||!Array.isArray(o.coordinates)||o.coordinates.length!==2)return!0;const[a,r]=o.coordinates;return!Number.isFinite(a)||!Number.isFinite(r)}),n=this.nodes.filter(o=>{if(!o.coordinates||!Array.isArray(o.coordinates)||o.coordinates.length!==2)return!1;const[a,r]=o.coordinates;return Number.isFinite(a)&&Number.isFinite(r)}),s=new Map;if(t.length>0){const l=this.Leaflet.latLngBounds([-50,-32],[0,0]);this.rectLayer=this.Leaflet.rectangle(l,{color:"#666",fillColor:"#f0f0f0",fillOpacity:.1,weight:1,dashArray:"5,5"}),this.rectLayer.addTo(this.map);const d=Math.ceil(Math.sqrt(t.length)),c=50/(Math.ceil(t.length/d)+1),u=32/(d+1);t.forEach((g,p)=>{const y=Math.floor(p/d),m=p%d,w=-50+(y+1)*c,b=-32+(m+1)*u;s.set(g.id,[w,b]);const _=this.selectedNodeId===g.id,C=g.style?.color||"#ffffff",E=_?"#2196f3":g.style?.borderColor||"#333333",v=`
          <div style="
            width: ${_?15:10}px;
            height: ${_?15:10}px;
            background-color: ${C};
            border: 2px solid ${E};
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
          "></div>
        `,B=this.Leaflet.divIcon({html:v,className:"relatos-node-marker",iconSize:[_?15:10,_?15:10],iconAnchor:[_?7.5:5,_?7.5:5]}),x=this.Leaflet.marker([w,b],{icon:B});x.bindPopup(g.label,{closeButton:!1,offset:[0,-10]}),x.on("click",T=>{if(this.onNodeClick){const A=T.latlng;this.onNodeClick({node:g,position:{x:A.lng,y:A.lat},originalEvent:T.originalEvent,view:"map2d"})}}),x.addTo(this.map),this.markers.set(g.id,x)})}for(const o of n){const[a,r]=o.coordinates;s.set(o.id,[a,r]);const h=this.selectedNodeId===o.id,l=o.style?.color||"#ffffff",d=h?"#2196f3":o.style?.borderColor||"#333333",f=`
        <div style="
          width: ${h?15:10}px;
          height: ${h?15:10}px;
          background-color: ${l};
          border: 2px solid ${d};
          border-radius: 50%;
          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        "></div>
      `,c=this.Leaflet.divIcon({html:f,className:"relatos-node-marker",iconSize:[h?15:10,h?15:10],iconAnchor:[h?7.5:5,h?7.5:5]}),u=this.Leaflet.marker([a,r],{icon:c});u.bindPopup(o.label,{closeButton:!1,offset:[0,-10]}),u.on("click",g=>{if(this.onNodeClick){const p=g.latlng;this.onNodeClick({node:o,position:{x:p.lng,y:p.lat},originalEvent:g.originalEvent})}}),u.addTo(this.map),this.markers.set(o.id,u)}if(this.alwaysShowEdges)for(const o of this.edges){const a=s.get(o.src),r=s.get(o.dst);if(!a||!r)continue;const[h,l]=a,[d,f]=r,c=o.style?.color||"#999999",u=o.style?.weight||1,g=Math.max(1,Math.min(5,u)),p=this.Leaflet.polyline([[h,l],[d,f]],{color:c,weight:g,opacity:.7});p.on("click",m=>{if(this.onEdgeClick){const w=m.latlng;this.onEdgeClick({edge:o,position:{x:w.lng,y:w.lat},originalEvent:m.originalEvent,view:"map2d"})}});const y=this.polylines.get(o.id);if(y&&this.map)try{this.map.hasLayer(y)&&this.map.removeLayer(y)}catch{}p.addTo(this.map),this.polylines.set(o.id,p)}}switchTileType(){if(this.customTileUrls.length>1){this.currentCustomTileIndex=(this.currentCustomTileIndex+1)%this.customTileUrls.length,this.setupBaseTileLayer(),this.updateTileTypeButton();return}}updateTileTypeButton(){if(this.tileTypeButton){if(this.customTileUrls.length>1){this.tileTypeButton.style.display="flex";const e=this.currentCustomTileIndex+1,t=this.customTileUrls.length;this.tileTypeButton.setAttribute("title",`Custom tile ${e}/${t}`),this.tileTypeButton.style.backgroundColor="#fff",this.tileTypeButton.style.borderColor="#ccc",this.tileTypeButton.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)",this.tileTypeButton.style.transform="translateY(0)";return}if(this.customTileUrls.length>0){this.tileTypeButton.style.display="none";return}this.tileTypeButton.style.display="none"}}updateAlwaysShowEdgesButton(){this.alwaysShowEdgesButton&&(this.alwaysShowEdges?(this.alwaysShowEdgesButton.setAttribute("aria-label","Hide edges"),this.alwaysShowEdgesButton.setAttribute("title","Hide edges"),this.alwaysShowEdgesButton.style.backgroundColor="#fff9c4",this.alwaysShowEdgesButton.style.color="#000000",this.alwaysShowEdgesButton.style.borderColor="#999",this.alwaysShowEdgesButton.style.boxShadow="inset 0 2px 4px rgba(0, 0, 0, 0.2)",this.alwaysShowEdgesButton.style.transform="translateY(1px)"):(this.alwaysShowEdgesButton.setAttribute("aria-label","Show edges"),this.alwaysShowEdgesButton.setAttribute("title","Show edges"),this.alwaysShowEdgesButton.style.backgroundColor="#fff",this.alwaysShowEdgesButton.style.color="#000000",this.alwaysShowEdgesButton.style.borderColor="#ccc",this.alwaysShowEdgesButton.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)",this.alwaysShowEdgesButton.style.transform="translateY(0)"))}getMoonIllumination(e){const n=this.julian(e)-2451545,s=(357.5291+.98560028*n)*Math.PI/180,o=(1.9148*Math.sin(s)+.02*Math.sin(2*s)+3e-4*Math.sin(3*s))*Math.PI/180,a=102.9372*Math.PI/180,r=s+o+a+Math.PI,h=23.4397*Math.PI/180,l=Math.atan2(Math.sin(r)*Math.cos(h)-Math.tan(0)*Math.sin(h),Math.cos(r)),d=Math.asin(Math.sin(0)*Math.cos(h)+Math.cos(0)*Math.sin(h)*Math.sin(r)),f=(218.316+13.176396*n)*Math.PI/180,c=(134.963+13.064993*n)*Math.PI/180,u=(93.272+13.22935*n)*Math.PI/180,g=f+6.289*Math.sin(c)*Math.PI/180,p=5.128*Math.sin(u)*Math.PI/180,y=Math.atan2(Math.sin(g)*Math.cos(h)-Math.tan(p)*Math.sin(h),Math.cos(g)),m=Math.asin(Math.sin(p)*Math.cos(h)+Math.cos(p)*Math.sin(h)*Math.sin(g)),w=385001-20905*Math.cos(c),b=149598e3,_=Math.acos(Math.sin(d)*Math.sin(m)+Math.cos(d)*Math.cos(m)*Math.cos(l-y)),C=Math.atan2(b*Math.sin(_),w-b*Math.cos(_)),E=Math.atan2(Math.cos(d)*Math.sin(l-y),Math.sin(d)*Math.cos(m)-Math.cos(d)*Math.sin(m)*Math.cos(l-y));return{fraction:(1+Math.cos(C))/2,phase:.5+.5*C*(E<0?-1:1)/Math.PI,angle:E}}getMoonPhase(e){const n=this.getMoonIllumination(e).phase;return Math.floor(n*8)%8}getMoonPhaseIcon(e,t=16){const s=["","","","","","","",""][e]||"";return`<span style="font-size: ${t}px; line-height: 1;">${s}</span>`}calculateMoonPosition(e,t,n){try{const s=this.julian(e),o=s-2451545,a=(218.316+13.176396*o)*Math.PI/180,r=(134.963+13.064993*o)*Math.PI/180,h=(93.272+13.22935*o)*Math.PI/180,l=a+6.289*Math.sin(r)*Math.PI/180,d=5.128*Math.sin(h)*Math.PI/180,f=23.4397*Math.PI/180,c=Math.atan2(Math.sin(l)*Math.cos(f)-Math.tan(d)*Math.sin(f),Math.cos(l)),u=Math.asin(Math.sin(d)*Math.cos(f)+Math.cos(d)*Math.sin(f)*Math.sin(l)),p=this.GMST(s)*Math.PI/12,y=u;let m=c-p;const w=y*180/Math.PI;let b=m*180/Math.PI;return b=b%360,b>180?b-=360:b<-180&&(b+=360),[w,b]}catch{return null}}updateMoonMarker(){if(!this.map||!this.Leaflet||(this.moonMarker&&(this.map.removeLayer(this.moonMarker),this.moonMarker=null),!this.moonEnabled))return;const e=this.timeISO?new Date(this.timeISO):new Date;let t=this.calculateMoonPosition(e,0,0);if(!t)return;const n=this.getMoonPhase(e),s=this.getMoonPhaseIcon(n,24),o=this.Leaflet.divIcon({html:s,className:"relatos-moon-marker",iconSize:[32,32],iconAnchor:[16,16]});this.moonMarker=this.Leaflet.marker([t[0],t[1]],{icon:o}),this.moonMarker.addTo(this.map)}createMoonToggleButton(){this.moonToggleButton=document.createElement("button"),this.moonToggleButton.setAttribute("aria-label","Toggle moon"),this.moonToggleButton.setAttribute("title","Toggle moon"),this.moonToggleButton.style.padding="6px",this.moonToggleButton.style.border="1px solid #ccc",this.moonToggleButton.style.borderRadius="4px",this.moonToggleButton.style.backgroundColor="#fff",this.moonToggleButton.style.cursor="pointer",this.moonToggleButton.style.fontSize="16px",this.moonToggleButton.style.width="32px",this.moonToggleButton.style.height="32px",this.moonToggleButton.style.display="flex",this.moonToggleButton.style.alignItems="center",this.moonToggleButton.style.justifyContent="center",this.moonToggleButton.style.pointerEvents="auto",this.moonToggleButton.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)",this.moonToggleButton.style.transition="0.2s",this.moonToggleButton.addEventListener("click",()=>{this.moonEnabled=!this.moonEnabled,this.updateMoonButton(),this.updateMoonMarker()})}isMoonEnabled(){return this.moonEnabled}toggleMoon(){this.moonEnabled=!this.moonEnabled,this.updateMoonMarker()}getTime(){return this.timeISO}updateMoonButton(){}updateLightingButton(){if(!this.lightingToggleButton)return;const e=this.isLightingEnabled();this.lightingToggleButton.innerHTML=ia("icon-sun",16),e?(this.lightingToggleButton.style.backgroundColor="#fff9c4",this.lightingToggleButton.style.boxShadow="inset 0 2px 4px rgba(0, 0, 0, 0.2)",this.lightingToggleButton.style.transform="translateY(1px)"):(this.lightingToggleButton.style.backgroundColor="#fff",this.lightingToggleButton.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)",this.lightingToggleButton.style.transform="translateY(0)"),this.lightingToggleButton.style.color="#333"}fitAndCenter(){this.fitToNodes()}fitToNodes(){if(!this.map||!this.Leaflet||this.nodes.length===0)return;const e=this.nodes.filter(d=>{if(!d.coordinates||!Array.isArray(d.coordinates)||d.coordinates.length!==2)return!1;const[f,c]=d.coordinates;return Number.isFinite(f)&&Number.isFinite(c)}),t=this.nodes.filter(d=>{if(!d.coordinates||!Array.isArray(d.coordinates)||d.coordinates.length!==2)return!0;const[f,c]=d.coordinates;return!Number.isFinite(f)||!Number.isFinite(c)}),n=[],s=[];if(e.forEach(d=>{if(d.coordinates&&d.coordinates.length===2){const[f,c]=d.coordinates;Number.isFinite(f)&&Number.isFinite(c)&&(n.push(f),s.push(c))}}),t.length>0){const g=Math.ceil(Math.sqrt(t.length)),y=50/(Math.ceil(t.length/g)+1),m=32/(g+1);t.forEach((w,b)=>{const _=Math.floor(b/g),C=b%g,E=-50+(_+1)*y,v=-32+(C+1)*m;n.push(E),s.push(v)})}if(n.length===0)return;const o=Math.min(...n),a=Math.max(...n),r=Math.min(...s),h=Math.max(...s),l=this.Leaflet.latLngBounds([o,r],[a,h]);this.map.flyToBounds(l,{padding:[20,20],maxZoom:5,duration:1,easeLinearity:.25})}show(){this.container.style.display="block",this.map?this.map.invalidateSize():this.leafletLoader&&this.initializeLeaflet().catch(()=>{})}hide(){this.container.style.display="none"}resize(){this.map&&this.map.invalidateSize()}destroy(){this.map&&(this.map.remove(),this.map=null),this.markers.clear(),this.polylines.clear()}isEditable(){return!1}}const sa=120,oa=60,ra=30,aa=50,la=25;function ae(i){const e=i.style||{};return{width:e.width??sa,height:e.height??oa}}function On(i,e){if(!i.position||!e.position)return{side:"right",t:.5};const{width:t,height:n}=ae(i),s=e.position.x-i.position.x,o=e.position.y-i.position.y,a=Math.atan2(o,s),r=a<0?a+2*Math.PI:a;let h,l;return r>=7*Math.PI/4||r<Math.PI/4?(h="right",l=.5+o/n*.5):r>=Math.PI/4&&r<3*Math.PI/4?(h="bottom",l=.5+s/t*.5):r>=3*Math.PI/4&&r<5*Math.PI/4?(h="left",l=.5-o/n*.5):(h="top",l=.5-s/t*.5),l=Math.max(0,Math.min(1,l)),{side:h,t:l}}function Hn(i,e,t,n){if(!i.position)return{x:0,y:0};const s=i.position.x,o=i.position.y;let a,r;switch(e.side){case"top":a=s-t/2+t*e.t,r=o-n/2;break;case"right":a=s+t/2,r=o-n/2+n*e.t;break;case"bottom":a=s-t/2+t*e.t,r=o+n/2;break;case"left":a=s-t/2,r=o-n/2+n*e.t;break;default:a=s,r=o}return{x:a,y:r}}function ha(i,e){const t=e.find(f=>f.id===i.src),n=e.find(f=>f.id===i.dst);if(!t?.position||!n?.position)return[];const s=i.srcAnchor??On(t,n),o=i.dstAnchor??On(n,t),a=ae(t),r=ae(n),h=Hn(t,s,a.width,a.height),l=Hn(n,o,r.width,r.height),d=[h];return i.bends?.length&&d.push(...i.bends),d.push(l),d}function da(i,e,t,n){const s=t.some(u=>u.parentId===i.id),o=new Set;if(s){const u=t.filter(p=>p.parentId===i.id),g=p=>{p.nodeIds.forEach(y=>o.add(y)),t.filter(y=>y.parentId===p.id).forEach(g)};u.forEach(g)}let a=1/0,r=-1/0,h=1/0,l=-1/0,d=!1;for(const u of i.nodeIds){if(s&&o.has(u))continue;const g=e.find(b=>b.id===u);if(!g?.position)continue;d=!0;const{width:p,height:y}=ae(g),m=g.position.x-p/2,w=g.position.y-y/2;a=Math.min(a,m),r=Math.max(r,m+p),h=Math.min(h,w),l=Math.max(l,w+y)}if(s){const u=t.filter(g=>g.parentId===i.id);for(const g of u){const p=n(g);p&&(d=!0,a=Math.min(a,p.position.x),r=Math.max(r,p.position.x+p.size.width),h=Math.min(h,p.position.y),l=Math.max(l,p.position.y+p.size.height))}}if(!d)return null;const f=s?aa:ra,c=f+la;return{minX:a-f,maxX:r+f,minY:h-c,maxY:l+f}}function Gn(i,e,t,n){if(i.layout)return i.layout;const s=da(i,e,t,o=>Gn(o,e,t));return s?{position:{x:s.minX,y:s.minY},size:{width:s.maxX-s.minX,height:s.maxY-s.minY}}:null}function Un(i,e,t=[]){const n=i,s=e,o=[];let a=1/0,r=-1/0,h=1/0,l=-1/0;for(const g of n){if(!g.position)continue;const{width:p,height:y}=ae(g),m=g.position.x-p/2,w=g.position.y-y/2,b=g.style||{};o.push({id:g.id,label:g.label,left:m,top:w,width:p,height:y,fillColor:b.color,strokeColor:b.borderColor,type:g.type}),a=Math.min(a,m),r=Math.max(r,m+p),h=Math.min(h,w),l=Math.max(l,w+y)}const d=g=>Gn(g,n,t),f=[];for(const g of t){const p=d(g);p&&(f.push({id:g.id,label:g.label,left:p.position.x,top:p.position.y,width:p.size.width,height:p.size.height,nodeIds:[...g.nodeIds],childGroupIds:t.filter(y=>y.parentId===g.id).map(y=>y.id)||void 0}),a=Math.min(a,p.position.x),r=Math.max(r,p.position.x+p.size.width),h=Math.min(h,p.position.y),l=Math.max(l,p.position.y+p.size.height))}const c=[];for(const g of s){const p=ha(g,n);if(p.length<2)continue;const y=g.style||{};c.push({id:g.id,srcId:g.src,dstId:g.dst,points:p,label:y.label??g.relType,srcLabel:y.srcLabel,dstLabel:y.dstLabel,color:y.color,weight:y.weight})}const u=o.length>0||f.length>0?{left:a,top:h,width:r-a,height:l-h}:void 0;return{nodes:o,edges:c,groups:f,bounds:u}}function ca(i,e={}){St();let t;if(typeof i=="string"){const c=document.querySelector(i);if(!c||!(c instanceof HTMLElement))throw new Error(`Container element not found: ${i}`);t=c}else t=i;const n=e.enabledViews||["graph","map2d","globe3d"],s=e.initialView||(n.includes("map2d")?"map2d":n[0]),o=e.graph?.mode||"view",a=e.graph?.editable||!1,r=e.tileServers,h=new Qr(t,n);e.time&&h.setTime(e.time),typeof e.enableLighting=="boolean"&&h.setLightingEnabled(e.enableLighting),e.tables&&h.setTableOptions(e.tables),e.events?.onNodeClick&&h.setOnNodeClickCallback(e.events.onNodeClick);const l=e.events?.onNodeClick?c=>{e.events.onNodeClick(c),h.highlightNodeRow(c.node.id)}:void 0,d=c=>{e.events?.onEdgeClick&&e.events.onEdgeClick(c),h.highlightEdgeRow(c.edge.id)},f=c=>{e.events?.onGroupClick&&e.events.onGroupClick(c),h.highlightGroupRow(c.group.id)};if(n.includes("graph")){const c=document.createElement("div");c.style.width="100%",c.style.height="100%",h.getViewContainer().appendChild(c);const u=new ai(c,l||e.events?.onNodeClick,e.events?.onSave,a,d,f);if(u.setModeChangeCallback(()=>{h.updateEditToggleButton(),h.updateGraphButtons()}),u.setAlwaysShowEdgesChangeCallback(g=>{h.setAlwaysShowEdges(g)}),u.setGraphButtonsUpdateCallback(()=>{h.updateGraphButtons()}),u.setMode(o),e.data){const g="groups"in e.data&&Array.isArray(e.data.groups)?e.data.groups:void 0;u.setData(e.data.nodes,e.data.edges,g)}h.registerView("graph",u)}if(n.includes("map2d")&&e.loaders?.leaflet){const c=document.createElement("div");c.style.width="100%",c.style.height="100%",h.getViewContainer().appendChild(c);const u=new na(c,l||e.events?.onNodeClick,e.loaders.leaflet,r,e.map2d,d);u.setAlwaysShowEdgesChangeCallback(g=>{h.setAlwaysShowEdges(g)}),u.setLightingChangeCallback(g=>{h.setLightingEnabled(g)}),e.data&&u.setData(e.data.nodes,e.data.edges),h.registerView("map2d",u)}if(n.includes("globe3d")&&e.loaders?.cesium)try{const c=document.createElement("div");c.style.width="100%",c.style.height="100%",h.getViewContainer().appendChild(c);const u=new ea(c,l||e.events?.onNodeClick,e.loaders.cesium,e.globe3d?{customTileUrl:e.globe3d.customTileUrl,customTileUrls:e.globe3d.customTileUrls}:void 0,r,d);u.setAlwaysShowEdgesChangeCallback(g=>{h.setAlwaysShowEdges(g)}),u.setLightingChangeCallback(g=>{h.setLightingEnabled(g)}),e.data&&u.setData(e.data.nodes,e.data.edges),h.registerView("globe3d",u)}catch{}if(h.setInitialView(s),e.data){const c="groups"in e.data&&Array.isArray(e.data.groups)?e.data.groups:void 0;h.setData(e.data.nodes,e.data.edges,c)}return{setData(c){const u=h.getView("graph");u&&u.setData(c.nodes,c.edges,c.groups);const g=h.getView("map2d");g&&g.setData(c.nodes,c.edges);const p=h.getView("globe3d");p&&p.setData(c.nodes,c.edges),h.setData(c.nodes,c.edges,c.groups)},setView(c){h.switchView(c)},getView(){const c=h.getCurrentView();if(!c)throw new Error("No view is currently active");return c},setMode(c){const u=h.getView("graph");u&&u.setMode(c)},getMode(){const c=h.getView("graph");return c?c.getMode():null},resize(){h.resize()},destroy(){h.destroy()},selectNode(c){const u=h.getView("graph");u&&u.selectNode&&u.selectNode(c);const g=h.getView("map2d");g&&g.selectNode&&g.selectNode(c);const p=h.getView("globe3d");p&&p.selectNode&&p.selectNode(c)},setTime(c){h.setTime(c)},setLighting(c){h.setLightingEnabled(c)},getData(){return h.getData()},exportToPlantUML(c){const u=h.getData(),g={useShortIds:!0,includeMetadata:!0,outputFormat:"plain",...c};return Ee(u.nodes,u.edges,u.groups,g)},importFromPlantUML(c){const u=zn(c),g=h.getView("graph");g&&g.setData(u.nodes,u.edges,u.groups);const p=h.getView("map2d");p&&p.setData(u.nodes,u.edges);const y=h.getView("globe3d");y&&y.setData(u.nodes,u.edges),h.setData(u.nodes,u.edges,u.groups)},setPlantUMLExportOptions(c){h.setPlantUMLExportOptions(c)},getShapeDataForOffice(){const{nodes:c,edges:u,groups:g}=h.getData();return Un(c,u,g)},getViewAsSvg(){const c=h.getCurrentView();return c?h.getView(c)?.getViewAsSvg?.()??null:null},async exportViewToImage(c,u){const g=h.getCurrentView();return g?h.getView(g)?.exportViewToImage?.(c,u)??Promise.resolve(null):null}}}F.createRelatosViewer=ca,F.decodeAndInflate=Nr,F.deflateAndEncode=Dn,F.exportToPlantUML=Ee,F.getPlantUMLServerUrl=Rr,F.getShapeDataForOffice=Un,F.importFromPlantUML=zn,F.isDeflateEncoded=Dr,Object.defineProperty(F,Symbol.toStringTag,{value:"Module"})}));
